<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OBEARCO</title>
</head>
<body>
<script>
/* ============================================================
   OBEARCO Web ‚Äî Refatorado para GitHub Pages
   - Mant√©m suas fun√ß√µes (login/register/me/admin)
   - Melhora performance: timeout, retry, cache, abort
   - UI: anima√ß√µes de rotas + toasts
   ============================================================ */

/** =========================
 *  CONFIG (GitHub status.json)
 *  ========================= */
const CONFIG = {
  // Recomendo usar RAW direto (menos dor de cabe√ßa e mais r√°pido)
  // Exemplo: https://raw.githubusercontent.com/NoSense-Bot/Servidor/main/server_status.json
  // Pode usar tanto a vers√£o "blob" do GitHub (https://github.com/.../blob/...) quanto
  // o raw (https://raw.githubusercontent.com/...). Se passar um blob, a fun√ß√£o
  // `normalizeGitHubRawUrl` converte automaticamente para o raw correto.
  STATUS_RAW_URL: "https://raw.githubusercontent.com/NoSense-Bot/Servidor/main/server_status.json",

  API_PREFIX: "/api/v1",
  STATUS_POLL_SEC: 25,     // atualiza bolinha/status no topo
  BOOT_RETRY: 2,           // tentativas para carregar status no boot
  FETCH_TIMEOUT_MS: 9000,  // timeout padr√£o
};

const LS = {
  token: "obearco_session_token",
  apiBase: "obearco_api_base",
  me: "obearco_me_cache",
};

/** =========================
 *  STATE
 *  ========================= */
const state = {
  loading: true,
  status: null,
  apiBase: localStorage.getItem(LS.apiBase) || "",
  token: localStorage.getItem(LS.token) || "",
  me: safeJson(localStorage.getItem(LS.me)) || null,
  isAdmin: false,
  route: location.hash || "#/login",
  lastStatusFetchAt: 0,
  statusTimer: null,
};

/** =========================
 *  Utils base
 *  ========================= */
function safeJson(s){ try{ return JSON.parse(s); }catch{ return null; } }

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

function pickId(user){
  return (user && user.id) || (user && user.user_id) || (user && user._id) || (user && user.email) || null;
}

function isAdminFromMe(me){
  return !!((me && me.is_admin) || (me && me.admin) || (me && me.role === "admin") || (me && me.nivel === "admin"));
}

function go(hash){ location.hash = hash; }

/** =========================
 *  Toast (com anima√ß√£o)
 *  ========================= */
function toast(title, msg, kind="info"){
  const wrap = document.getElementById("toasts");
  const t = document.createElement("div");
  t.className = "toast";
  const icon = kind==="ok" ? "‚úÖ" : kind==="bad" ? "‚ùå" : kind==="warn" ? "‚ö†Ô∏è" : "‚ÑπÔ∏è";
  t.innerHTML = `
    <div style="font-size:18px;line-height:1">${icon}</div>
    <div>
      <b>${escapeHtml(title)}</b>
      <div class="mini muted">${escapeHtml(msg)}</div>
    </div>
  `;
  wrap.appendChild(t);

  setTimeout(()=> t.classList.add("out"), 3200);
  setTimeout(()=> t.remove(), 3650);
}

/** =========================
 *  Fetch helper: timeout + retry
 *  ========================= */
async function fetchJson(url, opts={}){
  const timeout = opts.timeout ?? CONFIG.FETCH_TIMEOUT_MS;
  const tries = opts.tries ?? 1;

  let lastErr = null;

  for(let attempt=1; attempt<=tries; attempt++){
    const controller = new AbortController();
    const id = setTimeout(()=> controller.abort(), timeout);

    try{
      const res = await fetch(url, {
        ...opts,
        signal: controller.signal,
        headers: opts.headers ?? {},
      });
      clearTimeout(id);

      if(!res.ok){
        const text = await res.text().catch(()=> "");
          throw new Error(`HTTP ${res.status} ‚Äî ${(text && text.slice(0,120)) || "erro"}`);
      }
      return await res.json();
    }catch(err){
      clearTimeout(id);
      lastErr = err;
      // pequeno backoff
      if(attempt < tries) await sleep(350 * attempt);
    }
  }

  throw lastErr || new Error("Falha no fetch");
}

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

/** =========================
 *  STATUS (server_status.json)
 *  ========================= */
async function fetchStatus(){
  // cache-bust simples pra evitar GitHub cache agressivo em alguns casos
  // normaliza links do GitHub: se algu√©m configurar o link como
  // https://github.com/NoSense-Bot/Servidor/blob/main/server_status.json
  // converte automaticamente para a vers√£o raw em raw.githubusercontent.com
  function normalizeGitHubRawUrl(url){
    try{
      if(!url) return url;
      // ex: https://github.com/<owner>/<repo>/blob/<branch>/path
      const marker = "/blob/";
      if(url.indexOf("github.com/") !== -1 && url.indexOf(marker) !== -1){
        const after = url.split("github.com/")[1];
        const parts = after.split(marker);
        if(parts.length === 2){
          return "https://raw.githubusercontent.com/" + parts[0] + "/" + parts[1];
        }
      }
      return url;
    }catch(e){ return url; }
  }

  const rawUrl = normalizeGitHubRawUrl(CONFIG.STATUS_RAW_URL);
  const u = new URL(rawUrl);
  u.searchParams.set("t", String(Date.now()));

  try{
    return await fetchJson(u.toString(), { cache: "no-store", tries: 2 });
  }catch(e){
    // fallback para a URL original (caso a normaliza√ß√£o n√£o seja adequada)
    if(rawUrl !== CONFIG.STATUS_RAW_URL){
      try{
        const u2 = new URL(CONFIG.STATUS_RAW_URL);
        u2.searchParams.set("t", String(Date.now()));
        return await fetchJson(u2.toString(), { cache: "no-store", tries: 1 });
      }catch(_){ /* ignore */ }
    }
    throw e;
  }
}

function setServerBadge(online){
  const dot = document.getElementById("srvDot");
  const line = document.getElementById("srvLine");

  if(online){
    dot.style.background = "var(--ok)";
    dot.style.boxShadow = "0 0 0 4px rgba(34,197,94,.12)";
    dot.style.transform = "scale(1.0)";
    line.textContent = "Servidor: Online ‚úÖ";
  }else{
    dot.style.background = "var(--bad)";
    dot.style.boxShadow = "0 0 0 4px rgba(239,68,68,.12)";
    dot.style.transform = "scale(1.0)";
    line.textContent = "Servidor: Offline ‚ùå";
  }
}

/** =========================
 *  API helpers
 *  ========================= */
function apiUrl(path){
  const base = (state.apiBase || "").replace(/\/+$/,"");
  return base + path;
}

async function apiCmd(payload){
  // endpoint principal
  const url = apiUrl(CONFIG.API_PREFIX + "/cmd");

  const headers = { "Content-Type":"application/json" };
  if(state.token) headers["Authorization"] = "Bearer " + state.token;

  try{
    const j = await fetchJson(url, {
      method:"POST",
      headers,
      body: JSON.stringify(payload),
      tries: 1,
      timeout: CONFIG.FETCH_TIMEOUT_MS,
    });

  if(j && j.ok === false) throw new Error(j.error || "Falha no cmd");
    return j;
  }catch(err){
    // fallback legacy APENAS pra login/register
  if(payload && (payload.comando === "/login" || payload.comando === "/register")){
      const legacyPath = payload.comando === "/login" ? "/login" : "/register";
      const jj = await fetchJson(apiUrl(legacyPath), {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload),
        tries: 1,
        timeout: CONFIG.FETCH_TIMEOUT_MS,
      });
  if(jj && jj.ok === false) throw new Error(jj.error || "Falha no login/register");
      return jj;
    }
    throw err;
  }
}

/** =========================
 *  Auth flows
 *  ========================= */
async function doLogin(email, senha){
  const out = await apiCmd({ comando:"/login", email, senha });

  const token =
    out.session_token ||
    out.token ||
    (out && out.data && out.data.session_token) ||
    (out && out.session && out.session.token);

  if(!token) throw new Error("Login OK mas n√£o veio session_token");

  state.token = token;
  localStorage.setItem(LS.token, token);
  toast("Login", "Sess√£o salva ‚úÖ", "ok");

  await loadMe();
  go("#/feed");
}

async function doRegister(email, senha, extra={}){
  await apiCmd({ comando:"/register", email, senha, ...extra });
  toast("Conta criada", "Agora faz login üòâ", "ok");
  go("#/login");
}

function doLogout(){
  state.token = "";
  state.me = null;
  state.isAdmin = false;
  localStorage.removeItem(LS.token);
  localStorage.removeItem(LS.me);
  toast("Logout", "Sess√£o removida.", "ok");
  go("#/login");
}

/** =========================
 *  ME / USER CRUD
 *  ========================= */
async function loadMe(){
  if(!state.token) return null;

  try{
    const out = await apiCmd({ comando:"/me/get" });
    const me = out.me || out.user || out.account || out.data || out;
    applyMe(me);
    return me;
  }catch(e1){
    // compat
    const out2 = await apiCmd({ comando:"/me" }).catch(()=> null);
    if(out2){
      const me = out2.me || out2.user || out2.account || out2.data || out2;
      applyMe(me);
      return me;
    }
    throw e1;
  }
}

function applyMe(me){
  state.me = me;
  state.isAdmin = isAdminFromMe(me);
  localStorage.setItem(LS.me, JSON.stringify(me));
  renderNav();
}

async function updateMe(patch){
  await apiCmd({ comando:"/me/update", patch });
  toast("Conta", "Atualizada ‚úÖ", "ok");
  await loadMe();
}

async function deleteMe(){
  await apiCmd({ comando:"/me/delete" });
  toast("Conta", "Deletada üóëÔ∏è", "ok");
  doLogout();
}

async function addSkill(skill){
  await apiCmd({ comando:"/me/skills/add", skill });
  toast("Skills", "Adicionada ‚úÖ", "ok");
  await loadMe();
}

async function removeSkill(skill){
  await apiCmd({ comando:"/me/skills/remove", skill });
  toast("Skills", "Removida ‚úÖ", "ok");
  await loadMe();
}

/** =========================
 *  ADMIN CRUD
 *  ========================= */
async function adminListUsers(){
  const out = await apiCmd({ comando:"/admin/users/list" });
  return out.users || out.list || out.data || [];
}
async function adminGetUser(id){
  const out = await apiCmd({ comando:"/admin/users/get", id });
  return out.user || out.data || out;
}
async function adminUpdateUser(id, patch){
  await apiCmd({ comando:"/admin/users/update", id, patch });
  toast("Admin", "Usu√°rio atualizado ‚úÖ", "ok");
}
async function adminDeleteUser(id){
  await apiCmd({ comando:"/admin/users/delete", id });
  toast("Admin", "Usu√°rio deletado üóëÔ∏è", "ok");
}
async function adminCreateUser(payload){
  await apiCmd({ comando:"/admin/users/create", ...payload });
  toast("Admin", "Usu√°rio criado ‚úÖ", "ok");
}

/** =========================
 *  Router + Nav
 *  ========================= */
window.addEventListener("hashchange", ()=>{
  state.route = location.hash || "#/login";
  render();
});

function renderNav(){
  const nav = document.getElementById("nav");
  const authed = !!state.token;

  nav.innerHTML = "";

  const chip = document.createElement("div");
  chip.className = "chip";
  chip.innerHTML = `
    <span class="tag">API</span>
    <span class="muted">${escapeHtml(state.apiBase || "‚Äî")}</span>
  `;
  nav.appendChild(chip);

  if(!authed){
    nav.appendChild(btn("üîê Login", ()=>go("#/login"), "primary"));
    nav.appendChild(btn("üßæ Registrar", ()=>go("#/register")));
    return;
  }

  nav.appendChild(btn("üì∞ Feed", ()=>go("#/feed"), "primary"));
  nav.appendChild(btn("‚öôÔ∏è Config", ()=>go("#/config")));
  if(state.isAdmin) nav.appendChild(btn("üõ°Ô∏è Admin", ()=>go("#/admin")));
  nav.appendChild(btn("üö™ Sair", doLogout, "ghost"));
}

function btn(label, onClick, cls=""){
  const b = document.createElement("button");
  b.className = "btn " + cls;
  b.textContent = label;
  b.onclick = onClick;
  return b;
}

/** =========================
 *  Render Views
 *  ========================= */
function mountView(html){
  const app = document.getElementById("app");
  app.innerHTML = `<div class="view">${html}</div>`;
  return app.querySelector(".view");
}

function render(){
  const r = state.route;

  if(!state.token && (r.startsWith("#/feed") || r.startsWith("#/config") || r.startsWith("#/admin"))){
    go("#/login"); return;
  }
  if(state.token && r.startsWith("#/admin") && !state.isAdmin){
    toast("Sem permiss√£o", "Voc√™ n√£o √© admin üòÖ", "warn");
    go("#/feed"); return;
  }

  if(r.startsWith("#/login")) return renderLogin();
  if(r.startsWith("#/register")) return renderRegister();
  if(r.startsWith("#/feed")) return renderFeed();
  if(r.startsWith("#/config")) return renderConfig();
  if(r.startsWith("#/admin")) return renderAdmin();

  go("#/login");
}

function renderLogin(){
  const st = state.status || {};
  const view = mountView(`
    <div class="grid">
      <div class="card">
        <h2>üîê Login</h2>
        <div class="muted">Entre com sua conta (usu√°rio normal ou admin).</div>
        <div class="hr"></div>

        <div class="field">
          <label>Email</label>
          <input id="email" placeholder="email@exemplo.com" autocomplete="email" />
        </div>
        <div class="field">
          <label>Senha</label>
          <input id="senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnLogin">Entrar</button>
          <button class="btn" id="btnGoReg">Criar conta</button>
        </div>

        <div class="hr"></div>
        <div class="smallnote">
          üí° A base da API vem do <span class="tag">server_status.json</span> (GitHub).<br/>
          Se o CORS travar, confirme se seu servidor permite <span class="tag">https://nosense-bot.github.io</span> (ou seu dom√≠nio do Pages).
        </div>
      </div>

      <div class="card">
        <h2>üì° Conex√£o</h2>
        <div class="kpi">
          <div class="box"><div class="n">${escapeHtml(st.status_servidor ?? "‚Äî")}</div><div class="t">status_servidor</div></div>
          <div class="box"><div class="n">${escapeHtml(st.version_api ?? "‚Äî")}</div><div class="t">version_api</div></div>
          <div class="box"><div class="n">${escapeHtml(st.porta ?? "‚Äî")}</div><div class="t">porta</div></div>
        </div>
        <div class="hr"></div>
        <div class="muted mini"><span class="tag">url_api_base</span></div>
        <div class="tag">${escapeHtml(st.url_api_base ?? "‚Äî")}</div>
      </div>
    </div>
  `);

  const email = view.querySelector("#email");
  const senha = view.querySelector("#senha");
  const btnLogin = view.querySelector("#btnLogin");
  const btnGoReg = view.querySelector("#btnGoReg");

  btnGoReg.onclick = ()=> go("#/register");

  btnLogin.onclick = async ()=>{
    const e = (email.value || "").trim();
    const s = (senha.value || "");
    if(!e || !s){ toast("Ops", "Preenche email e senha üòÖ", "warn"); return; }

    btnLogin.disabled = true;
    btnLogin.textContent = "Entrando‚Ä¶";
    try{
      await doLogin(e, s);
    }catch(err){
  toast("Login falhou", (err && err.message) || String(err), "bad");
    }finally{
      btnLogin.disabled = false;
      btnLogin.textContent = "Entrar";
    }
  };
}

function renderRegister(){
  const view = mountView(`
    <div class="grid">
      <div class="card">
        <h2>üßæ Registrar</h2>
        <div class="muted">Cria conta de usu√°rio normal (admin voc√™ define no banco/servidor).</div>
        <div class="hr"></div>

        <div class="field">
          <label>Usu√°rio</label>
          <input id="usuario" placeholder="seu nick" autocomplete="username" />
        </div>
        <div class="field">
          <label>Email</label>
          <input id="email" placeholder="email@exemplo.com" autocomplete="email" />
        </div>
        <div class="field">
          <label>Senha</label>
          <input id="senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password" />
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnReg">Criar</button>
          <button class="btn" id="btnBack">Voltar</button>
        </div>

        <div class="hr"></div>
        <div class="smallnote">üîß Backend esperado: comando <span class="tag">/register</span> (requer email, senha, usuario).</div>
      </div>

      <div class="card">
        <h2>üß† Observa√ß√£o</h2>
        <div class="muted">
          Esse site salva o token no <span class="tag">localStorage</span> (simples e pr√°tico).<br/>
          Em produ√ß√£o, o ideal √© cookie HttpOnly + refresh token.
        </div>
      </div>
    </div>
  `);

  const usuario = view.querySelector("#usuario");
  const email = view.querySelector("#email");
  const senha = view.querySelector("#senha");
  const btnReg = view.querySelector("#btnReg");
  const btnBack = view.querySelector("#btnBack");

  btnBack.onclick = ()=> go("#/login");

  btnReg.onclick = async ()=>{
    const u = (usuario.value || "").trim();
    const e = (email.value || "").trim();
    const s = (senha.value || "");
    if(!u || !e || !s){
      toast("Ops", "Preenche usu√°rio, email e senha üòÖ", "warn");
      return;
    }

    btnReg.disabled = true;
    btnReg.textContent = "Criando‚Ä¶";
    try{
      await doRegister(e, s, { usuario: u });
    }catch(err){
  toast("Registro falhou", (err && err.message) || String(err), "bad");
    }finally{
      btnReg.disabled = false;
      btnReg.textContent = "Criar";
    }
  };
}

function renderFeed(){
  const me = state.me || {};
  const skills = me.skills ?? me.Skills ?? me.habilidades ?? null;

  mountView(`
    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <h2>üì∞ Feed</h2>
            <div class="muted">Seu perfil aparece no topo (skills etc.).</div>
          </div>
          <div class="row">
            ${state.isAdmin ? `<span class="pill ok">üõ°Ô∏è Admin</span>` : `<span class="pill warn">üë§ User</span>`}
          </div>
        </div>

        <div class="hr"></div>

        <div class="item" style="cursor:default">
          <div class="title">${escapeHtml(me.usuario || me.nome || me.name || me.username || me.email || "‚Äî")}</div>
          <div class="sub">${escapeHtml(me.email || "‚Äî")}</div>

          <div class="hr"></div>

          <div class="split">
            <div>
              <div class="muted mini">Token</div>
              <div class="tag">${escapeHtml(state.token ? state.token.slice(0,24)+"‚Ä¶" : "‚Äî")}</div>
            </div>
            <div>
              <div class="muted mini">ID</div>
              <div class="tag">${escapeHtml(pickId(me) || "‚Äî")}</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="muted mini">Skills</div>
          <div class="tag">${escapeHtml(skills === null ? "null" : JSON.stringify(skills))}</div>
        </div>

        <div class="hr"></div>
        <h3>üìå Seu feed (placeholder)</h3>
        <div class="muted mini">
          Aqui voc√™ pode listar posts, atividades, quests, etc.
        </div>
      </div>

      <div class="card">
        <h2>‚ö° A√ß√µes r√°pidas</h2>
        <div class="row">
          <button class="btn primary" onclick="location.hash='#/config'">‚öôÔ∏è Abrir Config</button>
          ${state.isAdmin ? `<button class="btn" onclick="location.hash='#/admin'">üõ°Ô∏è Abrir Admin</button>` : ``}
        </div>
        <div class="hr"></div>
        <div class="smallnote">
          ‚úÖ Conectado como: <span class="tag">${escapeHtml(me.email || "‚Äî")}</span><br/>
          üåê API: <span class="tag">${escapeHtml(state.apiBase || "‚Äî")}</span>
        </div>
      </div>
    </div>
  `);
}

function renderConfig(){
  const me = state.me || {};
  const skills = Array.isArray(me.skills) ? me.skills : (Array.isArray(me.Skills) ? me.Skills : []);
  const skillsJson = JSON.stringify(skills ?? null, null, 2);

  const view = mountView(`
    <div class="grid">
      <div class="card">
        <h2>‚öôÔ∏è Config (usu√°rio)</h2>
        <div class="muted">Seu token + dados da conta com CRUD.</div>

        <div class="hr"></div>

        <div class="field">
          <label>Session token</label>
          <input value="${escapeHtml(state.token || "")}" readonly />
        </div>

        <div class="split">
          <div class="field">
            <label>Usu√°rio</label>
            <input id="fUsuario" value="${escapeHtml(me.usuario || "")}" placeholder="seu nick" />
          </div>
          <div class="field">
            <label>Email</label>
            <input id="fEmail" value="${escapeHtml(me.email || "")}" placeholder="email@exemplo.com" />
          </div>
        </div>

        <div class="field">
          <label>Nome (opcional)</label>
          <input id="fName" value="${escapeHtml(me.nome || me.name || "")}" placeholder="Seu nome" />
        </div>

        <div class="field">
          <label>Bio (opcional)</label>
          <input id="fBio" value="${escapeHtml(me.bio || me.about || "")}" placeholder="Uma descri√ß√£o‚Ä¶" />
        </div>

        <div class="field">
          <label>Skills (JSON)</label>
          <textarea id="fSkills">${escapeHtml(skillsJson === "null" ? "null" : skillsJson)}</textarea>
          <div class="smallnote">üí° Se n√£o tiver skills ainda, deixa <span class="tag">null</span> ou <span class="tag">[]</span>.</div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnSave">üíæ Salvar</button>
          <button class="btn" id="btnReload">üîÑ Recarregar</button>
          <button class="btn danger" id="btnDelete">üóëÔ∏è Deletar conta</button>
        </div>
      </div>

      <div class="card">
        <h2>üß© Skills r√°pidas</h2>
        <div class="muted">Adicionar/remover skill (via comandos dedicados).</div>

        <div class="hr"></div>

        <div class="field">
          <label>Skill</label>
          <input id="skillName" placeholder="ex: espada, alquimia‚Ä¶" />
        </div>
        <div class="row">
          <button class="btn primary" id="btnAddSkill">‚ûï Add</button>
          <button class="btn" id="btnRemSkill">‚ûñ Remover</button>
        </div>

        <div class="hr"></div>

        <div class="smallnote">
          Backend esperado:<br/>
          <span class="tag">/me/update</span>, <span class="tag">/me/delete</span>, <span class="tag">/me/skills/add</span>, <span class="tag">/me/skills/remove</span>
        </div>
      </div>
    </div>
  `);

  const fUsuario = view.querySelector("#fUsuario");
  const fName = view.querySelector("#fName");
  const fEmail = view.querySelector("#fEmail");
  const fBio = view.querySelector("#fBio");
  const fSkills = view.querySelector("#fSkills");

  const btnSave = view.querySelector("#btnSave");
  const btnReload = view.querySelector("#btnReload");
  const btnDelete = view.querySelector("#btnDelete");

  const skillName = view.querySelector("#skillName");
  const btnAddSkill = view.querySelector("#btnAddSkill");
  const btnRemSkill = view.querySelector("#btnRemSkill");

  btnReload.onclick = async ()=>{
    try{ await loadMe(); render(); toast("OK", "Recarregado ‚úÖ", "ok"); }
  catch(err){ toast("Falhou", (err && err.message) || String(err), "bad"); }
  };

  btnSave.onclick = async ()=>{
    btnSave.disabled = true;
    btnSave.textContent = "Salvando‚Ä¶";
    try{
      let skillsVal = null;
      const raw = (fSkills.value || "").trim();
      if(raw !== "") skillsVal = JSON.parse(raw);

      const patch = {
        usuario: (fUsuario.value || "").trim(),
        name: (fName.value || "").trim(),
        email: (fEmail.value || "").trim(),
        bio: (fBio.value || "").trim(),
        skills: skillsVal,
      };

      await updateMe(patch);
      render();
    }catch(err){
  toast("Salvar falhou", (err && err.message) || String(err), "bad");
    }finally{
      btnSave.disabled = false;
      btnSave.textContent = "üíæ Salvar";
    }
  };

  btnDelete.onclick = async ()=>{
    if(!confirm("Tem certeza que quer deletar sua conta?")) return;
    btnDelete.disabled = true;
    try{ await deleteMe(); }
    catch(err){
  toast("Delete falhou", (err && err.message) || String(err), "bad");
      btnDelete.disabled = false;
    }
  };

  btnAddSkill.onclick = async ()=>{
    const sk = (skillName.value||"").trim();
    if(!sk){ toast("Ops", "Digita uma skill üòÖ", "warn"); return; }
    try{ await addSkill(sk); render(); }
  catch(err){ toast("Falhou", (err && err.message) || String(err), "bad"); }
  };

  btnRemSkill.onclick = async ()=>{
    const sk = (skillName.value||"").trim();
    if(!sk){ toast("Ops", "Digita uma skill üòÖ", "warn"); return; }
    try{ await removeSkill(sk); render(); }
  catch(err){ toast("Falhou", (err && err.message) || String(err), "bad"); }
  };
}

function renderAdmin(){
  const view = mountView(`
    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <h2>üõ°Ô∏è Admin</h2>
            <div class="muted">Ver todas as contas + CRUD total.</div>
          </div>
          <span class="pill ok">Admin mode</span>
        </div>

        <div class="hr"></div>

        <div class="split">
          <div class="field">
            <label>Buscar (email/id)</label>
            <input id="q" placeholder="ex: user@gmail.com" />
          </div>
          <div class="row" style="align-items:flex-end">
            <button class="btn primary" id="btnLoad">üì• Carregar lista</button>
            <button class="btn" id="btnNew">‚ûï Novo usu√°rio</button>
          </div>
        </div>

        <div class="hr"></div>
        <div class="list" id="usersList"></div>
      </div>

      <div class="card">
        <h2>‚úçÔ∏è Editor</h2>
        <div class="muted">Selecione um usu√°rio na lista pra editar.</div>

        <div class="hr"></div>

        <div class="field">
          <label>ID selecionado</label>
          <input id="selId" readonly />
        </div>

        <div class="field">
          <label>JSON (patch)</label>
          <textarea id="patch" placeholder='{"bio":"novo","skills":["a","b"],"is_admin":false}'></textarea>
          <div class="smallnote">üîß Isso envia <span class="tag">patch</span> pro comando <span class="tag">/admin/users/update</span></div>
        </div>

        <div class="row">
          <button class="btn primary" id="btnSaveUser">üíæ Atualizar</button>
          <button class="btn danger" id="btnDelUser">üóëÔ∏è Deletar</button>
          <button class="btn" id="btnGetUser">üîé Ver detalhes</button>
        </div>

        <div class="hr"></div>
        <div class="field">
          <label>Detalhes (read-only)</label>
          <textarea id="details" readonly></textarea>
        </div>
      </div>
    </div>
  `);

  const q = view.querySelector("#q");
  const btnLoad = view.querySelector("#btnLoad");
  const btnNew = view.querySelector("#btnNew");
  const usersList = view.querySelector("#usersList");
  const selId = view.querySelector("#selId");
  const patch = view.querySelector("#patch");
  const details = view.querySelector("#details");
  const btnSaveUser = view.querySelector("#btnSaveUser");
  const btnDelUser = view.querySelector("#btnDelUser");
  const btnGetUser = view.querySelector("#btnGetUser");

  let usersCache = [];

  function renderUsers(list){
    usersList.innerHTML = "";
    if(!list.length){
      usersList.innerHTML = `<div class="muted">Nenhuma conta encontrada.</div>`;
      return;
    }
    list.forEach(u=>{
      const id = pickId(u);
      const name = u.usuario || u.nome || u.name || u.username || u.email || "‚Äî";
      const role = (u.is_admin || u.admin || u.role==="admin") ? "admin" : "user";

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="title">${escapeHtml(name)}</div>
            <div class="sub">${escapeHtml(u.email || "")}</div>
          </div>
          <span class="pill ${role==="admin" ? "ok":"warn"}">${role==="admin" ? "üõ°Ô∏è admin":"üë§ user"}</span>
        </div>
        <div class="hr"></div>
        <div class="tag">${escapeHtml(id || "‚Äî")}</div>
      `;
      el.onclick = ()=>{
        selId.value = id || "";
        details.value = JSON.stringify(u, null, 2);
        patch.value = "{}";
      };
      usersList.appendChild(el);
    });
  }

  btnLoad.onclick = async ()=>{
    btnLoad.disabled = true;
    btnLoad.textContent = "Carregando‚Ä¶";
    try{
      const list = await adminListUsers();
      usersCache = Array.isArray(list) ? list : [];
      const term = (q.value||"").trim().toLowerCase();
      const filtered = term
        ? usersCache.filter(u => JSON.stringify(u).toLowerCase().includes(term))
        : usersCache;
      renderUsers(filtered);
      toast("Admin", "Lista carregada ‚úÖ", "ok");
    }catch(err){
  toast("Admin falhou", (err && err.message) || String(err), "bad");
    }finally{
      btnLoad.disabled = false;
      btnLoad.textContent = "üì• Carregar lista";
    }
  };

  btnNew.onclick = async ()=>{
    const usuario = prompt("Usu√°rio (nick):");
    if(!usuario) return;
    const email = prompt("Email do novo usu√°rio:");
    if(!email) return;
    const senha = prompt("Senha:");
    if(!senha) return;
    const isAdmin = confirm("Esse usu√°rio √© ADMIN?");
    try{
      await adminCreateUser({ usuario, email, senha, is_admin: isAdmin });
      await btnLoad.onclick();
    }catch(err){
  toast("Criar falhou", (err && err.message) || String(err), "bad");
    }
  };

  btnGetUser.onclick = async ()=>{
    const id = (selId.value||"").trim();
    if(!id){ toast("Ops", "Seleciona um usu√°rio üòÖ", "warn"); return; }
    try{
      const u = await adminGetUser(id);
      details.value = JSON.stringify(u, null, 2);
      toast("OK", "Detalhes carregados ‚úÖ", "ok");
    }catch(err){
  toast("Falhou", (err && err.message) || String(err), "bad");
    }
  };

  btnSaveUser.onclick = async ()=>{
    const id = (selId.value||"").trim();
    if(!id){ toast("Ops", "Seleciona um usu√°rio üòÖ", "warn"); return; }
    let p = {};
    try{ p = JSON.parse((patch.value||"{}") || "{}"); }
    catch{ toast("JSON inv√°lido", "Corrige o patch üòÖ", "warn"); return; }

    btnSaveUser.disabled = true;
    try{
      await adminUpdateUser(id, p);
      await btnLoad.onclick();
    }catch(err){
  toast("Update falhou", (err && err.message) || String(err), "bad");
    }finally{
      btnSaveUser.disabled = false;
    }
  };

  btnDelUser.onclick = async ()=>{
    const id = (selId.value||"").trim();
    if(!id){ toast("Ops", "Seleciona um usu√°rio üòÖ", "warn"); return; }
    if(!confirm("Deletar esse usu√°rio?")) return;

    btnDelUser.disabled = true;
    try{
      await adminDeleteUser(id);
      selId.value = "";
      details.value = "";
      patch.value = "{}";
      await btnLoad.onclick();
    }catch(err){
  toast("Delete falhou", (err && err.message) || String(err), "bad");
    }finally{
      btnDelUser.disabled = false;
    }
  };
}

/** =========================
 *  Boot + polling de status
 *  ========================= */
async function boot(){
  try{
    state.loading = true;
    renderNav();

    // skeleton simples enquanto carrega
    mountView(`
      <div class="card">
        <h2>Carregando‚Ä¶</h2>
        <div class="hr"></div>
        <div class="skeleton" style="width:55%"></div>
        <div style="height:10px"></div>
        <div class="skeleton" style="width:80%"></div>
        <div style="height:10px"></div>
        <div class="skeleton" style="width:35%"></div>
      </div>
    `);

    // tenta pegar status (com retries no boot)
    let st = null;
    let lastErr = null;

    for(let i=0; i<CONFIG.BOOT_RETRY; i++){
      try{
        st = await fetchStatus();
        break;
      }catch(e){
        lastErr = e;
        await sleep(350 * (i+1));
      }
    }

    if(!st) throw lastErr || new Error("N√£o consegui carregar o status");

    state.status = st;

  const base = ((st && st.url_api_base) || "").trim();
    if(base){
      state.apiBase = base.replace(/\/+$/,"");
      localStorage.setItem(LS.apiBase, state.apiBase);
    }

  const sstatus = (st && st.status_servidor) || "";
  const online = ("" + sstatus).toLowerCase().indexOf("online") !== -1;
    setServerBadge(online);

    // se tiver token, valida
    if(state.token){
      try{ await loadMe(); }
      catch(e){
        toast("Sess√£o", "Token inv√°lido/expirado. Faz login de novo üòâ", "warn");
        doLogout();
      }
    }

    renderNav();
    render();

    // polling do status (apenas UI)
    startStatusPolling();
  }catch(err){
    setServerBadge(false);
  toast("Boot falhou", (err && err.message) || String(err), "bad");
    renderNav();
    render();
  }finally{
    state.loading = false;
  }
}

function startStatusPolling(){
  if(state.statusTimer) clearInterval(state.statusTimer);

  state.statusTimer = setInterval(async ()=>{
    try{
      const st = await fetchStatus();
      state.status = st;

  const base = ((st && st.url_api_base) || "").trim();
      if(base && base.replace(/\/+$/,"") !== state.apiBase){
        state.apiBase = base.replace(/\/+$/,"");
        localStorage.setItem(LS.apiBase, state.apiBase);
        renderNav();
        toast("API atualizada", "Nova base detectada pelo status.json ‚úÖ", "ok");
      }

  const online = String((st && st.status_servidor) || "").toLowerCase().includes("online");
      setServerBadge(online);
    }catch{
      // silencioso: s√≥ marca offline, sem spam de toast
      setServerBadge(false);
    }
  }, Math.max(8, CONFIG.STATUS_POLL_SEC) * 1000);
}

boot();

</script>
</body>
</html>
