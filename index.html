<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OBEARCO ‚Äî Login</title>
  <style>
    :root{
      --bg0:#07060c;
      --bg1:#0b0a14;
      --card:#0f1020cc;
      --card2:#0b0b16cc;
      --txt:#e9e7ff;
      --mut:#a7a4d8;
      --acc:#8b5cf6;
      --acc2:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --line:#2b2b55;
      --glow: 0 0 22px rgba(139,92,246,.55);
      --glow2: 0 0 22px rgba(34,197,94,.45);
      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --radius: 18px;
      --radius2: 24px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color:var(--txt);
      background: radial-gradient(1200px 800px at 20% 10%, #1b0f35 0%, transparent 55%),
                  radial-gradient(900px 600px at 90% 20%, #0c3b28 0%, transparent 55%),
                  radial-gradient(1100px 800px at 50% 110%, #2b173d 0%, transparent 50%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* ====== VFX ====== */
    #vfx{
      position:fixed; inset:0;
      width:100%; height:100%;
      z-index:0;
      pointer-events:none;
      filter: drop-shadow(0 0 10px rgba(139,92,246,.25));
      opacity:.95;
    }
    .fog{
      position:fixed; inset:-20%;
      background:
        radial-gradient(closest-side at 20% 25%, rgba(139,92,246,.11), transparent 60%),
        radial-gradient(closest-side at 80% 35%, rgba(34,197,94,.10), transparent 60%),
        radial-gradient(closest-side at 55% 70%, rgba(255,255,255,.06), transparent 60%);
      animation: drift 18s linear infinite;
      z-index:0;
      pointer-events:none;
      mix-blend-mode: screen;
    }
    @keyframes drift{
      0%{transform:translate3d(-2%, -1%, 0) scale(1)}
      50%{transform:translate3d(2%, 1%, 0) scale(1.03)}
      100%{transform:translate3d(-2%, -1%, 0) scale(1)}
    }

    /* ====== Layout ====== */
    .wrap{
      position:relative;
      z-index:1;
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px 16px;
    }
    .shell{
      width:min(1200px, 96vw);
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:18px;
    }

    @media (max-width: 980px){
      .shell{grid-template-columns:1fr}
    }

    .card{
      background: linear-gradient(180deg, rgba(18,16,35,.85), rgba(10,10,20,.75));
      border:1px solid rgba(139,92,246,.20);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(600px 200px at 30% 0%, rgba(139,92,246,.25), transparent 70%),
                  radial-gradient(520px 220px at 90% 10%, rgba(34,197,94,.20), transparent 70%);
      opacity:.75;
      pointer-events:none;
    }

    .pane{
      position:relative;
      padding:22px;
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding-bottom:14px;
      border-bottom:1px solid rgba(139,92,246,.18);
      margin-bottom:16px;
    }
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.8px;
    }
    .badge{
      font-family: var(--mono);
      font-size:12px;
      color:rgba(255,255,255,.86);
      padding:7px 10px;
      border:1px solid rgba(255,255,255,.16);
      border-radius:999px;
      background: rgba(0,0,0,.25);
    }
    .badge b{color:var(--acc2)}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 560px){
      .grid2{grid-template-columns:1fr}
    }

    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      margin: 12px 0 0;
    }
    .tab{
      appearance:none; border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color:var(--txt);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: .18s ease;
      font-weight:650;
      letter-spacing:.2px;
    }
    .tab:hover{transform: translateY(-1px); box-shadow: var(--glow)}
    .tab.active{
      border-color: rgba(139,92,246,.45);
      background: rgba(139,92,246,.18);
      box-shadow: var(--glow);
    }

    .rune{
      position:absolute;
      right:-70px;
      top:-70px;
      width:220px;
      height:220px;
      border-radius:50%;
      border:1px dashed rgba(139,92,246,.35);
      box-shadow: 0 0 60px rgba(139,92,246,.22) inset;
      animation: spin 22s linear infinite;
      opacity:.55;
      pointer-events:none;
      filter: blur(.1px);
    }
    .rune::after{
      content:"";
      position:absolute; inset:22px;
      border-radius:50%;
      border:1px solid rgba(34,197,94,.22);
      box-shadow: 0 0 40px rgba(34,197,94,.18) inset;
    }
    @keyframes spin{ to{transform:rotate(360deg)} }

    label{display:block; font-size:12px; color:var(--mut); margin-bottom:6px}
    input, textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      color:var(--txt);
      outline:none;
      transition: .15s ease;
    }
    input:focus, textarea:focus{
      border-color: rgba(139,92,246,.5);
      box-shadow: var(--glow);
    }

    .btnrow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .btn{
      appearance:none;
      border:none;
      padding:12px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:800;
      letter-spacing:.3px;
      transition: .15s ease;
      color: #fff;
      background: linear-gradient(180deg, rgba(139,92,246,.95), rgba(109,40,217,.92));
      box-shadow: var(--glow);
    }
    .btn:hover{transform: translateY(-1px)}
    .btn:active{transform: translateY(0px) scale(.99)}
    .btn.secondary{
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: none;
      color: var(--txt);
    }
    .btn.good{
      background: linear-gradient(180deg, rgba(34,197,94,.95), rgba(16,185,129,.88));
      box-shadow: var(--glow2);
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(239,68,68,.95), rgba(185,28,28,.88));
      box-shadow: 0 0 22px rgba(239,68,68,.35);
    }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }

    .hint{
      margin-top:10px;
      font-size:12px;
      color:rgba(255,255,255,.78);
      opacity:.95;
    }
    .hint code{
      font-family: var(--mono);
      font-size:11px;
      background: rgba(0,0,0,.35);
      padding:2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.12);
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.16);
      padding:10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      z-index: 50;
      min-width: min(520px, 92vw);
      display:none;
    }
    .toast.show{display:block; animation: pop .18s ease}
    @keyframes pop{from{transform:translateX(-50%) translateY(8px); opacity:0} to{transform:translateX(-50%) translateY(0); opacity:1}}
    .toast .t{font-weight:800}
    .toast .m{color:rgba(255,255,255,.86); margin-top:4px; font-size:13px}

    /* ====== Right side: Patch + Feed ====== */
    .sideTop{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding-bottom:14px;
      border-bottom:1px solid rgba(255,255,255,.12);
      margin-bottom:14px;
    }
    .sideTop h2{margin:0; font-size:16px}
    .subpill{
      font-family:var(--mono);
      font-size:11px;
      opacity:.9;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.14);
      border-radius:999px;
      background: rgba(0,0,0,.22);
    }
    .box{
      border:1px solid rgba(255,255,255,.12);
      border-radius: var(--radius);
      background: rgba(0,0,0,.25);
      padding:12px;
      margin-bottom:12px;
    }
    .box h3{
      margin:0 0 8px;
      font-size:13px;
      color:rgba(255,255,255,.90);
      letter-spacing:.3px;
    }
    .notes{
      max-height: 280px;
      overflow:auto;
      padding-right:6px;
    }
    .note{
      padding:10px 10px;
      border:1px solid rgba(139,92,246,.15);
      background: rgba(139,92,246,.08);
      border-radius: 14px;
      margin-bottom:10px;
    }
    .note .d{font-family:var(--mono); font-size:11px; opacity:.86}
    .note .t{font-weight:900; margin:6px 0 4px}
    .note .b{font-size:13px; opacity:.92; line-height:1.35}
    .feed{
      max-height: 220px;
      overflow:auto;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      padding-right:6px;
    }
    .chip{
      padding:7px 10px;
      border-radius: 999px;
      border:1px solid rgba(34,197,94,.22);
      background: rgba(34,197,94,.10);
      font-weight:800;
      font-size:12px;
      letter-spacing:.2px;
      box-shadow: 0 0 18px rgba(34,197,94,.16);
    }

    /* ====== Pages ====== */
    .page{display:none}
    .page.active{display:block; animation: fadeIn .22s ease}
    @keyframes fadeIn{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)}}

    .rowline{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin: 10px 0;
    }
    .kv{
      font-family:var(--mono);
      font-size:12px;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      max-width: 100%;
      overflow:auto;
      white-space:nowrap;
    }

    /* ====== Modal confirm delete ====== */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:60;
      padding:18px;
    }
    .modalBack.show{display:flex}
    .modal{
      width:min(560px, 94vw);
      border-radius: var(--radius2);
      border:1px solid rgba(239,68,68,.25);
      background: linear-gradient(180deg, rgba(25,10,15,.92), rgba(12,7,12,.88));
      box-shadow: 0 0 40px rgba(239,68,68,.18);
      padding:18px;
      position:relative;
      overflow:hidden;
    }
    .modal h3{margin:0 0 8px}
    .modal p{margin:0; color:rgba(255,255,255,.86); line-height:1.4}
    .count{
      font-family:var(--mono);
      margin-top:10px;
      display:inline-block;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.14);
      border-radius: 999px;
      background: rgba(0,0,0,.28);
    }

    /* ====== Error shake ====== */
    .shake{animation: shake .28s ease}
    @keyframes shake{
      0%{transform:translateX(0)}
      25%{transform:translateX(-6px)}
      50%{transform:translateX(6px)}
      75%{transform:translateX(-4px)}
      100%{transform:translateX(0)}
    }
  </style>
</head>
<body>
  <canvas id="vfx"></canvas>
  <div class="fog"></div>

  <div class="wrap">
    <div class="shell">

      <!-- LEFT: Auth + Dashboard -->
      <div class="card">
        <div class="rune"></div>
        <div class="pane">
          <div class="brand">
            <h1>üõ°Ô∏è OBEARCO ‚Äî Portal do Aventureiro</h1>
            <div class="badge">API: <b id="apiBadge">carregando‚Ä¶</b></div>
          </div>

          <div class="tabs">
            <button class="tab active" id="tabLogin">Login</button>
            <button class="tab" id="tabRegister">Register</button>
            <button class="tab" id="tabDashboard" style="display:none">Painel</button>
          </div>

          <!-- Login Page -->
          <div class="page active" id="pageLogin">
            <div class="grid2" style="margin-top:14px">
              <div>
                <label>Login (email ou username)</label>
                <input id="login_login" placeholder="ex: meuemail@gmail.com ou MeuNick" autocomplete="username" />
              </div>
              <div>
                <label>Senha</label>
                <input id="login_senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
              </div>
            </div>
            <div class="btnrow">
              <button class="btn good" id="btnDoLogin">Entrar</button>
              <button class="btn secondary" id="btnGoRegister">Criar conta</button>
            </div>
            <div class="hint">
              Base carregada do <code>server_status.json</code>. Se cair, usa fallback local.
            </div>
          </div>

          <!-- Register Page -->
          <div class="page" id="pageRegister">
            <div class="grid2" style="margin-top:14px">
              <div>
                <label>Username</label>
                <input id="reg_username" placeholder="3-32 (letras/n√∫meros/espa√ßo/_)" autocomplete="username" />
              </div>
              <div>
                <label>Email</label>
                <input id="reg_email" placeholder="voce@exemplo.com" autocomplete="email" />
              </div>
            </div>
            <div style="margin-top:12px">
              <label>Senha</label>
              <input id="reg_senha" type="password" placeholder="m√≠n 6 chars" autocomplete="new-password" />
            </div>
            <div class="btnrow">
              <button class="btn good" id="btnDoRegister">Forjar Conta</button>
              <button class="btn secondary" id="btnGoLogin">Voltar</button>
            </div>
            <div class="hint">Dica: o servidor valida username/email/senha. Se der erro, a UI mostra o motivo.</div>
          </div>

          <!-- Dashboard -->
          <div class="page" id="pageDashboard">
            <div class="rowline" style="margin-top:14px">
              <span style="font-weight:900">Bem-vindo,</span>
              <span class="kv" id="dashUser">‚Ä¶</span>
              <button class="btn secondary" id="btnRefreshMe">Atualizar perfil</button>
              <button class="btn danger" id="btnLogout">Sair</button>
            </div>

            <div class="box">
              <h3>üîë Session Token (vis√≠vel pra copiar)</h3>
              <div class="rowline">
                <div class="kv" id="tokenBox" style="flex:1">‚Äî</div>
                <button class="btn secondary" id="btnCopyToken">Copiar</button>
              </div>
              <div class="hint">O launcher/site pode usar <code>Authorization: Bearer &lt;token&gt;</code> nas chamadas.</div>
            </div>

            <div class="grid2">
              <div class="box">
                <h3>üßô Perfil</h3>
                <label>Username (nome)</label>
                <input id="set_username" placeholder="Novo username" />
                <label style="margin-top:10px">Email</label>
                <input id="set_email" placeholder="novo@email.com" />
              </div>

              <div class="box">
                <h3>üó°Ô∏è Seguran√ßa</h3>
                <label>Nova senha</label>
                <input id="set_senha" type="password" placeholder="deixe vazio pra n√£o mudar" />
                <label style="margin-top:10px">Senha atual (pra confirmar)</label>
                <input id="set_senha_atual" type="password" placeholder="obrigat√≥rio pra alterar" />
              </div>
            </div>

            <div class="btnrow">
              <button class="btn good" id="btnSaveAccount">Salvar altera√ß√µes</button>
              <button class="btn danger" id="btnDeleteAccount">Deletar conta</button>
            </div>

            <div class="hint">
              Altera√ß√µes usam comandos: <code>/updateaccount</code> e <code>/deleteaccount</code>.
              Se seu servidor ainda n√£o tiver, vai aparecer ‚ÄúComando n√£o reconhecido‚Äù.
            </div>
          </div>

        </div>
      </div>

      <!-- RIGHT: Patch Notes + Feed -->
      <div class="card">
        <div class="pane">
          <div class="sideTop">
            <h2>üìú Patch Notes & Reino</h2>
            <div class="subpill" id="statusPill">status: ‚Ä¶</div>
          </div>

          <div class="box">
            <h3>üßæ Patch Notes</h3>
            <div class="notes" id="notes"></div>
          </div>

          <div class="box">
            <h3>üë• Aventureiros Registrados (feed)</h3>
            <div class="feed" id="feed"></div>
            <div class="btnrow" style="margin-top:10px">
              <button class="btn secondary" id="btnRefreshFeed">Atualizar feed</button>
              <button class="btn secondary" id="btnForceReloadBase">Recarregar API base</button>
            </div>
            <div class="hint">
              Feed usa comando <code>/listusers</code> (precisa existir no servidor).
            </div>
          </div>

          <div class="box">
            <h3>üåê Conex√£o</h3>
            <div class="hint" style="margin-top:0">
              server_status.json: <code id="statusUrl">raw github</code><br/>
              api_base atual: <code id="apiNow">‚Ä¶</code>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div class="t" id="toastT">‚Äî</div>
    <div class="m" id="toastM">‚Äî</div>
  </div>

  <!-- Modal delete -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <h3>‚ö†Ô∏è Deletar conta</h3>
      <p>Isso √© irrevers√≠vel. Seus dados e acesso ser√£o removidos. Tem certeza?</p>
      <div class="count" id="countDown">Confirma√ß√£o dispon√≠vel em 5s‚Ä¶</div>
      <div class="btnrow" style="margin-top:12px">
        <button class="btn secondary" id="btnCancelDel">Cancelar</button>
        <button class="btn danger" id="btnConfirmDel" disabled>Confirmar (aguarde)</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   0) Config / Status JSON
========================= */
const STATUS_RAW_URL = "https://raw.githubusercontent.com/NoSense-Bot/Servidor/main/server_status.json";

const el = (id)=>document.getElementById(id);
const toast = (t,m,kind="ok")=>{
  el("toastT").textContent = t;
  el("toastM").textContent = m;
  el("toast").classList.add("show");
  if(kind==="bad"){
    el("toast").style.borderColor = "rgba(239,68,68,.28)";
  }else if(kind==="warn"){
    el("toast").style.borderColor = "rgba(245,158,11,.28)";
  }else{
    el("toast").style.borderColor = "rgba(34,197,94,.22)";
  }
  setTimeout(()=>el("toast").classList.remove("show"), 2800);
};

let apiBase = ""; // ex: https://xxxxx.ngrok-free.dev
let statusCache = null;

async function loadServerStatus(){
  el("statusUrl").textContent = STATUS_RAW_URL;
  try{
    const r = await fetch(STATUS_RAW_URL, {cache:"no-store"});
    if(!r.ok) throw new Error("HTTP "+r.status);
    const j = await r.json();
    statusCache = j;
    apiBase = String(j.url_api_base || "").replace(/\/$/,"");
    if(!apiBase) throw new Error("url_api_base vazio no server_status.json");
    el("apiBadge").textContent = apiBase;
    el("apiNow").textContent = apiBase;
    el("statusPill").textContent = "status: " + (j.status_servidor || "Online");
    return true;
  }catch(e){
    // fallback local
    apiBase = (location.origin || "http://127.0.0.1:7776").replace(/\/$/,"");
    el("apiBadge").textContent = apiBase + " (fallback)";
    el("apiNow").textContent = apiBase + " (fallback)";
    el("statusPill").textContent = "status: (fallback)";
    toast("‚ö†Ô∏è Status JSON falhou", "Usando fallback: " + apiBase, "warn");
    return false;
  }
}

/* =========================
   1) API helper
========================= */
function getToken(){
  return localStorage.getItem("obearco_token") || "";
}
function setToken(t){
  if(t) localStorage.setItem("obearco_token", t);
  else localStorage.removeItem("obearco_token");
  renderToken();
}
function renderToken(){
  const t = getToken();
  el("tokenBox").textContent = t || "‚Äî";
}
async function apiCmd(payload){
  const url = apiBase + "/api/v1/cmd";
  const token = getToken();
  const headers = {"Content-Type":"application/json"};
  if(token) headers["Authorization"] = "Bearer " + token;
  const r = await fetch(url, {
    method:"POST",
    headers,
    body: JSON.stringify(payload || {})
  });
  const txt = await r.text();
  let j=null;
  try{ j = JSON.parse(txt); }catch{ j = {ok:false, error:"Resposta n√£o-JSON", raw:txt}; }
  // seu Server.py envolve em {ok:true, request_id, **out}, ent√£o:
  if(!r.ok || j.ok===false){
    return {ok:false, status:r.status, ...j};
  }
  return {ok:true, status:r.status, ...j};
}

/* =========================
   2) Pages / Tabs
========================= */
function setActiveTab(tabId){
  ["tabLogin","tabRegister","tabDashboard"].forEach(id=>{
    const t = el(id);
    if(!t) return;
    t.classList.toggle("active", id===tabId);
  });
  const map = {
    tabLogin:"pageLogin",
    tabRegister:"pageRegister",
    tabDashboard:"pageDashboard"
  };
  Object.values(map).forEach(pid=>el(pid).classList.remove("active"));
  el(map[tabId]).classList.add("active");
}

function showDashboard(){
  el("tabDashboard").style.display = "inline-block";
  setActiveTab("tabDashboard");
  el("tabLogin").style.display = "none";
  el("tabRegister").style.display = "none";
}
function showAuth(){
  el("tabDashboard").style.display = "none";
  el("tabLogin").style.display = "inline-block";
  el("tabRegister").style.display = "inline-block";
  setActiveTab("tabLogin");
}

/* =========================
   3) Patch Notes (mock)
========================= */
const PATCH = [
  {date:"2025-12-18", title:"Portal do Aventureiro", body:"Login/Register com VFX RPG. Perfil com token copi√°vel. Patch panel e feed de jogadores."},
  {date:"2025-12-17", title:"Servidor HTTP + UDP", body:"Hypercorn/FastAPI, UDP Lobby, ngrok e server_status.json com push opcional."},
  {date:"2025-12-16", title:"Sistema de contas", body:"Tabela contas com PBKDF2, sess√£o e comandos base (/register /login /whoami)."}
];
function renderNotes(){
  const root = el("notes");
  root.innerHTML = "";
  PATCH.forEach(n=>{
    const d = document.createElement("div");
    d.className = "note";
    d.innerHTML = `
      <div class="d">${n.date}</div>
      <div class="t">${n.title}</div>
      <div class="b">${n.body}</div>
    `;
    root.appendChild(d);
  });
}

/* =========================
   4) Feed users
========================= */
async function refreshFeed(){
  const box = el("feed");
  box.innerHTML = "";
  const r = await apiCmd({comando:"/listusers"});
  if(!r.ok){
    toast("‚ùå Feed falhou", (r.error || "erro"), "bad");
    // fallback UI
    const c = document.createElement("div");
    c.className = "chip";
    c.style.borderColor = "rgba(245,158,11,.35)";
    c.style.background = "rgba(245,158,11,.10)";
    c.textContent = "Servidor sem /listusers (adicione no Comandos.py)";
    box.appendChild(c);
    return;
  }
  const users = (r.users || r.usuarios || []);
  if(!Array.isArray(users) || users.length===0){
    const c = document.createElement("div");
    c.className = "chip";
    c.textContent = "ningu√©m ainda‚Ä¶";
    box.appendChild(c);
    return;
  }
  users.forEach(u=>{
    const c = document.createElement("div");
    c.className = "chip";
    c.textContent = String(u.username || u.nick || u || "???");
    box.appendChild(c);
  });
}

/* =========================
   5) Auth / Profile
========================= */
async function whoami(){
  const r = await apiCmd({comando:"/whoami"});
  if(!r.ok){
    return null;
  }
  // Comandos.py retorna ok(session=...), e Server envolve, ent√£o pode vir:
  // r.session OR r.session.session etc. Vamos ser tolerantes:
  return r.session || (r.data && r.data.session) || null;
}

function fillProfileFields(sess){
  const username = sess?.username || "";
  const email = sess?.email || "";
  el("dashUser").textContent = username ? `${username} (${email || "sem email"})` : (email || "‚Äî");
  el("set_username").value = username || "";
  el("set_email").value = email || "";
  el("set_senha").value = "";
  el("set_senha_atual").value = "";
}

async function doLogin(){
  const login = el("login_login").value.trim();
  const senha = el("login_senha").value.trim();
  const page = el("pageLogin");

  if(!login || !senha){
    page.classList.add("shake"); setTimeout(()=>page.classList.remove("shake"), 280);
    toast("‚ö†Ô∏è Falta coisa", "Preencha login e senha.", "warn");
    return;
  }

  const r = await apiCmd({comando:"/login", login, senha});
  if(!r.ok){
    page.classList.add("shake"); setTimeout(()=>page.classList.remove("shake"), 280);
    toast("‚ùå Login falhou", r.error || "erro", "bad");
    return;
  }
  const token = r.session_token || r.token || r.sessionToken;
  if(token) setToken(token);

  toast("‚úÖ Login OK", "Bem-vindo de volta!", "ok");
  showDashboard();

  // puxa perfil
  const sess = await whoami();
  if(sess) fillProfileFields(sess);

  // feed
  refreshFeed();
}

async function doRegister(){
  const username = el("reg_username").value.trim();
  const email = el("reg_email").value.trim();
  const senha = el("reg_senha").value.trim();
  const page = el("pageRegister");

  if(!username || !email || !senha){
    page.classList.add("shake"); setTimeout(()=>page.classList.remove("shake"), 280);
    toast("‚ö†Ô∏è Falta coisa", "Preencha username, email e senha.", "warn");
    return;
  }

  const r = await apiCmd({comando:"/register", username, email, senha});
  if(!r.ok){
    page.classList.add("shake"); setTimeout(()=>page.classList.remove("shake"), 280);
    toast("‚ùå Register falhou", r.error || "erro", "bad");
    return;
  }
  toast("‚úÖ Conta criada", "Agora fa√ßa login.", "ok");
  setActiveTab("tabLogin");
}

async function doLogout(){
  // tenta logout se existir
  await apiCmd({comando:"/logout"});
  setToken("");
  showAuth();
  toast("üëã Saiu", "Sess√£o limpa.", "ok");
}

async function refreshMe(){
  const sess = await whoami();
  if(!sess){
    toast("‚ö†Ô∏è Sess√£o", "Token inv√°lido/expirou. Fa√ßa login de novo.", "warn");
    setToken("");
    showAuth();
    return;
  }
  fillProfileFields(sess);
  toast("‚úÖ Perfil atualizado", "Dados recarregados.", "ok");
}

async function saveAccount(){
  const username = el("set_username").value.trim();
  const email = el("set_email").value.trim();
  const nova = el("set_senha").value.trim();
  const atual = el("set_senha_atual").value.trim();

  // se quer mudar senha, exige senha atual
  if(nova && !atual){
    toast("‚ö†Ô∏è Seguran√ßa", "Para trocar senha, informe a senha atual.", "warn");
    return;
  }

  const payload = {
    comando:"/updateaccount",
    username,
    email,
    senha_nova: nova || null,
    senha_atual: atual || null,
  };

  const r = await apiCmd(payload);
  if(!r.ok){
    toast("‚ùå N√£o salvou", r.error || "erro", "bad");
    return;
  }
  toast("‚úÖ Salvo", "Altera√ß√µes aplicadas.", "ok");
  // recarrega perfil
  refreshMe();
  refreshFeed();
}

/* =========================
   6) Delete modal (5s)
========================= */
let delTimer = null;
let delLeft = 5;

function openDeleteModal(){
  delLeft = 5;
  el("btnConfirmDel").disabled = true;
  el("btnConfirmDel").textContent = "Confirmar (aguarde)";
  el("countDown").textContent = "Confirma√ß√£o dispon√≠vel em 5s‚Ä¶";
  el("modalBack").classList.add("show");

  if(delTimer) clearInterval(delTimer);
  delTimer = setInterval(()=>{
    delLeft--;
    if(delLeft <= 0){
      clearInterval(delTimer);
      delTimer = null;
      el("btnConfirmDel").disabled = false;
      el("btnConfirmDel").textContent = "Confirmar agora";
      el("countDown").textContent = "‚ö†Ô∏è Clique em confirmar para deletar de verdade.";
    }else{
      el("countDown").textContent = `Confirma√ß√£o dispon√≠vel em ${delLeft}s‚Ä¶`;
    }
  }, 1000);
}

function closeDeleteModal(){
  el("modalBack").classList.remove("show");
  if(delTimer) clearInterval(delTimer);
  delTimer = null;
}

async function confirmDelete(){
  const r = await apiCmd({comando:"/deleteaccount"});
  if(!r.ok){
    toast("‚ùå Falhou", r.error || "erro", "bad");
    closeDeleteModal();
    return;
  }
  toast("‚úÖ Conta deletada", "Voc√™ saiu do reino.", "ok");
  closeDeleteModal();
  setToken("");
  showAuth();
  refreshFeed();
}

/* =========================
   7) Token copy
========================= */
async function copyToken(){
  const t = getToken();
  if(!t){
    toast("‚ö†Ô∏è Token vazio", "Fa√ßa login para gerar token.", "warn");
    return;
  }
  try{
    await navigator.clipboard.writeText(t);
    toast("‚úÖ Copiado", "Token no clipboard.", "ok");
  }catch{
    // fallback
    const ta = document.createElement("textarea");
    ta.value = t;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    toast("‚úÖ Copiado", "Token no clipboard.", "ok");
  }
}

/* =========================
   8) VFX particles (canvas)
========================= */
const canvas = el("vfx");
const ctx = canvas.getContext("2d");
let W=0,H=0, DPR=1;
let particles = [];
function resize(){
  DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  W = canvas.width = Math.floor(innerWidth * DPR);
  H = canvas.height = Math.floor(innerHeight * DPR);
  canvas.style.width = innerWidth+"px";
  canvas.style.height = innerHeight+"px";
}
window.addEventListener("resize", resize);

function rand(a,b){return a + Math.random()*(b-a);}
function spawn(n=110){
  particles = Array.from({length:n}, ()=>({
    x: rand(0,W), y: rand(0,H),
    r: rand(0.8, 2.4) * DPR,
    vx: rand(-0.18, 0.18) * DPR,
    vy: rand(-0.10, 0.22) * DPR,
    a: rand(0.15, 0.65),
    hue: Math.random() < 0.7 ? 270 : 140
  }));
}
function step(){
  ctx.clearRect(0,0,W,H);

  // soft vignette
  const g = ctx.createRadialGradient(W*0.5,H*0.55, 0, W*0.5,H*0.55, Math.max(W,H)*0.65);
  g.addColorStop(0,"rgba(0,0,0,0)");
  g.addColorStop(1,"rgba(0,0,0,0.55)");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,W,H);

  // particles
  for(const p of particles){
    p.x += p.vx;
    p.y += p.vy;
    if(p.x < -20) p.x = W+20;
    if(p.x > W+20) p.x = -20;
    if(p.y < -20) p.y = H+20;
    if(p.y > H+20) p.y = -20;

    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.fillStyle = `hsla(${p.hue}, 90%, 65%, ${p.a})`;
    ctx.fill();
  }

  // links
  for(let i=0;i<particles.length;i++){
    const a = particles[i];
    for(let j=i+1;j<i+8 && j<particles.length;j++){
      const b = particles[j];
      const dx=a.x-b.x, dy=a.y-b.y;
      const d = Math.hypot(dx,dy);
      if(d < 140*DPR){
        ctx.strokeStyle = `rgba(139,92,246,${0.08 * (1 - d/(140*DPR))})`;
        ctx.beginPath();
        ctx.moveTo(a.x,a.y);
        ctx.lineTo(b.x,b.y);
        ctx.stroke();
      }
    }
  }

  requestAnimationFrame(step);
}

/* =========================
   9) Boot
========================= */
function wire(){
  el("tabLogin").onclick = ()=>setActiveTab("tabLogin");
  el("tabRegister").onclick = ()=>setActiveTab("tabRegister");
  el("tabDashboard").onclick = ()=>setActiveTab("tabDashboard");

  el("btnGoRegister").onclick = ()=>setActiveTab("tabRegister");
  el("btnGoLogin").onclick = ()=>setActiveTab("tabLogin");

  el("btnDoLogin").onclick = doLogin;
  el("btnDoRegister").onclick = doRegister;

  el("btnLogout").onclick = doLogout;
  el("btnRefreshMe").onclick = refreshMe;

  el("btnCopyToken").onclick = copyToken;
  el("btnSaveAccount").onclick = saveAccount;

  el("btnDeleteAccount").onclick = openDeleteModal;
  el("btnCancelDel").onclick = closeDeleteModal;
  el("btnConfirmDel").onclick = confirmDelete;

  el("btnRefreshFeed").onclick = refreshFeed;
  el("btnForceReloadBase").onclick = async ()=>{ await loadServerStatus(); toast("üîÑ API base", apiBase, "ok"); };

  // enter key
  ["login_login","login_senha"].forEach(id=>{
    el(id).addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
  });
  ["reg_username","reg_email","reg_senha"].forEach(id=>{
    el(id).addEventListener("keydown", (e)=>{ if(e.key==="Enter") doRegister(); });
  });
}

(async function boot(){
  resize(); spawn(); step();
  wire(); renderNotes();
  renderToken();

  await loadServerStatus();

  // tenta auto-login se tiver token
  const t = getToken();
  if(t){
    const sess = await whoami();
    if(sess){
      showDashboard();
      fillProfileFields(sess);
      toast("üü£ Sess√£o restaurada", "Token v√°lido. Bem-vindo!", "ok");
      refreshFeed();
      return;
    }else{
      setToken("");
    }
  }
  // sem token
  showAuth();
  refreshFeed(); // vai falhar se /listusers n√£o existir, mas deixa a dica
})();
</script>
</body>
</html>
