<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NoSense ‚Ä¢ Social</title>

  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%23111827'/%3E%3Cpath d='M18 38c6 10 22 10 28 0' fill='none' stroke='%237c3aed' stroke-width='6' stroke-linecap='round'/%3E%3Ccircle cx='24' cy='26' r='4' fill='%23e5e7eb'/%3E%3Ccircle cx='40' cy='26' r='4' fill='%23e5e7eb'/%3E%3C/svg%3E" />

  <style>
    :root{
      --bg:#0b0e14; --panel:#111827; --panel2:#0f172a;
      --text:#e5e7eb; --muted:#9ca3af; --line:#1f2937;
      --ok:#22c55e; --bad:#ef4444; --brand:#7c3aed;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r: 16px; --pad: 14px; --gap: 14px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:radial-gradient(1200px 800px at 10% 0%, #1b1238 0%, transparent 50%), var(--bg); color:var(--text); }
    button, input{ font:inherit; }
    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 14px; border-bottom:1px solid var(--line);
      background:rgba(11,14,20,.75); backdrop-filter: blur(10px);
    }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:900; }
    .dot{ width:10px; height:10px; border-radius:999px; background:var(--bad); box-shadow:0 0 0 4px rgba(239,68,68,.15); }
    .dot.ok{ background:var(--ok); box-shadow:0 0 0 4px rgba(34,197,94,.15); }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border:1px solid var(--line);
      background:rgba(17,24,39,.6); border-radius:999px;
      color:var(--muted); font-size:13px;
      max-width:520px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .btn{
      border:1px solid var(--line);
      background:rgba(17,24,39,.9);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s transform ease;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.primary{ border-color:rgba(124,58,237,.55); background:rgba(124,58,237,.18); }
    .btn.danger{ border-color:rgba(239,68,68,.5); background:rgba(239,68,68,.14); }
    .wrap{ max-width:1200px; margin:0 auto; padding:14px; }
    .grid{ display:grid; gap:var(--gap); grid-template-columns: 320px 1fr 360px; align-items:start; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(17,24,39,.9), rgba(15,23,42,.75));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: var(--pad);
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .bd{ padding: var(--pad); }
    .title{ font-weight:900; }
    .muted{ color:var(--muted); font-size:13px; }
    .sep{ height:1px; background:var(--line); margin:10px 0; }

    .auth{ max-width:460px; margin:40px auto; padding:0 14px; }
    .auth .card{ border-radius:20px; }
    .field{ display:grid; gap:6px; margin:10px 0; }
    input{
      width:100%; padding:12px 12px; border-radius:12px;
      border:1px solid var(--line); background:rgba(2,6,23,.45);
      color:var(--text); outline:none;
    }
    input:focus{ border-color:rgba(124,58,237,.6); box-shadow:0 0 0 4px rgba(124,58,237,.15); }
    .toast{ margin-top:10px; font-size:13px; color:var(--muted); }

    .feedGrid{ display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:12px; }
    @media (max-width: 1100px){ .feedGrid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 520px){ .feedGrid{ grid-template-columns: 1fr; } }
    .userCard{
      border:1px solid var(--line); background:rgba(2,6,23,.35);
      border-radius:14px; padding:12px; cursor:pointer;
      transition:.15s transform ease, .15s border-color ease;
    }
    .userCard:hover{ transform: translateY(-2px); border-color:rgba(124,58,237,.55); }
    .userTop{ display:flex; gap:10px; align-items:center; }
    .avatar{
      width:42px; height:42px; border-radius:14px;
      display:grid; place-items:center;
      background:rgba(124,58,237,.18);
      border:1px solid rgba(124,58,237,.35);
      font-weight:900;
    }
    .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:10px; }
    .chip{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      background:rgba(17,24,39,.6);
      padding:6px 8px; border-radius:999px;
      max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }

    .chatBox{ display:flex; flex-direction:column; gap:10px; height:560px; }
    .chatMsgs{
      flex:1; overflow:auto; padding:10px;
      border:1px solid var(--line); border-radius:14px;
      background:rgba(2,6,23,.28);
    }
    .msg{ display:flex; margin:8px 0; }
    .msg.me{ justify-content:flex-end; }
    .bubble{
      max-width:80%; padding:10px 12px; border-radius:14px;
      border:1px solid var(--line); background:rgba(17,24,39,.75);
      white-space:pre-wrap; word-break:break-word; font-size:14px;
    }
    .msg.me .bubble{ border-color:rgba(124,58,237,.45); background:rgba(124,58,237,.14); }
    .chatSend{ display:flex; gap:10px; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <div class="dot" id="serverDot"></div>
      <div>NoSense ‚Ä¢ Social</div>
      <div class="pill" id="apiPill">API: carregando‚Ä¶</div>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <button class="btn" id="btnReload">Recarregar</button>
      <button class="btn danger" id="btnLogout" style="display:none;">Sair</button>
    </div>
  </div>

  <!-- AUTH -->
  <section class="auth" id="authView">
    <div class="card">
      <div class="hd">
        <div>
          <div class="title" id="authTitle">Entrar</div>
          <div class="muted" id="authSub">Login via /api/auth/login üòÑ</div>
        </div>
        <button class="btn" id="btnToggleAuth">Registrar</button>
      </div>

      <div class="bd">
        <div class="field" id="userField" style="display:none;">
          <div class="muted">Usu√°rio</div>
          <input id="inpUser" placeholder="ex: Guh" />
        </div>

        <div class="field">
          <div class="muted">Email</div>
          <input id="inpEmail" placeholder="seu@email.com" />
        </div>

        <div class="field">
          <div class="muted">Senha</div>
          <input id="inpPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>

        <button class="btn primary" id="btnAuthGo" style="width:100%;">Entrar</button>
        <div class="toast" id="authToast"></div>
      </div>
    </div>
  </section>

  <!-- APP -->
  <section class="wrap" id="appView" style="display:none;">
    <div class="grid">

      <div class="card">
        <div class="hd">
          <div>
            <div class="title">Meu perfil</div>
            <div class="muted" id="meMini">‚Äî</div>
          </div>
        </div>
        <div class="bd">
          <div class="muted">session_token</div>
          <div class="pill" id="tokenPill" title="session_token">‚Äî</div>
          <div class="sep"></div>
          <div class="muted">Status</div>
          <div class="toast" id="meToast">‚Äî</div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <div class="title">Feed</div>
            <div class="muted" id="feedInfo">Carregando‚Ä¶</div>
          </div>
          <button class="btn" id="btnRefreshFeed">Atualizar</button>
        </div>
        <div class="bd">
          <div class="feedGrid" id="feedGrid"></div>
          <div class="toast" id="feedToast"></div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <div class="title">Chat</div>
            <div class="muted" id="chatWith">Selecione algu√©m üëÄ</div>
          </div>
          <span class="pill" id="chatStatus">offline</span>
        </div>

        <div class="bd">
          <div class="chatBox">
            <div class="chatMsgs" id="chatMsgs"></div>
            <div class="chatSend">
              <input id="chatInput" placeholder="Digite‚Ä¶" disabled />
              <button class="btn primary" id="chatSendBtn" disabled>Enviar</button>
            </div>
            <div class="toast" id="chatToast">‚ö†Ô∏è tempor√°rio (sem salvar)</div>
          </div>
        </div>
      </div>

    </div>
  </section>

<script>
  const el = (id) => document.getElementById(id);
  const setToast = (id, msg) => el(id).textContent = msg || "";

  let API = null;
  let MODE = "login";
  let TOKEN = localStorage.getItem("ns_session_token") || "";
  let ME = null;

  // Chat
  let ws = null;
  let CHAT_TARGET = null;

  // tenta ler server_status.json do pr√≥prio site primeiro
  const statusUrls = [
    new URL("server_status.json", location.href).toString(),
    "https://raw.githubusercontent.com/NoSense-Bot/Servidor/main/server_status.json"
  ];

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  async function loadConfig(){
    let lastErr = null;
    for (const url of statusUrls){
      try{
        const r = await fetch(url, { cache:"no-store" });
        if (!r.ok) { lastErr = new Error("HTTP " + r.status); continue; }
        const cfg = await r.json();
        const api = cfg?.url_api_base;
        if (typeof api === "string" && api.startsWith("http")) return api.replace(/\/+$/,"");
        lastErr = new Error("url_api_base n√£o encontrado");
      }catch(e){ lastErr = e; }
    }
    throw lastErr || new Error("Falha lendo server_status.json");
  }

  async function ping(){
    try{
      const r = await fetch(API + "/api/status", { cache:"no-store" });
      return r.ok;
    }catch(_){ return false; }
  }

  async function apiFetch(path, opts = {}){
    const headers = Object.assign({ "Content-Type":"application/json" }, opts.headers || {});
    const r = await fetch(API + path, Object.assign({}, opts, { headers }));
    const ct = r.headers.get("content-type") || "";
    const body = ct.includes("application/json") ? await r.json().catch(()=>null) : await r.text().catch(()=>null);
    if (!r.ok){
      const msg = body?.error || ("HTTP " + r.status);
      throw new Error(msg);
    }
    return body;
  }

  function setAuthMode(mode){
    MODE = mode;
    const isReg = MODE === "register";
    el("authTitle").textContent = isReg ? "Registrar" : "Entrar";
    el("authSub").textContent = isReg ? "Register via /api/auth/register üöÄ" : "Login via /api/auth/login üòÑ";
    el("btnToggleAuth").textContent = isReg ? "Entrar" : "Registrar";
    el("btnAuthGo").textContent = isReg ? "Registrar" : "Entrar";
    el("userField").style.display = isReg ? "" : "none";
    setToast("authToast","");
  }

  function showAuth(){
    el("authView").style.display = "";
    el("appView").style.display = "none";
    el("btnLogout").style.display = "none";
  }
  function showApp(){
    el("authView").style.display = "none";
    el("appView").style.display = "";
    el("btnLogout").style.display = "";
  }

  function renderMe(){
    el("meMini").textContent = ME ? `@${ME.usuario} ‚Ä¢ ${ME.email}` : "‚Äî";
    el("tokenPill").textContent = TOKEN || "‚Äî";
  }

  // =========================
  // FEED
  // =========================
  function initials(name){ return (name?.trim()?.[0] || "?").toUpperCase(); }

  function normalizeUser(u){
    // esperado do backend: { user_id(email), usuario, personagens:[{nick/name...}] }
    const user_id = u.user_id || u.email || u.id || u._id || "";
    const usuario = u.usuario || u.nick || u.username || (u.email ? u.email.split("@")[0] : "User");
    const chars = Array.isArray(u.personagens) ? u.personagens : (Array.isArray(u.characters) ? u.characters : []);
    const charNames = chars.map(c => c.nick || c.name || c.nome || "Personagem");
    return { user_id, usuario, charNames, raw:u };
  }

  function renderFeed(users){
    const grid = el("feedGrid");
    grid.innerHTML = "";
    const norm = users.map(normalizeUser);
    el("feedInfo").textContent = `${norm.length} contas üë•`;

    norm.forEach(u => {
      const div = document.createElement("div");
      div.className = "userCard";
      div.innerHTML = `
        <div class="userTop">
          <div class="avatar">${initials(u.usuario)}</div>
          <div style="min-width:0;">
            <div style="font-weight:900; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(u.usuario)}</div>
            <div class="muted">${u.charNames.length} personagem(ns)</div>
          </div>
        </div>
        <div class="chips">
          ${(u.charNames.slice(0,4)).map(n => `<span class="chip">${escapeHtml(n)}</span>`).join("")}
          ${u.charNames.length > 4 ? `<span class="chip">+${u.charNames.length-4}</span>` : ""}
        </div>
      `;
      div.onclick = () => openChat(u);
      grid.appendChild(div);
    });
  }

  async function refreshFeed(){
    setToast("feedToast","");
    el("feedInfo").textContent = "Carregando‚Ä¶";
    try{
      // ‚úÖ endpoint que vamos adicionar no backend:
      const res = await apiFetch("/api/social/users", { method:"GET" });
      const users = res?.users || [];
      renderFeed(users);
    }catch(e){
      el("feedInfo").textContent = "‚ùå Feed indispon√≠vel";
      setToast("feedToast", "Crie /api/social/users no backend üòÖ (patch abaixo)");
      el("feedGrid").innerHTML = "";
    }
  }

  // =========================
  // CHAT (WebSocket no mesmo server)
  // =========================
  function setChatStatus(ok, msg){
    el("chatStatus").textContent = ok ? "online" : "offline";
    el("chatStatus").style.borderColor = ok ? "rgba(34,197,94,.4)" : "rgba(239,68,68,.4)";
    el("chatStatus").style.background  = ok ? "rgba(34,197,94,.12)" : "rgba(239,68,68,.12)";
    if (msg) setToast("chatToast", msg);
  }

  function wsUrl(){
    // http -> ws, https -> wss
    const base = API.replace(/^http/, "ws");
    return `${base}/ws/chat?session_token=${encodeURIComponent(TOKEN)}`;
  }

  function connectWS(){
    if (!API || !TOKEN) return;

    try{
      ws?.close();
    }catch(_){}

    ws = new WebSocket(wsUrl());

    ws.onopen = () => setChatStatus(true, "üí¨ chat conectado!");
    ws.onclose = () => setChatStatus(false, "‚ö†Ô∏è chat desconectado");
    ws.onerror = () => setChatStatus(false, "‚ùå erro no chat");

    ws.onmessage = (ev) => {
      let msg = null;
      try{ msg = JSON.parse(ev.data); }catch(_){ return; }

      // esperado: {type:"dm", from:{user_id,usuario}, to:"...", text:"..."}
      if (msg.type === "dm"){
        if (!CHAT_TARGET) return;
        if (String(msg.from?.user_id) === String(CHAT_TARGET.user_id)){
          addMsg(msg.text, false);
        }
      }
    };
  }

  function openChat(user){
    CHAT_TARGET = user;
    el("chatWith").textContent = `Com @${user.usuario}`;
    el("chatMsgs").innerHTML = "";
    el("chatInput").disabled = false;
    el("chatSendBtn").disabled = false;
    el("chatInput").focus();
  }

  function addMsg(text, isMe){
    const wrap = document.createElement("div");
    wrap.className = "msg" + (isMe ? " me" : "");
    const bub = document.createElement("div");
    bub.className = "bubble";
    bub.textContent = text;
    wrap.appendChild(bub);
    el("chatMsgs").appendChild(wrap);
    el("chatMsgs").scrollTop = el("chatMsgs").scrollHeight;
  }

  function sendChat(){
    const text = (el("chatInput").value || "").trim();
    if (!text || !CHAT_TARGET) return;
    el("chatInput").value = "";
    addMsg(text, true);

    if (!ws || ws.readyState !== 1){
      setToast("chatToast", "‚ö†Ô∏è ws offline");
      return;
    }

    ws.send(JSON.stringify({
      type: "dm",
      to: CHAT_TARGET.user_id,
      text
    }));
  }

  // =========================
  // BOOT
  // =========================
  async function boot(){
    setToast("authToast","");
    el("apiPill").textContent = "API: carregando‚Ä¶";
    el("serverDot").classList.remove("ok");

    try{
      API = await loadConfig();
      el("apiPill").textContent = "API: " + API;

      const ok = await ping();
      el("serverDot").classList.toggle("ok", ok);

      if (TOKEN){
        // valida sess√£o
        try{
          const v = await apiFetch("/api/auth/validate", {
            method:"POST",
            body: JSON.stringify({ session_token: TOKEN })
          });
          if (!v?.ok) throw new Error("Sess√£o inv√°lida");
          ME = { email: v.user_id, usuario: (v.user_id?.split("@")?.[0] || "user") };
          showApp();
          renderMe();
          setToast("meToast","‚úÖ sess√£o ok");
          connectWS();
          await refreshFeed();
          return;
        }catch(_){
          TOKEN = "";
          localStorage.removeItem("ns_session_token");
        }
      }

      showAuth();
    }catch(e){
      showAuth();
      setToast("authToast", "‚ùå " + e.message);
    }
  }

  // =========================
  // EVENTS
  // =========================
  el("btnToggleAuth").onclick = () => setAuthMode(MODE === "login" ? "register" : "login");

  el("btnAuthGo").onclick = async () => {
    const email = (el("inpEmail").value || "").trim();
    const password = (el("inpPass").value || "").trim();
    const usuario = (el("inpUser").value || "").trim();

    if (!email || !password) return setToast("authToast","‚ö†Ô∏è preenche email e senha");
    if (MODE === "register" && !usuario) return setToast("authToast","‚ö†Ô∏è preenche usu√°rio");

    try{
      setToast("authToast","‚è≥ enviando...");
      let res;

      if (MODE === "register"){
        res = await apiFetch("/api/auth/register", {
          method:"POST",
          body: JSON.stringify({ email, password, usuario })
        });
      }else{
        res = await apiFetch("/api/auth/login", {
          method:"POST",
          body: JSON.stringify({ email, password })
        });
      }

      const token = res?.session_token;
      if (!token) throw new Error("API n√£o retornou session_token üòµ‚Äçüí´");

      TOKEN = token;
      localStorage.setItem("ns_session_token", TOKEN);

      ME = { email, usuario: (MODE === "register" ? usuario : (email.split("@")[0] || "user")) };

      showApp();
      renderMe();
      setToast("meToast","‚úÖ logado!");
      connectWS();
      await refreshFeed();

    }catch(e){
      setToast("authToast", "‚ùå " + e.message);
    }
  };

  el("btnLogout").onclick = () => {
    TOKEN = "";
    ME = null;
    CHAT_TARGET = null;
    localStorage.removeItem("ns_session_token");
    try{ ws?.close(); }catch(_){}
    ws = null;
    showAuth();
    setAuthMode("login");
  };

  el("btnReload").onclick = () => boot();
  el("btnRefreshFeed").onclick = () => refreshFeed();
  el("chatSendBtn").onclick = () => sendChat();
  el("chatInput").addEventListener("keydown", (e) => { if (e.key === "Enter") sendChat(); });

  setAuthMode("login");
  boot();
</script>
</body>
</html>
