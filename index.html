<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OBEARCO â€¢ Gate of Accounts</title>
  <style>
    :root{
      --bg0:#07060a; --bg1:#0b0a12; --panel:rgba(18,16,28,.72);
      --panel2:rgba(15,12,22,.55);
      --line:rgba(255,255,255,.10);
      --text:#e9e6ff; --muted:rgba(233,230,255,.65);
      --gold:#d7b46a; --gold2:#ffdf8c;
      --aqua:#62f0ff; --vio:#a66bff; --red:#ff5b6e; --ok:#55ff9a;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background: radial-gradient(1200px 600px at 20% 10%, rgba(166,107,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 85% 20%, rgba(98,240,255,.14), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    /* ======= VFX layers ======= */
    #vfx, #vfx2{
      position:fixed; inset:0; width:100%; height:100%;
      pointer-events:none; z-index:0;
    }
    .grain{
      position:fixed; inset:-40%;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      opacity:.08; mix-blend-mode:overlay; animation:grain 8s steps(2,end) infinite;
      z-index:1; pointer-events:none;
    }
    @keyframes grain{
      0%{transform:translate(0,0)} 20%{transform:translate(-2%,3%)}
      40%{transform:translate(3%,-1%)} 60%{transform:translate(-1%,-2%)}
      80%{transform:translate(2%,2%)} 100%{transform:translate(0,0)}
    }
    .scanlines{
      position:fixed; inset:0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,.05), rgba(255,255,255,.05) 1px,
        transparent 1px, transparent 4px
      );
      opacity:.05; mix-blend-mode:soft-light; z-index:1; pointer-events:none;
    }

    /* ======= Layout ======= */
    .app{
      position:relative; z-index:2;
      height:100%;
      display:grid;
      grid-template-rows: 74px 1fr;
    }
    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(0,0,0,.42), rgba(0,0,0,.05));
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; gap:12px; align-items:center;
    }
    .sigil{
      width:42px; height:42px; border-radius:14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,223,140,.75), transparent 55%),
        radial-gradient(circle at 70% 70%, rgba(166,107,255,.55), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.10), rgba(0,0,0,.25));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 0 28px rgba(255,223,140,.18);
      position:relative;
      overflow:hidden;
    }
    .sigil::after{
      content:"";
      position:absolute; inset:-40%;
      background: conic-gradient(from 90deg, transparent, rgba(98,240,255,.32), transparent, rgba(255,223,140,.22), transparent);
      animation:spin 5.5s linear infinite;
      filter: blur(1px);
      opacity:.9;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .brand h1{
      margin:0; font-size:15px; letter-spacing:.18em; text-transform:uppercase;
      color:rgba(255,255,255,.90);
    }
    .brand .sub{
      font-size:12px; color:var(--muted); margin-top:4px;
    }

    .topRight{
      display:flex; gap:10px; align-items:center;
    }
    .chip{
      display:flex; gap:10px; align-items:center;
      padding:10px 12px; border-radius:999px;
      background:rgba(18,16,28,.45); border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
    }
    .chip .name{
      font-weight:700; letter-spacing:.02em;
    }
    .chip .email{
      font-size:12px; color:var(--muted); max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .btn{
      cursor:pointer; user-select:none;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.22));
      color:var(--text);
      padding:10px 12px; border-radius:12px;
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    .btn:hover{ transform:translateY(-1px); border-color:rgba(255,223,140,.35); box-shadow: 0 14px 34px rgba(0,0,0,.35); }
    .btn:active{ transform:translateY(0px) scale(.99); }
    .btn.primary{
      border-color: rgba(255,223,140,.26);
      background: linear-gradient(180deg, rgba(255,223,140,.20), rgba(0,0,0,.25));
    }
    .btn.danger{
      border-color: rgba(255,91,110,.35);
      background: linear-gradient(180deg, rgba(255,91,110,.18), rgba(0,0,0,.28));
    }
    .btn.ghost{
      background: transparent;
      box-shadow:none;
    }

    main{
      height:100%;
      display:grid;
      grid-template-columns: 290px 1fr 360px;
      gap:14px;
      padding:14px;
      overflow:hidden;
    }

    .panel{
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(18,16,28,.78), rgba(10,8,14,.62));
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow:hidden;
      position:relative;
    }
    .panel::before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(420px 200px at 20% 10%, rgba(255,223,140,.12), transparent 60%),
                  radial-gradient(420px 260px at 80% 0%, rgba(98,240,255,.10), transparent 65%),
                  radial-gradient(520px 260px at 40% 100%, rgba(166,107,255,.10), transparent 70%);
      pointer-events:none;
    }

    .leftNav{
      display:flex; flex-direction:column;
    }
    .navHead{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between;
    }
    .navHead .title{
      font-weight:900; letter-spacing:.16em; text-transform:uppercase;
      font-size:12px; color:rgba(255,255,255,.78);
    }
    .navList{ padding:10px; display:flex; flex-direction:column; gap:8px; }
    .tab{
      display:flex; align-items:center; gap:10px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.18));
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, filter .12s ease;
      position:relative;
      overflow:hidden;
    }
    .tab::after{
      content:"";
      position:absolute; inset:-60%;
      background: conic-gradient(from 220deg, transparent, rgba(98,240,255,.20), transparent, rgba(255,223,140,.16), transparent);
      opacity:0;
      transition: opacity .18s ease;
    }
    .tab:hover{ transform:translateY(-1px); border-color:rgba(255,223,140,.28); }
    .tab:hover::after{ opacity:.7; }
    .tab.active{
      border-color: rgba(255,223,140,.40);
      filter: drop-shadow(0 0 16px rgba(255,223,140,.12));
    }
    .tab .ic{
      width:26px; height:26px; border-radius:10px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:grid; place-items:center;
      font-size:13px;
    }
    .tab .label{ font-weight:800; letter-spacing:.02em; }
    .tab .hint{ font-size:12px; color:var(--muted); margin-top:2px; }

    .center{
      display:flex; flex-direction:column; overflow:hidden;
    }
    .centerHead{
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .centerHead .title{
      font-size:14px; font-weight:900; letter-spacing:.12em; text-transform:uppercase;
      color:rgba(255,255,255,.88);
    }
    .centerBody{
      padding:14px;
      overflow:auto;
      height:100%;
    }

    .right{
      display:flex; flex-direction:column; overflow:hidden;
    }
    .rightHead{
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .rightHead .title{
      font-size:12px; font-weight:900; letter-spacing:.18em; text-transform:uppercase;
      color:rgba(255,255,255,.75);
    }
    .rightBody{ padding:14px; overflow:auto; height:100%; }

    /* ======= Forms ======= */
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    label{ font-size:12px; color:var(--muted); letter-spacing:.06em; text-transform:uppercase; }
    input, textarea, select{
      width:100%;
      border-radius:14px;
      padding:12px 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }
    input:focus, textarea:focus{
      border-color: rgba(98,240,255,.38);
      box-shadow: 0 0 0 4px rgba(98,240,255,.10);
    }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .sep{ height:1px; background:rgba(255,255,255,.10); margin:14px 0; }

    .note{
      font-size:12px; color:var(--muted); line-height:1.45;
    }

    .banner{
      padding:12px 12px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      background: linear-gradient(180deg, rgba(255,223,140,.10), rgba(0,0,0,.20));
      display:flex; gap:10px; align-items:flex-start;
      position:relative; overflow:hidden;
    }
    .banner::after{
      content:"";
      position:absolute; inset:-60%;
      background: radial-gradient(circle at 30% 30%, rgba(98,240,255,.18), transparent 55%),
                  radial-gradient(circle at 70% 60%, rgba(166,107,255,.14), transparent 60%);
      animation:float 6.2s ease-in-out infinite;
      opacity:.9;
    }
    @keyframes float{
      0%,100%{transform:translate(0,0)}
      50%{transform:translate(2.2%, -1.4%)}
    }
    .banner > *{ position:relative; z-index:1; }

    .toastWrap{
      position:fixed; right:16px; bottom:16px;
      display:flex; flex-direction:column; gap:10px; z-index:99;
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      max-width: 420px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,8,14,.78);
      backdrop-filter: blur(12px);
      padding:12px 12px;
      box-shadow: 0 18px 55px rgba(0,0,0,.45);
      transform: translateY(10px);
      opacity:0;
      animation:toastIn .22s ease forwards;
    }
    @keyframes toastIn{to{transform:translateY(0); opacity:1}}
    .toast .t{ font-weight:900; letter-spacing:.04em; }
    .toast .m{ margin-top:4px; font-size:12px; color:var(--muted); line-height:1.35; }
    .toast.ok{ border-color: rgba(85,255,154,.25) }
    .toast.err{ border-color: rgba(255,91,110,.30) }

    /* Feed list */
    .list{
      display:flex; flex-direction:column; gap:10px;
    }
    .card{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      border-radius:16px;
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:-40%;
      background: conic-gradient(from 90deg, transparent, rgba(255,223,140,.12), transparent, rgba(98,240,255,.10), transparent);
      opacity:.35;
      animation:spin 10s linear infinite;
    }
    .card > *{ position:relative; z-index:1; }
    .nick{ font-weight:900; letter-spacing:.02em; }
    .meta{ font-size:12px; color:var(--muted); margin-top:4px; }

    .tokenBox{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      padding:12px;
      font-family: var(--mono);
      font-size:12px;
      line-height:1.35;
      word-break: break-all;
      position:relative; overflow:hidden;
    }
    .tokenBox::after{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,223,140,.12), transparent 55%),
                  radial-gradient(circle at 70% 70%, rgba(98,240,255,.10), transparent 60%);
      opacity:.9;
      animation:float 7s ease-in-out infinite;
      pointer-events:none;
    }
    .tokenBox code{ position:relative; z-index:1; }

    /* Mobile */
    @media (max-width: 1020px){
      main{ grid-template-columns:1fr; grid-template-rows:auto auto auto; overflow:auto; }
      body{ overflow:auto; }
      #vfx,#vfx2,.grain,.scanlines{ position:fixed; }
    }
  </style>
</head>
<body>
  <canvas id="vfx"></canvas>
  <canvas id="vfx2"></canvas>
  <div class="grain"></div>
  <div class="scanlines"></div>

  <div class="app">
    <header>
      <div class="brand">
        <div class="sigil" aria-hidden="true"></div>
        <div>
          <h1>OBEARCO â€¢ Gate of Accounts</h1>
          <div class="sub" id="subLine">Conectando ao grimÃ³rio do servidor...</div>
        </div>
      </div>

      <div class="topRight">
        <div class="chip" id="userChip" style="display:none">
          <div>
            <div class="name" id="chipName">â€”</div>
            <div class="email" id="chipEmail">â€”</div>
          </div>
        </div>
        <button class="btn ghost" id="btnReloadBase">ğŸ”„ Sync status.json</button>
        <button class="btn" id="btnLogout" style="display:none">ğŸšª Logout</button>
      </div>
    </header>

    <main>
      <!-- Left Nav -->
      <section class="panel leftNav">
        <div class="navHead">
          <div class="title">Abas</div>
          <div class="title" id="baseBadge" style="opacity:.7"></div>
        </div>
        <div class="navList">
          <div class="tab active" data-tab="auth">
            <div class="ic">ğŸ—ï¸</div>
            <div>
              <div class="label">Portal</div>
              <div class="hint">login / registro</div>
            </div>
          </div>
          <div class="tab" data-tab="feed">
            <div class="ic">ğŸ“œ</div>
            <div>
              <div class="label">Taverna</div>
              <div class="hint">nicks registrados</div>
            </div>
          </div>
          <div class="tab" data-tab="profile">
            <div class="ic">ğŸ›¡ï¸</div>
            <div>
              <div class="label">Perfil</div>
              <div class="hint">token / dados</div>
            </div>
          </div>
          <div class="tab" data-tab="account">
            <div class="ic">âš™ï¸</div>
            <div>
              <div class="label">Conta</div>
              <div class="hint">editar / deletar</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Center -->
      <section class="panel center">
        <div class="centerHead">
          <div class="title" id="centerTitle">Portal</div>
          <div class="row">
            <button class="btn primary" id="btnPing">ğŸ«€ Ping</button>
            <button class="btn" id="btnWhoami">ğŸ‘ï¸ Whoami</button>
          </div>
        </div>
        <div class="centerBody" id="centerBody"></div>
      </section>

      <!-- Right -->
      <section class="panel right">
        <div class="rightHead">
          <div class="title">Patch Notes</div>
          <button class="btn ghost" id="btnLoadNotes">âœ¨ Atualizar</button>
        </div>
        <div class="rightBody">
          <div class="banner">
            <div style="font-size:18px">ğŸ§™</div>
            <div>
              <div style="font-weight:900; letter-spacing:.05em">CrÃ´nicas do Reino</div>
              <div class="note">Essa coluna sempre fica do lado, estilo â€œsite AAAâ€. VocÃª pode trocar o texto quando quiser.</div>
            </div>
          </div>
          <div class="sep"></div>
          <div id="notesBox" class="note">Carregando patch notes...</div>
        </div>
      </section>
    </main>
  </div>

  <div class="toastWrap" id="toastWrap"></div>

<script>
/* ==========================
   CONFIG: server_status.json
   ========================== */
const STATUS_JSON_URL = "https://github.com/NoSense-Bot/Servidor/blob/main/server_status.json"; // vocÃª pediu assim
const FALLBACK_BASE = "http://127.0.0.1:7776";
const API_PREFIX = "/api/v1";

function toRawGithub(url){
  // aceita "blob" e converte pra raw
  try{
    if(url.includes("github.com") && url.includes("/blob/")){
      const u = new URL(url);
      const parts = u.pathname.split("/").filter(Boolean);
      // /{owner}/{repo}/blob/{branch}/{...path}
      const owner = parts[0], repo = parts[1], branch = parts[3];
      const path = parts.slice(4).join("/");
      return `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${path}`;
    }
  }catch{}
  return url;
}

let apiBase = FALLBACK_BASE;
let sessionToken = localStorage.getItem("obearco_token") || "";
let cachedConta = null;

/* ==========================
   UI helpers
   ========================== */
const $ = (q)=>document.querySelector(q);
const centerBody = $("#centerBody");

function toast(kind, title, msg){
  const wrap = $("#toastWrap");
  const el = document.createElement("div");
  el.className = `toast ${kind}`;
  el.innerHTML = `<div class="t">${title}</div><div class="m">${msg}</div>`;
  wrap.appendChild(el);
  setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(10px)"; }, 2800);
  setTimeout(()=>{ el.remove(); }, 3300);
}

function setSubtitle(text){
  $("#subLine").textContent = text;
}

function setChip(conta){
  const chip = $("#userChip");
  const btnLogout = $("#btnLogout");
  if(conta){
    chip.style.display = "";
    btnLogout.style.display = "";
    $("#chipName").textContent = conta.username || "â€”";
    $("#chipEmail").textContent = conta.email || "â€”";
  }else{
    chip.style.display = "none";
    btnLogout.style.display = "none";
    $("#chipName").textContent = "â€”";
    $("#chipEmail").textContent = "â€”";
  }
}

function setBaseBadge(){
  try{
    const u = new URL(apiBase);
    $("#baseBadge").textContent = `${u.hostname}:${u.port || (u.protocol==="https:"?"443":"80")}`;
  }catch{
    $("#baseBadge").textContent = apiBase;
  }
}

/* ==========================
   API wrapper
   ========================== */
async function cmd(payload){
  const url = apiBase.replace(/\/$/,"") + API_PREFIX + "/cmd";
  const headers = { "Content-Type":"application/json" };
  if(sessionToken) headers["Authorization"] = "Bearer " + sessionToken;

  const r = await fetch(url, { method:"POST", headers, body: JSON.stringify(payload) });
  const data = await r.json().catch(()=>({ok:false,error:"Resposta nÃ£o Ã© JSON"}));
  if(!data.ok){
    throw new Error(data.error || "Erro desconhecido");
  }
  return data;
}

async function syncFromStatusJson(){
  const raw = toRawGithub(STATUS_JSON_URL);
  const bust = raw + (raw.includes("?")?"&":"?") + "ts=" + Date.now();
  setSubtitle("Sincronizando status.json...");
  try{
    const r = await fetch(bust, { cache:"no-store" });
    const j = await r.json();
    if(j && j.url_api_base){
      apiBase = String(j.url_api_base).replace(/\/$/,"");
      localStorage.setItem("obearco_api_base", apiBase);
      setSubtitle("Conectado ao portal: " + apiBase);
      setBaseBadge();
      toast("ok","Portal sincronizado","API base carregada do server_status.json.");
      return;
    }
    throw new Error("status.json sem url_api_base");
  }catch(e){
    apiBase = localStorage.getItem("obearco_api_base") || FALLBACK_BASE;
    setSubtitle("Falha no status.json. Usando fallback: " + apiBase);
    setBaseBadge();
    toast("err","Falha no status.json", String(e.message||e));
  }
}

/* ==========================
   Tabs
   ========================== */
const tabs = document.querySelectorAll(".tab");
tabs.forEach(t=>{
  t.addEventListener("click", ()=>{
    tabs.forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const id = t.dataset.tab;
    renderTab(id);
  });
});

function mustBeLogged(){
  if(!sessionToken){
    toast("err","Sem sessÃ£o","FaÃ§a login primeiro.");
    renderTab("auth");
    return false;
  }
  return true;
}

function setTitle(t){ $("#centerTitle").textContent = t; }

function renderTab(id){
  if(id==="auth"){ setTitle("Portal"); renderAuth(); return; }
  if(id==="feed"){ setTitle("Taverna"); renderFeed(); return; }
  if(id==="profile"){ setTitle("Perfil"); renderProfile(); return; }
  if(id==="account"){ setTitle("Conta"); renderAccount(); return; }
}

function setActiveTab(id){
  tabs.forEach(x=>x.classList.toggle("active", x.dataset.tab===id));
  renderTab(id);
}

/* ==========================
   AUTH TAB
   ========================== */
function renderAuth(){
  centerBody.innerHTML = `
    <div class="banner">
      <div style="font-size:18px">âš”ï¸</div>
      <div>
        <div style="font-weight:900; letter-spacing:.06em">Portal do Aventureiro</div>
        <div class="note">Registre sua conta ou entre no reino. Tudo usa <b>/api/v1/cmd</b>.</div>
      </div>
    </div>

    <div class="sep"></div>

    <div class="grid2">
      <div class="card">
        <div class="nick">Login</div>
        <div class="meta">Use <b>username</b> ou <b>email</b> no campo â€œloginâ€.</div>
        <div class="sep"></div>

        <div class="field">
          <label>Login (email ou username)</label>
          <input id="login_login" placeholder="ex: Gustavo ou gustavo@email.com" autocomplete="username" />
        </div>
        <div class="field" style="margin-top:10px">
          <label>Senha</label>
          <input id="login_senha" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="doLogin">ğŸ—ï¸ Entrar</button>
          <button class="btn" id="clearToken">ğŸ§¹ Limpar token</button>
        </div>
      </div>

      <div class="card">
        <div class="nick">Registro</div>
        <div class="meta">Cria a conta usando os campos da sua tabela <b>contas</b>.</div>
        <div class="sep"></div>

        <div class="field">
          <label>Username</label>
          <input id="reg_user" placeholder="ex: Gustavo_42" autocomplete="username" />
        </div>
        <div class="field" style="margin-top:10px">
          <label>Email</label>
          <input id="reg_email" placeholder="ex: voce@email.com" autocomplete="email" />
        </div>
        <div class="field" style="margin-top:10px">
          <label>Senha</label>
          <input id="reg_senha" type="password" placeholder="mÃ­nimo 6 chars" autocomplete="new-password" />
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="doRegister">ğŸ§¾ Registrar</button>
        </div>
      </div>
    </div>

    <div class="sep"></div>

    <div class="card">
      <div class="nick">API / Token</div>
      <div class="meta">Base atual: <span style="color:var(--gold)">${apiBase}</span></div>
      <div class="sep"></div>
      <div class="row">
        <button class="btn" id="copyBase">ğŸ“‹ Copiar API Base</button>
        <button class="btn" id="openBase">ğŸŒ Abrir API</button>
      </div>
    </div>
  `;

  $("#doLogin").onclick = async ()=>{
    const login = $("#login_login").value.trim();
    const senha = $("#login_senha").value.trim();
    if(!login || !senha){ toast("err","Campos","Preencha login e senha."); return; }
    try{
      const out = await cmd({ comando:"/login", login, senha });
      sessionToken = out.session_token || "";
      localStorage.setItem("obearco_token", sessionToken);
      cachedConta = out.conta || null;
      setChip(cachedConta);
      toast("ok","Login ok","SessÃ£o criada. Bem-vindo ao reino.");
      setActiveTab("profile");
    }catch(e){
      toast("err","Falha no login", e.message);
    }
  };

  $("#doRegister").onclick = async ()=>{
    const username = $("#reg_user").value.trim();
    const email = $("#reg_email").value.trim();
    const senha = $("#reg_senha").value.trim();
    if(!username || !email || !senha){ toast("err","Campos","Preencha username, email e senha."); return; }
    try{
      await cmd({ comando:"/register", username, email, senha });
      toast("ok","Conta criada","Agora faÃ§a login.");
    }catch(e){
      toast("err","Falha no registro", e.message);
    }
  };

  $("#clearToken").onclick = ()=>{
    sessionToken = "";
    cachedConta = null;
    localStorage.removeItem("obearco_token");
    setChip(null);
    toast("ok","Token limpo","SessÃ£o removida do navegador.");
  };

  $("#copyBase").onclick = async ()=>{
    try{ await navigator.clipboard.writeText(apiBase); toast("ok","Copiado","API Base copiada."); }
    catch{ toast("err","Erro","NÃ£o deu pra copiar (permissÃ£o do navegador)."); }
  };

  $("#openBase").onclick = ()=> window.open(apiBase + API_PREFIX + "/status", "_blank");
}

/* ==========================
   FEED TAB (nicks registrados)
   Requer backend: /listusers
   ========================== */
async function renderFeed(){
  centerBody.innerHTML = `
    <div class="banner">
      <div style="font-size:18px">ğŸ»</div>
      <div>
        <div style="font-weight:900; letter-spacing:.06em">Taverna</div>
        <div class="note">Mostra o nick de todos registrados. (Requer comando <b>/listusers</b> no backend.)</div>
      </div>
    </div>
    <div class="sep"></div>
    <div class="row">
      <button class="btn primary" id="btnLoadUsers">ğŸ“œ Carregar nicks</button>
    </div>
    <div class="sep"></div>
    <div id="usersList" class="list"></div>
  `;

  $("#btnLoadUsers").onclick = async ()=>{
    const box = $("#usersList");
    box.innerHTML = `
      <div class="card"><div class="nick">â³ Consultando o reino...</div><div class="meta">carregando</div></div>
      <div class="card"><div class="nick">â³ Consultando o reino...</div><div class="meta">carregando</div></div>
      <div class="card"><div class="nick">â³ Consultando o reino...</div><div class="meta">carregando</div></div>
    `;
    try{
      const out = await cmd({ comando:"/listusers" });
      const users = out.users || [];
      box.innerHTML = users.map((u,i)=>`
        <div class="card">
          <div class="nick">ğŸ—¡ï¸ ${escapeHtml(u.username || ("User_"+i))}</div>
          <div class="meta">${u.created_at ? ("Criado em: " + escapeHtml(u.created_at)) : "â€”"}</div>
        </div>
      `).join("") || `<div class="card"><div class="nick">Vazio</div><div class="meta">Nenhuma conta encontrada.</div></div>`;
      toast("ok","Ok","Lista carregada.");
    }catch(e){
      toast("err","Falha ao listar","Falta implementar /listusers no Comandos.py. " + e.message);
      box.innerHTML = `<div class="card"><div class="nick">âš ï¸ Backend faltando</div><div class="meta">Implemente /listusers no Comandos.py.</div></div>`;
    }
  };
}

/* ==========================
   PROFILE TAB (token visÃ­vel + copiar)
   ========================== */
async function renderProfile(){
  if(!mustBeLogged()) return;

  centerBody.innerHTML = `
    <div class="banner">
      <div style="font-size:18px">ğŸ›¡ï¸</div>
      <div>
        <div style="font-weight:900; letter-spacing:.06em">Perfil do Aventureiro</div>
        <div class="note">Seu token fica visÃ­vel (pra copiar) e vocÃª pode checar quem vocÃª Ã©.</div>
      </div>
    </div>

    <div class="sep"></div>

    <div class="card">
      <div class="nick">Token de SessÃ£o</div>
      <div class="meta">Use como <code>Authorization: Bearer &lt;token&gt;</code></div>
      <div class="sep"></div>
      <div class="tokenBox"><code id="tokenText"></code></div>
      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="copyToken">ğŸ“‹ Copiar token</button>
        <button class="btn" id="revealToken">ğŸ‘ï¸ Alternar mÃ¡scara</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="grid2">
      <div class="card">
        <div class="nick">Whoami</div>
        <div class="meta">Puxa os dados da sessÃ£o no server.</div>
        <div class="sep"></div>
        <button class="btn primary" id="doWhoami">ğŸ‘ï¸ Consultar</button>
        <div class="sep"></div>
        <pre id="whoamiOut" class="tokenBox" style="white-space:pre-wrap"></pre>
      </div>

      <div class="card">
        <div class="nick">Logout</div>
        <div class="meta">Invalida o token no banco (se /logout usar session).</div>
        <div class="sep"></div>
        <button class="btn danger" id="doLogout">ğŸšª Sair do reino</button>
        <div class="sep"></div>
        <div class="note">Obs: se vocÃª quiser logout â€œde verdadeâ€, seu backend precisa limpar o token na tabela <b>contas</b> (vocÃª jÃ¡ tem cmd_logout).</div>
      </div>
    </div>
  `;

  const tokenEl = $("#tokenText");
  let masked = true;

  function paintToken(){
    if(!sessionToken){ tokenEl.textContent = "â€”"; return; }
    if(!masked){ tokenEl.textContent = sessionToken; return; }
    tokenEl.textContent = sessionToken.slice(0,6) + "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" + sessionToken.slice(-6);
  }
  paintToken();

  $("#copyToken").onclick = async ()=>{
    try{ await navigator.clipboard.writeText(sessionToken); toast("ok","Copiado","Token copiado."); }
    catch{ toast("err","Erro","NÃ£o deu pra copiar (permissÃ£o do navegador)."); }
  };
  $("#revealToken").onclick = ()=>{ masked = !masked; paintToken(); };

  $("#doWhoami").onclick = async ()=>{
    try{
      const out = await cmd({ comando:"/whoami" });
      $("#whoamiOut").textContent = JSON.stringify(out, null, 2);
      // tenta atualizar chip
      if(out.session){ cachedConta = out.session; setChip(cachedConta); }
      toast("ok","Ok","Whoami carregado.");
    }catch(e){
      toast("err","Falhou", e.message);
    }
  };

  $("#doLogout").onclick = async ()=>{
    try{
      // seu cmd_logout exige payload.session (Server.py sÃ³ passa se PASS_SESSION_INFO_TO_COMMAND + token vÃ¡lido)
      const out = await cmd({ comando:"/logout" });
      sessionToken = "";
      cachedConta = null;
      localStorage.removeItem("obearco_token");
      setChip(null);
      toast("ok","Logout","VocÃª saiu.");
      setActiveTab("auth");
    }catch(e){
      toast("err","Falha no logout", e.message);
    }
  };
}

/* ==========================
   ACCOUNT TAB (update + delete com 5s)
   Requer backend: /updateaccount + /deleteaccount
   ========================== */
async function renderAccount(){
  if(!mustBeLogged()) return;

  centerBody.innerHTML = `
    <div class="banner">
      <div style="font-size:18px">âš™ï¸</div>
      <div>
        <div style="font-weight:900; letter-spacing:.06em">GestÃ£o da Conta</div>
        <div class="note">Editar username/email/senha e deletar com confirmaÃ§Ã£o + delay de 5 segundos.</div>
      </div>
    </div>

    <div class="sep"></div>

    <div class="grid2">
      <div class="card">
        <div class="nick">Atualizar Dados</div>
        <div class="meta">Requer comando <b>/updateaccount</b> no backend.</div>
        <div class="sep"></div>

        <div class="field">
          <label>Novo username (opcional)</label>
          <input id="up_user" placeholder="ex: NovoNome" />
        </div>

        <div class="field" style="margin-top:10px">
          <label>Novo email (opcional)</label>
          <input id="up_email" placeholder="ex: novo@email.com" />
        </div>

        <div class="sep"></div>

        <div class="field">
          <label>Senha atual (obrigatÃ³ria p/ trocar senha)</label>
          <input id="up_oldpass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
        <div class="field" style="margin-top:10px">
          <label>Nova senha (opcional)</label>
          <input id="up_newpass" type="password" placeholder="mÃ­nimo 6 chars" />
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="doUpdate">âœ¨ Salvar</button>
        </div>
      </div>

      <div class="card">
        <div class="nick">Deletar Conta</div>
        <div class="meta">Requer comando <b>/deleteaccount</b> no backend.</div>
        <div class="sep"></div>

        <div class="note">Ao confirmar, o botÃ£o fica bloqueado por <b>5 segundos</b> (pra evitar clique no susto).</div>

        <div class="sep"></div>
        <div class="field">
          <label>Digite: DELETAR</label>
          <input id="del_word" placeholder="DELETAR" />
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn danger" id="doDelete" disabled>ğŸ©¸ Confirmar DeleÃ§Ã£o (5s)</button>
          <button class="btn" id="armDelete">âš ï¸ Quero deletar</button>
        </div>
        <div class="sep"></div>
        <div class="note" id="delHint">Ainda nÃ£o armado.</div>
      </div>
    </div>
  `;

  $("#doUpdate").onclick = async ()=>{
    const username = $("#up_user").value.trim();
    const email = $("#up_email").value.trim();
    const old_password = $("#up_oldpass").value.trim();
    const new_password = $("#up_newpass").value.trim();

    if(!username && !email && !new_password){
      toast("err","Nada pra salvar","Preencha pelo menos 1 campo.");
      return;
    }
    try{
      const out = await cmd({ comando:"/updateaccount", username, email, old_password, new_password });
      toast("ok","Salvo","Conta atualizada.");
      if(out.conta){ cachedConta = out.conta; setChip(cachedConta); }
    }catch(e){
      toast("err","Falha ao salvar", e.message);
    }
  };

  let armed = false;
  let timer = null;
  $("#armDelete").onclick = ()=>{
    armed = true;
    $("#delHint").textContent = "Armado. Agora digite DELETAR e espere 5 segundos para o botÃ£o liberar.";
    $("#doDelete").textContent = "ğŸ©¸ Confirmar DeleÃ§Ã£o (5s)";
    $("#doDelete").disabled = true;
    let left = 5;
    if(timer) clearInterval(timer);
    timer = setInterval(()=>{
      left--;
      $("#doDelete").textContent = `ğŸ©¸ Confirmar DeleÃ§Ã£o (${left}s)`;
      if(left<=0){
        clearInterval(timer);
        $("#doDelete").textContent = "ğŸ©¸ Confirmar DeleÃ§Ã£o";
        // sÃ³ libera se palavra certa
        if($("#del_word").value.trim().toUpperCase()==="DELETAR"){
          $("#doDelete").disabled = false;
          $("#delHint").textContent = "Pronto. Clique para deletar (Ãºltima chance!).";
        }else{
          $("#delHint").textContent = "Tempo passou, mas a palavra nÃ£o estÃ¡ certa. Digite DELETAR.";
        }
      }
    }, 1000);
  };

  $("#del_word").addEventListener("input", ()=>{
    if(!armed) return;
    if($("#del_word").value.trim().toUpperCase()==="DELETAR" && $("#doDelete").textContent==="ğŸ©¸ Confirmar DeleÃ§Ã£o"){
      $("#doDelete").disabled = false;
    }else{
      $("#doDelete").disabled = true;
    }
  });

  $("#doDelete").onclick = async ()=>{
    if($("#del_word").value.trim().toUpperCase()!=="DELETAR"){
      toast("err","ConfirmaÃ§Ã£o","Digite DELETAR.");
      return;
    }
    try{
      await cmd({ comando:"/deleteaccount" });
      toast("ok","Deletado","Sua conta foi removida.");
      sessionToken = "";
      cachedConta = null;
      localStorage.removeItem("obearco_token");
      setChip(null);
      setActiveTab("auth");
    }catch(e){
      toast("err","Falha ao deletar", e.message);
    }
  };
}

/* ==========================
   Patch notes (front-end)
   ========================== */
function loadNotes(){
  const box = $("#notesBox");
  // VocÃª pode trocar isso por fetch de um .md depois.
  const now = new Date().toLocaleString("pt-BR");
  box.innerHTML = `
    <div class="card">
      <div class="nick">âœ¨ Atualizado em ${escapeHtml(now)}</div>
      <div class="meta">â€¢ Portal de contas (medieval/anime) <br>â€¢ Tabs + VFX <br>â€¢ Token visÃ­vel + copiar <br>â€¢ Delete com delay 5s</div>
    </div>
    <div class="card">
      <div class="nick">ğŸ§ª PrÃ³ximo</div>
      <div class="meta">â€¢ Personagens /createcharacter <br>â€¢ Feed com presenÃ§a online <br>â€¢ InventÃ¡rio / loja</div>
    </div>
  `;
}

/* ==========================
   Top buttons
   ========================== */
$("#btnReloadBase").onclick = syncFromStatusJson;

$("#btnPing").onclick = async ()=>{
  try{
    const out = await cmd({ comando:"/ping" });
    toast("ok","Pong", "ts=" + (out.ts || "â€”"));
  }catch(e){ toast("err","Ping falhou", e.message); }
};

$("#btnWhoami").onclick = ()=>{
  setActiveTab("profile");
  setTimeout(()=> $("#doWhoami")?.click(), 80);
};

$("#btnLogout").onclick = ()=>{
  setActiveTab("profile");
  setTimeout(()=> $("#doLogout")?.click(), 80);
};

$("#btnLoadNotes").onclick = loadNotes;

/* ==========================
   Init
   ========================== */
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

async function boot(){
  // background vfx start
  startVFX();

  await syncFromStatusJson();
  loadNotes();

  if(sessionToken){
    setSubtitle("SessÃ£o encontrada. Tentando validar...");
    try{
      const out = await cmd({ comando:"/whoami" });
      cachedConta = out.session || null;
      setChip(cachedConta);
      toast("ok","SessÃ£o ok","Token vÃ¡lido.");
      setActiveTab("profile");
    }catch(e){
      toast("err","SessÃ£o invÃ¡lida","FaÃ§a login novamente. " + e.message);
      sessionToken = "";
      localStorage.removeItem("obearco_token");
      setChip(null);
      setActiveTab("auth");
    }
  }else{
    setChip(null);
    setActiveTab("auth");
  }
}
boot();

/* ==========================
   VFX (canvas)
   ========================== */
function startVFX(){
  const c1 = document.getElementById("vfx");
  const c2 = document.getElementById("vfx2");
  const ctx1 = c1.getContext("2d");
  const ctx2 = c2.getContext("2d");
  let w=0,h=0, dpr=1;

  function resize(){
    dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    w = Math.floor(window.innerWidth);
    h = Math.floor(window.innerHeight);
    [c1,c2].forEach(c=>{
      c.width = Math.floor(w*dpr);
      c.height = Math.floor(h*dpr);
      c.style.width = w+"px";
      c.style.height = h+"px";
    });
    ctx1.setTransform(dpr,0,0,dpr,0,0);
    ctx2.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener("resize", resize);
  resize();

  // Particles (embers)
  const P = [];
  const N = 140;
  for(let i=0;i<N;i++){
    P.push({
      x: Math.random()*w,
      y: Math.random()*h,
      r: 0.8 + Math.random()*2.4,
      vx: -0.15 + Math.random()*0.3,
      vy: -0.35 + Math.random()*0.25,
      a: 0.12 + Math.random()*0.25,
      hue: Math.random()<0.55 ? "gold" : "aqua"
    });
  }

  // Runes (glow lines)
  const R = [];
  const RN = 26;
  for(let i=0;i<RN;i++){
    R.push({
      x: Math.random()*w,
      y: Math.random()*h,
      len: 60 + Math.random()*220,
      ang: Math.random()*Math.PI*2,
      sp: 0.002 + Math.random()*0.004,
      ph: Math.random()*10
    });
  }

  let t=0;
  function tick(){
    t += 0.016;
    ctx1.clearRect(0,0,w,h);
    ctx2.clearRect(0,0,w,h);

    // layer 1: embers
    for(const p of P){
      p.x += p.vx;
      p.y += p.vy;
      p.y += Math.sin(t*0.8 + p.x*0.01)*0.08;
      if(p.x< -20) p.x = w+20;
      if(p.x> w+20) p.x = -20;
      if(p.y< -40) p.y = h+40;

      const glow = p.hue==="gold" ? "rgba(255,223,140,"+p.a+")" : "rgba(98,240,255,"+p.a+")";
      ctx1.beginPath();
      ctx1.fillStyle = glow;
      ctx1.shadowBlur = 18;
      ctx1.shadowColor = glow;
      ctx1.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx1.fill();
    }
    ctx1.shadowBlur = 0;

    // layer 2: runes
    ctx2.globalCompositeOperation = "lighter";
    for(const r of R){
      r.ang += r.sp;
      const x2 = r.x + Math.cos(r.ang)*r.len;
      const y2 = r.y + Math.sin(r.ang)*r.len;

      const a = 0.06 + (Math.sin(t + r.ph)*0.04);
      ctx2.lineWidth = 1;
      ctx2.strokeStyle = "rgba(166,107,255,"+a+")";
      ctx2.shadowBlur = 22;
      ctx2.shadowColor = "rgba(166,107,255,"+(a+0.08)+")";

      ctx2.beginPath();
      ctx2.moveTo(r.x, r.y);
      ctx2.lineTo(x2, y2);
      ctx2.stroke();

      // small glyph
      ctx2.fillStyle = "rgba(255,223,140,"+(a*1.2)+")";
      ctx2.shadowColor = "rgba(255,223,140,"+(a+0.08)+")";
      ctx2.shadowBlur = 18;
      ctx2.beginPath();
      ctx2.arc(x2, y2, 1.3, 0, Math.PI*2);
      ctx2.fill();
    }
    ctx2.shadowBlur = 0;
    ctx2.globalCompositeOperation = "source-over";

    requestAnimationFrame(tick);
  }
  tick();
}
</script>
</body>
</html>
