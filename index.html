<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OBEARCO ‚Ä¢ Web</title>
  <meta name="color-scheme" content="dark light" />
  <meta name="description" content="Painel web p√∫blico do OBEARCO (login, conta, admin) consumindo a API via server_status.json no GitHub." />

  <style>
    :root{
      --bg:#0b0d10; --panel:#10141a; --panel2:#0f1318;
      --text:#e7eef7; --muted:#a6b2c2; --border:#1e2632;
      --accent:#5aa6ff; --accent2:#8b5cf6; --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b;
      --shadow: 0 10px 35px rgba(0,0,0,.35);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--sans);
      background:
        radial-gradient(1200px 700px at 10% -10%, rgba(90,166,255,.12), transparent 50%),
        radial-gradient(900px 600px at 90% 0%, rgba(139,92,246,.10), transparent 45%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    a{color:inherit; text-decoration:none}
    button,input,textarea,select{font-family:inherit}
    .app{min-height:100vh; display:flex; flex-direction:column}

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      background: rgba(11,13,16,.75);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .topbar-inner{
      max-width:1100px; margin:0 auto; padding:14px 16px;
      display:flex; align-items:center; gap:12px; justify-content:space-between;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.4px;}
    .brand .title{display:flex; gap:8px; align-items:baseline}
    .brand .title span{font-weight:800}
    .mini{font-size:12px}
    .muted{color:var(--muted)}

    /* Status dot animado */
    .dot{
      width:10px;height:10px;border-radius:999px;background:var(--warn);
      box-shadow:0 0 0 4px rgba(245,158,11,.12);
      position:relative;
    }
    .dot.pulse::after{
      content:"";
      position:absolute; inset:-10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.06);
      animation:pulse 1.8s ease-out infinite;
    }
    @keyframes pulse{
      0%{transform:scale(.45); opacity:.0}
      30%{opacity:.25}
      100%{transform:scale(1.1); opacity:0}
    }

    /* Nav */
    .nav{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .chip{
      border:1px solid var(--border); background:rgba(16,20,26,.6);
      padding:8px 10px; border-radius:999px; color:var(--muted);
      font-size:13px;
      display:inline-flex; gap:8px; align-items:center;
    }

    /* Bot√µes */
    .btn{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(16,20,26,.85), rgba(16,20,26,.55));
      color:var(--text);
      padding:9px 12px; border-radius:12px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px; font-weight:650;
      transition: transform .15s ease, filter .15s ease, border-color .15s ease, opacity .15s ease;
      will-change: transform;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.06); border-color:#2a3648}
    .btn:active{transform:translateY(0px) scale(.99)}
    .btn[disabled]{opacity:.55; cursor:not-allowed; transform:none}
    .btn.primary{
      border-color: rgba(90,166,255,.35);
      background: linear-gradient(180deg, rgba(90,166,255,.22), rgba(90,166,255,.10));
    }
    .btn.danger{
      border-color: rgba(239,68,68,.35);
      background: linear-gradient(180deg, rgba(239,68,68,.22), rgba(239,68,68,.10));
    }
    .btn.ghost{background:transparent}

    /* Layout */
    .container{
      max-width:1100px; width:100%;
      margin:0 auto; padding:18px 16px 34px;
      display:grid; gap:16px;
    }
    .grid{display:grid; gap:16px; grid-template-columns: 1.2fr .8fr;}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }

    /* Cards com anima√ß√£o de entrada */
    .card{
      background:linear-gradient(180deg, rgba(16,20,26,.95), rgba(16,20,26,.70));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      transform: translateY(6px);
      opacity:0;
      animation: cardIn .35s ease forwards;
    }
    @keyframes cardIn{to{transform:translateY(0); opacity:1}}

    .card h2{margin:0 0 8px; font-size:18px}
    .card h3{margin:0 0 8px; font-size:15px; color:var(--muted); font-weight:700}

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .col{display:flex; flex-direction:column; gap:10px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; font-size:12px;
      border:1px solid var(--border); background:rgba(15,19,24,.65);
      color:var(--muted);
    }
    .pill.ok{border-color: rgba(34,197,94,.35); color:#b7f7cb; background:rgba(34,197,94,.08)}
    .pill.bad{border-color: rgba(239,68,68,.35); color:#ffd0d0; background:rgba(239,68,68,.08)}
    .pill.warn{border-color: rgba(245,158,11,.35); color:#ffe2b3; background:rgba(245,158,11,.08)}

    .hr{height:1px; background:var(--border); margin:12px 0}

    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-size:12px; color:var(--muted)}
    input, textarea, select{
      width:100%;
      padding:10px 11px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(15,19,24,.85);
      color:var(--text);
      outline:none;
      transition:border-color .15s ease, filter .15s ease;
    }
    input:focus,textarea:focus,select:focus{border-color:rgba(90,166,255,.45); filter:brightness(1.02)}
    textarea{min-height:110px; resize:vertical; font-family:var(--mono); font-size:12.5px}

    .kpi{display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px;}
    @media (max-width: 600px){ .kpi{grid-template-columns:1fr} }
    .kpi .box{
      border:1px solid var(--border);
      background:rgba(15,19,24,.6);
      border-radius:14px;
      padding:10px;
      transition: transform .15s ease, border-color .15s ease;
    }
    .kpi .box:hover{transform:translateY(-1px); border-color:#2a3648}
    .kpi .n{font-weight:900; font-size:16px}
    .kpi .t{font-size:12px; color:var(--muted)}

    /* Toasts com anima√ß√£o */
    .toast-wrap{
      position:fixed; right:16px; bottom:16px; z-index:9999;
      display:flex; flex-direction:column; gap:10px;
      max-width:min(520px, calc(100vw - 32px));
    }
    .toast{
      border:1px solid var(--border);
      background:rgba(16,20,26,.92);
      border-radius:14px;
      padding:10px 12px;
      box-shadow:var(--shadow);
      display:flex; gap:10px; align-items:flex-start;
      transform: translateY(8px);
      opacity:0;
      animation: toastIn .22s ease forwards;
    }
    @keyframes toastIn{to{transform:translateY(0); opacity:1}}
    .toast.out{animation: toastOut .18s ease forwards}
    @keyframes toastOut{to{transform:translateY(6px); opacity:0}}

    .toast b{display:block; margin-bottom:2px}
    .tag{font-family:var(--mono); font-size:12px; opacity:.92}
    .list{display:flex; flex-direction:column; gap:10px}
    .item{
      border:1px solid var(--border);
      background:rgba(15,19,24,.6);
      border-radius:14px;
      padding:10px;
      transition: transform .15s ease, border-color .15s ease, filter .15s ease;
      cursor:pointer;
    }
    .item:hover{transform:translateY(-1px); border-color:#2a3648; filter:brightness(1.04)}
    .item .title{font-weight:800}
    .item .sub{color:var(--muted); font-size:12px}
    .split{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 700px){ .split{grid-template-columns:1fr} }
    .smallnote{font-size:12px; color:var(--muted); line-height:1.35}

    /* Barra de carregamento do topo */
    .loadingbar{
      position:absolute; left:0; right:0; bottom:-1px; height:2px;
      background:linear-gradient(90deg, rgba(90,166,255,.0), rgba(90,166,255,.9), rgba(139,92,246,.9), rgba(90,166,255,.0));
      background-size: 200% 100%;
      opacity:0;
      animation: loadmove 1.2s linear infinite;
      transform-origin:left;
    }
    .loadingbar.on{opacity:.9}
    @keyframes loadmove{0%{background-position:0% 0}100%{background-position:200% 0}}

    /* Acessibilidade */
    .sr-only{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden;
      clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }
  </style>
</head>

<body>
<div class="app">
  <header class="topbar">
    <div class="topbar-inner" style="position:relative">
      <div class="brand">
        <span class="dot pulse" id="srvDot" aria-hidden="true"></span>
        <div>
          <div class="title">
            <span>OBEARCO</span> <span class="muted">Web</span>
          </div>
          <div class="mini muted" id="srvLine">Carregando status‚Ä¶</div>
        </div>
      </div>

      <nav class="nav" id="nav" aria-label="Navega√ß√£o">
        <!-- preenchido via JS -->
      </nav>

      <div class="loadingbar" id="loadingBar" aria-hidden="true"></div>
    </div>
  </header>

  <main class="container" id="app" aria-live="polite"></main>
</div>

<div class="toast-wrap" id="toasts" aria-live="polite" aria-relevant="additions"></div>

<script>
/* ============================================================
   OBEARCO Web ‚Äî vers√£o p√∫blica (GitHub Pages)
   - Consome server_status.json via RAW do GitHub
   - Mant√©m suas fun√ß√µes (login/register/me/admin)
   - Adiciona anima√ß√µes e melhora robustez (retry, polling, cache-bust)
   ============================================================ */

/* =========================
   1) CONFIGURA√á√ÉO
   ========================= */

/** URL RAW do status.json (CORRETO para fetch). */
const STATUS_RAW_URL = "https://raw.githubusercontent.com/NoSense-Bot/Servidor/main/server_status.json";

/** Intervalos e timeouts */
const CFG = {
  STATUS_POLL_MS: 20_000,     // atualiza status a cada 20s
  FETCH_TIMEOUT_MS: 7_500,    // timeout do fetch
  RETRY_MAX: 2,               // tentativas extras (al√©m da 1¬™)
  RETRY_BACKOFF_MS: 600,      // backoff base
};

/** LocalStorage keys */
const LS = {
  token: "obearco_session_token",
  apiBase: "obearco_api_base",
  me: "obearco_me_cache",
};

/* =========================
   2) ESTADO GLOBAL
   ========================= */

const state = {
  booting: true,
  status: null,
  apiBase: localStorage.getItem(LS.apiBase) || "",
  token: localStorage.getItem(LS.token) || "",
  me: safeJson(localStorage.getItem(LS.me)) || null,
  isAdmin: false,
  route: location.hash || "#/login",
};

/* =========================
   3) UTILIT√ÅRIOS
   ========================= */

/** Faz parse JSON seguro. */
function safeJson(s){
  try{ return JSON.parse(s); }catch{ return null; }
}

/** Escape b√°sico para evitar inje√ß√£o de HTML via innerHTML. */
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/** Controla o ‚Äúloading bar‚Äù no topo. */
function setLoadingBar(on){
  const el = document.getElementById("loadingBar");
  el.classList.toggle("on", !!on);
}

/** Toast animado. */
function toast(title, msg, kind="info"){
  const wrap = document.getElementById("toasts");
  const t = document.createElement("div");
  t.className = "toast";
  const icon = kind==="ok" ? "‚úÖ" : kind==="bad" ? "‚ùå" : kind==="warn" ? "‚ö†Ô∏è" : "‚ÑπÔ∏è";
  t.innerHTML = `
    <div style="font-size:18px;line-height:1">${icon}</div>
    <div>
      <b>${escapeHtml(title)}</b>
      <div class="mini muted">${escapeHtml(msg)}</div>
    </div>
  `;
  wrap.appendChild(t);
  setTimeout(()=>{ t.classList.add("out"); }, 3200);
  setTimeout(()=>{ t.remove(); }, 3600);
}

/** Timeout wrapper para fetch. */
async function fetchWithTimeout(url, options={}, timeoutMs=CFG.FETCH_TIMEOUT_MS){
  const ctrl = new AbortController();
  const id = setTimeout(()=>ctrl.abort(), timeoutMs);
  try{
    return await fetch(url, { ...options, signal: ctrl.signal });
  }finally{
    clearTimeout(id);
  }
}

/** Retry simples com backoff. */
async function withRetry(fn, maxRetry=CFG.RETRY_MAX){
  let lastErr = null;
  for(let attempt=0; attempt<=maxRetry; attempt++){
    try{
      return await fn(attempt);
    }catch(err){
      lastErr = err;
      const wait = CFG.RETRY_BACKOFF_MS * (attempt+1);
      await new Promise(r=>setTimeout(r, wait));
    }
  }
  throw lastErr;
}

/** Remove barras no final do base URL. */
function normalizeBase(base){
  return String(base || "").trim().replace(/\/+$/,"");
}

/** Monta URL da API. */
function apiUrl(path){
  const base = normalizeBase(state.apiBase);
  return base + path;
}

/** Extrai um ID prov√°vel de um user. */
function pickId(user){
  return user?.id ?? user?.user_id ?? user?._id ?? user?.email ?? null;
}

/** Descobre se √© admin pelo payload do /me. */
function isAdminFromMe(me){
  return !!(me?.is_admin || me?.admin || me?.role === "admin" || me?.nivel === "admin");
}

/* =========================
   4) STATUS (GitHub -> API Base)
   ========================= */

/** Baixa o status.json (RAW) com cache-busting. */
async function fetchStatus(){
  const url = STATUS_RAW_URL + "?t=" + Date.now(); // evita cache no GitHub Pages/browser
  const res = await fetchWithTimeout(url, { cache:"no-store" });
  if(!res.ok) throw new Error("N√£o consegui baixar server_status.json");
  return await res.json();
}

/** Atualiza UI do badge (topo) */
function setServerBadge(online){
  const dot = document.getElementById("srvDot");
  const line = document.getElementById("srvLine");

  dot.classList.add("pulse");
  if(online){
    dot.style.background = "var(--ok)";
    dot.style.boxShadow = "0 0 0 4px rgba(34,197,94,.12)";
    line.textContent = "Servidor: Online ‚úÖ";
  }else{
    dot.style.background = "var(--bad)";
    dot.style.boxShadow = "0 0 0 4px rgba(239,68,68,.12)";
    line.textContent = "Servidor: Offline ‚ùå";
  }
}

/** Aplica status no state e salva apiBase */
function applyStatus(st){
  state.status = st || null;
  const base = normalizeBase(st?.url_api_base || "");
  if(base){
    state.apiBase = base;
    localStorage.setItem(LS.apiBase, base);
  }
  const online = String(st?.status_servidor || "").toLowerCase().includes("online");
  setServerBadge(online);
  renderNav();
}

/* =========================
   5) API (cmd + fallbacks legacy)
   ========================= */

/** Faz chamada /api/v1/cmd, com fallback para /login e /register legacy. */
async function apiCmd(payload){
  const url = apiUrl("/api/v1/cmd");
  const headers = { "Content-Type":"application/json" };
  if(state.token) headers["Authorization"] = "Bearer " + state.token;

  const doMain = async () => {
    const r = await fetchWithTimeout(url, {
      method:"POST",
      headers,
      body: JSON.stringify(payload),
    });
    const j = await r.json().catch(()=> ({}));
    if(!r.ok || j.ok === false) throw new Error(j.error || "Falha no cmd");
    return j;
  };

  try{
    return await doMain();
  }catch(err){
    // Fallback apenas para login/register
    if(payload?.comando === "/login" || payload?.comando === "/register"){
      const legacyPath = payload.comando === "/login" ? "/login" : "/register";
      const rr = await fetchWithTimeout(apiUrl(legacyPath), {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload),
      });
      const jj = await rr.json().catch(()=> ({}));
      if(!rr.ok || jj.ok === false) throw new Error(jj.error || "Falha no login/register");
      return jj;
    }
    throw err;
  }
}

/* =========================
   6) AUTH (Login/Register/Logout)
   ========================= */

/** Faz login e salva token. */
async function doLogin(email, senha){
  const out = await apiCmd({ comando:"/login", email, senha });

  // tenta encontrar token em formatos comuns
  const token =
    out.session_token || out.token ||
    out?.data?.session_token || out?.session?.token ||
    out?.data?.token;

  if(!token) throw new Error("Login OK mas n√£o veio session_token");
  state.token = token;
  localStorage.setItem(LS.token, token);

  toast("Login", "Sess√£o salva ‚úÖ", "ok");
  await loadMe();
  go("#/feed");
}

/** Cria conta (envia usuario conforme seu backend). */
async function doRegister(email, senha, extra={}){
  await apiCmd({ comando:"/register", email, senha, ...extra });
  toast("Conta criada", "Agora faz login üòâ", "ok");
  go("#/login");
}

/** Limpa sess√£o. */
function doLogout(){
  state.token = "";
  state.me = null;
  state.isAdmin = false;
  localStorage.removeItem(LS.token);
  localStorage.removeItem(LS.me);
  toast("Logout", "Sess√£o removida.", "ok");
  go("#/login");
}

/* =========================
   7) ME (CRUD)
   ========================= */

/** Carrega /me (tenta 2 comandos diferentes). */
async function loadMe(){
  if(!state.token) return null;

  const try1 = async () => {
    const out = await apiCmd({ comando:"/me/get" });
    return out.me || out.user || out.account || out.data || out;
  };
  const try2 = async () => {
    const out = await apiCmd({ comando:"/me" });
    return out.me || out.user || out.account || out.data || out;
  };

  const me = await try1().catch(()=> try2());
  state.me = me;
  state.isAdmin = isAdminFromMe(me);
  localStorage.setItem(LS.me, JSON.stringify(me));
  renderNav();
  return me;
}

async function updateMe(patch){
  await apiCmd({ comando:"/me/update", patch });
  toast("Conta", "Atualizada ‚úÖ", "ok");
  await loadMe();
}

async function deleteMe(){
  await apiCmd({ comando:"/me/delete" });
  toast("Conta", "Deletada üóëÔ∏è", "ok");
  doLogout();
}

async function addSkill(skill){
  await apiCmd({ comando:"/me/skills/add", skill });
  toast("Skills", "Adicionada ‚úÖ", "ok");
  await loadMe();
}

async function removeSkill(skill){
  await apiCmd({ comando:"/me/skills/remove", skill });
  toast("Skills", "Removida ‚úÖ", "ok");
  await loadMe();
}

/* =========================
   8) ADMIN (CRUD total)
   ========================= */

async function adminListUsers(){
  const out = await apiCmd({ comando:"/admin/users/list" });
  return out.users || out.list || out.data || [];
}
async function adminGetUser(id){
  const out = await apiCmd({ comando:"/admin/users/get", id });
  return out.user || out.data || out;
}
async function adminUpdateUser(id, patch){
  await apiCmd({ comando:"/admin/users/update", id, patch });
  toast("Admin", "Usu√°rio atualizado ‚úÖ", "ok");
}
async function adminDeleteUser(id){
  await apiCmd({ comando:"/admin/users/delete", id });
  toast("Admin", "Usu√°rio deletado üóëÔ∏è", "ok");
}
async function adminCreateUser(payload){
  await apiCmd({ comando:"/admin/users/create", ...payload });
  toast("Admin", "Usu√°rio criado ‚úÖ", "ok");
}

/* =========================
   9) ROUTER
   ========================= */

function go(hash){ location.hash = hash; }

window.addEventListener("hashchange", ()=>{
  state.route = location.hash || "#/login";
  render();
});

/* =========================
   10) NAV + UI HELPERS
   ========================= */

function btn(label, onClick, cls=""){
  const b = document.createElement("button");
  b.className = "btn " + cls;
  b.type = "button";
  b.textContent = label;
  b.onclick = onClick;
  return b;
}

function renderNav(){
  const nav = document.getElementById("nav");
  const authed = !!state.token;
  nav.innerHTML = "";

  // Chip com API base
  const chip = document.createElement("div");
  chip.className = "chip";
  chip.innerHTML = `
    <span class="tag">API</span>
    <span class="muted">${escapeHtml(state.apiBase || "‚Äî")}</span>
  `;
  nav.appendChild(chip);

  // Bot√£o de ‚Äúrecarregar status‚Äù
  nav.appendChild(btn("üîÑ Status", async ()=>{
    try{
      setLoadingBar(true);
      const st = await withRetry(()=>fetchStatus());
      applyStatus(st);
      toast("Status", "Atualizado ‚úÖ", "ok");
    }catch(e){
      toast("Status", e?.message || String(e), "bad");
    }finally{
      setLoadingBar(false);
    }
  }));

  if(!authed){
    nav.appendChild(btn("üîê Login", ()=>go("#/login"), "primary"));
    nav.appendChild(btn("üßæ Registrar", ()=>go("#/register")));
    return;
  }

  nav.appendChild(btn("üì∞ Feed", ()=>go("#/feed"), "primary"));
  nav.appendChild(btn("‚öôÔ∏è Config", ()=>go("#/config")));
  if(state.isAdmin) nav.appendChild(btn("üõ°Ô∏è Admin", ()=>go("#/admin")));
  nav.appendChild(btn("üö™ Sair", doLogout, "ghost"));
}

/* =========================
   11) RENDER PRINCIPAL
   ========================= */

function render(){
  const app = document.getElementById("app");
  const r = state.route;

  // Guardas
  if(!state.token && (r.startsWith("#/feed") || r.startsWith("#/config") || r.startsWith("#/admin"))){
    go("#/login");
    return;
  }
  if(state.token && r.startsWith("#/admin") && !state.isAdmin){
    toast("Sem permiss√£o", "Voc√™ n√£o √© admin üòÖ", "warn");
    go("#/feed");
    return;
  }

  if(r.startsWith("#/login")) return renderLogin(app);
  if(r.startsWith("#/register")) return renderRegister(app);
  if(r.startsWith("#/feed")) return renderFeed(app);
  if(r.startsWith("#/config")) return renderConfig(app);
  if(r.startsWith("#/admin")) return renderAdmin(app);

  go("#/login");
}

/* =========================
   12) TELAS
   ========================= */

function renderLogin(app){
  const st = state.status || {};

  app.innerHTML = `
    <div class="grid">
      <section class="card">
        <h2>üîê Login</h2>
        <div class="muted">Entre com sua conta (usu√°rio normal ou admin).</div>
        <div class="hr"></div>

        <div class="field">
          <label>Email</label>
          <input id="email" placeholder="email@exemplo.com" autocomplete="email" />
        </div>
        <div class="field">
          <label>Senha</label>
          <input id="senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnLogin" type="button">Entrar</button>
          <button class="btn" type="button" id="toRegister">Criar conta</button>
        </div>

        <div class="hr"></div>
        <div class="smallnote">
          üí° A base da API vem do <span class="tag">server_status.json</span> (GitHub RAW).<br/>
          Se CORS travar, confirme se o servidor permite <span class="tag">https://nosense-bot.github.io</span>.
        </div>
      </section>

      <aside class="card">
        <h2>üì° Conex√£o</h2>
        <div class="kpi">
          <div class="box">
            <div class="n" id="kpiStatus">${escapeHtml(st.status_servidor ?? "‚Äî")}</div>
            <div class="t">status_servidor</div>
          </div>
          <div class="box">
            <div class="n" id="kpiApi">${escapeHtml(st.version_api ?? "‚Äî")}</div>
            <div class="t">version_api</div>
          </div>
          <div class="box">
            <div class="n" id="kpiPort">${escapeHtml(st.porta ?? "‚Äî")}</div>
            <div class="t">porta</div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="muted mini"><span class="tag">url_api_base</span></div>
        <div class="tag" id="kpiBase">${escapeHtml(st.url_api_base ?? "‚Äî")}</div>
      </aside>
    </div>
  `;

  const email = app.querySelector("#email");
  const senha = app.querySelector("#senha");
  const btnLogin = app.querySelector("#btnLogin");

  app.querySelector("#toRegister").onclick = ()=>go("#/register");

  btnLogin.onclick = async ()=>{
    const e = (email.value || "").trim();
    const s = (senha.value || "");
    if(!e || !s){ toast("Ops", "Preenche email e senha üòÖ", "warn"); return; }

    btnLogin.disabled = true;
    btnLogin.textContent = "Entrando‚Ä¶";
    setLoadingBar(true);
    try{
      await doLogin(e, s);
    }catch(err){
      toast("Login falhou", err?.message || String(err), "bad");
    }finally{
      setLoadingBar(false);
      btnLogin.disabled = false;
      btnLogin.textContent = "Entrar";
    }
  };

  // Enter para logar
  senha.addEventListener("keydown", (ev)=>{ if(ev.key==="Enter") btnLogin.click(); });
}

function renderRegister(app){
  app.innerHTML = `
    <div class="grid">
      <section class="card">
        <h2>üßæ Registrar</h2>
        <div class="muted">Cria conta de usu√°rio normal (admin voc√™ define no servidor/banco).</div>
        <div class="hr"></div>

        <div class="field">
          <label>Usu√°rio</label>
          <input id="usuario" placeholder="seu nick" autocomplete="username" />
        </div>
        <div class="field">
          <label>Email</label>
          <input id="email" placeholder="email@exemplo.com" autocomplete="email" />
        </div>
        <div class="field">
          <label>Senha</label>
          <input id="senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password" />
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnReg" type="button">Criar</button>
          <button class="btn" type="button" id="toLogin">Voltar</button>
        </div>

        <div class="hr"></div>
        <div class="smallnote">
          üîß Backend esperado: comando <span class="tag">/register</span> requer <span class="tag">email</span>, <span class="tag">senha</span>, <span class="tag">usuario</span>.
        </div>
      </section>

      <aside class="card">
        <h2>üß† Seguran√ßa</h2>
        <div class="muted">
          Este site salva token no <span class="tag">localStorage</span> (pr√°tico pra dev).<br/>
          Em produ√ß√£o ‚Äúforte‚Äù, prefira cookie HttpOnly (no backend).
        </div>
      </aside>
    </div>
  `;

  const usuario = app.querySelector("#usuario");
  const email = app.querySelector("#email");
  const senha = app.querySelector("#senha");
  const btnReg = app.querySelector("#btnReg");

  app.querySelector("#toLogin").onclick = ()=>go("#/login");

  btnReg.onclick = async ()=>{
    const u = (usuario.value || "").trim();
    const e = (email.value || "").trim();
    const s = (senha.value || "");
    if(!u || !e || !s){
      toast("Ops", "Preenche usu√°rio, email e senha üòÖ", "warn");
      return;
    }

    btnReg.disabled = true;
    btnReg.textContent = "Criando‚Ä¶";
    setLoadingBar(true);
    try{
      await doRegister(e, s, { usuario: u });
    }catch(err){
      toast("Registro falhou", err?.message || String(err), "bad");
    }finally{
      setLoadingBar(false);
      btnReg.disabled = false;
      btnReg.textContent = "Criar";
    }
  };

  // Enter para criar
  senha.addEventListener("keydown", (ev)=>{ if(ev.key==="Enter") btnReg.click(); });
}

function renderFeed(app){
  const me = state.me || {};
  const skills = me.skills ?? me.Skills ?? me.habilidades ?? null;

  app.innerHTML = `
    <div class="grid">
      <section class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <h2>üì∞ Feed</h2>
            <div class="muted">Seu perfil aparece no topo (skills etc.).</div>
          </div>
          <div class="row">
            ${state.isAdmin ? `<span class="pill ok">üõ°Ô∏è Admin</span>` : `<span class="pill warn">üë§ User</span>`}
          </div>
        </div>

        <div class="hr"></div>

        <div class="item" style="cursor:default">
          <div class="title">${escapeHtml(me.usuario || me.nome || me.name || me.username || me.email || "‚Äî")}</div>
          <div class="sub">${escapeHtml(me.email || "‚Äî")}</div>

          <div class="hr"></div>

          <div class="split">
            <div>
              <div class="muted mini">Token</div>
              <div class="tag">${escapeHtml(state.token ? state.token.slice(0,24)+"‚Ä¶" : "‚Äî")}</div>
            </div>
            <div>
              <div class="muted mini">ID</div>
              <div class="tag">${escapeHtml(pickId(me) || "‚Äî")}</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="muted mini">Skills</div>
          <div class="tag">${escapeHtml(skills === null ? "null" : JSON.stringify(skills))}</div>
        </div>

        <div class="hr"></div>

        <h3>üìå Seu feed (placeholder)</h3>
        <div class="muted mini">
          Aqui voc√™ pode listar posts, atividades, quests, etc.<br/>
          Quando criar comandos tipo <span class="tag">/feed/list</span>, √© s√≥ plugar.
        </div>
      </section>

      <aside class="card">
        <h2>‚ö° A√ß√µes r√°pidas</h2>
        <div class="row">
          <button class="btn primary" type="button" onclick="location.hash='#/config'">‚öôÔ∏è Abrir Config</button>
          ${state.isAdmin ? `<button class="btn" type="button" onclick="location.hash='#/admin'">üõ°Ô∏è Abrir Admin</button>` : ``}
        </div>
        <div class="hr"></div>
        <div class="smallnote">
          ‚úÖ Conectado como: <span class="tag">${escapeHtml(me.email || "‚Äî")}</span><br/>
          üåê API: <span class="tag">${escapeHtml(state.apiBase || "‚Äî")}</span>
        </div>
      </aside>
    </div>
  `;
}

function renderConfig(app){
  const me = state.me || {};
  const skills = Array.isArray(me.skills) ? me.skills : (Array.isArray(me.Skills) ? me.Skills : []);
  const skillsJson = JSON.stringify(skills ?? null, null, 2);

  app.innerHTML = `
    <div class="grid">
      <section class="card">
        <h2>‚öôÔ∏è Config (usu√°rio)</h2>
        <div class="muted">Seu token + dados da conta com CRUD.</div>

        <div class="hr"></div>

        <div class="field">
          <label>Session token</label>
          <input value="${escapeHtml(state.token || "")}" readonly />
        </div>

        <div class="split">
          <div class="field">
            <label>Usu√°rio</label>
            <input id="fUsuario" value="${escapeHtml(me.usuario || "")}" placeholder="seu nick" />
          </div>
          <div class="field">
            <label>Email</label>
            <input id="fEmail" value="${escapeHtml(me.email || "")}" placeholder="email@exemplo.com" />
          </div>
        </div>

        <div class="field">
          <label>Nome (opcional)</label>
          <input id="fName" value="${escapeHtml(me.nome || me.name || "")}" placeholder="Seu nome" />
        </div>

        <div class="field">
          <label>Bio (opcional)</label>
          <input id="fBio" value="${escapeHtml(me.bio || me.about || "")}" placeholder="Uma descri√ß√£o‚Ä¶" />
        </div>

        <div class="field">
          <label>Skills (JSON)</label>
          <textarea id="fSkills">${escapeHtml(skillsJson === "null" ? "null" : skillsJson)}</textarea>
          <div class="smallnote">üí° Se n√£o tiver skills ainda, deixa <span class="tag">null</span> ou <span class="tag">[]</span>.</div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnSave" type="button">üíæ Salvar</button>
          <button class="btn" id="btnReload" type="button">üîÑ Recarregar</button>
          <button class="btn danger" id="btnDelete" type="button">üóëÔ∏è Deletar conta</button>
        </div>
      </section>

      <aside class="card">
        <h2>üß© Skills r√°pidas</h2>
        <div class="muted">Adicionar/remover skill (via comandos dedicados).</div>

        <div class="hr"></div>

        <div class="field">
          <label>Skill</label>
          <input id="skillName" placeholder="ex: espada, alquimia‚Ä¶" />
        </div>
        <div class="row">
          <button class="btn primary" id="btnAddSkill" type="button">‚ûï Add</button>
          <button class="btn" id="btnRemSkill" type="button">‚ûñ Remover</button>
        </div>

        <div class="hr"></div>

        <div class="smallnote">
          Backend esperado:<br/>
          <span class="tag">/me/update</span>, <span class="tag">/me/delete</span>, <span class="tag">/me/skills/add</span>, <span class="tag">/me/skills/remove</span>
        </div>
      </aside>
    </div>
  `;

  const fUsuario = app.querySelector("#fUsuario");
  const fName = app.querySelector("#fName");
  const fEmail = app.querySelector("#fEmail");
  const fBio = app.querySelector("#fBio");
  const fSkills = app.querySelector("#fSkills");

  const btnSave = app.querySelector("#btnSave");
  const btnReload = app.querySelector("#btnReload");
  const btnDelete = app.querySelector("#btnDelete");

  const skillName = app.querySelector("#skillName");
  const btnAddSkill = app.querySelector("#btnAddSkill");
  const btnRemSkill = app.querySelector("#btnRemSkill");

  btnReload.onclick = async ()=>{
    try{
      setLoadingBar(true);
      await loadMe();
      render();
      toast("OK", "Recarregado ‚úÖ", "ok");
    }catch(err){
      toast("Falhou", err?.message || String(err), "bad");
    }finally{
      setLoadingBar(false);
    }
  };

  btnSave.onclick = async ()=>{
    btnSave.disabled = true;
    btnSave.textContent = "Salvando‚Ä¶";
    setLoadingBar(true);
    try{
      let skillsVal = null;
      const raw = (fSkills.value || "").trim();
      if(raw !== "") skillsVal = JSON.parse(raw);

      const patch = {
        usuario: (fUsuario.value || "").trim(),
        name: (fName.value || "").trim(),
        email: (fEmail.value || "").trim(),
        bio: (fBio.value || "").trim(),
        skills: skillsVal,
      };

      await updateMe(patch);
      render();
    }catch(err){
      toast("Salvar falhou", err?.message || String(err), "bad");
    }finally{
      setLoadingBar(false);
      btnSave.disabled = false;
      btnSave.textContent = "üíæ Salvar";
    }
  };

  btnDelete.onclick = async ()=>{
    if(!confirm("Tem certeza que quer deletar sua conta?")) return;
    btnDelete.disabled = true;
    setLoadingBar(true);
    try{
      await deleteMe();
    }catch(err){
      toast("Delete falhou", err?.message || String(err), "bad");
      btnDelete.disabled = false;
    }finally{
      setLoadingBar(false);
    }
  };

  btnAddSkill.onclick = async ()=>{
    const sk = (skillName.value||"").trim();
    if(!sk){ toast("Ops", "Digita uma skill üòÖ", "warn"); return; }
    setLoadingBar(true);
    try{ await addSkill(sk); render(); }
    catch(err){ toast("Falhou", err?.message || String(err), "bad"); }
    finally{ setLoadingBar(false); }
  };

  btnRemSkill.onclick = async ()=>{
    const sk = (skillName.value||"").trim();
    if(!sk){ toast("Ops", "Digita uma skill üòÖ", "warn"); return; }
    setLoadingBar(true);
    try{ await removeSkill(sk); render(); }
    catch(err){ toast("Falhou", err?.message || String(err), "bad"); }
    finally{ setLoadingBar(false); }
  };
}

function renderAdmin(app){
  app.innerHTML = `
    <div class="grid">
      <section class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <h2>üõ°Ô∏è Admin</h2>
            <div class="muted">Ver todas as contas + CRUD total.</div>
          </div>
          <span class="pill ok">Admin mode</span>
        </div>

        <div class="hr"></div>

        <div class="split">
          <div class="field">
            <label>Buscar (email/id)</label>
            <input id="q" placeholder="ex: user@gmail.com" />
          </div>
          <div class="row" style="align-items:flex-end; justify-content:flex-end">
            <button class="btn primary" id="btnLoad" type="button">üì• Carregar lista</button>
            <button class="btn" id="btnNew" type="button">‚ûï Novo usu√°rio</button>
          </div>
        </div>

        <div class="hr"></div>
        <div class="list" id="usersList"></div>
      </section>

      <aside class="card">
        <h2>‚úçÔ∏è Editor</h2>
        <div class="muted">Selecione um usu√°rio na lista pra editar.</div>

        <div class="hr"></div>

        <div class="field">
          <label>ID selecionado</label>
          <input id="selId" readonly />
        </div>

        <div class="field">
          <label>JSON (patch)</label>
          <textarea id="patch" placeholder='{"bio":"novo","skills":["a","b"],"is_admin":false}'></textarea>
          <div class="smallnote">Envia <span class="tag">patch</span> para <span class="tag">/admin/users/update</span></div>
        </div>

        <div class="row">
          <button class="btn primary" id="btnSaveUser" type="button">üíæ Atualizar</button>
          <button class="btn danger" id="btnDelUser" type="button">üóëÔ∏è Deletar</button>
          <button class="btn" id="btnGetUser" type="button">üîé Ver detalhes</button>
        </div>

        <div class="hr"></div>
        <div class="field">
          <label>Detalhes (read-only)</label>
          <textarea id="details" readonly></textarea>
        </div>
      </aside>
    </div>
  `;

  const q = app.querySelector("#q");
  const btnLoad = app.querySelector("#btnLoad");
  const btnNew = app.querySelector("#btnNew");
  const usersList = app.querySelector("#usersList");
  const selId = app.querySelector("#selId");
  const patch = app.querySelector("#patch");
  const details = app.querySelector("#details");
  const btnSaveUser = app.querySelector("#btnSaveUser");
  const btnDelUser = app.querySelector("#btnDelUser");
  const btnGetUser = app.querySelector("#btnGetUser");

  let usersCache = [];

  function renderUsers(list){
    usersList.innerHTML = "";
    if(!list.length){
      usersList.innerHTML = `<div class="muted">Nenhuma conta encontrada.</div>`;
      return;
    }
    list.forEach(u=>{
      const id = pickId(u);
      const name = u.usuario || u.nome || u.name || u.username || u.email || "‚Äî";
      const role = (u.is_admin || u.admin || u.role==="admin") ? "admin" : "user";

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="title">${escapeHtml(name)}</div>
            <div class="sub">${escapeHtml(u.email || "")}</div>
          </div>
          <span class="pill ${role==="admin" ? "ok":"warn"}">${role==="admin" ? "üõ°Ô∏è admin":"üë§ user"}</span>
        </div>
        <div class="hr"></div>
        <div class="tag">${escapeHtml(id || "‚Äî")}</div>
      `;
      el.onclick = ()=>{
        selId.value = id || "";
        details.value = JSON.stringify(u, null, 2);
        patch.value = "{}";
      };
      usersList.appendChild(el);
    });
  }

  btnLoad.onclick = async ()=>{
    btnLoad.disabled = true;
    btnLoad.textContent = "Carregando‚Ä¶";
    setLoadingBar(true);
    try{
      const list = await adminListUsers();
      usersCache = Array.isArray(list) ? list : [];

      const term = (q.value||"").trim().toLowerCase();
      const filtered = term
        ? usersCache.filter(u => JSON.stringify(u).toLowerCase().includes(term))
        : usersCache;

      renderUsers(filtered);
      toast("Admin", "Lista carregada ‚úÖ", "ok");
    }catch(err){
      toast("Admin falhou", err?.message || String(err), "bad");
    }finally{
      setLoadingBar(false);
      btnLoad.disabled = false;
      btnLoad.textContent = "üì• Carregar lista";
    }
  };

  btnNew.onclick = async ()=>{
    const usuario = prompt("Usu√°rio (nick):");
    if(!usuario) return;
    const email = prompt("Email do novo usu√°rio:");
    if(!email) return;
    const senha = prompt("Senha:");
    if(!senha) return;
    const isAdmin = confirm("Esse usu√°rio √© ADMIN?");
    setLoadingBar(true);
    try{
      await adminCreateUser({ usuario, email, senha, is_admin: isAdmin });
      await btnLoad.onclick();
    }catch(err){
      toast("Criar falhou", err?.message || String(err), "bad");
    }finally{
      setLoadingBar(false);
    }
  };

  btnGetUser.onclick = async ()=>{
    const id = (selId.value||"").trim();
    if(!id){ toast("Ops", "Seleciona um usu√°rio üòÖ", "warn"); return; }
    setLoadingBar(true);
    try{
      const u = await adminGetUser(id);
      details.value = JSON.stringify(u, null, 2);
      toast("OK", "Detalhes carregados ‚úÖ", "ok");
    }catch(err){
      toast("Falhou", err?.message || String(err), "bad");
    }finally{
      setLoadingBar(false);
    }
  };

  btnSaveUser.onclick = async ()=>{
    const id = (selId.value||"").trim();
    if(!id){ toast("Ops", "Seleciona um usu√°rio üòÖ", "warn"); return; }

    let p = {};
    try{ p = JSON.parse((patch.value||"{}") || "{}"); }
    catch{ toast("JSON inv√°lido", "Corrige o patch üòÖ", "warn"); return; }

    btnSaveUser.disabled = true;
    setLoadingBar(true);
    try{
      await adminUpdateUser(id, p);
      await btnLoad.onclick();
    }catch(err){
      toast("Update falhou", err?.message || String(err), "bad");
    }finally{
      setLoadingBar(false);
      btnSaveUser.disabled = false;
    }
  };

  btnDelUser.onclick = async ()=>{
    const id = (selId.value||"").trim();
    if(!id){ toast("Ops", "Seleciona um usu√°rio üòÖ", "warn"); return; }
    if(!confirm("Deletar esse usu√°rio?")) return;

    btnDelUser.disabled = true;
    setLoadingBar(true);
    try{
      await adminDeleteUser(id);
      selId.value = "";
      details.value = "";
      patch.value = "{}";
      await btnLoad.onclick();
    }catch(err){
      toast("Delete falhou", err?.message || String(err), "bad");
    }finally{
      setLoadingBar(false);
      btnDelUser.disabled = false;
    }
  };
}

/* =========================
   13) BOOT + POLLING
   ========================= */

/** Faz boot: baixa status, ajusta apiBase, valida token/me e renderiza. */
async function boot(){
  try{
    state.booting = true;
    setLoadingBar(true);
    renderNav();

    const st = await withRetry(()=>fetchStatus());
    applyStatus(st);

    // Se j√° tem token, tenta carregar /me
    if(state.token){
      try{
        await loadMe();
      }catch(e){
        toast("Sess√£o", "Token inv√°lido/expirado. Faz login de novo üòâ", "warn");
        doLogout();
      }
    }

    renderNav();
    render();
  }catch(err){
    setServerBadge(false);
    toast("Boot falhou", err?.message || String(err), "bad");
    renderNav();
    render();
  }finally{
    setLoadingBar(false);
    state.booting = false;
  }
}

/** Poll do status (n√£o interrompe usu√°rio). */
function startStatusPolling(){
  setInterval(async ()=>{
    try{
      const st = await fetchStatus();
      // s√≥ reaplica se mudou base ou status (evita ‚Äúpiscar‚Äù)
      const old = state.status || {};
      const changed =
        normalizeBase(old.url_api_base) !== normalizeBase(st.url_api_base) ||
        String(old.status_servidor||"") !== String(st.status_servidor||"");
      if(changed) applyStatus(st);
    }catch{
      // Silencioso no polling (sem spam de toast)
    }
  }, CFG.STATUS_POLL_MS);
}

// Start
boot();
startStatusPolling();
</script>
</body>
</html>
