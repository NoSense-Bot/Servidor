<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>NoSense ‚Ä¢ Social</title>
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0b0e14" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%23111827'/%3E%3Cpath d='M18 38c6 10 22 10 28 0' fill='none' stroke='%237c3aed' stroke-width='6' stroke-linecap='round'/%3E%3Ccircle cx='24' cy='26' r='4' fill='%23e5e7eb'/%3E%3Ccircle cx='40' cy='26' r='4' fill='%23e5e7eb'/%3E%3C/svg%3E" />

  <style>
    :root{
      --bg:#0b0e14; --bg2:#070a10;
      --panel: rgba(17,24,39,.86);
      --panel2: rgba(15,23,42,.70);
      --stroke: rgba(148,163,184,.14);
      --text:#e5e7eb; --muted:#94a3b8;
      --brand:#7c3aed; --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b;
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --r:18px; --r2:26px; --pad:14px; --gap:14px; --max:1180px; --blur:14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1000px 700px at 10% 0%, rgba(124,58,237,.30) 0%, rgba(124,58,237,0) 55%),
        radial-gradient(900px 700px at 100% 20%, rgba(34,197,94,.12) 0%, rgba(34,197,94,0) 60%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      overflow-x:hidden;
    }
    button,input{ font:inherit; }
    a{ color:inherit; text-decoration:none; }
    ::selection{ background: rgba(124,58,237,.28); }
    @media (prefers-reduced-motion: reduce){ *{ animation:none !important; transition:none !important; } }

    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(var(--blur));
      background: rgba(11,14,20,.62);
      border-bottom: 1px solid var(--stroke);
    }
    .topbarInner{
      max-width:var(--max); margin:0 auto; padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:900; min-width:0; }
    .dot{ width:10px; height:10px; border-radius:999px; background: var(--warn);
      box-shadow: 0 0 0 4px rgba(245,158,11,.16); flex:0 0 auto; }
    .dot.ok{ background:var(--ok); box-shadow: 0 0 0 4px rgba(34,197,94,.16); }
    .dot.bad{ background:var(--bad); box-shadow: 0 0 0 4px rgba(239,68,68,.16); }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border:1px solid var(--stroke);
      background: rgba(17,24,39,.52);
      border-radius:999px; color:var(--muted); font-size:12.5px;
      max-width: 62ch; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }

    .btn{
      border:1px solid var(--stroke);
      background: rgba(17,24,39,.80);
      color: var(--text);
      padding:10px 12px;
      border-radius:12px; cursor:pointer; user-select:none;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
      display:inline-flex; align-items:center; gap:8px; white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(124,58,237,.42); }
    .btn:active{ transform: translateY(0px) scale(.99); }
    .btn.primary{ border-color: rgba(124,58,237,.58); background: rgba(124,58,237,.18); }
    .btn.ghost{ background: rgba(17,24,39,.35); }
    .btn.danger{ border-color: rgba(239,68,68,.55); background: rgba(239,68,68,.12); }

    .wrap{ max-width: var(--max); margin:0 auto; padding:14px; }
    .shell{ display:grid; grid-template-columns: 280px 1fr; gap: var(--gap); align-items:start; padding-top:6px; }
    @media (max-width: 980px){ .shell{ grid-template-columns: 1fr; } }

    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{ display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: var(--pad); border-bottom:1px solid var(--stroke); }
    .bd{ padding: var(--pad); }
    .title{ font-weight:900; }
    .muted{ color:var(--muted); font-size:13px; }
    .sep{ height:1px; background: var(--stroke); margin: 12px 0; }

    .field{ display:grid; gap:6px; margin: 10px 0; }
    input{
      width:100%; padding: 12px 12px; border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(2,6,23,.35);
      color: var(--text); outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus{ border-color: rgba(124,58,237,.60); box-shadow: 0 0 0 4px rgba(124,58,237,.16); }

    .side{ position: sticky; top: 68px; }
    @media (max-width:980px){ .side{ position: static; } }

    .nav{ display:grid; gap:10px; }
    .navItem{
      padding: 12px 12px; border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(2,6,23,.25);
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .navItem:hover{ transform: translateY(-2px); border-color: rgba(124,58,237,.42); }
    .navItem.active{ border-color: rgba(124,58,237,.60); background: rgba(124,58,237,.14); }
    .kbd{
      font-size:12px; padding: 4px 8px; border-radius:999px;
      border:1px solid var(--stroke); color:var(--muted);
      background: rgba(17,24,39,.5);
    }

    .view{ display:none; }
    .view.active{ display:block; }

    .authWrap{ max-width: 480px; margin: 40px auto; padding: 0 14px; }
    .authWrap .card{ border-radius: var(--r2); }
    .hint{ white-space: pre-wrap; font-size: 13px; color: var(--muted); margin-top: 10px; }

    .feedTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .search{ flex:1; min-width: 200px; }
    .grid{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 12px; }
    @media (max-width:980px){ .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width:560px){ .grid{ grid-template-columns: 1fr; } }

    .userCard{
      border: 1px solid var(--stroke);
      background: rgba(2,6,23,.28);
      border-radius: 16px;
      padding: 12px;
      transition: transform .15s ease, border-color .15s ease;
      will-change: transform;
    }
    .userCard:hover{ transform: translateY(-3px); border-color: rgba(124,58,237,.55); }
    .userTop{ display:flex; align-items:center; gap:10px; min-width:0; }
    .avatar{
      width: 44px; height: 44px; border-radius: 16px;
      display:grid; place-items:center;
      background: rgba(124,58,237,.16);
      border: 1px solid rgba(124,58,237,.35);
      font-weight: 900; flex:0 0 auto;
    }
    .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:10px; }
    .chip{
      font-size: 12px; color: var(--muted);
      border: 1px solid var(--stroke);
      background: rgba(17,24,39,.55);
      padding: 6px 8px; border-radius: 999px;
      max-width: 100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }

    .skeleton{
      position: relative; overflow:hidden;
      border-radius: 16px; border:1px solid var(--stroke);
      background: rgba(2,6,23,.26); height: 118px;
    }
    .skeleton::after{
      content:""; position:absolute; inset:-40%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent);
      transform: translateX(-40%); animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer{ to{ transform: translateX(40%); } }
    @media (prefers-reduced-motion: reduce){ .skeleton::after{ animation:none; } }

    .bottomNav{
      position: fixed; left: 14px; right: 14px; bottom: 14px;
      border: 1px solid var(--stroke);
      background: rgba(17,24,39,.72);
      backdrop-filter: blur(var(--blur));
      border-radius: 18px;
      padding: 8px;
      display:none;
      z-index: 60;
      box-shadow: var(--shadow);
    }
    .bottomNavInner{ display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; }
    .bItem{
      padding: 10px 10px; border-radius: 14px;
      border: 1px solid transparent;
      background: rgba(2,6,23,.20);
      cursor:pointer; text-align:center;
      color: var(--muted); font-weight: 800;
      transition: transform .15s ease, background .15s ease, color .15s ease, border-color .15s ease;
    }
    .bItem.active{
      color: var(--text);
      border-color: rgba(124,58,237,.55);
      background: rgba(124,58,237,.14);
    }
    .bItem:hover{ transform: translateY(-1px); }
    @media (max-width:980px){ .bottomNav{ display:block; } .wrap{ padding-bottom: 92px; } }

    .toasts{ position: fixed; inset: auto 14px 14px auto; display:grid; gap:10px; z-index:100; }
    .toast{
      width: min(420px, calc(100vw - 28px));
      border: 1px solid var(--stroke);
      background: rgba(17,24,39,.92);
      backdrop-filter: blur(var(--blur));
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 12px;
      transform-origin: 100% 100%;
    }
    .toast b{ display:block; margin-bottom:2px; }
    .toast .small{ color: var(--muted); font-size: 12.5px; white-space: pre-wrap; }

    .netBanner{
      position: fixed; inset: 0;
      display:flex; align-items:center; justify-content:center;
      padding: 16px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      z-index: 9999;
    }
    .netBanner.hidden{ display:none; }
    .netBox{
      width: min(680px, 100%);
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(17,24,39,.92);
      border-radius: 18px;
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .netTitle{ font-weight: 1000; font-size: 16px; margin-bottom: 6px; }
    .netText{ color: #e5e7eb; font-size: 13.5px; white-space: pre-wrap; }
    .netSmall{ margin-top: 10px; color:#94a3b8; font-size: 12.5px; white-space: pre-wrap; }
    .netActions{ display:flex; gap:10px; margin-top: 12px; flex-wrap:wrap; }
    .netBtn{
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.35);
      color: #e5e7eb;
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
    }
    .netBtn.primary{
      border-color: rgba(124,58,237,.58);
      background: rgba(124,58,237,.18);
    }

    ::view-transition-old(root), ::view-transition-new(root){ animation-duration: 260ms; }
  </style>
</head>

<body>
  <div id="netBanner" class="netBanner hidden">
    <div class="netBox">
      <div class="netTitle">‚ö†Ô∏è Aviso de Conex√£o</div>
      <div class="netText" id="netText"></div>
      <div class="netActions">
        <button class="netBtn" id="btnHideNet">Entendi</button>
        <button class="netBtn primary" id="btnCopyApi">Copiar API</button>
      </div>
      <div class="netSmall" id="netSmall"></div>
    </div>
  </div>

  <header class="topbar">
    <div class="topbarInner">
      <div class="brand" style="min-width:0;">
        <div id="dot" class="dot"></div>
        <div>NoSense ‚Ä¢ Social</div>
        <div id="apiPill" class="pill" title="API Base">API: carregando‚Ä¶</div>
      </div>

      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn ghost" id="btnRefresh">Recarregar</button>
        <button class="btn" id="btnOpenSettings">Config</button>
        <button class="btn danger" id="btnLogout" style="display:none;">Sair</button>
      </div>
    </div>
  </header>

  <section id="auth" class="authWrap">
    <div class="card">
      <div class="hd">
        <div>
          <div class="title" id="authTitle">Entrar</div>
          <div class="muted" id="authSub">Login/Registro + warnings ‚úÖ</div>
        </div>
        <button class="btn" id="btnToggleAuth">Registrar</button>
      </div>

      <div class="bd">
        <div class="field" id="fieldUsuario" style="display:none;">
          <div class="muted">Usu√°rio</div>
          <input id="inpUsuario" placeholder="ex: Guh" autocomplete="username" />
        </div>

        <div class="field">
          <div class="muted">Email</div>
          <input id="inpEmail" placeholder="seu@email.com" autocomplete="email" />
        </div>

        <div class="field">
          <div class="muted">Senha</div>
          <input id="inpSenha" type="password" placeholder="m√≠nimo 6 chars" autocomplete="current-password" />
        </div>

        <button class="btn primary" id="btnAuthGo" style="width:100%;">Entrar</button>
        <div class="hint" id="authHint"></div>
      </div>
    </div>
  </section>

  <main id="app" class="wrap" style="display:none;">
    <div class="shell">
      <aside class="side">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Menu</div>
              <div class="muted" id="meMini">‚Äî</div>
            </div>
          </div>
          <div class="bd">
            <nav class="nav">
              <div class="navItem active" data-route="feed">
                <div>
                  <div style="font-weight:1000;">Feed</div>
                  <div class="muted">Todas as contas</div>
                </div>
                <span class="kbd">1</span>
              </div>

              <div class="navItem" data-route="profile">
                <div>
                  <div style="font-weight:1000;">Perfil</div>
                  <div class="muted">Sua sess√£o</div>
                </div>
                <span class="kbd">2</span>
              </div>

              <div class="navItem" data-route="settings">
                <div>
                  <div style="font-weight:1000;">Config</div>
                  <div class="muted">API / Feed</div>
                </div>
                <span class="kbd">3</span>
              </div>
            </nav>
          </div>
        </div>
      </aside>

      <section class="card">
        <div class="hd">
          <div>
            <div class="title" id="viewTitle">Feed</div>
            <div class="muted" id="viewSub">Carregando‚Ä¶</div>
          </div>
          <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn" id="btnReloadView">Atualizar</button>
          </div>
        </div>

        <div class="bd">
          <div class="view active" id="view_feed">
            <div class="feedTop">
              <input class="search" id="search" placeholder="Buscar usu√°rio/email‚Ä¶" />
              <button class="btn" id="btnFeedRefresh">Atualizar feed</button>
            </div>
            <div class="sep"></div>
            <div id="feedGrid" class="grid"></div>
            <div class="hint" id="feedHint"></div>
          </div>

          <div class="view" id="view_profile">
            <div class="title">Sua sess√£o</div>
            <div class="muted">Token salvo no navegador üôÇ</div>
            <div class="sep"></div>
            <div class="muted">session_token</div>
            <div class="pill" id="tokenPill" style="max-width:100%;">‚Äî</div>
            <div class="sep"></div>
            <div class="hint" id="profileHint">‚Äî</div>
          </div>

          <div class="view" id="view_settings">
            <div class="title">Configura√ß√µes</div>
            <div class="muted">Se a API estiver bloqueada, ajusta aqui üòÑ</div>
            <div class="sep"></div>

            <div class="muted">API detectada (server_status.json)</div>
            <div class="pill" id="detectedPill" style="max-width:100%;">‚Äî</div>

            <div class="sep"></div>

            <div class="muted">API override (recomendado HTTPS p√∫blico)</div>
            <div class="field">
              <input id="inpApiOverride" placeholder="https://xxxx.trycloudflare.com" />
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn primary" id="btnSaveApi">Salvar</button>
              <button class="btn" id="btnClearApi">Limpar</button>
            </div>

            <div class="sep"></div>

            <div class="muted">Feed endpoint (se voc√™ criar no server)</div>
            <div class="field">
              <input id="inpFeedEp" placeholder="/api/social/users" />
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn primary" id="btnSaveFeed">Salvar</button>
              <button class="btn" id="btnResetFeed">Reset</button>
            </div>

            <div class="hint" id="settingsHint"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <div class="bottomNav" aria-hidden="true">
    <div class="bottomNavInner">
      <button class="bItem active" data-route="feed">Feed</button>
      <button class="bItem" data-route="profile">Perfil</button>
      <button class="bItem" data-route="settings">Config</button>
    </div>
  </div>

  <div class="toasts" id="toasts"></div>

<script>
(() => {
  const $ = (q, el=document) => el.querySelector(q);
  const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));
  const escapeHtml = (s) => String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  const initials = (name) => (String(name || "?").trim()[0] || "?").toUpperCase();

  const LS = { token:"ns_session_token", apiOverride:"ns_api_override", feedEp:"ns_feed_endpoint" };

  // ‚úÖ do jeito que voc√™ pediu: link do GitHub (blob) + raw fallback
  const STATUS_BLOB_RAW = "https://github.com/NoSense-Bot/Servidor/blob/main/server_status.json?raw=1";
  const STATUS_RAW_FALLBACK = "https://raw.githubusercontent.com/NoSense-Bot/Servidor/main/server_status.json";

  const DEFAULT_FEED_EP = "/api/social/users";

  const state = {
    mode: "login",
    apiDetected: null,
    apiBase: null,
    statusOk: false,
    token: localStorage.getItem(LS.token) || "",
    me: null,
    feed: [],
    feedEp: localStorage.getItem(LS.feedEp) || DEFAULT_FEED_EP,
  };

  const el = {
    dot: $("#dot"),
    apiPill: $("#apiPill"),
    btnRefresh: $("#btnRefresh"),
    btnOpenSettings: $("#btnOpenSettings"),
    btnLogout: $("#btnLogout"),

    auth: $("#auth"),
    app: $("#app"),
    authTitle: $("#authTitle"),
    authSub: $("#authSub"),
    btnToggleAuth: $("#btnToggleAuth"),
    btnAuthGo: $("#btnAuthGo"),
    authHint: $("#authHint"),
    fieldUsuario: $("#fieldUsuario"),
    inpUsuario: $("#inpUsuario"),
    inpEmail: $("#inpEmail"),
    inpSenha: $("#inpSenha"),

    meMini: $("#meMini"),
    viewTitle: $("#viewTitle"),
    viewSub: $("#viewSub"),
    btnReloadView: $("#btnReloadView"),

    feedGrid: $("#feedGrid"),
    feedHint: $("#feedHint"),
    btnFeedRefresh: $("#btnFeedRefresh"),
    search: $("#search"),

    tokenPill: $("#tokenPill"),
    profileHint: $("#profileHint"),

    detectedPill: $("#detectedPill"),
    inpApiOverride: $("#inpApiOverride"),
    btnSaveApi: $("#btnSaveApi"),
    btnClearApi: $("#btnClearApi"),
    inpFeedEp: $("#inpFeedEp"),
    btnSaveFeed: $("#btnSaveFeed"),
    btnResetFeed: $("#btnResetFeed"),
    settingsHint: $("#settingsHint"),

    toasts: $("#toasts"),

    netBanner: $("#netBanner"),
    netText: $("#netText"),
    netSmall: $("#netSmall"),
    btnHideNet: $("#btnHideNet"),
    btnCopyApi: $("#btnCopyApi"),
  };

  function toast(title, msg){
    const n = document.createElement("div");
    n.className = "toast";
    n.innerHTML = `<b>${escapeHtml(title)}</b><div class="small">${escapeHtml(msg)}</div>`;
    el.toasts.appendChild(n);

    if (!matchMedia("(prefers-reduced-motion: reduce)").matches) {
      try {
        n.animate(
          [{ transform:"translateY(8px) scale(.98)", opacity:0 }, { transform:"translateY(0) scale(1)", opacity:1 }],
          { duration:220, easing:"cubic-bezier(.2,.8,.2,1)" }
        );
      } catch {}
    }

    setTimeout(() => {
      try {
        const a = n.animate(
          [{ transform:"translateY(0) scale(1)", opacity:1 }, { transform:"translateY(8px) scale(.98)", opacity:0 }],
          { duration:220, easing:"cubic-bezier(.2,.8,.2,1)" }
        );
        a.onfinish = () => n.remove();
      } catch { n.remove(); }
    }, 3200);
  }

  function viewTransition(updateDOM){
    if (document.startViewTransition && !matchMedia("(prefers-reduced-motion: reduce)").matches){
      document.startViewTransition(() => updateDOM());
    } else updateDOM();
  }

  async function isBraveBrowser(){
    try{
      if (navigator.brave && typeof navigator.brave.isBrave === "function") {
        return await navigator.brave.isBrave();
      }
    } catch {}
    return /Brave/i.test(navigator.userAgent);
  }

  function isLikelyBlockedFetch(err){
    const m = String(err?.message || err || "");
    return m.includes("Failed to fetch") || m.includes("NetworkError") || m.includes("Load failed");
  }

  function normalizeApi(url){
    if (!url) return null;
    url = String(url).trim();
    if (!/^https?:\/\//i.test(url)) return null;
    return url.replace(/\/+$/, "");
  }

  function isMixedContentRisk(){
    return location.protocol === "https:" && state.apiBase && state.apiBase.startsWith("http://");
  }

  function showNetBlockBanner({ where, errMsg }){
    (async () => {
      const brave = await isBraveBrowser();
      const mixed = isMixedContentRisk();

      let tips = [];
      if (brave) tips.push("‚Ä¢ Brave: clique no le√£o ü¶Å e coloque Shields DOWN pra este site");
      tips.push("‚Ä¢ Desative AdBlock/uBlock/antiv√≠rus web para este site");
      tips.push("‚Ä¢ Teste em aba an√¥nima (sem extens√µes)");
      if (mixed) tips.push("‚Ä¢ HTTPS site + HTTP API (mixed content) ‚Üí use API HTTPS p√∫blica no override");

      el.netText.textContent =
`O navegador bloqueou a conex√£o com a API.

üìå Onde: ${where}
üîó API: ${state.apiBase || "‚Äî"}

‚úÖ Como resolver:
${tips.join("\n")}`;

      el.netSmall.textContent =
`Detalhe t√©cnico: ${errMsg || "Failed to fetch / ERR_BLOCKED_BY_CLIENT (prov√°vel)"}\nObs: o site n√£o consegue desligar Shields por c√≥digo.`;

      el.netBanner.classList.remove("hidden");

      el.btnHideNet.onclick = () => el.netBanner.classList.add("hidden");
      el.btnCopyApi.onclick = async () => {
        try{
          await navigator.clipboard.writeText(state.apiBase || "");
          el.netSmall.textContent = "‚úÖ API copiada!";
        } catch {
          el.netSmall.textContent = "‚ùå N√£o consegui copiar (permite clipboard no navegador).";
        }
      };
    })();
  }

  function setDot(kind){
    el.dot.classList.remove("ok","bad");
    if (kind === "ok") el.dot.classList.add("ok");
    if (kind === "bad") el.dot.classList.add("bad");
  }

  function setApiPill(){
    el.apiPill.textContent = "API: " + (state.apiBase || "‚Äî");
    el.apiPill.title = state.apiBase || "API";
  }

  function showAuth(){ el.btnLogout.style.display="none"; el.app.style.display="none"; el.auth.style.display=""; }
  function showApp(){ el.btnLogout.style.display=""; el.auth.style.display="none"; el.app.style.display=""; }

  function setAuthMode(mode){
    state.mode = mode;
    const isReg = mode === "register";
    el.authTitle.textContent = isReg ? "Registrar" : "Entrar";
    el.authSub.textContent = isReg ? "Registro (bcrypt + valida√ß√µes) üöÄ" : "Login (session_token) üòÑ";
    el.btnToggleAuth.textContent = isReg ? "Entrar" : "Registrar";
    el.btnAuthGo.textContent = isReg ? "Registrar" : "Entrar";
    el.fieldUsuario.style.display = isReg ? "" : "none";
    el.authHint.textContent = "";
  }

  async function fetchWithTimeout(url, opts={}, ms=12000){
    const c = new AbortController();
    const t = setTimeout(() => c.abort("timeout"), ms);
    try{ return await fetch(url, { ...opts, signal:c.signal }); }
    finally{ clearTimeout(t); }
  }

  async function loadStatusFromGithub(){
    // 1) blob?raw=1 (como voc√™ pediu)
    try{
      const r = await fetchWithTimeout(STATUS_BLOB_RAW + "&v=" + Date.now(), { cache:"no-store" }, 10000);
      if (r.ok){
        const j = await r.json();
        const api = normalizeApi(j?.url_api_base);
        if (api) return api;
      }
    } catch {}

    // 2) fallback raw.githubusercontent
    const r2 = await fetchWithTimeout(STATUS_RAW_FALLBACK + "?v=" + Date.now(), { cache:"no-store" }, 10000);
    if (!r2.ok) throw new Error("Falha lendo server_status.json (HTTP " + r2.status + ")");
    const j2 = await r2.json();
    const api2 = normalizeApi(j2?.url_api_base);
    if (!api2) throw new Error("url_api_base n√£o encontrado no server_status.json");
    return api2;
  }

  async function apiFetch(path, opts={}){
    if (!state.apiBase) throw new Error("API n√£o definida");
    const url = state.apiBase + path;

    const headers = { "Content-Type":"application/json", ...(opts.headers || {}) };
    const r = await fetchWithTimeout(url, { ...opts, headers }, 12000);

    const ct = r.headers.get("content-type") || "";
    const body = ct.includes("application/json") ? await r.json().catch(()=>null) : await r.text().catch(()=>null);

    if (!r.ok){
      const msg = body?.error || ("HTTP " + r.status);
      const e = new Error(msg);
      e.status = r.status;
      throw e;
    }
    return body;
  }

  async function ping(){
    try{
      const r = await fetchWithTimeout(state.apiBase + "/api/status", { cache:"no-store" }, 8000);
      return r.ok;
    } catch (e){
      if (isLikelyBlockedFetch(e)) showNetBlockBanner({ where:"/api/status", errMsg: e?.message });
      return false;
    }
  }

  // ‚úÖ bate com seu server.py:
  // /api/auth/login recebe {email, password}
  // /api/auth/register recebe {email, password, usuario}
  async function login(email, password){
    try{
      return await apiFetch("/api/auth/login", { method:"POST", body: JSON.stringify({ email, password }) });
    } catch (e){
      // fallback: rota direta /login usa {email, senha}
      if (e.status === 404){
        return await apiFetch("/login", { method:"POST", body: JSON.stringify({ email, senha: password, comando:"/login" }) });
      }
      throw e;
    }
  }

  async function register(email, password, usuario){
    try{
      return await apiFetch("/api/auth/register", { method:"POST", body: JSON.stringify({ email, password, usuario }) });
    } catch (e){
      // fallback: rota direta /register usa {email, senha, usuario}
      if (e.status === 404){
        return await apiFetch("/register", { method:"POST", body: JSON.stringify({ email, senha: password, usuario, comando:"/register" }) });
      }
      throw e;
    }
  }

  async function validate(token){
    return await apiFetch("/api/auth/validate", { method:"POST", body: JSON.stringify({ session_token: token }) });
  }

  function renderSkeletons(){
    el.feedGrid.innerHTML = "";
    for (let i=0; i<9; i++){
      const s = document.createElement("div");
      s.className = "skeleton";
      el.feedGrid.appendChild(s);
    }
  }

  function renderFeed(){
    const q = (el.search.value || "").trim().toLowerCase();
    const list = state.feed.filter(u => {
      const usuario = String(u?.usuario || "").toLowerCase();
      const email = String(u?.email || "").toLowerCase();
      return !q || usuario.includes(q) || email.includes(q);
    });

    el.viewSub.textContent = `${list.length} contas üë•`;
    el.feedGrid.innerHTML = "";

    if (!list.length){
      el.feedHint.textContent = "Nada encontrado üòÖ";
      return;
    }

    list.forEach((u, idx) => {
      const usuario = String(u?.usuario || "user");
      const email = String(u?.email || "‚Äî");
      const chars = Array.isArray(u?.personagens) ? u.personagens : [];
      const names = chars.map(c => c?.nome || c?.nick || c?.name || (typeof c === "string" ? c : "Personagem"));

      const div = document.createElement("div");
      div.className = "userCard";
      div.innerHTML = `
        <div class="userTop">
          <div class="avatar">${initials(usuario)}</div>
          <div style="min-width:0;">
            <div style="font-weight:1000; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(usuario)}</div>
            <div class="muted" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(email)}</div>
          </div>
        </div>
        <div class="chips">
          <span class="chip">${names.length} personagem(ns)</span>
          ${names.slice(0,4).map(n => `<span class="chip">${escapeHtml(n)}</span>`).join("")}
          ${names.length > 4 ? `<span class="chip">+${names.length-4}</span>` : ""}
        </div>
      `;
      el.feedGrid.appendChild(div);

      if (!matchMedia("(prefers-reduced-motion: reduce)").matches){
        try{
          div.animate(
            [{ transform:"translateY(10px) scale(.99)", opacity:0 }, { transform:"translateY(0) scale(1)", opacity:1 }],
            { duration:260, easing:"cubic-bezier(.2,.8,.2,1)", delay: Math.min(idx*18, 200) }
          );
        } catch {}
      }
    });
  }

  // ‚ö†Ô∏è FEED: seu backend ainda n√£o tem comando/rota pra listar usu√°rios no Comandos.py
  async function refreshFeed(){
    el.feedHint.textContent = "";
    renderSkeletons();

    try{
      // tentativa 1: endpoint configur√°vel (se voc√™ criar depois)
      try{
        const r = await apiFetch(state.feedEp, { method:"GET" });
        const users = r?.users ?? r?.result ?? (Array.isArray(r) ? r : []);
        if (Array.isArray(users)) {
          state.feed = users;
          el.feedHint.textContent = "";
          renderFeed();
          toast("Feed", "Atualizado ‚úÖ");
          return;
        }
      } catch {}

      // tentativa 2: por /api/cmd (mas seu Comandos.py n√£o tem comando de users)
      // ent√£o mostramos aviso amig√°vel:
      state.feed = [];
      el.feedGrid.innerHTML = "";
      el.feedHint.textContent =
"‚ö†Ô∏è O servidor ainda N√ÉO exp√µe um comando/rota de FEED.\n\n" +
"‚úÖ Seu Comandos.py tem s√≥: /register, /login, /status.\n" +
"üëâ Quando voc√™ criar algo tipo /users (listagem), eu plugo aqui e fica 100% autom√°tico.\n\n" +
"Dica r√°pida: crie uma rota GET /api/users ou um comando /users retornando [{email, usuario, personagens}]";
      toast("Feed", "Sem endpoint de listagem no servidor üòÖ");

    } catch (e){
      const msg = isLikelyBlockedFetch(e)
        ? "Bloqueado pelo navegador/extens√£o (ou mixed content) üòµ‚Äçüí´"
        : (e.message || "Erro no feed");
      el.feedGrid.innerHTML = "";
      el.feedHint.textContent = "‚ùå " + msg + "\nüëâ Abre Config e ajusta a API (de prefer√™ncia HTTPS p√∫blico).";
      toast("Erro", msg);
      if (isLikelyBlockedFetch(e)) showNetBlockBanner({ where:"Feed", errMsg: e?.message });
    }
  }

  function setRoute(route){
    const routes = ["feed","profile","settings"];
    if (!routes.includes(route)) route = "feed";
    viewTransition(() => {
      $$(".navItem").forEach(x => x.classList.toggle("active", x.dataset.route === route));
      $$(".bItem").forEach(x => x.classList.toggle("active", x.dataset.route === route));
      $$(".view").forEach(v => v.classList.remove("active"));
      $("#view_" + route).classList.add("active");

      if (route === "feed"){ el.viewTitle.textContent="Feed"; el.btnReloadView.onclick = refreshFeed; }
      if (route === "profile"){ el.viewTitle.textContent="Perfil"; el.btnReloadView.onclick = bootSessionOnly; }
      if (route === "settings"){ el.viewTitle.textContent="Config"; el.btnReloadView.onclick = boot; }
    });
    history.replaceState({}, "", "#"+route);
  }

  async function bootSessionOnly(){
    try{
      const v = await validate(state.token);
      const email = v?.user_id || "";
      const usuario = email.includes("@") ? email.split("@")[0] : "user";
      state.me = { email, usuario };

      el.meMini.textContent = state.me.email ? `@${state.me.usuario} ‚Ä¢ ${state.me.email}` : `@${state.me.usuario}`;
      el.tokenPill.textContent = state.token || "‚Äî";
      el.profileHint.textContent = state.statusOk ? "‚úÖ sess√£o ok ‚Ä¢ servidor online" : "‚ö†Ô∏è sess√£o ok ‚Ä¢ sem ping";
    } catch (e){
      state.token = "";
      localStorage.removeItem(LS.token);
      state.me = null;
      showAuth();
      toast("Sess√£o", "Sess√£o inv√°lida, loga de novo üôè");
    }
  }

  async function boot(){
    el.authHint.textContent = "";
    el.settingsHint.textContent = "";
    el.profileHint.textContent = "‚Äî";
    el.tokenPill.textContent = state.token || "‚Äî";
    el.meMini.textContent = "‚Äî";

    el.apiPill.textContent = "API: carregando‚Ä¶";
    setDot("warn");

    try{
      const api = await loadStatusFromGithub();
      state.apiDetected = api;

      const override = normalizeApi(localStorage.getItem(LS.apiOverride));
      state.apiBase = override || state.apiDetected;

      setApiPill();
      el.detectedPill.textContent = state.apiDetected || "‚Äî";
      el.inpApiOverride.value = override || "";
      el.inpFeedEp.value = state.feedEp;

      if (isMixedContentRisk()){
        el.settingsHint.textContent =
"‚ö†Ô∏è HTTPS site + HTTP API (mixed content) pode ser bloqueado.\n" +
"‚úÖ Use uma API HTTPS p√∫blica e coloque no override.";
        setDot("bad");
      }

      const ok = await ping();
      state.statusOk = ok;
      setDot(ok ? "ok" : "bad");

      if (!ok){
        el.settingsHint.textContent =
(el.settingsHint.textContent ? el.settingsHint.textContent + "\n\n" : "") +
"‚ö†Ô∏è N√£o consegui pingar /api/status.\nSe aparecer ERR_BLOCKED_BY_CLIENT √© Brave/Adblock bloqueando.";
      }

      if (state.token){
        await bootSessionOnly();
        showApp();
        setRoute(location.hash.replace("#","") || "feed");
        await refreshFeed();
      } else showAuth();

    } catch (e){
      setDot("bad");
      showAuth();

      const msg = isLikelyBlockedFetch(e)
        ? "Falha de rede/bloqueio ao buscar server_status.json üòµ‚Äçüí´"
        : (e.message || "Erro no boot");

      el.authHint.textContent =
"‚ùå " + msg +
"\n\n‚úÖ Dicas:\n- Brave: Shields DOWN ü¶Å\n- Desliga AdBlock/uBlock/antiv√≠rus web\n- Testa aba an√¥nima";

      toast("Boot", msg);
      if (isLikelyBlockedFetch(e)) showNetBlockBanner({ where:"server_status.json", errMsg: e?.message });
    }
  }

  // ====== Eventos ======
  el.btnRefresh.onclick = boot;
  el.btnOpenSettings.onclick = () => setRoute("settings");

  el.btnLogout.onclick = () => {
    state.token = "";
    localStorage.removeItem(LS.token);
    state.me = null;
    toast("Logout", "Saiu ‚úÖ");
    viewTransition(() => showAuth());
    setAuthMode("login");
  };

  el.btnToggleAuth.onclick = () => setAuthMode(state.mode === "login" ? "register" : "login");

  el.btnAuthGo.onclick = async () => {
    const email = (el.inpEmail.value || "").trim();
    const password = (el.inpSenha.value || "").trim();
    const usuario = (el.inpUsuario.value || "").trim();

    if (!email || !password){ el.authHint.textContent = "‚ö†Ô∏è Preenche email e senha"; return; }
    if (state.mode === "register" && !usuario){ el.authHint.textContent = "‚ö†Ô∏è Preenche usu√°rio"; return; }

    try{
      el.authHint.textContent = "‚è≥ enviando‚Ä¶";
      const res = state.mode === "register"
        ? await register(email, password, usuario)
        : await login(email, password);

      const token = res?.session_token;
      if (!token) throw new Error("API n√£o retornou session_token");

      state.token = token;
      localStorage.setItem(LS.token, state.token);

      toast(state.mode === "register" ? "Registro" : "Login", "Sucesso ‚úÖ");
      viewTransition(() => showApp());
      await bootSessionOnly();
      setRoute("feed");
      await refreshFeed();

    } catch (e){
      const msg = isLikelyBlockedFetch(e)
        ? "Failed to fetch (bloqueio/extens√£o ou mixed content)"
        : (e.message || "Erro no auth");
      el.authHint.textContent = "‚ùå " + msg;
      toast("Auth", msg);
      if (isLikelyBlockedFetch(e)) showNetBlockBanner({ where: state.mode === "register" ? "register" : "login", errMsg: e?.message });
    }
  };

  el.btnFeedRefresh.onclick = refreshFeed;
  el.search.addEventListener("input", () => renderFeed());

  $$(".navItem").forEach(n => n.addEventListener("click", () => setRoute(n.dataset.route)));
  $$(".bItem").forEach(n => n.addEventListener("click", () => setRoute(n.dataset.route)));

  el.btnSaveApi.onclick = () => {
    const v = normalizeApi(el.inpApiOverride.value);
    if (!v){ el.settingsHint.textContent = "‚ùå URL inv√°lida. Ex: https://xxxx.trycloudflare.com"; toast("Config","URL inv√°lida"); return; }
    localStorage.setItem(LS.apiOverride, v);
    el.settingsHint.textContent = "‚úÖ Salvo! Clica Recarregar.";
    toast("Config","API override salva ‚úÖ");
  };

  el.btnClearApi.onclick = () => {
    localStorage.removeItem(LS.apiOverride);
    el.inpApiOverride.value = "";
    el.settingsHint.textContent = "‚úÖ Override removido! Clica Recarregar.";
    toast("Config","Override removido ‚úÖ");
  };

  el.btnSaveFeed.onclick = () => {
    const v = (el.inpFeedEp.value || "").trim();
    if (!v.startsWith("/")){ el.settingsHint.textContent = "‚ùå Endpoint precisa come√ßar com /"; toast("Config","Endpoint inv√°lido"); return; }
    state.feedEp = v;
    localStorage.setItem(LS.feedEp, state.feedEp);
    el.settingsHint.textContent = "‚úÖ Feed endpoint salvo! Vai em Feed e Atualiza.";
    toast("Config","Feed endpoint salvo ‚úÖ");
  };

  el.btnResetFeed.onclick = () => {
    state.feedEp = DEFAULT_FEED_EP;
    localStorage.setItem(LS.feedEp, state.feedEp);
    el.inpFeedEp.value = state.feedEp;
    el.settingsHint.textContent = "‚úÖ Resetado pro padr√£o.";
    toast("Config","Reset ‚úÖ");
  };

  window.addEventListener("keydown", (e) => {
    if (e.target && ["INPUT","TEXTAREA"].includes(e.target.tagName)) return;
    if (e.key === "1") setRoute("feed");
    if (e.key === "2") setRoute("profile");
    if (e.key === "3") setRoute("settings");
  });

  // ‚úÖ warnings globais (qualquer erro vira toast + modal se for bloqueio)
  window.addEventListener("error", (ev) => {
    const msg = ev?.message || "Erro desconhecido";
    toast("Erro", msg);
  });
  window.addEventListener("unhandledrejection", (ev) => {
    const msg = String(ev?.reason?.message || ev?.reason || "Promise rejeitada");
    toast("Erro", msg);
    if (isLikelyBlockedFetch(ev?.reason)) showNetBlockBanner({ where:"Promise", errMsg: msg });
  });

  setAuthMode("login");
  boot();
})();
</script>
</body>
</html>
