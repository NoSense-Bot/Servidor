<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NoSense â€¢ Social</title>

  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%23111827'/%3E%3Cpath d='M18 38c6 10 22 10 28 0' fill='none' stroke='%237c3aed' stroke-width='6' stroke-linecap='round'/%3E%3Ccircle cx='24' cy='26' r='4' fill='%23e5e7eb'/%3E%3Ccircle cx='40' cy='26' r='4' fill='%23e5e7eb'/%3E%3C/svg%3E" />

  <style>
    :root{
      --bg:#0b0e14; --panel:#111827; --panel2:#0f172a;
      --text:#e5e7eb; --muted:#9ca3af; --line:#1f2937;
      --ok:#22c55e; --bad:#ef4444; --brand:#7c3aed;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r: 16px; --pad: 14px; --gap: 14px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:radial-gradient(1200px 800px at 10% 0%, #1b1238 0%, transparent 50%), var(--bg); color:var(--text); }
    button, input{ font:inherit; }

    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 14px; border-bottom:1px solid var(--line);
      background:rgba(11,14,20,.75); backdrop-filter: blur(10px);
    }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:900; }
    .dot{ width:10px; height:10px; border-radius:999px; background:var(--bad); box-shadow:0 0 0 4px rgba(239,68,68,.15); }
    .dot.ok{ background:var(--ok); box-shadow:0 0 0 4px rgba(34,197,94,.15); }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border:1px solid var(--line);
      background:rgba(17,24,39,.6); border-radius:999px;
      color:var(--muted); font-size:13px;
      max-width:520px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .btn{
      border:1px solid var(--line);
      background:rgba(17,24,39,.9);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s transform ease;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.primary{ border-color:rgba(124,58,237,.55); background:rgba(124,58,237,.18); }
    .btn.danger{ border-color:rgba(239,68,68,.5); background:rgba(239,68,68,.14); }

    .wrap{ max-width:1120px; margin:0 auto; padding:14px; }
    .grid{ display:grid; gap:var(--gap); grid-template-columns: 360px 1fr; align-items:start; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(17,24,39,.9), rgba(15,23,42,.75));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: var(--pad);
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .bd{ padding: var(--pad); }
    .title{ font-weight:900; }
    .muted{ color:var(--muted); font-size:13px; }
    .sep{ height:1px; background:var(--line); margin:10px 0; }
    .toast{ margin-top:10px; font-size:13px; color:var(--muted); white-space:pre-wrap; }

    .auth{ max-width:460px; margin:40px auto; padding:0 14px; }
    .auth .card{ border-radius:20px; }
    .field{ display:grid; gap:6px; margin:10px 0; }
    input{
      width:100%; padding:12px 12px; border-radius:12px;
      border:1px solid var(--line); background:rgba(2,6,23,.45);
      color:var(--text); outline:none;
    }
    input:focus{ border-color:rgba(124,58,237,.6); box-shadow:0 0 0 4px rgba(124,58,237,.15); }

    .feedTop{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .search{ flex:1; min-width:200px; }

    .feedGrid{ display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:12px; }
    @media (max-width: 980px){ .feedGrid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 520px){ .feedGrid{ grid-template-columns: 1fr; } }

    .userCard{
      border:1px solid var(--line); background:rgba(2,6,23,.35);
      border-radius:14px; padding:12px;
      transition:.15s transform ease, .15s border-color ease;
    }
    .userCard:hover{ transform: translateY(-2px); border-color:rgba(124,58,237,.55); }
    .userTop{ display:flex; gap:10px; align-items:center; }
    .avatar{
      width:42px; height:42px; border-radius:14px;
      display:grid; place-items:center;
      background:rgba(124,58,237,.18);
      border:1px solid rgba(124,58,237,.35);
      font-weight:900;
    }
    .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:10px; }
    .chip{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      background:rgba(17,24,39,.6);
      padding:6px 8px; border-radius:999px;
      max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }

    /* modal settings */
    .backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:14px;
      z-index:50;
    }
    .modal{
      width:min(720px, 100%);
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(17,24,39,.98), rgba(15,23,42,.95));
      border-radius:18px; box-shadow: var(--shadow);
      overflow:hidden;
    }
    .grid2{ display:grid; gap:12px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 700px){ .grid2{ grid-template-columns:1fr; } }
    code{ color:#c7d2fe; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <div class="dot" id="serverDot"></div>
      <div>NoSense â€¢ Social</div>
      <div class="pill" id="apiPill">API: carregandoâ€¦</div>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <button class="btn" id="btnSettings">Config</button>
      <button class="btn" id="btnReload">Recarregar</button>
      <button class="btn danger" id="btnLogout" style="display:none;">Sair</button>
    </div>
  </div>

  <!-- AUTH -->
  <section class="auth" id="authView">
    <div class="card">
      <div class="hd">
        <div>
          <div class="title" id="authTitle">Entrar</div>
          <div class="muted" id="authSub">GitHub Pages ready âœ…</div>
        </div>
        <button class="btn" id="btnToggleAuth">Registrar</button>
      </div>

      <div class="bd">
        <div class="field" id="userField" style="display:none;">
          <div class="muted">UsuÃ¡rio</div>
          <input id="inpUser" placeholder="ex: Guh" autocomplete="username" />
        </div>

        <div class="field">
          <div class="muted">Email</div>
          <input id="inpEmail" placeholder="seu@email.com" autocomplete="email" />
        </div>

        <div class="field">
          <div class="muted">Senha</div>
          <input id="inpPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
        </div>

        <button class="btn primary" id="btnAuthGo" style="width:100%;">Entrar</button>
        <div class="toast" id="authToast"></div>
      </div>
    </div>
  </section>

  <!-- APP -->
  <section class="wrap" id="appView" style="display:none;">
    <div class="grid">

      <div class="card">
        <div class="hd">
          <div>
            <div class="title">Meu perfil</div>
            <div class="muted" id="meMini">â€”</div>
          </div>
        </div>
        <div class="bd">
          <div class="muted">session_token</div>
          <div class="pill" id="tokenPill" title="session_token">â€”</div>
          <div class="sep"></div>
          <div class="muted">Avisos</div>
          <div class="toast" id="meToast">â€”</div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div class="feedTop" style="width:100%;">
            <div>
              <div class="title">Feed</div>
              <div class="muted" id="feedInfo">Carregandoâ€¦</div>
            </div>
            <input class="search" id="search" placeholder="Buscar usuÃ¡rio/emailâ€¦" />
            <button class="btn" id="btnRefreshFeed">Atualizar</button>
          </div>
        </div>
        <div class="bd">
          <div class="feedGrid" id="feedGrid"></div>
          <div class="toast" id="feedToast"></div>
        </div>
      </div>

    </div>
  </section>

  <!-- SETTINGS -->
  <div class="backdrop" id="backdrop">
    <div class="modal">
      <div class="hd" style="padding:14px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div class="title">ConfiguraÃ§Ãµes</div>
          <div class="muted">Pra GitHub Pages funcionar sem dor ðŸ˜„</div>
        </div>
        <button class="btn" id="btnCloseSettings">Fechar</button>
      </div>
      <div class="bd" style="padding:14px;">
        <div class="grid2">
          <div class="card" style="box-shadow:none;">
            <div class="hd"><div class="title">API Base</div><div class="muted">override</div></div>
            <div class="bd">
              <div class="muted">Detectado do <code>server_status.json</code>:</div>
              <div class="pill" id="detectedApi">â€”</div>

              <div class="sep"></div>

              <div class="muted">Usar manual (ex: <code>https://xxxx.trycloudflare.com</code>):</div>
              <div class="field">
                <input id="manualApi" placeholder="https://..." />
              </div>

              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn primary" id="btnSaveApi">Salvar</button>
                <button class="btn" id="btnClearApi">Limpar</button>
              </div>

              <div class="toast" id="apiHint"></div>
            </div>
          </div>

          <div class="card" style="box-shadow:none;">
            <div class="hd"><div class="title">Feed</div><div class="muted">endpoint</div></div>
            <div class="bd">
              <div class="muted">Endpoint padrÃ£o:</div>
              <div class="pill">GET <span id="defaultFeedEp">/api/social/users</span></div>

              <div class="sep"></div>

              <div class="muted">Se seu servidor nÃ£o tiver isso, troque aqui:</div>
              <div class="field">
                <input id="feedEndpoint" placeholder="/api/social/users" />
              </div>

              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn primary" id="btnSaveFeedEp">Salvar</button>
                <button class="btn" id="btnResetFeedEp">Reset</button>
              </div>

              <div class="toast">
                Dica: se nÃ£o existir endpoint, o front tenta fallback:
                <code>POST /api/cmd</code> com <code>{comando:"/social/users"}</code> ðŸ˜‰
              </div>
            </div>
          </div>
        </div>

        <div class="sep"></div>
        <div class="toast" id="netWarn"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const el = (id) => document.getElementById(id);
  const setText = (id, t) => { el(id).textContent = t ?? ""; };

  const LS = {
    token: "ns_session_token",
    apiOverride: "ns_api_override",
    feedEndpoint: "ns_feed_endpoint"
  };

  let MODE = "login";
  let TOKEN = localStorage.getItem(LS.token) || "";
  let ME = null;

  let API_DETECTED = null;
  let API = null;

  const DEFAULT_FEED_EP = "/api/social/users";
  let FEED_EP = localStorage.getItem(LS.feedEndpoint) || DEFAULT_FEED_EP;

  let FEED = [];

  const statusCandidates = [
    new URL("server_status.json", location.href).toString(),
    "https://raw.githubusercontent.com/NoSense-Bot/Servidor/main/server_status.json"
  ];

  function isLocalHost(url) {
    try {
      const u = new URL(url);
      const h = u.hostname;
      return h === "127.0.0.1" || h === "localhost" || h.endsWith(".local");
    } catch { return false; }
  }

  function isPrivateIpHost(url) {
    try {
      const h = new URL(url).hostname;
      // 10.x.x.x | 192.168.x.x | 172.16-31.x.x
      if (/^10\./.test(h)) return true;
      if (/^192\.168\./.test(h)) return true;
      const m = h.match(/^172\.(\d+)\./);
      if (m) {
        const n = parseInt(m[1], 10);
        return n >= 16 && n <= 31;
      }
      return false;
    } catch { return false; }
  }

  function normalizeApiBase(url) {
    if (!url) return null;
    url = String(url).trim();
    if (!/^https?:\/\//i.test(url)) return null;
    return url.replace(/\/+$/, "");
  }

  function upgradeToHttpsIfSafe(url) {
    // se pÃ¡gina Ã© https e API Ã© http, tenta upgrade (exceto localhost/private ip)
    if (location.protocol !== "https:") return url;
    if (!url || !url.startsWith("http://")) return url;
    if (isLocalHost(url) || isPrivateIpHost(url)) return url; // nÃ£o inventa
    return "https://" + url.slice("http://".length);
  }

  function explainFetchError(err) {
    const msg = String(err?.message || err || "");
    // muito comum no Chrome quando extensÃ£o bloqueia
    if (msg.includes("Failed to fetch") || msg.includes("NetworkError")) {
      return "âŒ Falhou (provÃ¡vel bloqueio do navegador/extensÃ£o ou API http em site https).\nðŸ‘‰ Tenta aba anÃ´nima/desliga AdBlock/uBlock/antivÃ­rus web.";
    }
    return "âŒ " + msg;
  }

  async function loadStatusJson() {
    let last = null;
    for (const u of statusCandidates) {
      try {
        const r = await fetch(u + (u.includes("?") ? "&" : "?") + "v=" + Date.now(), { cache: "no-store" });
        if (!r.ok) { last = new Error("HTTP " + r.status); continue; }
        const j = await r.json();
        const api = normalizeApiBase(j?.url_api_base);
        if (api) return { api, raw: j, src: u };
        last = new Error("url_api_base nÃ£o encontrado");
      } catch (e) { last = e; }
    }
    throw last || new Error("NÃ£o deu pra ler server_status.json");
  }

  async function apiFetch(path, opts = {}) {
    if (!API) throw new Error("API nÃ£o definida");
    const headers = Object.assign({ "Content-Type": "application/json" }, opts.headers || {});
    const r = await fetch(API + path, Object.assign({}, opts, { headers }));
    const ct = r.headers.get("content-type") || "";
    const body = ct.includes("application/json") ? await r.json().catch(()=>null) : await r.text().catch(()=>null);

    if (!r.ok) {
      const msg = body?.error || ("HTTP " + r.status);
      throw new Error(msg);
    }
    return body;
  }

  async function pingStatus() {
    const r = await fetch(API + "/api/status", { cache: "no-store" });
    return r.ok;
  }

  function setAuthMode(mode) {
    MODE = mode;
    const isReg = MODE === "register";
    setText("authTitle", isReg ? "Registrar" : "Entrar");
    setText("authSub", isReg ? "Register via /api/auth/register ðŸš€" : "Login via /api/auth/login ðŸ˜„");
    setText("btnToggleAuth", isReg ? "Entrar" : "Registrar");
    setText("btnAuthGo", isReg ? "Registrar" : "Entrar");
    el("userField").style.display = isReg ? "" : "none";
    setText("authToast", "");
  }

  function showAuth() {
    el("authView").style.display = "";
    el("appView").style.display = "none";
    el("btnLogout").style.display = "none";
  }

  function showApp() {
    el("authView").style.display = "none";
    el("appView").style.display = "";
    el("btnLogout").style.display = "";
  }

  function renderMe() {
    setText("meMini", ME ? `@${ME.usuario} â€¢ ${ME.email}` : "â€”");
    setText("tokenPill", TOKEN || "â€”");
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function initials(name){ return (name?.trim()?.[0] || "?").toUpperCase(); }

  function normalizeUser(u){
    const user_id = u.user_id || u.email || u.id || u._id || "";
    const usuario = u.usuario || u.nick || u.username || (u.email ? u.email.split("@")[0] : "User");
    const chars = Array.isArray(u.personagens) ? u.personagens : (Array.isArray(u.characters) ? u.characters : []);
    const charNames = chars.map(c => c?.nick || c?.name || c?.nome || (typeof c === "string" ? c : "Personagem"));
    return { user_id: String(user_id || ""), usuario: String(usuario || "user"), charNames };
  }

  function renderFeed(list){
    const q = (el("search").value || "").trim().toLowerCase();
    const grid = el("feedGrid");
    grid.innerHTML = "";

    const norm = list.map(normalizeUser)
      .filter(u => !q || u.usuario.toLowerCase().includes(q) || u.user_id.toLowerCase().includes(q));

    setText("feedInfo", `${norm.length} contas ðŸ‘¥`);

    norm.forEach(u => {
      const div = document.createElement("div");
      div.className = "userCard";
      div.innerHTML = `
        <div class="userTop">
          <div class="avatar">${initials(u.usuario)}</div>
          <div style="min-width:0;">
            <div style="font-weight:900; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(u.usuario)}</div>
            <div class="muted" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(u.user_id || "â€”")}</div>
          </div>
        </div>
        <div class="chips">
          <span class="chip">${u.charNames.length} personagem(ns)</span>
          ${(u.charNames.slice(0,4)).map(n => `<span class="chip">${escapeHtml(n)}</span>`).join("")}
          ${u.charNames.length > 4 ? `<span class="chip">+${u.charNames.length-4}</span>` : ""}
        </div>
      `;
      grid.appendChild(div);
    });

    if (!norm.length) {
      setText("feedToast", "Nada encontrado ðŸ˜…");
    } else {
      setText("feedToast", "");
    }
  }

  async function fetchFeedSmart() {
    // 1) tenta GET no endpoint configurado
    try {
      const res = await apiFetch(FEED_EP, { method: "GET" });
      const users = res?.users || res?.result || res || [];
      if (Array.isArray(users)) return users;
      if (Array.isArray(res)) return res;
    } catch (e) {
      // segue fallback
    }

    // 2) fallback: POST /api/cmd com comando "/social/users"
    try {
      const res2 = await apiFetch("/api/cmd", {
        method: "POST",
        body: JSON.stringify({ comando: "/social/users" })
      });
      const users2 = res2?.users || res2?.result || [];
      if (Array.isArray(users2)) return users2;
    } catch (e) {
      // segue erro final
    }

    throw new Error("Sem feed disponÃ­vel. Configure o endpoint do feed (Config) ou implemente comando /social/users.");
  }

  async function refreshFeed(){
    setText("feedToast", "");
    setText("feedInfo", "Carregandoâ€¦");
    try {
      const users = await fetchFeedSmart();
      FEED = users;
      renderFeed(FEED);
    } catch (e) {
      setText("feedInfo", "âŒ Feed indisponÃ­vel");
      setText("feedToast", explainFetchError(e));
      el("feedGrid").innerHTML = "";
    }
  }

  function updateTopbarApi() {
    setText("apiPill", "API: " + (API || "â€”"));
    el("serverDot").classList.toggle("ok", false);
  }

  function warnMixedContent() {
    const notes = [];
    if (location.protocol === "https:" && API && API.startsWith("http://")) {
      notes.push("âš ï¸ Seu site estÃ¡ em HTTPS (GitHub Pages) e a API estÃ¡ em HTTP â†’ o browser pode bloquear.");
      notes.push("âœ… Use uma API HTTPS (ex: trycloudflare) e cole em Config > API Base.");
    }
    if (API && (isLocalHost(API) || isPrivateIpHost(API))) {
      notes.push("âš ï¸ API local/rede privada: isso NÃƒO funciona para visitantes no GitHub Pages.");
      notes.push("âœ… Precisa de URL pÃºblica (ex: tunnel) e colar no override.");
    }
    setText("netWarn", notes.join("\n"));
  }

  async function boot(){
    setText("authToast", "");
    setText("meToast", "â€”");
    setText("feedToast", "");
    setText("feedInfo", "Carregandoâ€¦");
    el("serverDot").classList.remove("ok");

    try {
      const st = await loadStatusJson();
      API_DETECTED = st.api;

      // aplica override se existir
      const override = normalizeApiBase(localStorage.getItem(LS.apiOverride));
      API = override || API_DETECTED;

      // tenta upgrade pra https (quando fizer sentido)
      API = upgradeToHttpsIfSafe(API);

      updateTopbarApi();
      setText("detectedApi", API_DETECTED || "â€”");
      el("manualApi").value = override || "";
      el("feedEndpoint").value = FEED_EP;
      setText("defaultFeedEp", DEFAULT_FEED_EP);

      warnMixedContent();

      // ping
      try {
        const ok = await pingStatus();
        el("serverDot").classList.toggle("ok", ok);
      } catch (e) {
        // se falhar, pode ser bloqueio por extensÃ£o
        setText("authToast", explainFetchError(e));
      }

      if (TOKEN) {
        try {
          const v = await apiFetch("/api/auth/validate", {
            method: "POST",
            body: JSON.stringify({ session_token: TOKEN })
          });
          if (!v?.ok) throw new Error("SessÃ£o invÃ¡lida");
          const email = v.user_id || "";
          const usuario = v.usuario || (email.includes("@") ? email.split("@")[0] : "user");
          ME = { email, usuario };
          showApp();
          renderMe();
          setText("meToast", "âœ… sessÃ£o ok");
          await refreshFeed();
          return;
        } catch (e) {
          TOKEN = "";
          localStorage.removeItem(LS.token);
        }
      }

      showAuth();
    } catch (e) {
      showAuth();
      setText("authToast", explainFetchError(e));
    }
  }

  // ===== Events =====
  el("btnToggleAuth").onclick = () => setAuthMode(MODE === "login" ? "register" : "login");

  el("btnAuthGo").onclick = async () => {
    const email = (el("inpEmail").value || "").trim();
    const password = (el("inpPass").value || "").trim();
    const usuario = (el("inpUser").value || "").trim();

    if (!email || !password) return setText("authToast", "âš ï¸ preenche email e senha");
    if (MODE === "register" && !usuario) return setText("authToast", "âš ï¸ preenche usuÃ¡rio");

    try {
      setText("authToast", "â³ enviando...");

      const path = MODE === "register" ? "/api/auth/register" : "/api/auth/login";
      const body = MODE === "register"
        ? { email, password, usuario }
        : { email, password };

      const res = await apiFetch(path, { method:"POST", body: JSON.stringify(body) });
      const token = res?.session_token;
      if (!token) throw new Error("API nÃ£o retornou session_token ðŸ˜µâ€ðŸ’«");

      TOKEN = token;
      localStorage.setItem(LS.token, TOKEN);

      // valida pra pegar usuario se vier
      try {
        const v = await apiFetch("/api/auth/validate", {
          method:"POST",
          body: JSON.stringify({ session_token: TOKEN })
        });
        const mail = v.user_id || email;
        const nick = v.usuario || (MODE === "register" ? usuario : (mail.includes("@") ? mail.split("@")[0] : "user"));
        ME = { email: mail, usuario: nick };
      } catch {
        ME = { email, usuario: (MODE === "register" ? usuario : (email.split("@")[0] || "user")) };
      }

      showApp();
      renderMe();
      setText("meToast", "âœ… logado!");
      await refreshFeed();

    } catch (e) {
      setText("authToast", explainFetchError(e));
    }
  };

  el("btnLogout").onclick = () => {
    TOKEN = "";
    ME = null;
    localStorage.removeItem(LS.token);
    showAuth();
    setAuthMode("login");
  };

  el("btnReload").onclick = () => boot();
  el("btnRefreshFeed").onclick = () => refreshFeed();
  el("search").addEventListener("input", () => renderFeed(FEED));

  // settings modal
  el("btnSettings").onclick = () => {
    el("backdrop").style.display = "flex";
    warnMixedContent();
    setText("apiHint", "");
  };
  el("btnCloseSettings").onclick = () => el("backdrop").style.display = "none";
  el("backdrop").onclick = (e) => { if (e.target.id === "backdrop") el("backdrop").style.display = "none"; };

  el("btnSaveApi").onclick = () => {
    const v = normalizeApiBase(el("manualApi").value);
    if (!v) return setText("apiHint", "âŒ URL invÃ¡lida. Ex: https://xxxx.trycloudflare.com");
    localStorage.setItem(LS.apiOverride, v);
    setText("apiHint", "âœ… salvo! clica Recarregar.");
  };
  el("btnClearApi").onclick = () => {
    localStorage.removeItem(LS.apiOverride);
    el("manualApi").value = "";
    setText("apiHint", "âœ… override removido! clica Recarregar.");
  };

  el("btnSaveFeedEp").onclick = () => {
    const v = (el("feedEndpoint").value || "").trim();
    if (!v.startsWith("/")) return setText("feedToast", "âŒ endpoint tem que comeÃ§ar com /");
    FEED_EP = v;
    localStorage.setItem(LS.feedEndpoint, FEED_EP);
    setText("feedToast", "âœ… endpoint do feed salvo! clica Atualizar.");
  };

  el("btnResetFeedEp").onclick = () => {
    FEED_EP = DEFAULT_FEED_EP;
    localStorage.setItem(LS.feedEndpoint, FEED_EP);
    el("feedEndpoint").value = FEED_EP;
    setText("feedToast", "âœ… resetado pro padrÃ£o. clica Atualizar.");
  };

  // init
  setAuthMode("login");
  boot();
})();
</script>
</body>
</html>
