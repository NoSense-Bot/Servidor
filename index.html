<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OBEARCO ‚Ä¢ Gate of Accounts</title>
  <style>
    :root{
      --bg0:#07060b;
      --bg1:#0b0a12;
      --panel: rgba(22, 20, 32, .62);
      --panel2: rgba(14, 13, 22, .55);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.06);
      --text:#e9e7ff;
      --muted: rgba(233,231,255,.68);
      --gold:#d6b46a;
      --vio:#9d7bff;
      --teal:#5ce0d8;
      --danger:#ff5a7a;
      --ok:#48f0a6;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r: 18px;
      --r2: 26px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 600px at 15% 0%, rgba(157,123,255,.22), transparent 60%),
        radial-gradient(1000px 520px at 85% 10%, rgba(92,224,216,.14), transparent 55%),
        radial-gradient(900px 520px at 50% 120%, rgba(214,180,106,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    /* VFX */
    #vfx{
      position:fixed; inset:0; z-index:0;
      pointer-events:none;
      filter: blur(.0px);
      opacity:.95;
    }
    .grain{
      position:fixed; inset:-30%;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      opacity:.18;
      animation: grain 10s steps(6) infinite;
      z-index:1;
      pointer-events:none;
    }
    @keyframes grain{
      0%{transform:translate(0,0)}
      15%{transform:translate(-2%,3%)}
      35%{transform:translate(4%,-2%)}
      55%{transform:translate(-3%,-4%)}
      75%{transform:translate(3%,2%)}
      100%{transform:translate(0,0)}
    }

    .wrap{
      position:relative;
      z-index:2;
      height:100%;
      padding:18px;
      display:flex;
      gap:18px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid var(--stroke);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(700px 220px at 20% 0%, rgba(157,123,255,.20), transparent 55%),
        radial-gradient(700px 220px at 80% 0%, rgba(92,224,216,.12), transparent 55%),
        radial-gradient(800px 340px at 50% 120%, rgba(214,180,106,.10), transparent 60%);
      opacity:.95;
      pointer-events:none;
    }
    .card > *{position:relative; z-index:1;}

    /* Layout */
    .sidebar{
      width:320px;
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .main{
      flex:1;
      min-width:520px;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .right{
      width:360px;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:14px 16px;
      border:1px solid var(--stroke2);
      border-radius: var(--r2);
      background: rgba(0,0,0,.16);
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .orb{
      width:42px; height:42px; border-radius:14px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.55), transparent 55%),
        radial-gradient(40px 40px at 70% 80%, rgba(157,123,255,.55), transparent 60%),
        radial-gradient(40px 40px at 20% 70%, rgba(92,224,216,.35), transparent 60%),
        linear-gradient(135deg, rgba(214,180,106,.20), rgba(0,0,0,0));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 34px rgba(0,0,0,.55);
      position:relative;
    }
    .orb::after{
      content:"";
      position:absolute; inset:-1px;
      border-radius:14px;
      background: radial-gradient(18px 18px at 40% 20%, rgba(255,255,255,.35), transparent 60%);
      opacity:.7;
      filter: blur(.2px);
      pointer-events:none;
    }
    .brand h1{
      margin:0;
      font-size:14px;
      letter-spacing:.22em;
      text-transform:uppercase;
      opacity:.95;
    }
    .brand .sub{
      margin-top:2px;
      font-size:12px;
      color:var(--muted);
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}

    /* Buttons */
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      background: rgba(0,0,0,.22);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease, box-shadow .12s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(214,180,106,.35);
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      background: rgba(0,0,0,.28);
    }
    .btn:active{transform: translateY(0px) scale(.99)}
    .btn.gold{
      background: linear-gradient(180deg, rgba(214,180,106,.22), rgba(0,0,0,.20));
      border-color: rgba(214,180,106,.38);
    }
    .btn.ghost{
      background: rgba(0,0,0,.14);
      border-color: rgba(255,255,255,.10);
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255,90,122,.20), rgba(0,0,0,.20));
      border-color: rgba(255,90,122,.35);
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-size:12px;
      color:var(--muted);
    }

    /* Sidebar */
    .sideTitle{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px 6px;
      opacity:.92;
    }
    .sideTitle .small{font-size:12px;color:var(--muted)}
    .nav{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:6px 4px 10px;
    }
    .navItem{
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      display:flex; align-items:center; justify-content:space-between;
    }
    .navItem:hover{
      transform: translateY(-1px);
      border-color: rgba(157,123,255,.30);
      background: rgba(0,0,0,.22);
    }
    .navItem.active{
      border-color: rgba(214,180,106,.40);
      background: linear-gradient(180deg, rgba(214,180,106,.14), rgba(0,0,0,.16));
      box-shadow: 0 18px 38px rgba(0,0,0,.35);
    }
    .navItem .label{display:flex; flex-direction:column; gap:4px;}
    .navItem .label b{font-size:18px; letter-spacing:.02em;}
    .navItem .label span{font-size:12px; color:var(--muted);}

    /* Sections */
    .section{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
      border-radius: var(--r2);
      overflow:hidden;
    }
    .sectionHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
    }
    .sectionHead h2{margin:0;font-size:18px;letter-spacing:.02em;}
    .sectionHead p{margin:4px 0 0; font-size:12px; color:var(--muted);}
    .sectionBody{padding:16px;}

    /* Portal */
    .portalHero{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 20px;
      padding:16px;
      background:
        radial-gradient(600px 180px at 10% 0%, rgba(157,123,255,.22), transparent 60%),
        radial-gradient(600px 180px at 90% 0%, rgba(92,224,216,.12), transparent 60%),
        rgba(0,0,0,.14);
      margin-bottom:14px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
    }
    .portalHero .t{
      display:flex; flex-direction:column; gap:4px;
    }
    .portalHero .t b{font-size:22px}
    .portalHero .t span{color:var(--muted); font-size:13px}

    /* Red area replacement: One container + tabs */
    .authShell{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      border-radius: 22px;
      overflow:hidden;
      position:relative;
    }
    .authShell::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(520px 220px at 18% 0%, rgba(214,180,106,.12), transparent 60%),
        radial-gradient(520px 220px at 82% 0%, rgba(157,123,255,.12), transparent 60%);
      pointer-events:none;
      opacity:.9;
    }
    .authShell > *{position:relative; z-index:1;}
    .authTabs{
      display:flex;
      gap:10px;
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
    }
    .tabBtn{
      flex:1;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:var(--text);
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      display:flex; align-items:center; justify-content:center; gap:8px;
      font-weight:650;
      letter-spacing:.02em;
    }
    .tabBtn:hover{transform: translateY(-1px); border-color: rgba(214,180,106,.30)}
    .tabBtn.active{
      background: linear-gradient(180deg, rgba(214,180,106,.18), rgba(0,0,0,.18));
      border-color: rgba(214,180,106,.40);
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
    }
    .authInner{
      padding:16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .pane{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 20px;
      background: rgba(0,0,0,.14);
      padding:16px;
      min-height: 260px;
      position:relative;
      overflow:hidden;
      animation: paneIn .28s ease both;
    }
    @keyframes paneIn{
      from{opacity:0; transform: translateY(6px)}
      to{opacity:1; transform: translateY(0)}
    }
    .pane h3{margin:0 0 8px; font-size:20px;}
    .pane p{margin:0 0 14px; font-size:12px; color:var(--muted); line-height:1.35}
    .form{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label{
      font-size:11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:rgba(233,231,255,.70);
    }
    .input{
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
      transition: border-color .12s ease, box-shadow .12s ease;
    }
    .input:focus{
      border-color: rgba(157,123,255,.38);
      box-shadow: 0 0 0 3px rgba(157,123,255,.12);
    }
    .actions{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-top:4px;
    }

    /* For single-tab feel: hide right pane, expand left */
    .authInner.oneCol{
      grid-template-columns: 1fr;
    }
    .hidden{display:none !important;}

    /* Right panel */
    .notesCard{
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      padding:16px;
    }
    .notesCard h3{margin:0 0 8px; letter-spacing:.14em; text-transform:uppercase; font-size:12px; color:rgba(233,231,255,.75)}
    .noteBox{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      border-radius: 18px;
      padding:14px;
      display:flex; gap:10px;
    }
    .noteBox b{display:block; margin-bottom:4px}
    .noteBox span{color:var(--muted); font-size:12px; line-height:1.35}
    .smallList{
      margin:10px 0 0;
      padding-left:16px;
      color:rgba(233,231,255,.78);
      font-size:12px;
      line-height:1.5;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%; bottom:18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.16);
      padding:10px 12px;
      border-radius: 14px;
      color:var(--text);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index:9;
      backdrop-filter: blur(10px);
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-2px);
    }
    .muted{color:var(--muted)}
    .ok{color:var(--ok)}
    .bad{color:var(--danger)}

    /* Responsive */
    @media (max-width: 1100px){
      body{overflow:auto}
      .wrap{flex-direction:column; height:auto}
      .sidebar,.right{width:100%}
      .main{min-width:auto}
      .authInner{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <canvas id="vfx"></canvas>
  <div class="grain"></div>

  <div class="wrap">
    <!-- SIDEBAR -->
    <div class="card sidebar">
      <div class="sideTitle">
        <div>
          <div style="font-weight:800; letter-spacing:.16em; opacity:.9;">ABAS</div>
          <div class="small">navega√ß√£o</div>
        </div>
        <div class="pill" id="pillBase">‚Äî</div>
      </div>

      <div class="nav" id="nav">
        <div class="navItem active" data-tab="portal">
          <div class="label">
            <b>Portal</b>
            <span>login / registro</span>
          </div>
          <div class="pill">üóùÔ∏è</div>
        </div>

        <div class="navItem" data-tab="taverna">
          <div class="label">
            <b>Taverna</b>
            <span>nicks registrados</span>
          </div>
          <div class="pill">üçª</div>
        </div>

        <div class="navItem" data-tab="perfil">
          <div class="label">
            <b>Perfil</b>
            <span>token / dados</span>
          </div>
          <div class="pill">üõ°Ô∏è</div>
        </div>

        <div class="navItem" data-tab="conta">
          <div class="label">
            <b>Conta</b>
            <span>editar / deletar</span>
          </div>
          <div class="pill">‚öôÔ∏è</div>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="card main">
      <div class="topbar">
        <div class="brand">
          <div class="orb"></div>
          <div>
            <h1>OBEARCO ‚Ä¢ Gate of Accounts</h1>
            <div class="sub">Conectado ao portal: <span id="baseLabel" class="muted">‚Äî</span></div>
          </div>
        </div>

        <div class="row">
          <button class="btn ghost" id="btnSync">üîÑ Sync status.json</button>
          <button class="btn" id="btnPing">‚òê Ping</button>
          <button class="btn" id="btnWho">üëÅÔ∏è Whoami</button>
        </div>
      </div>

      <!-- PORTAL TAB -->
      <div class="section" data-view="portal">
        <div class="sectionHead">
          <div>
            <h2>PORTAL</h2>
            <p>Login/Registro usando <b>/api/v1/cmd</b>. (Base vem do server_status.json)</p>
          </div>
          <div class="row">
            <span class="pill" id="statusServer">status: ?</span>
          </div>
        </div>
        <div class="sectionBody">
          <div class="portalHero">
            <div class="t">
              <b>‚öîÔ∏è Portal do Aventureiro</b>
              <span>Escolha <b>Login</b> ou <b>Registro</b> e forje sua entrada no reino.</span>
            </div>
            <div class="row">
              <button class="btn gold" id="tabLoginBtn">üîë Login</button>
              <button class="btn ghost" id="tabRegisterBtn">üßæ Registro</button>
            </div>
          </div>

          <!-- ‚úÖ AQUI: UMA TELA S√ì + ABAS -->
          <div class="authShell">
            <div class="authTabs">
              <button class="tabBtn active" id="innerTabLogin">üîë Login</button>
              <button class="tabBtn" id="innerTabRegister">üßæ Registro</button>
            </div>

            <div class="authInner oneCol" id="authInner">
              <!-- LOGIN PANE -->
              <div class="pane" id="paneLogin">
                <h3>Login</h3>
                <p>Use username ou email no campo <b>login</b>.</p>

                <div class="form">
                  <div class="field">
                    <label>LOGIN (EMAIL OU USERNAME)</label>
                    <input class="input" id="login_login" placeholder="ex: Gustavo ou gustavo@email.com" />
                  </div>
                  <div class="field">
                    <label>SENHA</label>
                    <input class="input" id="login_senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                  </div>
                  <div class="actions">
                    <button class="btn gold" id="doLogin">üîë Entrar</button>
                    <button class="btn" id="clearToken">üßπ Limpar token</button>
                  </div>
                  <div class="muted" style="font-size:12px;">
                    Token ser√° salvo localmente (localStorage) para as abas Perfil/Conta.
                  </div>
                </div>
              </div>

              <!-- REGISTER PANE -->
              <div class="pane hidden" id="paneRegister">
                <h3>Registro</h3>
                <p>Cria conta na tabela <b>contas</b> usando os campos do teu backend.</p>

                <div class="form">
                  <div class="field">
                    <label>USERNAME</label>
                    <input class="input" id="reg_user" placeholder="ex: Gustavo_42" />
                  </div>
                  <div class="field">
                    <label>EMAIL</label>
                    <input class="input" id="reg_email" placeholder="ex: voce@email.com" />
                  </div>
                  <div class="field">
                    <label>SENHA</label>
                    <input class="input" id="reg_senha" type="password" placeholder="m√≠nimo 6 chars" />
                  </div>
                  <div class="actions">
                    <button class="btn gold" id="doRegister">üßæ Registrar</button>
                  </div>
                  <div class="muted" style="font-size:12px;">
                    Depois do registro, volte pro Login e entre.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="section" style="border-radius:22px;">
            <div class="sectionHead">
              <div>
                <h2>API / Token</h2>
                <p class="muted">Base atual (do status.json): <span id="baseEcho">‚Äî</span></p>
              </div>
              <div class="row">
                <span class="pill" id="apiPrefix">/api/v1</span>
              </div>
            </div>
            <div class="sectionBody">
              <div class="muted" style="font-size:12px; line-height:1.5">
                Se o bot√£o <b>Sync status.json</b> n√£o atualizar, o problema quase sempre √©:
                <b>URL errada (blob)</b> ou <b>cache</b>. Aqui j√° est√° corrigido (RAW + cache-bust).
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- TAVERNA TAB -->
      <div class="section hidden" data-view="taverna">
        <div class="sectionHead">
          <div>
            <h2>TAVERNA</h2>
            <p>Lista de nicks (precisa endpoint no servidor pra listar contas).</p>
          </div>
          <div class="row">
            <button class="btn ghost" id="refreshTaverna">üîÑ Atualizar</button>
          </div>
        </div>
        <div class="sectionBody">
          <div class="muted" style="font-size:12px;">
            Hoje teu backend n√£o tem ‚Äú/list users‚Äù. Quando voc√™ criar um comando tipo <b>/listusers</b>,
            eu ligo aqui em 30s.
          </div>
        </div>
      </div>

      <!-- PERFIL TAB -->
      <div class="section hidden" data-view="perfil">
        <div class="sectionHead">
          <div>
            <h2>PERFIL</h2>
            <p>Token vis√≠vel + bot√£o copiar + whoami.</p>
          </div>
          <div class="row">
            <button class="btn ghost" id="btnCopyToken">üìã Copiar token</button>
          </div>
        </div>
        <div class="sectionBody">
          <div class="field" style="max-width:780px;">
            <label>TOKEN (VIS√çVEL)</label>
            <input class="input" id="tokenBox" placeholder="(fa√ßa login para gerar)" />
          </div>
          <div style="height:10px"></div>
          <button class="btn" id="btnWho2">üëÅÔ∏è Whoami</button>
          <pre id="whoOut" style="
            margin-top:12px;
            padding:14px;
            border-radius:18px;
            background: rgba(0,0,0,.22);
            border:1px solid rgba(255,255,255,.10);
            overflow:auto;
            max-height:260px;
          " class="muted">{}</pre>
        </div>
      </div>

      <!-- CONTA TAB -->
      <div class="section hidden" data-view="conta">
        <div class="sectionHead">
          <div>
            <h2>CONTA</h2>
            <p>Editar email/senha/nome + deletar (quando existir comando no servidor).</p>
          </div>
        </div>
        <div class="sectionBody">
          <div class="muted" style="font-size:12px; line-height:1.6">
            No teu <b>Comandos.py</b> atual voc√™ ainda n√£o tem os comandos de update/delete.
            Quando voc√™ adicionar algo como:
            <b>/updateaccount</b> e <b>/deleteaccount</b>,
            eu conecto aqui com confirma√ß√£o + delay 5s do bot√£o.
          </div>
        </div>
      </div>

    </div>

    <!-- RIGHT PANEL -->
    <div class="card right">
      <div class="notesCard">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <h3>PATCH NOTES</h3>
          <button class="btn gold" id="btnPatch">‚ú® Atualizar</button>
        </div>

        <div style="height:10px"></div>

        <div class="noteBox">
          <div style="font-size:18px;">üêß</div>
          <div>
            <b>Cr√¥nicas do Reino</b>
            <span>Coluna fixa do lado, estilo ‚Äúsite AAA‚Äù. Voc√™ troca o texto quando quiser.</span>
          </div>
        </div>

        <ul class="smallList" id="patchList">
          <li class="muted">Carregando‚Ä¶</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* =========================
   CONFIG: status.json RAW
   =========================
   Troque apenas se mudar repo/arquivo.
*/
const STATUS_RAW_URL = "https://raw.githubusercontent.com/NoSense-Bot/Servidor/main/server_status.json";

/* =========================
   State
   ========================= */
let API_BASE = "http://127.0.0.1:7776";
const API_PREFIX = "/api/v1";
const LS_TOKEN_KEY = "obearco_token";

/* =========================
   Helpers UI
   ========================= */
const $ = (id)=>document.getElementById(id);
function toast(msg, good=true){
  const t = $("toast");
  t.textContent = msg;
  t.classList.add("show");
  t.style.borderColor = good ? "rgba(72,240,166,.35)" : "rgba(255,90,122,.35)";
  setTimeout(()=>t.classList.remove("show"), 1800);
}
function setBase(base){
  API_BASE = (base||"").replace(/\/+$/,"") || API_BASE;
  $("baseLabel").textContent = API_BASE;
  $("baseEcho").textContent = API_BASE;
  $("pillBase").textContent = API_BASE.replace(/^https?:\/\//,"");
}
function getToken(){ return localStorage.getItem(LS_TOKEN_KEY) || ""; }
function setToken(t){
  if(!t){ localStorage.removeItem(LS_TOKEN_KEY); }
  else{ localStorage.setItem(LS_TOKEN_KEY, t); }
  $("tokenBox").value = getToken();
}
function authHeaders(){
  const tok = getToken();
  return tok ? { "Authorization": "Bearer " + tok } : {};
}

/* =========================
   Fetch status.json (RAW + cache-bust)
   ========================= */
async function syncStatus(){
  try{
    const url = STATUS_RAW_URL + "?t=" + Date.now();
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) throw new Error("HTTP " + r.status);
    const js = await r.json();

    // teu status.json tem url_api_base
    if(js.url_api_base) setBase(js.url_api_base);
    $("statusServer").textContent = "status: " + (js.status_servidor || "??");
    toast("status.json sincronizado ‚úÖ", true);

    // patch notes simples (exemplo)
    const now = new Date();
    $("patchList").innerHTML = `
      <li><b>Atualizado</b> em ${now.toLocaleString("pt-BR")}</li>
      <li>‚Ä¢ Portal de contas (medieval/anime)</li>
      <li>‚Ä¢ Abas internas Login/Registro (1 tela)</li>
      <li>‚Ä¢ RAW status.json + anti-cache</li>
      <li class="muted">Pr√≥ximo: /listusers, /updateaccount, /deleteaccount</li>
    `;
  }catch(e){
    toast("Falhou puxar status.json: " + e.message, false);
  }
}

/* =========================
   API helpers
   ========================= */
async function apiCmd(payload){
  const url = API_BASE + API_PREFIX + "/cmd";
  const r = await fetch(url, {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      ...authHeaders(),
    },
    body: JSON.stringify(payload),
  });
  const js = await r.json().catch(()=>({ok:false,error:"Resposta inv√°lida"}));
  return { ok: r.ok && js.ok, http_ok:r.ok, data: js };
}

/* =========================
   Tabs (sidebar)
   ========================= */
function setView(tab){
  document.querySelectorAll("[data-view]").forEach(v=>{
    v.classList.toggle("hidden", v.getAttribute("data-view") !== tab);
  });
  document.querySelectorAll(".navItem").forEach(n=>{
    n.classList.toggle("active", n.getAttribute("data-tab") === tab);
  });
}

/* =========================
   Inner auth tabs (ONE SCREEN)
   ========================= */
function setAuthTab(which){
  const isLogin = which === "login";
  $("innerTabLogin").classList.toggle("active", isLogin);
  $("innerTabRegister").classList.toggle("active", !isLogin);
  $("paneLogin").classList.toggle("hidden", !isLogin);
  $("paneRegister").classList.toggle("hidden", isLogin);

  // top quick buttons keep same feel
  $("tabLoginBtn").classList.toggle("gold", isLogin);
  $("tabLoginBtn").classList.toggle("ghost", !isLogin);
  $("tabRegisterBtn").classList.toggle("gold", !isLogin);
  $("tabRegisterBtn").classList.toggle("ghost", isLogin);
}

/* =========================
   Actions
   ========================= */
async function doPing(){
  const res = await apiCmd({ comando:"/ping" });
  if(res.ok) toast("pong ‚úÖ", true);
  else toast(res.data.error || "ping falhou", false);
}
async function doWho(){
  const res = await apiCmd({ comando:"/whoami" });
  $("whoOut").textContent = JSON.stringify(res.data, null, 2);
  toast(res.ok ? "whoami ok ‚úÖ" : "whoami falhou", res.ok);
}
async function doLogin(){
  const login = $("login_login").value.trim();
  const senha = $("login_senha").value.trim();
  const res = await apiCmd({ comando:"/login", login, senha });
  if(res.ok){
    const tok = res.data.session_token || "";
    setToken(tok);
    $("tokenBox").value = tok;
    toast("Login ok ‚úÖ token salvo", true);
  }else{
    toast(res.data.error || "login falhou", false);
  }
}
async function doRegister(){
  const username = $("reg_user").value.trim();
  const email = $("reg_email").value.trim();
  const senha = $("reg_senha").value.trim();
  const res = await apiCmd({ comando:"/register", username, email, senha });
  toast(res.ok ? "Conta criada ‚úÖ" : (res.data.error || "registro falhou"), res.ok);
  if(res.ok){
    setAuthTab("login");
    $("login_login").value = username || email;
    $("login_senha").value = senha;
  }
}

/* =========================
   Copy
   ========================= */
async function copyToken(){
  const tok = getToken();
  if(!tok) return toast("Sem token ainda.", false);
  try{
    await navigator.clipboard.writeText(tok);
    toast("Token copiado üìã", true);
  }catch{
    // fallback
    $("tokenBox").focus();
    $("tokenBox").select();
    document.execCommand("copy");
    toast("Token copiado üìã", true);
  }
}

/* =========================
   VFX Canvas (particles + embers)
   ========================= */
function startVFX(){
  const c = $("vfx");
  const ctx = c.getContext("2d");
  let W=0,H=0, DPR=Math.min(2, window.devicePixelRatio||1);
  const particles = [];
  const embers = [];

  function resize(){
    W = window.innerWidth;
    H = window.innerHeight;
    c.width = Math.floor(W*DPR);
    c.height = Math.floor(H*DPR);
    c.style.width = W+"px";
    c.style.height = H+"px";
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  window.addEventListener("resize", resize);
  resize();

  function rnd(a,b){ return a + Math.random()*(b-a); }

  for(let i=0;i<70;i++){
    particles.push({
      x:rnd(0,W), y:rnd(0,H),
      r:rnd(1,3.2),
      vx:rnd(-.15,.15), vy:rnd(-.08,.10),
      a:rnd(.08,.22),
      hue: Math.random()<.5 ? "rgba(157,123,255," : "rgba(92,224,216,"
    });
  }
  for(let i=0;i<30;i++){
    embers.push({
      x:rnd(0,W), y:rnd(H*0.25,H),
      r:rnd(1,2.6),
      vx:rnd(-.05,.05), vy:rnd(-.35,-.12),
      a:rnd(.06,.16),
    });
  }

  let t=0;
  function tick(){
    t+=1;
    ctx.clearRect(0,0,W,H);

    // soft vignette
    const g = ctx.createRadialGradient(W*0.5,H*0.55, 80, W*0.5,H*0.55, Math.max(W,H)*0.75);
    g.addColorStop(0, "rgba(0,0,0,0)");
    g.addColorStop(1, "rgba(0,0,0,.55)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    // particles
    for(const p of particles){
      p.x += p.vx; p.y += p.vy;
      if(p.x< -20) p.x=W+20;
      if(p.x> W+20) p.x=-20;
      if(p.y< -20) p.y=H+20;
      if(p.y> H+20) p.y=-20;

      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fillStyle = p.hue + p.a + ")";
      ctx.fill();
    }

    // embers (gold)
    for(const e of embers){
      e.x += e.vx + Math.sin((t+e.x)*0.003)*0.08;
      e.y += e.vy;
      if(e.y < -40){
        e.y = H + rnd(20,120);
        e.x = rnd(0,W);
      }
      ctx.beginPath();
      ctx.arc(e.x, e.y, e.r, 0, Math.PI*2);
      ctx.fillStyle = "rgba(214,180,106,"+e.a+")";
      ctx.fill();
    }

    requestAnimationFrame(tick);
  }
  tick();
}

/* =========================
   Wire up
   ========================= */
document.addEventListener("click", (e)=>{
  const item = e.target.closest(".navItem");
  if(item){
    setView(item.getAttribute("data-tab"));
  }
});

$("btnSync").onclick = syncStatus;
$("btnPatch").onclick = syncStatus;
$("btnPing").onclick = doPing;
$("btnWho").onclick = doWho;

$("tabLoginBtn").onclick = ()=>setAuthTab("login");
$("tabRegisterBtn").onclick = ()=>setAuthTab("register");
$("innerTabLogin").onclick = ()=>setAuthTab("login");
$("innerTabRegister").onclick = ()=>setAuthTab("register");

$("doLogin").onclick = doLogin;
$("doRegister").onclick = doRegister;
$("clearToken").onclick = ()=>{ setToken(""); toast("Token limpo.", true); };

$("btnCopyToken").onclick = copyToken;
$("btnWho2").onclick = doWho;
$("refreshTaverna").onclick = ()=>toast("Falta comando /listusers no servidor.", false);

/* init */
setBase(API_BASE);
$("apiPrefix").textContent = API_PREFIX;
setToken(getToken());
startVFX();
syncStatus();
</script>
</body>
</html>
