<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>NoSense â€¢ Social</title>

  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0b0e14" />

  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%23111827'/%3E%3Cpath d='M18 38c6 10 22 10 28 0' fill='none' stroke='%237c3aed' stroke-width='6' stroke-linecap='round'/%3E%3Ccircle cx='24' cy='26' r='4' fill='%23e5e7eb'/%3E%3Ccircle cx='40' cy='26' r='4' fill='%23e5e7eb'/%3E%3C/svg%3E" />

  <style>
    /* ====== Design Tokens ====== */
    :root{
      --bg: #0b0e14;
      --bg2:#070a10;
      --panel: rgba(17,24,39,.86);
      --panel2: rgba(15,23,42,.72);
      --stroke: rgba(148,163,184,.14);
      --text: #e5e7eb;
      --muted:#94a3b8;
      --brand:#7c3aed;
      --ok:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --r: 18px;
      --r2: 26px;
      --pad: 14px;
      --gap: 14px;
      --max: 1180px;
      --blur: 14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(1000px 700px at 10% 0%, rgba(124,58,237,.30) 0%, rgba(124,58,237,0) 55%),
        radial-gradient(900px 700px at 100% 20%, rgba(34,197,94,.12) 0%, rgba(34,197,94,0) 60%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      overflow-x:hidden;
    }
    a{ color: inherit; text-decoration:none; }
    button, input{ font:inherit; }
    ::selection{ background: rgba(124,58,237,.28); }

    /* Accessibility */
    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; scroll-behavior:auto !important; }
    }

    /* ====== Layout ====== */
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(var(--blur));
      background: rgba(11,14,20,.62);
      border-bottom: 1px solid var(--stroke);
    }
    .topbarInner{
      max-width: var(--max);
      margin:0 auto;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight: 900;
      letter-spacing:.2px;
      min-width: 0;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--bad);
      box-shadow: 0 0 0 4px rgba(239,68,68,.15);
      flex:0 0 auto;
    }
    .dot.ok{ background: var(--ok); box-shadow: 0 0 0 4px rgba(34,197,94,.16); }
    .dot.warn{ background: var(--warn); box-shadow: 0 0 0 4px rgba(245,158,11,.16); }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border: 1px solid var(--stroke);
      background: rgba(17,24,39,.52);
      border-radius: 999px;
      color: var(--muted);
      font-size: 12.5px;
      max-width: 52ch;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .wrap{
      max-width: var(--max);
      margin:0 auto;
      padding: 14px;
    }
    .shell{
      display:grid;
      grid-template-columns: 280px 1fr;
      gap: var(--gap);
      align-items:start;
      padding-top: 6px;
    }
    @media (max-width: 980px){
      .shell{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: var(--pad);
      border-bottom: 1px solid var(--stroke);
    }
    .bd{ padding: var(--pad); }
    .title{ font-weight: 900; }
    .muted{ color: var(--muted); font-size: 13px; }
    .sep{ height:1px; background: var(--stroke); margin: 12px 0; }

    /* ====== Buttons / Inputs ====== */
    .btn{
      border: 1px solid var(--stroke);
      background: rgba(17,24,39,.80);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
      user-select:none;
      display:inline-flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(124,58,237,.42); }
    .btn:active{ transform: translateY(0px) scale(.99); }
    .btn.primary{
      border-color: rgba(124,58,237,.58);
      background: rgba(124,58,237,.18);
    }
    .btn.ghost{ background: rgba(17,24,39,.35); }
    .btn.danger{
      border-color: rgba(239,68,68,.55);
      background: rgba(239,68,68,.12);
    }

    .field{ display:grid; gap:6px; margin: 10px 0; }
    input{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(2,6,23,.35);
      color: var(--text);
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus{
      border-color: rgba(124,58,237,.60);
      box-shadow: 0 0 0 4px rgba(124,58,237,.16);
    }

    /* ====== Sidebar ====== */
    .side{
      position: sticky;
      top: 68px;
    }
    @media (max-width:980px){
      .side{ position: static; }
    }
    .nav{
      display:grid; gap:10px;
    }
    .navItem{
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(2,6,23,.25);
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .navItem:hover{ transform: translateY(-2px); border-color: rgba(124,58,237,.42); }
    .navItem.active{
      border-color: rgba(124,58,237,.60);
      background: rgba(124,58,237,.14);
    }
    .kbd{
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      color: var(--muted);
      background: rgba(17,24,39,.5);
    }

    /* ====== Views ====== */
    .view{ display:none; }
    .view.active{ display:block; }

    /* ====== Auth (centered) ====== */
    .authWrap{
      max-width: 480px;
      margin: 40px auto;
      padding: 0 14px;
    }
    .authWrap .card{ border-radius: var(--r2); }
    .hint{
      white-space: pre-wrap;
      font-size: 13px;
      color: var(--muted);
      margin-top: 10px;
    }

    /* ====== Feed ====== */
    .feedTop{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
    }
    .search{
      flex: 1;
      min-width: 200px;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px;
    }
    @media (max-width:980px){ .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width:560px){ .grid{ grid-template-columns: 1fr; } }

    .userCard{
      border: 1px solid var(--stroke);
      background: rgba(2,6,23,.28);
      border-radius: 16px;
      padding: 12px;
      transition: transform .15s ease, border-color .15s ease;
      will-change: transform;
    }
    .userCard:hover{ transform: translateY(-3px); border-color: rgba(124,58,237,.55); }
    .userTop{ display:flex; align-items:center; gap:10px; min-width:0; }
    .avatar{
      width: 44px; height: 44px;
      border-radius: 16px;
      display:grid; place-items:center;
      background: rgba(124,58,237,.16);
      border: 1px solid rgba(124,58,237,.35);
      font-weight: 900;
      flex:0 0 auto;
    }
    .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:10px; }
    .chip{
      font-size: 12px;
      color: var(--muted);
      border: 1px solid var(--stroke);
      background: rgba(17,24,39,.55);
      padding: 6px 8px;
      border-radius: 999px;
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* ====== Skeleton ====== */
    .skeleton{
      position: relative;
      overflow:hidden;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(2,6,23,.26);
      height: 118px;
    }
    .skeleton::after{
      content:"";
      position:absolute; inset:-40%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent);
      transform: translateX(-40%);
      animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer{
      to{ transform: translateX(40%); }
    }
    @media (prefers-reduced-motion: reduce){
      .skeleton::after{ animation:none; }
    }

    /* ====== Toast ====== */
    .toasts{
      position: fixed;
      inset: auto 14px 14px auto;
      display:grid;
      gap:10px;
      z-index:100;
    }
    .toast{
      width: min(360px, calc(100vw - 28px));
      border: 1px solid var(--stroke);
      background: rgba(17,24,39,.92);
      backdrop-filter: blur(var(--blur));
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 12px;
      transform-origin: 100% 100%;
    }
    .toast b{ display:block; margin-bottom: 2px; }
    .toast .small{ color: var(--muted); font-size: 12.5px; white-space: pre-wrap; }

    /* ====== Bottom nav mobile ====== */
    .bottomNav{
      position: fixed;
      left: 14px; right: 14px; bottom: 14px;
      border: 1px solid var(--stroke);
      background: rgba(17,24,39,.72);
      backdrop-filter: blur(var(--blur));
      border-radius: 18px;
      padding: 8px;
      display:none;
      z-index: 60;
      box-shadow: var(--shadow);
    }
    .bottomNavInner{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:8px;
    }
    .bItem{
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid transparent;
      background: rgba(2,6,23,.20);
      cursor:pointer;
      text-align:center;
      color: var(--muted);
      font-weight: 700;
      transition: transform .15s ease, background .15s ease, color .15s ease, border-color .15s ease;
    }
    .bItem.active{
      color: var(--text);
      border-color: rgba(124,58,237,.55);
      background: rgba(124,58,237,.14);
    }
    .bItem:hover{ transform: translateY(-1px); }
    @media (max-width:980px){
      .bottomNav{ display:block; }
      .wrap{ padding-bottom: 92px; }
    }

    /* View Transitions (progressivo) */
    ::view-transition-old(root), ::view-transition-new(root){ animation-duration: 260ms; }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbarInner">
      <div class="brand" style="min-width:0;">
        <div id="dot" class="dot"></div>
        <div>NoSense â€¢ Social</div>
        <div id="apiPill" class="pill" title="API Base">API: carregandoâ€¦</div>
      </div>

      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn ghost" id="btnRefresh">Recarregar</button>
        <button class="btn" id="btnOpenSettings">Config</button>
        <button class="btn danger" id="btnLogout" style="display:none;">Sair</button>
      </div>
    </div>
  </header>

  <!-- AUTH -->
  <section id="auth" class="authWrap">
    <div class="card">
      <div class="hd">
        <div>
          <div class="title" id="authTitle">Entrar</div>
          <div class="muted" id="authSub">Login/Registro com fallback automÃ¡tico âœ…</div>
        </div>
        <button class="btn" id="btnToggleAuth">Registrar</button>
      </div>

      <div class="bd">
        <div class="field" id="fieldUsuario" style="display:none;">
          <div class="muted">UsuÃ¡rio</div>
          <input id="inpUsuario" placeholder="ex: Guh" autocomplete="username" />
        </div>

        <div class="field">
          <div class="muted">Email</div>
          <input id="inpEmail" placeholder="seu@email.com" autocomplete="email" />
        </div>

        <div class="field">
          <div class="muted">Senha</div>
          <input id="inpSenha" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
        </div>

        <button class="btn primary" id="btnAuthGo" style="width:100%;">Entrar</button>
        <div class="hint" id="authHint"></div>
      </div>
    </div>
  </section>

  <!-- APP -->
  <main id="app" class="wrap" style="display:none;">
    <div class="shell">

      <aside class="side">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Menu</div>
              <div class="muted" id="meMini">â€”</div>
            </div>
          </div>
          <div class="bd">
            <nav class="nav">
              <div class="navItem active" data-route="feed">
                <div>
                  <div style="font-weight:900;">Feed</div>
                  <div class="muted">Todas as contas</div>
                </div>
                <span class="kbd">1</span>
              </div>

              <div class="navItem" data-route="profile">
                <div>
                  <div style="font-weight:900;">Perfil</div>
                  <div class="muted">Sua sessÃ£o</div>
                </div>
                <span class="kbd">2</span>
              </div>

              <div class="navItem" data-route="settings">
                <div>
                  <div style="font-weight:900;">Config</div>
                  <div class="muted">API / Feed</div>
                </div>
                <span class="kbd">3</span>
              </div>
            </nav>
          </div>
        </div>
      </aside>

      <section class="card">
        <div class="hd" id="viewHeader">
          <div>
            <div class="title" id="viewTitle">Feed</div>
            <div class="muted" id="viewSub">Carregandoâ€¦</div>
          </div>
          <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn" id="btnReloadView">Atualizar</button>
          </div>
        </div>

        <div class="bd">
          <!-- FEED -->
          <div class="view active" id="view_feed">
            <div class="feedTop">
              <input class="search" id="search" placeholder="Buscar usuÃ¡rio/emailâ€¦" />
              <button class="btn" id="btnFeedRefresh">Atualizar feed</button>
            </div>
            <div class="sep"></div>

            <div id="feedGrid" class="grid"></div>
            <div class="hint" id="feedHint"></div>
          </div>

          <!-- PROFILE -->
          <div class="view" id="view_profile">
            <div class="title">Sua sessÃ£o</div>
            <div class="muted">Token fica salvo no navegador (localStorage) ðŸ™‚</div>

            <div class="sep"></div>

            <div class="muted">session_token</div>
            <div class="pill" id="tokenPill" style="max-width:100%;">â€”</div>

            <div class="sep"></div>
            <div class="hint" id="profileHint">â€”</div>
          </div>

          <!-- SETTINGS -->
          <div class="view" id="view_settings">
            <div class="title">ConfiguraÃ§Ãµes</div>
            <div class="muted">Pra GitHub Pages funcionar suave ðŸ˜„</div>

            <div class="sep"></div>

            <div class="muted">API detectada (GitHub server_status.json)</div>
            <div class="pill" id="detectedPill" style="max-width:100%;">â€”</div>

            <div class="sep"></div>

            <div class="muted">API override (se o JSON vier localhost/http)</div>
            <div class="field">
              <input id="inpApiOverride" placeholder="https://xxxx.trycloudflare.com" />
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn primary" id="btnSaveApi">Salvar</button>
              <button class="btn" id="btnClearApi">Limpar</button>
            </div>

            <div class="sep"></div>

            <div class="muted">Feed endpoint (opcional)</div>
            <div class="field">
              <input id="inpFeedEp" placeholder="/api/social/users" />
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn primary" id="btnSaveFeed">Salvar</button>
              <button class="btn" id="btnResetFeed">Reset</button>
            </div>

            <div class="hint" id="settingsHint"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Bottom nav (mobile) -->
  <div class="bottomNav" aria-hidden="true">
    <div class="bottomNavInner">
      <button class="bItem active" data-route="feed">Feed</button>
      <button class="bItem" data-route="profile">Perfil</button>
      <button class="bItem" data-route="settings">Config</button>
    </div>
  </div>

  <div class="toasts" id="toasts"></div>

<script>
(() => {
  // ===== Utils =====
  const $ = (q, el=document) => el.querySelector(q);
  const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));

  const LS = {
    token: "ns_session_token",
    apiOverride: "ns_api_override",
    feedEp: "ns_feed_endpoint"
  };

  const GITHUB_OWNER = "NoSense-Bot";
  const GITHUB_REPO  = "Servidor";
  const STATUS_PATH  = "server_status.json";
  const RAW_URL = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/main/${STATUS_PATH}`;
  const CONTENTS_URL = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${STATUS_PATH}`;

  const DEFAULT_FEED_EP = "/api/social/users";

  const state = {
    mode: "login",
    apiDetected: null,
    apiBase: null,
    statusOk: false,
    token: localStorage.getItem(LS.token) || "",
    me: null,
    feed: [],
    feedEp: localStorage.getItem(LS.feedEp) || DEFAULT_FEED_EP,
  };

  const el = {
    dot: $("#dot"),
    apiPill: $("#apiPill"),
    btnRefresh: $("#btnRefresh"),
    btnOpenSettings: $("#btnOpenSettings"),
    btnLogout: $("#btnLogout"),

    auth: $("#auth"),
    app: $("#app"),

    authTitle: $("#authTitle"),
    authSub: $("#authSub"),
    btnToggleAuth: $("#btnToggleAuth"),
    btnAuthGo: $("#btnAuthGo"),
    authHint: $("#authHint"),
    fieldUsuario: $("#fieldUsuario"),
    inpUsuario: $("#inpUsuario"),
    inpEmail: $("#inpEmail"),
    inpSenha: $("#inpSenha"),

    meMini: $("#meMini"),

    viewTitle: $("#viewTitle"),
    viewSub: $("#viewSub"),
    btnReloadView: $("#btnReloadView"),

    view_feed: $("#view_feed"),
    view_profile: $("#view_profile"),
    view_settings: $("#view_settings"),

    feedGrid: $("#feedGrid"),
    feedHint: $("#feedHint"),
    btnFeedRefresh: $("#btnFeedRefresh"),
    search: $("#search"),

    tokenPill: $("#tokenPill"),
    profileHint: $("#profileHint"),

    detectedPill: $("#detectedPill"),
    inpApiOverride: $("#inpApiOverride"),
    btnSaveApi: $("#btnSaveApi"),
    btnClearApi: $("#btnClearApi"),
    inpFeedEp: $("#inpFeedEp"),
    btnSaveFeed: $("#btnSaveFeed"),
    btnResetFeed: $("#btnResetFeed"),
    settingsHint: $("#settingsHint"),

    toasts: $("#toasts"),
  };

  function toast(title, msg, type="info"){
    const n = document.createElement("div");
    n.className = "toast";
    n.innerHTML = `<b>${escapeHtml(title)}</b><div class="small">${escapeHtml(msg)}</div>`;
    el.toasts.appendChild(n);

    // WAAPI (rÃ¡pido e suave) :contentReference[oaicite:1]{index=1}
    try {
      n.animate(
        [
          { transform: "translateY(8px) scale(.98)", opacity: 0 },
          { transform: "translateY(0px) scale(1)", opacity: 1 }
        ],
        { duration: 220, easing: "cubic-bezier(.2,.8,.2,1)" }
      );
    } catch {}

    setTimeout(() => {
      try {
        const a = n.animate(
          [
            { transform: "translateY(0px) scale(1)", opacity: 1 },
            { transform: "translateY(8px) scale(.98)", opacity: 0 }
          ],
          { duration: 220, easing: "cubic-bezier(.2,.8,.2,1)" }
        );
        a.onfinish = () => n.remove();
      } catch { n.remove(); }
    }, 3200);
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function normalizeApi(url){
    if (!url) return null;
    url = String(url).trim();
    if (!/^https?:\/\//i.test(url)) return null;
    return url.replace(/\/+$/, "");
  }

  function initials(name){
    const t = String(name || "?").trim();
    return (t[0] || "?").toUpperCase();
  }

  function isLikelyBlockedFetch(err){
    const m = String(err?.message || err || "");
    return m.includes("Failed to fetch") || m.includes("NetworkError");
  }

  async function fetchWithTimeout(url, opts={}, ms=9000){
    const c = new AbortController();
    const t = setTimeout(() => c.abort("timeout"), ms);
    try{
      const r = await fetch(url, { ...opts, signal: c.signal });
      return r;
    } finally{
      clearTimeout(t);
    }
  }

  function b64ToText(b64){
    // remove quebras + padding
    let s = String(b64 || "").replace(/\n/g, "");
    const pad = s.length % 4;
    if (pad) s += "=".repeat(4 - pad);
    return atob(s);
  }

  // ===== GitHub status.json resolver =====
  async function loadStatusFromGithub(){
    // RAW (JSON direto) â€” normalmente CORS ok :contentReference[oaicite:2]{index=2}
    try{
      const r = await fetchWithTimeout(RAW_URL + "?v=" + Date.now(), { cache:"no-store" }, 9000);
      if (r.ok){
        const j = await r.json();
        const api = normalizeApi(j?.url_api_base);
        if (api) return { api, src: "raw" };
      }
    } catch {}

    // Contents API (content base64) :contentReference[oaicite:3]{index=3}
    const r2 = await fetchWithTimeout(CONTENTS_URL + "?v=" + Date.now(), {
      cache:"no-store",
      headers: { "Accept": "application/vnd.github+json" }
    }, 9000);

    if (!r2.ok) throw new Error("Falha lendo server_status.json do GitHub (HTTP " + r2.status + ")");
    const data = await r2.json();
    const txt = b64ToText(data?.content || "");
    const j = JSON.parse(txt);
    const api = normalizeApi(j?.url_api_base);
    if (!api) throw new Error("url_api_base nÃ£o encontrado no server_status.json");
    return { api, src: "contents" };
  }

  // ===== API calls (fallback-friendly) =====
  async function apiFetch(path, opts={}){
    if (!state.apiBase) throw new Error("API nÃ£o definida");
    const url = state.apiBase + path;
    const headers = { "Content-Type":"application/json", ...(opts.headers || {}) };
    const r = await fetchWithTimeout(url, { ...opts, headers }, 12000);
    const ct = r.headers.get("content-type") || "";
    const body = ct.includes("application/json") ? await r.json().catch(()=>null) : await r.text().catch(()=>null);

    if (!r.ok){
      const msg = body?.error || ("HTTP " + r.status);
      const e = new Error(msg);
      e.status = r.status;
      throw e;
    }
    return body;
  }

  async function ping(){
    try{
      const r = await fetchWithTimeout(state.apiBase + "/api/status", { cache:"no-store" }, 8000);
      return r.ok;
    } catch { return false; }
  }

  async function login(email, password){
    // tenta /api/auth/login -> fallback /login
    try{
      return await apiFetch("/api/auth/login", { method:"POST", body: JSON.stringify({ email, password }) });
    } catch (e){
      if (e.status === 404){
        return await apiFetch("/login", { method:"POST", body: JSON.stringify({ email, password }) });
      }
      throw e;
    }
  }

  async function register(email, password, usuario){
    try{
      return await apiFetch("/api/auth/register", { method:"POST", body: JSON.stringify({ email, password, usuario }) });
    } catch (e){
      if (e.status === 404){
        return await apiFetch("/register", { method:"POST", body: JSON.stringify({ email, password, usuario }) });
      }
      throw e;
    }
  }

  async function validate(token){
    try{
      return await apiFetch("/api/auth/validate", { method:"POST", body: JSON.stringify({ session_token: token }) });
    } catch (e){
      // se nÃ£o existir validate, sÃ³ nÃ£o quebra a UX
      if (e.status === 404) return { ok:true, user_id:"", usuario:"" };
      throw e;
    }
  }

  async function fetchFeed(){
    // 1) GET /api/social/users (ou custom)
    try{
      const r = await apiFetch(state.feedEp, { method:"GET" });
      const users = r?.users ?? r?.result ?? (Array.isArray(r) ? r : []);
      if (Array.isArray(users)) return users;
    } catch (e){
      // continua
    }

    // 2) fallback: POST /api/cmd {comando:"/social/users"}
    const r2 = await apiFetch("/api/cmd", {
      method:"POST",
      body: JSON.stringify({ comando: "/social/users" })
    });
    const users2 = r2?.users ?? r2?.result ?? [];
    if (Array.isArray(users2)) return users2;

    return [];
  }

  // ===== UI: transitions =====
  function viewTransition(updateDOM){
    // View Transition API (progressivo) :contentReference[oaicite:4]{index=4}
    if (document.startViewTransition && !window.matchMedia("(prefers-reduced-motion: reduce)").matches){
      document.startViewTransition(() => updateDOM());
    } else {
      updateDOM();
    }
  }

  function setDot(kind){
    el.dot.classList.remove("ok","warn");
    if (kind === "ok") el.dot.classList.add("ok");
    else if (kind === "warn") el.dot.classList.add("warn");
  }

  function setApiPill(){
    el.apiPill.textContent = "API: " + (state.apiBase || "â€”");
    el.apiPill.title = state.apiBase || "API";
  }

  function showAuth(){
    el.btnLogout.style.display = "none";
    el.app.style.display = "none";
    el.auth.style.display = "";
  }

  function showApp(){
    el.btnLogout.style.display = "";
    el.auth.style.display = "none";
    el.app.style.display = "";
  }

  function setAuthMode(mode){
    state.mode = mode;
    const isReg = mode === "register";
    el.authTitle.textContent = isReg ? "Registrar" : "Entrar";
    el.authSub.textContent = isReg
      ? "Register (tenta /api/auth/register e cai pro /register) ðŸš€"
      : "Login (tenta /api/auth/login e cai pro /login) ðŸ˜„";
    el.btnToggleAuth.textContent = isReg ? "Entrar" : "Registrar";
    el.btnAuthGo.textContent = isReg ? "Registrar" : "Entrar";
    el.fieldUsuario.style.display = isReg ? "" : "none";
    el.authHint.textContent = "";
  }

  function setRoute(route){
    const routes = ["feed","profile","settings"];
    if (!routes.includes(route)) route = "feed";

    viewTransition(() => {
      $$(".navItem").forEach(x => x.classList.toggle("active", x.dataset.route === route));
      $$(".bItem").forEach(x => x.classList.toggle("active", x.dataset.route === route));

      $$(".view").forEach(v => v.classList.remove("active"));
      $("#view_" + route).classList.add("active");

      if (route === "feed"){
        el.viewTitle.textContent = "Feed";
        el.viewSub.textContent = state.feed.length ? `${state.feed.length} contas ðŸ‘¥` : "Todas as contas";
        el.btnReloadView.onclick = refreshFeed;
      }
      if (route === "profile"){
        el.viewTitle.textContent = "Perfil";
        el.viewSub.textContent = "Sua sessÃ£o e status";
        el.btnReloadView.onclick = bootSessionOnly;
      }
      if (route === "settings"){
        el.viewTitle.textContent = "Config";
        el.viewSub.textContent = "API / Feed";
        el.btnReloadView.onclick = boot;
      }
    });

    history.replaceState({}, "", "#"+route);
  }

  // ===== Render feed =====
  function normalizeUser(u){
    const user_id = String(u?.user_id || u?.email || u?.id || u?._id || "");
    const usuario = String(u?.usuario || u?.nick || u?.username || (user_id.includes("@") ? user_id.split("@")[0] : "user"));
    const chars = Array.isArray(u?.personagens) ? u.personagens : (Array.isArray(u?.characters) ? u.characters : []);
    const names = chars.map(c => c?.nick || c?.name || c?.nome || (typeof c === "string" ? c : "Personagem"));
    return { user_id, usuario, names };
  }

  function renderSkeletons(){
    el.feedGrid.innerHTML = "";
    for (let i=0; i<9; i++){
      const s = document.createElement("div");
      s.className = "skeleton";
      el.feedGrid.appendChild(s);
    }
  }

  function renderFeed(){
    const q = (el.search.value || "").trim().toLowerCase();
    const list = state.feed.map(normalizeUser).filter(u => {
      if (!q) return true;
      return u.usuario.toLowerCase().includes(q) || u.user_id.toLowerCase().includes(q);
    });

    el.viewSub.textContent = `${list.length} contas ðŸ‘¥`;
    el.feedHint.textContent = "";

    el.feedGrid.innerHTML = "";
    if (!list.length){
      el.feedHint.textContent = "Nada encontrado ðŸ˜…";
      return;
    }

    list.forEach((u, idx) => {
      const div = document.createElement("div");
      div.className = "userCard";
      div.innerHTML = `
        <div class="userTop">
          <div class="avatar">${initials(u.usuario)}</div>
          <div style="min-width:0;">
            <div style="font-weight:900; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(u.usuario)}</div>
            <div class="muted" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(u.user_id || "â€”")}</div>
          </div>
        </div>
        <div class="chips">
          <span class="chip">${u.names.length} personagem(ns)</span>
          ${u.names.slice(0,4).map(n => `<span class="chip">${escapeHtml(n)}</span>`).join("")}
          ${u.names.length > 4 ? `<span class="chip">+${u.names.length-4}</span>` : ""}
        </div>
      `;

      el.feedGrid.appendChild(div);

      // Entrada com WAAPI (progressivo) :contentReference[oaicite:5]{index=5}
      if (!window.matchMedia("(prefers-reduced-motion: reduce)").matches){
        try{
          div.animate(
            [
              { transform: "translateY(10px) scale(.99)", opacity: 0 },
              { transform: "translateY(0px) scale(1)", opacity: 1 }
            ],
            { duration: 260, easing: "cubic-bezier(.2,.8,.2,1)", delay: Math.min(idx*18, 200) }
          );
        } catch {}
      }
    });
  }

  async function refreshFeed(){
    el.feedHint.textContent = "";
    renderSkeletons();

    try{
      const users = await fetchFeed();
      state.feed = Array.isArray(users) ? users : [];
      renderFeed();
      toast("Feed", "Atualizado âœ…");
    } catch (e){
      const msg = isLikelyBlockedFetch(e)
        ? "Bloqueado pelo navegador/extensÃ£o ou API inacessÃ­vel ðŸ˜µâ€ðŸ’«"
        : (e.message || "Erro");
      el.feedGrid.innerHTML = "";
      el.feedHint.textContent = "âŒ " + msg + "\nDica: Config > API override e tente uma URL https pÃºblica.";
      toast("Erro no feed", msg);
    }
  }

  // ===== Boot =====
  async function boot(){
    el.authHint.textContent = "";
    el.settingsHint.textContent = "";
    el.profileHint.textContent = "â€”";
    el.tokenPill.textContent = state.token || "â€”";
    el.meMini.textContent = "â€”";

    setDot("warn");
    el.apiPill.textContent = "API: carregandoâ€¦";

    try{
      const { api } = await loadStatusFromGithub();
      state.apiDetected = api;

      const override = normalizeApi(localStorage.getItem(LS.apiOverride));
      state.apiBase = override || state.apiDetected;

      setApiPill();

      // settings fields
      el.detectedPill.textContent = state.apiDetected || "â€”";
      el.inpApiOverride.value = override || "";
      el.inpFeedEp.value = state.feedEp;

      // ping
      const ok = await ping();
      state.statusOk = ok;
      setDot(ok ? "ok" : "warn");

      if (!ok){
        el.settingsHint.textContent =
          "âš ï¸ NÃ£o consegui pingar /api/status.\nSe a API detectada for http/localhost, use API override (https pÃºblica).";
      }

      if (state.token){
        await bootSessionOnly();
        showApp();
        setRoute(location.hash.replace("#","") || "feed");
        await refreshFeed();
      } else {
        showAuth();
      }
    } catch (e){
      setDot("warn");
      showAuth();
      const msg = isLikelyBlockedFetch(e)
        ? "Falha de rede (bloqueio/extensÃ£o) ao buscar server_status.json ðŸ˜µâ€ðŸ’«"
        : (e.message || "Erro");
      el.authHint.textContent =
        "âŒ " + msg +
        "\n\nâœ… Dicas:\n- Testa aba anÃ´nima (desliga AdBlock/uBlock/antivÃ­rus web)\n- Confere se o JSON estÃ¡ pÃºblico no GitHub";
      toast("Boot falhou", msg);
    }
  }

  async function bootSessionOnly(){
    try{
      const v = await validate(state.token);
      // se validate existir, usa
      const email = v?.user_id || "";
      const usuario = v?.usuario || (email.includes("@") ? email.split("@")[0] : "user");
      state.me = { email, usuario };
      el.meMini.textContent = state.me.email ? `@${state.me.usuario} â€¢ ${state.me.email}` : `@${state.me.usuario}`;
      el.tokenPill.textContent = state.token || "â€”";
      el.profileHint.textContent = state.statusOk ? "âœ… sessÃ£o ok â€¢ servidor online" : "âš ï¸ sessÃ£o ok â€¢ servidor sem ping";
    } catch (e){
      // sessÃ£o invÃ¡lida
      state.token = "";
      localStorage.removeItem(LS.token);
      state.me = null;
      showAuth();
      toast("SessÃ£o", "SessÃ£o invÃ¡lida, loga de novo ðŸ™");
    }
  }

  // ===== Events =====
  el.btnRefresh.onclick = boot;

  el.btnLogout.onclick = () => {
    state.token = "";
    localStorage.removeItem(LS.token);
    state.me = null;
    toast("Logout", "Saiu âœ…");
    viewTransition(() => showAuth());
    setAuthMode("login");
  };

  el.btnToggleAuth.onclick = () => setAuthMode(state.mode === "login" ? "register" : "login");

  el.btnAuthGo.onclick = async () => {
    const email = (el.inpEmail.value || "").trim();
    const password = (el.inpSenha.value || "").trim();
    const usuario = (el.inpUsuario.value || "").trim();

    if (!email || !password){
      el.authHint.textContent = "âš ï¸ Preenche email e senha";
      return;
    }
    if (state.mode === "register" && !usuario){
      el.authHint.textContent = "âš ï¸ Preenche usuÃ¡rio";
      return;
    }

    try{
      el.authHint.textContent = "â³ enviandoâ€¦";
      const res = state.mode === "register"
        ? await register(email, password, usuario)
        : await login(email, password);

      const token = res?.session_token;
      if (!token) throw new Error("API nÃ£o retornou session_token");

      state.token = token;
      localStorage.setItem(LS.token, state.token);

      toast(state.mode === "register" ? "Registro" : "Login", "Sucesso âœ…");
      viewTransition(() => showApp());
      await bootSessionOnly();
      setRoute("feed");
      await refreshFeed();
    } catch (e){
      const msg = isLikelyBlockedFetch(e)
        ? "Failed to fetch (bloqueio/extensÃ£o ou API inacessÃ­vel)"
        : (e.message || "Erro");
      el.authHint.textContent = "âŒ " + msg;
      toast("Auth", msg);
    }
  };

  el.btnFeedRefresh.onclick = refreshFeed;
  el.search.addEventListener("input", () => renderFeed());

  // Sidebar + bottom nav
  $$(".navItem").forEach(n => n.addEventListener("click", () => setRoute(n.dataset.route)));
  $$(".bItem").forEach(n => n.addEventListener("click", () => setRoute(n.dataset.route)));

  // Settings open goes to settings view (sem modal)
  el.btnOpenSettings.onclick = () => setRoute("settings");

  // Settings actions
  el.btnSaveApi.onclick = () => {
    const v = normalizeApi(el.inpApiOverride.value);
    if (!v){
      el.settingsHint.textContent = "âŒ URL invÃ¡lida. Ex: https://xxxx.trycloudflare.com";
      toast("Config", "URL invÃ¡lida");
      return;
    }
    localStorage.setItem(LS.apiOverride, v);
    el.settingsHint.textContent = "âœ… Salvo! Clica Recarregar.";
    toast("Config", "API override salva âœ…");
  };

  el.btnClearApi.onclick = () => {
    localStorage.removeItem(LS.apiOverride);
    el.inpApiOverride.value = "";
    el.settingsHint.textContent = "âœ… Override removido! Clica Recarregar.";
    toast("Config", "Override removido âœ…");
  };

  el.btnSaveFeed.onclick = () => {
    const v = (el.inpFeedEp.value || "").trim();
    if (!v.startsWith("/")){
      el.settingsHint.textContent = "âŒ Endpoint precisa comeÃ§ar com /";
      toast("Config", "Endpoint invÃ¡lido");
      return;
    }
    state.feedEp = v;
    localStorage.setItem(LS.feedEp, state.feedEp);
    el.settingsHint.textContent = "âœ… Feed endpoint salvo! Vai em Feed e Atualiza.";
    toast("Config", "Feed endpoint salvo âœ…");
  };

  el.btnResetFeed.onclick = () => {
    state.feedEp = DEFAULT_FEED_EP;
    localStorage.setItem(LS.feedEp, state.feedEp);
    el.inpFeedEp.value = state.feedEp;
    el.settingsHint.textContent = "âœ… Resetado pro padrÃ£o.";
    toast("Config", "Reset âœ…");
  };

  // Keyboard shortcuts 1/2/3
  window.addEventListener("keydown", (e) => {
    if (e.target && ["INPUT","TEXTAREA"].includes(e.target.tagName)) return;
    if (e.key === "1") setRoute("feed");
    if (e.key === "2") setRoute("profile");
    if (e.key === "3") setRoute("settings");
  });

  // Start
  setAuthMode("login");
  boot();
})();
</script>
</body>
</html>
