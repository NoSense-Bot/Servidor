<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NoSense â€¢ Social</title>

  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%23111827'/%3E%3Cpath d='M18 38c6 10 22 10 28 0' fill='none' stroke='%237c3aed' stroke-width='6' stroke-linecap='round'/%3E%3Ccircle cx='24' cy='26' r='4' fill='%23e5e7eb'/%3E%3Ccircle cx='40' cy='26' r='4' fill='%23e5e7eb'/%3E%3C/svg%3E" />

  <style>
    :root{
      --bg:#0b0e14; --panel:#111827; --panel2:#0f172a;
      --text:#e5e7eb; --muted:#9ca3af; --line:#1f2937;
      --ok:#22c55e; --bad:#ef4444; --brand:#7c3aed;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r: 16px; --pad: 14px; --gap: 14px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:radial-gradient(1200px 800px at 10% 0%, #1b1238 0%, transparent 50%), var(--bg); color:var(--text); }
    button, input{ font:inherit; }

    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 14px; border-bottom:1px solid var(--line);
      background:rgba(11,14,20,.75); backdrop-filter: blur(10px);
    }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:900; }
    .dot{ width:10px; height:10px; border-radius:999px; background:var(--bad); box-shadow:0 0 0 4px rgba(239,68,68,.15); }
    .dot.ok{ background:var(--ok); box-shadow:0 0 0 4px rgba(34,197,94,.15); }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border:1px solid var(--line);
      background:rgba(17,24,39,.6); border-radius:999px;
      color:var(--muted); font-size:13px;
      max-width:520px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .btn{
      border:1px solid var(--line);
      background:rgba(17,24,39,.9);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s transform ease;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.primary{ border-color:rgba(124,58,237,.55); background:rgba(124,58,237,.18); }
    .btn.danger{ border-color:rgba(239,68,68,.5); background:rgba(239,68,68,.14); }

    .wrap{ max-width:1100px; margin:0 auto; padding:14px; }
    .grid{ display:grid; gap:var(--gap); grid-template-columns: 340px 1fr; align-items:start; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(17,24,39,.9), rgba(15,23,42,.75));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: var(--pad);
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .bd{ padding: var(--pad); }
    .title{ font-weight:900; }
    .muted{ color:var(--muted); font-size:13px; }
    .sep{ height:1px; background:var(--line); margin:10px 0; }
    .toast{ margin-top:10px; font-size:13px; color:var(--muted); }

    .auth{ max-width:460px; margin:40px auto; padding:0 14px; }
    .auth .card{ border-radius:20px; }
    .field{ display:grid; gap:6px; margin:10px 0; }
    input{
      width:100%; padding:12px 12px; border-radius:12px;
      border:1px solid var(--line); background:rgba(2,6,23,.45);
      color:var(--text); outline:none;
    }
    input:focus{ border-color:rgba(124,58,237,.6); box-shadow:0 0 0 4px rgba(124,58,237,.15); }

    .feedGrid{ display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:12px; }
    @media (max-width: 980px){ .feedGrid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 520px){ .feedGrid{ grid-template-columns: 1fr; } }

    .userCard{
      border:1px solid var(--line); background:rgba(2,6,23,.35);
      border-radius:14px; padding:12px; cursor:pointer;
      transition:.15s transform ease, .15s border-color ease;
    }
    .userCard:hover{ transform: translateY(-2px); border-color:rgba(124,58,237,.55); }
    .userTop{ display:flex; gap:10px; align-items:center; }
    .avatar{
      width:42px; height:42px; border-radius:14px;
      display:grid; place-items:center;
      background:rgba(124,58,237,.18);
      border:1px solid rgba(124,58,237,.35);
      font-weight:900;
    }
    .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:10px; }
    .chip{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      background:rgba(17,24,39,.6);
      padding:6px 8px; border-radius:999px;
      max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }

    /* Modal simples */
    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:14px;
    }
    .modal{
      width:min(560px, 100%);
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(17,24,39,.98), rgba(15,23,42,.95));
      border-radius:18px; box-shadow: var(--shadow);
      overflow:hidden;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <div class="dot" id="serverDot"></div>
      <div>NoSense â€¢ Social</div>
      <div class="pill" id="apiPill">API: carregandoâ€¦</div>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <button class="btn" id="btnReload">Recarregar</button>
      <button class="btn danger" id="btnLogout" style="display:none;">Sair</button>
    </div>
  </div>

  <!-- AUTH -->
  <section class="auth" id="authView">
    <div class="card">
      <div class="hd">
        <div>
          <div class="title" id="authTitle">Entrar</div>
          <div class="muted" id="authSub">Login via /api/auth/login ðŸ˜„</div>
        </div>
        <button class="btn" id="btnToggleAuth">Registrar</button>
      </div>

      <div class="bd">
        <div class="field" id="userField" style="display:none;">
          <div class="muted">UsuÃ¡rio</div>
          <input id="inpUser" placeholder="ex: Guh" />
        </div>

        <div class="field">
          <div class="muted">Email</div>
          <input id="inpEmail" placeholder="seu@email.com" />
        </div>

        <div class="field">
          <div class="muted">Senha</div>
          <input id="inpPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>

        <button class="btn primary" id="btnAuthGo" style="width:100%;">Entrar</button>
        <div class="toast" id="authToast"></div>
      </div>
    </div>
  </section>

  <!-- APP -->
  <section class="wrap" id="appView" style="display:none;">
    <div class="grid">

      <div class="card">
        <div class="hd">
          <div>
            <div class="title">Meu perfil</div>
            <div class="muted" id="meMini">â€”</div>
          </div>
        </div>
        <div class="bd">
          <div class="muted">session_token</div>
          <div class="pill" id="tokenPill" title="session_token">â€”</div>
          <div class="sep"></div>
          <div class="muted">Status</div>
          <div class="toast" id="meToast">â€”</div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <div class="title">Feed</div>
            <div class="muted" id="feedInfo">Carregandoâ€¦</div>
          </div>
          <button class="btn" id="btnRefreshFeed">Atualizar</button>
        </div>
        <div class="bd">
          <div class="feedGrid" id="feedGrid"></div>
          <div class="toast" id="feedToast"></div>
        </div>
      </div>

    </div>
  </section>

  <!-- Modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="hd" style="padding:14px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div class="title" id="mTitle">Conta</div>
          <div class="muted" id="mSub">â€”</div>
        </div>
        <button class="btn" id="mClose">Fechar</button>
      </div>
      <div class="bd" style="padding:14px;">
        <div class="muted">Personagens</div>
        <div class="sep"></div>
        <div id="mChars" class="chips"></div>
      </div>
    </div>
  </div>

<script>
  const el = (id) => document.getElementById(id);
  const setToast = (id, msg) => el(id).textContent = msg || "";

  let API = null;
  let MODE = "login";
  let TOKEN = localStorage.getItem("ns_session_token") || "";
  let ME = null;

  const statusUrls = [
    new URL("server_status.json", location.href).toString(),
    "https://raw.githubusercontent.com/NoSense-Bot/Servidor/main/server_status.json"
  ];

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  async function loadConfig(){
    let lastErr = null;
    for (const url of statusUrls){
      try{
        const r = await fetch(url, { cache:"no-store" });
        if (!r.ok) { lastErr = new Error("HTTP " + r.status); continue; }
        const cfg = await r.json();
        const api = cfg?.url_api_base;
        if (typeof api === "string" && api.startsWith("http")) return api.replace(/\/+$/,"");
        lastErr = new Error("url_api_base nÃ£o encontrado");
      }catch(e){ lastErr = e; }
    }
    throw lastErr || new Error("Falha lendo server_status.json");
  }

  async function ping(){
    try{
      const r = await fetch(API + "/api/status", { cache:"no-store" });
      return r.ok;
    }catch(_){ return false; }
  }

  async function apiFetch(path, opts = {}){
    const headers = Object.assign({ "Content-Type":"application/json" }, opts.headers || {});
    const r = await fetch(API + path, Object.assign({}, opts, { headers }));
    const ct = r.headers.get("content-type") || "";
    const body = ct.includes("application/json") ? await r.json().catch(()=>null) : await r.text().catch(()=>null);
    if (!r.ok){
      const msg = body?.error || ("HTTP " + r.status);
      throw new Error(msg);
    }
    return body;
  }

  function setAuthMode(mode){
    MODE = mode;
    const isReg = MODE === "register";
    el("authTitle").textContent = isReg ? "Registrar" : "Entrar";
    el("authSub").textContent = isReg ? "Register via /api/auth/register ðŸš€" : "Login via /api/auth/login ðŸ˜„";
    el("btnToggleAuth").textContent = isReg ? "Entrar" : "Registrar";
    el("btnAuthGo").textContent = isReg ? "Registrar" : "Entrar";
    el("userField").style.display = isReg ? "" : "none";
    setToast("authToast","");
  }

  function showAuth(){
    el("authView").style.display = "";
    el("appView").style.display = "none";
    el("btnLogout").style.display = "none";
  }
  function showApp(){
    el("authView").style.display = "none";
    el("appView").style.display = "";
    el("btnLogout").style.display = "";
  }
  function renderMe(){
    el("meMini").textContent = ME ? `@${ME.usuario} â€¢ ${ME.email}` : "â€”";
    el("tokenPill").textContent = TOKEN || "â€”";
  }

  // ===== FEED =====
  function initials(name){ return (name?.trim()?.[0] || "?").toUpperCase(); }

  function normalizeUser(u){
    const user_id = u.user_id || u.email || u.id || u._id || "";
    const usuario = u.usuario || u.nick || u.username || (u.email ? u.email.split("@")[0] : "User");
    const chars = Array.isArray(u.personagens) ? u.personagens : (Array.isArray(u.characters) ? u.characters : []);
    const charNames = chars.map(c => c.nick || c.name || c.nome || "Personagem");
    return { user_id, usuario, charNames, raw:u };
  }

  function openModal(u){
    el("mTitle").textContent = "@" + u.usuario;
    el("mSub").textContent = u.user_id || "â€”";
    const wrap = el("mChars");
    wrap.innerHTML = "";
    if (!u.charNames.length){
      wrap.innerHTML = `<span class="chip">Sem personagens</span>`;
    } else {
      u.charNames.forEach(n => {
        const span = document.createElement("span");
        span.className = "chip";
        span.textContent = n;
        wrap.appendChild(span);
      });
    }
    el("modalBack").style.display = "flex";
  }

  function renderFeed(users){
    const grid = el("feedGrid");
    grid.innerHTML = "";
    const norm = users.map(normalizeUser);

    el("feedInfo").textContent = `${norm.length} contas ðŸ‘¥`;
    norm.forEach(u => {
      const div = document.createElement("div");
      div.className = "userCard";
      div.innerHTML = `
        <div class="userTop">
          <div class="avatar">${initials(u.usuario)}</div>
          <div style="min-width:0;">
            <div style="font-weight:900; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(u.usuario)}</div>
            <div class="muted">${u.charNames.length} personagem(ns)</div>
          </div>
        </div>
        <div class="chips">
          ${(u.charNames.slice(0,4)).map(n => `<span class="chip">${escapeHtml(n)}</span>`).join("")}
          ${u.charNames.length > 4 ? `<span class="chip">+${u.charNames.length-4}</span>` : ""}
        </div>
      `;
      div.onclick = () => openModal(u);
      grid.appendChild(div);
    });
  }

  async function refreshFeed(){
    setToast("feedToast","");
    el("feedInfo").textContent = "Carregandoâ€¦";
    try{
      const res = await apiFetch("/api/social/users", { method:"GET" });
      const users = res?.users || [];
      renderFeed(users);
    }catch(e){
      el("feedInfo").textContent = "âŒ Feed indisponÃ­vel";
      setToast("feedToast", "Backend: cria /api/social/users (cÃ³digo abaixo) ðŸ˜…");
      el("feedGrid").innerHTML = "";
    }
  }

  // ===== BOOT =====
  async function boot(){
    setToast("authToast","");
    el("apiPill").textContent = "API: carregandoâ€¦";
    el("serverDot").classList.remove("ok");

    try{
      API = await loadConfig();
      el("apiPill").textContent = "API: " + API;

      const ok = await ping();
      el("serverDot").classList.toggle("ok", ok);

      if (TOKEN){
        try{
          const v = await apiFetch("/api/auth/validate", {
            method:"POST",
            body: JSON.stringify({ session_token: TOKEN })
          });
          if (!v?.ok) throw new Error("SessÃ£o invÃ¡lida");
          ME = { email: v.user_id, usuario: (v.user_id?.split("@")?.[0] || "user") };
          showApp();
          renderMe();
          setToast("meToast","âœ… sessÃ£o ok");
          await refreshFeed();
          return;
        }catch(_){
          TOKEN = "";
          localStorage.removeItem("ns_session_token");
        }
      }

      showAuth();
    }catch(e){
      showAuth();
      setToast("authToast", "âŒ " + e.message);
    }
  }

  // ===== EVENTS =====
  el("btnToggleAuth").onclick = () => setAuthMode(MODE === "login" ? "register" : "login");

  el("btnAuthGo").onclick = async () => {
    const email = (el("inpEmail").value || "").trim();
    const password = (el("inpPass").value || "").trim();
    const usuario = (el("inpUser").value || "").trim();

    if (!email || !password) return setToast("authToast","âš ï¸ preenche email e senha");
    if (MODE === "register" && !usuario) return setToast("authToast","âš ï¸ preenche usuÃ¡rio");

    try{
      setToast("authToast","â³ enviando...");
      let res;

      if (MODE === "register"){
        res = await apiFetch("/api/auth/register", {
          method:"POST",
          body: JSON.stringify({ email, password, usuario })
        });
      }else{
        res = await apiFetch("/api/auth/login", {
          method:"POST",
          body: JSON.stringify({ email, password })
        });
      }

      const token = res?.session_token;
      if (!token) throw new Error("API nÃ£o retornou session_token ðŸ˜µâ€ðŸ’«");

      TOKEN = token;
      localStorage.setItem("ns_session_token", TOKEN);

      ME = { email, usuario: (MODE === "register" ? usuario : (email.split("@")[0] || "user")) };

      showApp();
      renderMe();
      setToast("meToast","âœ… logado!");
      await refreshFeed();

    }catch(e){
      setToast("authToast", "âŒ " + e.message);
    }
  };

  el("btnLogout").onclick = () => {
    TOKEN = "";
    ME = null;
    localStorage.removeItem("ns_session_token");
    showAuth();
    setAuthMode("login");
  };

  el("btnReload").onclick = () => boot();
  el("btnRefreshFeed").onclick = () => refreshFeed();

  el("mClose").onclick = () => el("modalBack").style.display = "none";
  el("modalBack").onclick = (e) => { if (e.target.id === "modalBack") el("modalBack").style.display = "none"; };

  setAuthMode("login");
  boot();
</script>
</body>
</html>
