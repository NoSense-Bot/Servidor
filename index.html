<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OBEARCO ‚Ä¢ RPG Hub</title>
  <meta name="color-scheme" content="dark light" />

  <style>
    :root{
      --bg:#07090c;
      --panel: rgba(16,20,26,.72);
      --panel2: rgba(12,16,21,.58);
      --glass: rgba(255,255,255,.06);
      --text:#eaf2ff;
      --muted:#a7b4c7;
      --border: rgba(180,210,255,.12);
      --accent:#5aa6ff;
      --accent2:#8b5cf6;
      --ok:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 18px 65px rgba(0,0,0,.45);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1100px 650px at 15% -10%, rgba(90,166,255,.14), transparent 55%),
                  radial-gradient(900px 650px at 95% 5%, rgba(139,92,246,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    a{color:inherit; text-decoration:none}

    /* ===== Background animado ===== */
    #bg{
      position:fixed;
      inset:0;
      z-index:-1;
      opacity:.85;
      filter: saturate(1.1);
    }
    .vignette{
      position:fixed;
      inset:0;
      z-index:-1;
      pointer-events:none;
      background: radial-gradient(900px 700px at 50% 35%, transparent 30%, rgba(0,0,0,.55) 78%),
                  linear-gradient(to bottom, rgba(0,0,0,.55), transparent 30%, rgba(0,0,0,.65));
    }

    /* ===== App ===== */
    .app{min-height:100vh; display:flex; flex-direction:column}
    .topbar{
      position:sticky; top:0; z-index:50;
      background: rgba(7,9,12,.65);
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--border);
    }
    .topbar-inner{
      max-width:1120px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      font-weight:900; letter-spacing:.5px;
    }
    .brand .title{display:flex; flex-direction:column; line-height:1.1}
    .brand .title .sub{font-size:12px; color:var(--muted); font-weight:700}
    .dot{
      width:11px;height:11px;border-radius:999px;
      background:var(--warn);
      box-shadow:0 0 0 6px rgba(245,158,11,.10);
      transition: .25s ease;
    }

    .nav{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition: transform .15s ease, filter .15s ease, border-color .15s ease;
      display:inline-flex; align-items:center; gap:8px;
      font-weight:800;
      letter-spacing:.2px;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.06); border-color: rgba(180,210,255,.22)}
    .btn:active{transform:translateY(0px); filter:brightness(1.02)}
    .btn.primary{
      border-color: rgba(90,166,255,.32);
      background: linear-gradient(180deg, rgba(90,166,255,.22), rgba(90,166,255,.10));
    }
    .btn.ghost{background:transparent}
    .btn.danger{
      border-color: rgba(239,68,68,.30);
      background: linear-gradient(180deg, rgba(239,68,68,.18), rgba(239,68,68,.08));
    }

    .container{
      max-width:1120px; width:100%;
      margin:0 auto; padding:18px 16px 34px;
      display:grid; gap:16px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
      animation: fadeUp .35s ease both;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute;
      inset:-1px;
      background: radial-gradient(800px 220px at 20% 0%, rgba(90,166,255,.14), transparent 55%),
                  radial-gradient(800px 220px at 80% 0%, rgba(139,92,246,.12), transparent 55%);
      opacity:.65;
      pointer-events:none;
      mix-blend-mode: screen;
    }
    .card > *{position:relative}
    .card h2{margin:0 0 8px; font-size:18px}
    .card h3{margin:0 0 8px; font-size:14px; color:var(--muted); font-weight:900; letter-spacing:.3px}
    .muted{color:var(--muted)}
    .mini{font-size:12px}
    .tag{font-family:var(--mono); font-size:12px; opacity:.92}

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .col{display:flex; flex-direction:column; gap:10px}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px; border-radius:999px; font-size:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      font-weight:800;
    }
    .pill.ok{border-color: rgba(34,197,94,.32); color:#b7f7cb; background:rgba(34,197,94,.08)}
    .pill.bad{border-color: rgba(239,68,68,.32); color:#ffd0d0; background:rgba(239,68,68,.08)}
    .pill.warn{border-color: rgba(245,158,11,.32); color:#ffe2b3; background:rgba(245,158,11,.08)}

    .hr{height:1px; background:var(--border); margin:12px 0}
    .field{display:flex; flex-direction:column; gap:7px}
    .field label{font-size:12px; color:var(--muted); font-weight:800; letter-spacing:.2px}
    input, textarea, select{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:120px; resize:vertical; font-family:var(--mono); font-size:12.5px}
    input:focus, textarea:focus{border-color: rgba(90,166,255,.32); box-shadow: 0 0 0 4px rgba(90,166,255,.10)}

    .kpi{
      display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px;
    }
    @media (max-width: 600px){ .kpi{grid-template-columns:1fr} }
    .kpi .box{
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      border-radius:16px;
      padding:10px;
    }
    .kpi .n{font-weight:950; font-size:16px}
    .kpi .t{font-size:12px; color:var(--muted); font-weight:800}

    .list{display:flex; flex-direction:column; gap:10px}
    .item{
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      border-radius:16px;
      padding:12px;
      transition: transform .12s ease, border-color .12s ease, filter .12s ease;
    }
    .item:hover{transform: translateY(-1px); border-color: rgba(180,210,255,.20); filter:brightness(1.04)}
    .item .title{font-weight:950}
    .item .sub{color:var(--muted); font-size:12px; font-weight:800}

    .split{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 760px){ .split{grid-template-columns:1fr} }

    .smallnote{font-size:12px; color:var(--muted); line-height:1.45}

    /* ===== Toast ===== */
    .toast-wrap{
      position:fixed; right:16px; bottom:16px; z-index:9999;
      display:flex; flex-direction:column; gap:10px;
      max-width:min(520px, calc(100vw - 32px));
    }
    .toast{
      border:1px solid var(--border);
      background: rgba(7,9,12,.75);
      backdrop-filter: blur(10px);
      border-radius:16px;
      padding:10px 12px;
      box-shadow:var(--shadow);
      display:flex; gap:10px; align-items:flex-start;
      animation: toastIn .22s ease both;
    }
    .toast b{display:block; margin-bottom:2px}
    @keyframes toastIn{from{opacity:0; transform: translateY(8px)} to{opacity:1; transform: translateY(0)}}
    @keyframes fadeUp{from{opacity:0; transform: translateY(6px)} to{opacity:1; transform: translateY(0)}}

    /* ===== Skeleton ===== */
    .skeleton{
      position:relative;
      overflow:hidden;
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      border-radius:16px;
      min-height: 90px;
    }
    .skeleton:after{
      content:"";
      position:absolute;
      inset:0;
      transform: translateX(-60%);
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.10), transparent);
      animation: shimmer 1.2s ease infinite;
    }
    @keyframes shimmer{to{transform: translateX(60%)}}

    /* ===== Footer ===== */
    .footer{
      max-width:1120px;
      margin:0 auto 24px;
      padding:0 16px;
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      opacity:.9;
    }
  </style>
</head>

<body>
<canvas id="bg"></canvas>
<div class="vignette"></div>

<div class="app">
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <span class="dot" id="srvDot"></span>
        <div class="title">
          <div>OBEARCO <span class="muted">RPG Hub</span></div>
          <div class="sub" id="srvLine">Carregando status‚Ä¶</div>
        </div>
      </div>

      <div class="nav" id="nav"></div>
    </div>
  </div>

  <main class="container" id="app"></main>

  <div class="footer">
    <div>‚öîÔ∏è OBEARCO ‚Ä¢ UI para p√∫blico (GitHub Pages)</div>
    <div class="muted">Dica: mantenha CORS liberado para o dom√≠nio do seu Pages.</div>
  </div>
</div>

<div class="toast-wrap" id="toasts"></div>

<script>
/* ============================================================
   CONFIG ‚Äî SEMPRE BUSCAR API NO server_status.json DO GITHUB
   ============================================================ */

// URL que voc√™ mandou (corrigindo o .jsonn quando aparecer errado)
const STATUS_GITHUB_URL = "https://github.com/NoSense-Bot/Servidor/blob/main/server_status.json";

function githubBlobToRaw(url){
  try{
    const u = String(url||"").trim();
    if(!u) return u;
    if(u.includes("raw.githubusercontent.com")) return u;
    return u.replace("https://github.com/", "https://raw.githubusercontent.com/")
            .replace("/blob/", "/");
  }catch{ return url; }
}

const LS = {
  token: "obearco_session_token",
  apiBase: "obearco_api_base",
  me: "obearco_me_cache",
  updatesLocal: "obearco_updates_local_v1",
};

// Estado global
const state = {
  loading: true,
  status: null,
  apiBase: "", // NUNCA mostramos na UI
  token: localStorage.getItem(LS.token) || "",
  me: safeJson(localStorage.getItem(LS.me)) || null,
  isAdmin: false,
  route: location.hash || "#/login",
  updates: [], // feed p√∫blico de updates
};

/* ============================================================
   Utils
   ============================================================ */
function safeJson(s){ try{ return JSON.parse(s); }catch{ return null; } }

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

function toast(title, msg, kind="info"){
  const wrap = document.getElementById("toasts");
  const t = document.createElement("div");
  t.className = "toast";
  const icon = kind==="ok" ? "‚úÖ" : kind==="bad" ? "‚ùå" : kind==="warn" ? "‚ö†Ô∏è" : "‚ÑπÔ∏è";
  t.innerHTML = `
    <div style="font-size:18px;line-height:1">${icon}</div>
    <div>
      <b>${escapeHtml(title)}</b>
      <div class="mini muted">${escapeHtml(msg)}</div>
    </div>
  `;
  wrap.appendChild(t);
  setTimeout(()=>{ t.style.opacity="0"; t.style.transform="translateY(6px)"; }, 3200);
  setTimeout(()=>{ t.remove(); }, 3800);
}

function go(hash){ location.hash = hash; }

function pickId(user){
  return user?.id ?? user?.user_id ?? user?._id ?? user?.email ?? null;
}

function isAdminFromMe(me){
  return !!(me?.is_admin || me?.admin || me?.role === "admin" || me?.nivel === "admin");
}

/* ============================================================
   Status + API base
   ============================================================ */
async function fetchStatusAlways(){
  // Sempre busca do GitHub ao abrir (no-store), e tenta 2x se falhar
  const rawUrl = githubBlobToRaw(STATUS_GITHUB_URL);
  for(let attempt=1; attempt<=2; attempt++){
    try{
      const res = await fetch(rawUrl, { cache:"no-store" });
      if(!res.ok) throw new Error("N√£o consegui baixar server_status.json");
      return await res.json();
    }catch(err){
      if(attempt===2) throw err;
      await sleep(500);
    }
  }
}

function setServerBadge(online){
  const dot = document.getElementById("srvDot");
  const line = document.getElementById("srvLine");
  if(online){
    dot.style.background = "var(--ok)";
    dot.style.boxShadow = "0 0 0 6px rgba(34,197,94,.10)";
    line.textContent = "Servidor: Online ‚úÖ";
  }else{
    dot.style.background = "var(--bad)";
    dot.style.boxShadow = "0 0 0 6px rgba(239,68,68,.10)";
    line.textContent = "Servidor: Offline ‚ùå";
  }
}

function apiUrl(path){
  const base = (state.apiBase || "").replace(/\/+$/,"");
  return base + path;
}

async function apiCmd(payload){
  // Mant√©m seu padr√£o: /api/v1/cmd com fallback legacy (/login, /register)
  const url = apiUrl("/api/v1/cmd");
  const headers = { "Content-Type":"application/json" };
  if(state.token) headers["Authorization"] = "Bearer " + state.token;

  try{
    const r = await fetch(url, { method:"POST", headers, body: JSON.stringify(payload) });
    const j = await r.json().catch(()=> ({}));
    if(!r.ok || j.ok === false) throw new Error(j.error || "Falha no cmd");
    return j;
  }catch(err){
    if(payload?.comando === "/login" || payload?.comando === "/register"){
      const legacyPath = payload.comando === "/login" ? "/login" : "/register";
      const rr = await fetch(apiUrl(legacyPath), {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const jj = await rr.json().catch(()=> ({}));
      if(!rr.ok || jj.ok === false) throw new Error(jj.error || "Falha no login/register");
      return jj;
    }
    throw err;
  }
}

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

/* ============================================================
   Auth
   ============================================================ */
async function doLogin(email, senha){
  const out = await apiCmd({ comando:"/login", email, senha });
  const token = out.session_token || out.token || out?.data?.session_token || out?.session?.token;
  if(!token) throw new Error("Login OK mas n√£o veio session_token");
  state.token = token;
  localStorage.setItem(LS.token, token);
  toast("Login", "Sess√£o salva ‚úÖ", "ok");
  await loadMe();
  await loadUpdates(); // carrega feed junto
  go("#/feed");
}

async function doRegister(email, senha, extra={}){
  await apiCmd({ comando:"/register", email, senha, ...extra });
  toast("Conta criada", "Agora faz login üòâ", "ok");
  go("#/login");
}

function doLogout(){
  state.token = "";
  state.me = null;
  state.isAdmin = false;
  localStorage.removeItem(LS.token);
  localStorage.removeItem(LS.me);
  toast("Logout", "Sess√£o removida.", "ok");
  go("#/login");
}

/* ============================================================
   Me (CRUD)
   ============================================================ */
async function loadMe(){
  if(!state.token) return null;
  try{
    const out = await apiCmd({ comando:"/me/get" });
    const me = out.me || out.user || out.account || out.data || out;
    state.me = me;
    state.isAdmin = isAdminFromMe(me);
    localStorage.setItem(LS.me, JSON.stringify(me));
    renderNav();
    return me;
  }catch(e1){
    const out2 = await apiCmd({ comando:"/me" }).catch(()=> null);
    if(out2){
      const me = out2.me || out2.user || out2.account || out2.data || out2;
      state.me = me;
      state.isAdmin = isAdminFromMe(me);
      localStorage.setItem(LS.me, JSON.stringify(me));
      renderNav();
      return me;
    }
    throw e1;
  }
}

async function updateMe(patch){
  await apiCmd({ comando:"/me/update", patch });
  toast("Conta", "Atualizada ‚úÖ", "ok");
  await loadMe();
}

async function deleteMe(){
  await apiCmd({ comando:"/me/delete" });
  toast("Conta", "Deletada üóëÔ∏è", "ok");
  doLogout();
}

async function addSkill(skill){
  await apiCmd({ comando:"/me/skills/add", skill });
  toast("Skills", "Adicionada ‚úÖ", "ok");
  await loadMe();
}

async function removeSkill(skill){
  await apiCmd({ comando:"/me/skills/remove", skill });
  toast("Skills", "Removida ‚úÖ", "ok");
  await loadMe();
}

/* ============================================================
   Admin (CRUD usu√°rios)
   ============================================================ */
async function adminListUsers(){
  const out = await apiCmd({ comando:"/admin/users/list" });
  return out.users || out.list || out.data || [];
}
async function adminGetUser(id){
  const out = await apiCmd({ comando:"/admin/users/get", id });
  return out.user || out.data || out;
}
async function adminUpdateUser(id, patch){
  await apiCmd({ comando:"/admin/users/update", id, patch });
  toast("Admin", "Usu√°rio atualizado ‚úÖ", "ok");
}
async function adminDeleteUser(id){
  await apiCmd({ comando:"/admin/users/delete", id });
  toast("Admin", "Usu√°rio deletado üóëÔ∏è", "ok");
}
async function adminCreateUser(payload){
  await apiCmd({ comando:"/admin/users/create", ...payload });
  toast("Admin", "Usu√°rio criado ‚úÖ", "ok");
}

/* ============================================================
   Updates (P√∫blico + Editor Admin)
   ============================================================ */
/*
  ‚úÖ Profissional: tenta buscar/salvar por API
  - Lista p√∫blica:  comando "/updates/list"
  - Criar update (admin): "/admin/updates/create"
  - (opcional) deletar: "/admin/updates/delete"

  üîÅ Fallback: localStorage (para n√£o ‚Äúquebrar‚Äù se backend ainda n√£o existe)
*/
function getLocalUpdates(){
  const arr = safeJson(localStorage.getItem(LS.updatesLocal)) || [];
  return Array.isArray(arr) ? arr : [];
}
function setLocalUpdates(list){
  localStorage.setItem(LS.updatesLocal, JSON.stringify(list));
}

async function loadUpdates(){
  // tenta API primeiro
  try{
    const out = await apiCmd({ comando:"/updates/list" });
    const list = out.updates || out.list || out.data || [];
    state.updates = Array.isArray(list) ? list : [];
    return state.updates;
  }catch{
    // fallback local
    state.updates = getLocalUpdates();
    return state.updates;
  }
}

async function createUpdate({ title, body, tags=[] }){
  const payload = {
    title: String(title||"").trim(),
    body: String(body||"").trim(),
    tags: Array.isArray(tags) ? tags : [],
    ts: Date.now()
  };
  if(!payload.title || !payload.body) throw new Error("T√≠tulo e texto s√£o obrigat√≥rios.");

  // tenta API
  try{
    await apiCmd({ comando:"/admin/updates/create", update: payload });
    toast("Updates", "Publicado ‚úÖ", "ok");
    await loadUpdates();
    return;
  }catch{
    // fallback local
    const list = getLocalUpdates();
    list.unshift({ ...payload, id: "local_" + payload.ts });
    setLocalUpdates(list);
    toast("Updates", "Publicado (local) ‚úÖ", "ok");
    await loadUpdates();
  }
}

/* ============================================================
   Router + Nav
   ============================================================ */
window.addEventListener("hashchange", ()=>{
  state.route = location.hash || "#/login";
  render();
});

function renderNav(){
  const nav = document.getElementById("nav");
  const authed = !!state.token;
  nav.innerHTML = "";

  if(!authed){
    nav.appendChild(btn("üîê Login", ()=>go("#/login"), "primary"));
    nav.appendChild(btn("üßæ Registrar", ()=>go("#/register")));
    return;
  }

  nav.appendChild(btn("üì∞ Feed", ()=>go("#/feed"), "primary"));
  nav.appendChild(btn("üì¢ Updates", ()=>go("#/updates")));
  nav.appendChild(btn("‚öôÔ∏è Config", ()=>go("#/config")));
  if(state.isAdmin) nav.appendChild(btn("üõ°Ô∏è Admin", ()=>go("#/admin")));
  nav.appendChild(btn("üö™ Sair", doLogout, "ghost"));
}

function btn(label, onClick, cls=""){
  const b = document.createElement("button");
  b.className = "btn " + cls;
  b.textContent = label;
  b.onclick = onClick;
  return b;
}

function guardRoute(){
  const r = state.route;
  if(!state.token && (r.startsWith("#/feed") || r.startsWith("#/config") || r.startsWith("#/admin") || r.startsWith("#/updates"))){
    go("#/login");
    return false;
  }
  if(state.token && r.startsWith("#/admin") && !state.isAdmin){
    toast("Sem permiss√£o", "Voc√™ n√£o √© admin üòÖ", "warn");
    go("#/feed");
    return false;
  }
  return true;
}

function render(){
  if(!guardRoute()) return;

  const app = document.getElementById("app");
  const r = state.route;

  if(r.startsWith("#/login")) return renderLogin(app);
  if(r.startsWith("#/register")) return renderRegister(app);
  if(r.startsWith("#/feed")) return renderFeed(app);
  if(r.startsWith("#/updates")) return renderUpdates(app);
  if(r.startsWith("#/config")) return renderConfig(app);
  if(r.startsWith("#/admin")) return renderAdmin(app);

  go("#/login");
}

/* ============================================================
   Views
   ============================================================ */
function renderLogin(app){
  const st = state.status || {};
  app.innerHTML = `
    <div class="grid">
      <div class="card">
        <h2>üîê Login</h2>
        <div class="muted">Entre com sua conta (usu√°rio normal ou admin).</div>
        <div class="hr"></div>

        <div class="field">
          <label>Email</label>
          <input id="email" placeholder="email@exemplo.com" autocomplete="username" />
        </div>
        <div class="field">
          <label>Senha</label>
          <input id="senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnLogin">Entrar</button>
          <button class="btn" onclick="location.hash='#/register'">Criar conta</button>
        </div>

        <div class="hr"></div>
        <div class="smallnote">
          üí° A base da API √© carregada automaticamente do <span class="tag">server_status.json</span> no GitHub, sempre que voc√™ abre o site.<br/>
          ‚úÖ As URLs e chamadas ficam ‚Äúescondidas‚Äù da UI (pra ficar mais p√∫blico/profissional).
        </div>
      </div>

      <div class="card">
        <h2>üì° Status</h2>
        <div class="kpi">
          <div class="box">
            <div class="n">${escapeHtml(st.status_servidor ?? "‚Äî")}</div>
            <div class="t">status_servidor</div>
          </div>
          <div class="box">
            <div class="n">${escapeHtml(st.version_api ?? "‚Äî")}</div>
            <div class="t">version_api</div>
          </div>
          <div class="box">
            <div class="n">${escapeHtml(st.porta ?? "‚Äî")}</div>
            <div class="t">porta</div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="smallnote">
          <b>Conectividade:</b><br/>
          - Se estiver Offline, o login vai falhar.<br/>
          - Se CORS travar, libere o dom√≠nio do seu GitHub Pages no servidor.
        </div>
      </div>
    </div>
  `;

  const email = app.querySelector("#email");
  const senha = app.querySelector("#senha");
  const btnLogin = app.querySelector("#btnLogin");

  btnLogin.onclick = async ()=>{
    const e = (email.value || "").trim();
    const s = (senha.value || "");
    if(!e || !s){ toast("Ops", "Preenche email e senha üòÖ", "warn"); return; }
    btnLogin.disabled = true; btnLogin.textContent = "Entrando‚Ä¶";
    try{ await doLogin(e, s); }
    catch(err){ toast("Login falhou", err?.message || String(err), "bad"); }
    finally{ btnLogin.disabled = false; btnLogin.textContent = "Entrar"; }
  };
}

function renderRegister(app){
  app.innerHTML = `
    <div class="grid">
      <div class="card">
        <h2>üßæ Registrar</h2>
        <div class="muted">Cria conta de usu√°rio normal.</div>
        <div class="hr"></div>

        <div class="field">
          <label>Usu√°rio</label>
          <input id="usuario" placeholder="seu nick" autocomplete="nickname" />
        </div>
        <div class="field">
          <label>Email</label>
          <input id="email" placeholder="email@exemplo.com" autocomplete="username" />
        </div>
        <div class="field">
          <label>Senha</label>
          <input id="senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password" />
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnReg">Criar</button>
          <button class="btn" onclick="location.hash='#/login'">Voltar</button>
        </div>

        <div class="hr"></div>
        <div class="smallnote">Backend esperado: comando <span class="tag">/register</span> (requer email, senha, usuario).</div>
      </div>

      <div class="card">
        <h2>üß† Seguran√ßa</h2>
        <div class="muted">
          O token fica no <span class="tag">localStorage</span> (bom pra dev, simples).<br/>
          Em produ√ß√£o ‚Äúreal‚Äù, o ideal √© usar cookie HttpOnly.
        </div>
      </div>
    </div>
  `;

  const usuario = app.querySelector("#usuario");
  const email = app.querySelector("#email");
  const senha = app.querySelector("#senha");
  const btnReg = app.querySelector("#btnReg");

  btnReg.onclick = async ()=>{
    const u = (usuario.value || "").trim();
    const e = (email.value || "").trim();
    const s = (senha.value || "");
    if(!u || !e || !s){
      toast("Ops", "Preenche usu√°rio, email e senha üòÖ", "warn");
      return;
    }
    btnReg.disabled = true; btnReg.textContent = "Criando‚Ä¶";
    try{ await doRegister(e, s, { usuario: u }); }
    catch(err){ toast("Registro falhou", err?.message || String(err), "bad"); }
    finally{ btnReg.disabled = false; btnReg.textContent = "Criar"; }
  };
}

function renderFeed(app){
  const me = state.me || {};
  const skills = me.skills ?? me.Skills ?? me.habilidades ?? null;

  app.innerHTML = `
    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <h2>üì∞ Feed</h2>
            <div class="muted">Hub do jogador (perfil + atualiza√ß√µes p√∫blicas).</div>
          </div>
          <div class="row">
            ${state.isAdmin ? `<span class="pill ok">üõ°Ô∏è Admin</span>` : `<span class="pill warn">üë§ User</span>`}
          </div>
        </div>

        <div class="hr"></div>

        <div class="item">
          <div class="title">${escapeHtml(me.usuario || me.nome || me.name || me.username || me.email || "‚Äî")}</div>
          <div class="sub">${escapeHtml(me.email || "‚Äî")}</div>

          <div class="hr"></div>

          <div class="split">
            <div>
              <div class="muted mini">Token</div>
              <div class="tag">${escapeHtml(state.token ? state.token.slice(0,24)+"‚Ä¶" : "‚Äî")}</div>
            </div>
            <div>
              <div class="muted mini">ID</div>
              <div class="tag">${escapeHtml(pickId(me) || "‚Äî")}</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="muted mini">Skills</div>
          <div class="tag">${escapeHtml(skills === null ? "null" : JSON.stringify(skills))}</div>
        </div>

        <div class="hr"></div>

        <h3>üì¢ √öltimos updates</h3>
        <div id="updatesPreview" class="list"></div>
      </div>

      <div class="card">
        <h2>‚ö° A√ß√µes r√°pidas</h2>
        <div class="row">
          <button class="btn primary" onclick="location.hash='#/updates'">üì¢ Ver Updates</button>
          <button class="btn" onclick="location.hash='#/config'">‚öôÔ∏è Config</button>
          ${state.isAdmin ? `<button class="btn" onclick="location.hash='#/admin'">üõ°Ô∏è Admin</button>` : ``}
        </div>
        <div class="hr"></div>
        <div class="smallnote">
          üé≤ Dica: use a aba <b>Updates</b> como ‚Äúpatch notes‚Äù do seu RPG (mudan√ßas, eventos, temporadas).
        </div>
      </div>
    </div>
  `;

  renderUpdatesPreview(app.querySelector("#updatesPreview"));
}

function renderUpdatesPreview(el){
  const list = Array.isArray(state.updates) ? state.updates.slice(0,4) : [];
  if(!list.length){
    el.innerHTML = `<div class="muted mini">Ainda n√£o h√° updates publicados.</div>`;
    return;
  }
  el.innerHTML = list.map(u=>{
    const title = u.title || u.titulo || "Update";
    const body = u.body || u.texto || u.msg || "";
    const ts = u.ts || u.created_at || u.time || null;
    const when = ts ? new Date(Number(ts)).toLocaleString() : "";
    return `
      <div class="item">
        <div class="row" style="justify-content:space-between">
          <div class="title">${escapeHtml(title)}</div>
          <span class="pill ok">üìå</span>
        </div>
        <div class="sub">${escapeHtml(when)}</div>
        <div class="hr"></div>
        <div class="mini muted">${escapeHtml(String(body).slice(0,180))}${String(body).length>180 ? "‚Ä¶" : ""}</div>
      </div>
    `;
  }).join("");
}

function renderUpdates(app){
  const canPost = !!state.isAdmin;

  app.innerHTML = `
    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <h2>üì¢ Updates</h2>
            <div class="muted">Patch notes, eventos, an√∫ncios (p√∫blico).</div>
          </div>
          ${canPost ? `<span class="pill ok">Editor (Admin)</span>` : `<span class="pill warn">Leitor</span>`}
        </div>

        <div class="hr"></div>
        <div class="list" id="updatesList">
          <div class="skeleton"></div>
        </div>
      </div>

      <div class="card">
        <h2>‚úçÔ∏è Publicar</h2>
        <div class="muted">${canPost ? "Somente admin publica." : "Voc√™ n√£o √© admin."}</div>
        <div class="hr"></div>

        <div class="field">
          <label>T√≠tulo</label>
          <input id="uTitle" placeholder="Ex: Update 1.0.2 ‚Äî Balanceamento" ${canPost ? "" : "disabled"} />
        </div>

        <div class="field">
          <label>Texto</label>
          <textarea id="uBody" placeholder="Escreva o update‚Ä¶ (markdown simples ok)" ${canPost ? "" : "disabled"}></textarea>
        </div>

        <div class="field">
          <label>Tags (separadas por v√≠rgula)</label>
          <input id="uTags" placeholder="evento, patch, balance" ${canPost ? "" : "disabled"} />
        </div>

        <div class="row">
          <button class="btn primary" id="btnPub" ${canPost ? "" : "disabled"}>üìå Publicar</button>
          <button class="btn" id="btnReload">üîÑ Recarregar</button>
        </div>

        <div class="hr"></div>
        <div class="smallnote">
          ‚úÖ O site tenta salvar via API (<span class="tag">/admin/updates/create</span>) e listar via (<span class="tag">/updates/list</span>).<br/>
          üîÅ Se n√£o existir no backend ainda, cai em <span class="tag">localStorage</span>.
        </div>
      </div>
    </div>
  `;

  const listEl = app.querySelector("#updatesList");
  const btnReload = app.querySelector("#btnReload");
  const btnPub = app.querySelector("#btnPub");

  btnReload.onclick = async ()=>{
    btnReload.disabled = true;
    try{
      await loadUpdates();
      paintUpdates(listEl);
      toast("Updates", "Recarregado ‚úÖ", "ok");
    }catch(err){
      toast("Updates", err?.message || String(err), "bad");
    }finally{
      btnReload.disabled = false;
    }
  };

  if(btnPub){
    btnPub.onclick = async ()=>{
      const title = (app.querySelector("#uTitle").value || "").trim();
      const body = (app.querySelector("#uBody").value || "").trim();
      const tagsRaw = (app.querySelector("#uTags").value || "").trim();
      const tags = tagsRaw ? tagsRaw.split(",").map(s=>s.trim()).filter(Boolean) : [];
      btnPub.disabled = true; btnPub.textContent = "Publicando‚Ä¶";
      try{
        await createUpdate({ title, body, tags });
        paintUpdates(listEl);
        app.querySelector("#uTitle").value = "";
        app.querySelector("#uBody").value = "";
        app.querySelector("#uTags").value = "";
      }catch(err){
        toast("Publicar falhou", err?.message || String(err), "bad");
      }finally{
        btnPub.disabled = false; btnPub.textContent = "üìå Publicar";
      }
    };
  }

  paintUpdates(listEl);
}

function paintUpdates(listEl){
  const list = Array.isArray(state.updates) ? state.updates : [];
  if(!list.length){
    listEl.innerHTML = `<div class="muted mini">Nenhum update ainda.</div>`;
    return;
  }
  listEl.innerHTML = list.map(u=>{
    const title = u.title || u.titulo || "Update";
    const body = u.body || u.texto || u.msg || "";
    const tags = u.tags || u.etiquetas || [];
    const ts = u.ts || u.created_at || u.time || null;
    const when = ts ? new Date(Number(ts)).toLocaleString() : "";
    const tagsView = Array.isArray(tags) && tags.length
      ? `<div class="row" style="margin-top:10px">${tags.slice(0,6).map(t=>`<span class="pill">${escapeHtml(t)}</span>`).join("")}</div>`
      : "";
    return `
      <div class="item">
        <div class="row" style="justify-content:space-between">
          <div class="title">${escapeHtml(title)}</div>
          <span class="pill ok">üì¢</span>
        </div>
        <div class="sub">${escapeHtml(when)}</div>
        <div class="hr"></div>
        <div class="mini muted" style="white-space:pre-wrap">${escapeHtml(body)}</div>
        ${tagsView}
      </div>
    `;
  }).join("");
}

function renderConfig(app){
  const me = state.me || {};
  const skills = Array.isArray(me.skills) ? me.skills : (Array.isArray(me.Skills) ? me.Skills : []);
  const skillsJson = JSON.stringify(skills ?? null, null, 2);

  app.innerHTML = `
    <div class="grid">
      <div class="card">
        <h2>‚öôÔ∏è Config (usu√°rio)</h2>
        <div class="muted">Token + dados da conta + CRUD.</div>

        <div class="hr"></div>

        <div class="field">
          <label>Session token</label>
          <input value="${escapeHtml(state.token || "")}" readonly />
        </div>

        <div class="split">
          <div class="field">
            <label>Usu√°rio</label>
            <input id="fUsuario" value="${escapeHtml(me.usuario || "")}" placeholder="seu nick" />
          </div>
          <div class="field">
            <label>Email</label>
            <input id="fEmail" value="${escapeHtml(me.email || "")}" placeholder="email@exemplo.com" />
          </div>
        </div>

        <div class="field">
          <label>Nome (opcional)</label>
          <input id="fName" value="${escapeHtml(me.nome || me.name || "")}" placeholder="Seu nome" />
        </div>

        <div class="field">
          <label>Bio (opcional)</label>
          <input id="fBio" value="${escapeHtml(me.bio || me.about || "")}" placeholder="Uma descri√ß√£o‚Ä¶" />
        </div>

        <div class="field">
          <label>Skills (JSON)</label>
          <textarea id="fSkills">${escapeHtml(skillsJson === "null" ? "null" : skillsJson)}</textarea>
          <div class="smallnote">üí° Se n√£o tiver skills ainda, deixa <span class="tag">null</span> ou <span class="tag">[]</span>.</div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnSave">üíæ Salvar</button>
          <button class="btn" id="btnReload">üîÑ Recarregar</button>
          <button class="btn danger" id="btnDelete">üóëÔ∏è Deletar conta</button>
        </div>
      </div>

      <div class="card">
        <h2>üß© Skills r√°pidas</h2>
        <div class="muted">Adicionar/remover skill (comandos dedicados).</div>

        <div class="hr"></div>

        <div class="field">
          <label>Skill</label>
          <input id="skillName" placeholder="ex: espada, alquimia‚Ä¶" />
        </div>
        <div class="row">
          <button class="btn primary" id="btnAddSkill">‚ûï Add</button>
          <button class="btn" id="btnRemSkill">‚ûñ Remover</button>
        </div>
      </div>
    </div>
  `;

  const fUsuario = app.querySelector("#fUsuario");
  const fName = app.querySelector("#fName");
  const fEmail = app.querySelector("#fEmail");
  const fBio = app.querySelector("#fBio");
  const fSkills = app.querySelector("#fSkills");
  const btnSave = app.querySelector("#btnSave");
  const btnReload = app.querySelector("#btnReload");
  const btnDelete = app.querySelector("#btnDelete");
  const skillName = app.querySelector("#skillName");
  const btnAddSkill = app.querySelector("#btnAddSkill");
  const btnRemSkill = app.querySelector("#btnRemSkill");

  btnReload.onclick = async ()=>{
    try{ await loadMe(); render(); toast("OK", "Recarregado ‚úÖ", "ok"); }
    catch(err){ toast("Falhou", err?.message || String(err), "bad"); }
  };

  btnSave.onclick = async ()=>{
    btnSave.disabled = true; btnSave.textContent = "Salvando‚Ä¶";
    try{
      let skillsVal = null;
      const raw = (fSkills.value || "").trim();
      if(raw !== "") skillsVal = JSON.parse(raw);

      const patch = {
        usuario: (fUsuario.value || "").trim(),
        name: (fName.value || "").trim(),
        email: (fEmail.value || "").trim(),
        bio: (fBio.value || "").trim(),
        skills: skillsVal,
      };
      await updateMe(patch);
      render();
    }catch(err){
      toast("Salvar falhou", err?.message || String(err), "bad");
    }finally{
      btnSave.disabled = false; btnSave.textContent = "üíæ Salvar";
    }
  };

  btnDelete.onclick = async ()=>{
    if(!confirm("Tem certeza que quer deletar sua conta?")) return;
    btnDelete.disabled = true;
    try{ await deleteMe(); }
    catch(err){ toast("Delete falhou", err?.message || String(err), "bad"); btnDelete.disabled = false; }
  };

  btnAddSkill.onclick = async ()=>{
    const sk = (skillName.value||"").trim();
    if(!sk){ toast("Ops", "Digita uma skill üòÖ", "warn"); return; }
    try{ await addSkill(sk); render(); }
    catch(err){ toast("Falhou", err?.message || String(err), "bad"); }
  };

  btnRemSkill.onclick = async ()=>{
    const sk = (skillName.value||"").trim();
    if(!sk){ toast("Ops", "Digita uma skill üòÖ", "warn"); return; }
    try{ await removeSkill(sk); render(); }
    catch(err){ toast("Falhou", err?.message || String(err), "bad"); }
  };
}

function renderAdmin(app){
  app.innerHTML = `
    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <h2>üõ°Ô∏è Admin</h2>
            <div class="muted">Ver todas as contas + CRUD total.</div>
          </div>
          <span class="pill ok">Admin mode</span>
        </div>

        <div class="hr"></div>

        <div class="split">
          <div class="field">
            <label>Buscar (email/id)</label>
            <input id="q" placeholder="ex: user@gmail.com" />
          </div>
          <div class="row" style="align-items:flex-end">
            <button class="btn primary" id="btnLoad">üì• Carregar lista</button>
            <button class="btn" id="btnNew">‚ûï Novo usu√°rio</button>
          </div>
        </div>

        <div class="hr"></div>
        <div class="list" id="usersList"></div>
      </div>

      <div class="card">
        <h2>‚úçÔ∏è Editor</h2>
        <div class="muted">Selecione um usu√°rio na lista pra editar.</div>

        <div class="hr"></div>

        <div class="field">
          <label>ID selecionado</label>
          <input id="selId" readonly />
        </div>

        <div class="field">
          <label>JSON (patch)</label>
          <textarea id="patch" placeholder='{"bio":"novo","skills":["a","b"],"is_admin":false}'></textarea>
          <div class="smallnote">Envia <span class="tag">patch</span> para <span class="tag">/admin/users/update</span>.</div>
        </div>

        <div class="row">
          <button class="btn primary" id="btnSaveUser">üíæ Atualizar</button>
          <button class="btn danger" id="btnDelUser">üóëÔ∏è Deletar</button>
          <button class="btn" id="btnGetUser">üîé Ver detalhes</button>
        </div>

        <div class="hr"></div>
        <div class="field">
          <label>Detalhes (read-only)</label>
          <textarea id="details" readonly></textarea>
        </div>
      </div>
    </div>
  `;

  const q = app.querySelector("#q");
  const btnLoad = app.querySelector("#btnLoad");
  const btnNew = app.querySelector("#btnNew");
  const usersList = app.querySelector("#usersList");
  const selId = app.querySelector("#selId");
  const patch = app.querySelector("#patch");
  const details = app.querySelector("#details");
  const btnSaveUser = app.querySelector("#btnSaveUser");
  const btnDelUser = app.querySelector("#btnDelUser");
  const btnGetUser = app.querySelector("#btnGetUser");

  let usersCache = [];

  function renderUsers(list){
    usersList.innerHTML = "";
    if(!list.length){
      usersList.innerHTML = `<div class="muted">Nenhuma conta encontrada.</div>`;
      return;
    }
    list.forEach(u=>{
      const id = pickId(u);
      const name = u.usuario || u.nome || u.name || u.username || u.email || "‚Äî";
      const role = (u.is_admin || u.admin || u.role==="admin") ? "admin" : "user";
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="title">${escapeHtml(name)}</div>
            <div class="sub">${escapeHtml(u.email || "")}</div>
          </div>
          <span class="pill ${role==="admin" ? "ok":"warn"}">${role==="admin" ? "üõ°Ô∏è admin":"üë§ user"}</span>
        </div>
        <div class="hr"></div>
        <div class="tag">${escapeHtml(id || "‚Äî")}</div>
      `;
      el.onclick = ()=>{
        selId.value = id || "";
        details.value = JSON.stringify(u, null, 2);
        patch.value = "{}";
      };
      usersList.appendChild(el);
    });
  }

  btnLoad.onclick = async ()=>{
    btnLoad.disabled = true;
    btnLoad.textContent = "Carregando‚Ä¶";
    try{
      const list = await adminListUsers();
      usersCache = Array.isArray(list) ? list : [];
      const term = (q.value||"").trim().toLowerCase();
      const filtered = term
        ? usersCache.filter(u => JSON.stringify(u).toLowerCase().includes(term))
        : usersCache;
      renderUsers(filtered);
      toast("Admin", "Lista carregada ‚úÖ", "ok");
    }catch(err){
      toast("Admin falhou", err?.message || String(err), "bad");
    }finally{
      btnLoad.disabled = false;
      btnLoad.textContent = "üì• Carregar lista";
    }
  };

  btnNew.onclick = async ()=>{
    const usuario = prompt("Usu√°rio (nick):");
    if(!usuario) return;
    const email = prompt("Email do novo usu√°rio:");
    if(!email) return;
    const senha = prompt("Senha:");
    if(!senha) return;
    const isAdmin = confirm("Esse usu√°rio √© ADMIN?");
    try{
      await adminCreateUser({ usuario, email, senha, is_admin: isAdmin });
      await btnLoad.onclick();
    }catch(err){
      toast("Criar falhou", err?.message || String(err), "bad");
    }
  };

  btnGetUser.onclick = async ()=>{
    const id = (selId.value||"").trim();
    if(!id){ toast("Ops", "Seleciona um usu√°rio üòÖ", "warn"); return; }
    try{
      const u = await adminGetUser(id);
      details.value = JSON.stringify(u, null, 2);
      toast("OK", "Detalhes carregados ‚úÖ", "ok");
    }catch(err){
      toast("Falhou", err?.message || String(err), "bad");
    }
  };

  btnSaveUser.onclick = async ()=>{
    const id = (selId.value||"").trim();
    if(!id){ toast("Ops", "Seleciona um usu√°rio üòÖ", "warn"); return; }
    let p = {};
    try{ p = JSON.parse((patch.value||"{}") || "{}"); }
    catch{ toast("JSON inv√°lido", "Corrige o patch üòÖ", "warn"); return; }

    btnSaveUser.disabled = true;
    try{
      await adminUpdateUser(id, p);
      await btnLoad.onclick();
    }catch(err){
      toast("Update falhou", err?.message || String(err), "bad");
    }finally{
      btnSaveUser.disabled = false;
    }
  };

  btnDelUser.onclick = async ()=>{
    const id = (selId.value||"").trim();
    if(!id){ toast("Ops", "Seleciona um usu√°rio üòÖ", "warn"); return; }
    if(!confirm("Deletar esse usu√°rio?")) return;
    btnDelUser.disabled = true;
    try{
      await adminDeleteUser(id);
      selId.value = "";
      details.value = "";
      patch.value = "{}";
      await btnLoad.onclick();
    }catch(err){
      toast("Delete falhou", err?.message || String(err), "bad");
    }finally{
      btnDelUser.disabled = false;
    }
  };
}

/* ============================================================
   Boot (sempre busca json do GitHub ao abrir)
   ============================================================ */
async function boot(){
  try{
    state.loading = true;
    renderNav();

    const st = await fetchStatusAlways();     // ‚úÖ SEMPRE busca no GitHub ao carregar
    state.status = st;

    const base = (st?.url_api_base || "").trim();
    if(!base) throw new Error("server_status.json sem url_api_base");
    state.apiBase = base.replace(/\/+$/,"");
    localStorage.setItem(LS.apiBase, state.apiBase);

    const online = String(st?.status_servidor || "").toLowerCase().includes("online");
    setServerBadge(online);

    if(state.token){
      try{ await loadMe(); }
      catch{ toast("Sess√£o", "Token inv√°lido/expirado. Faz login de novo üòâ", "warn"); doLogout(); }
    }

    await loadUpdates(); // carrega updates para p√∫blico
    renderNav();
    render();
  }catch(err){
    setServerBadge(false);
    toast("Boot falhou", err?.message || String(err), "bad");
    renderNav();
    render();
  }finally{
    state.loading = false;
  }
}
boot();

/* ============================================================
   Background animado (particles / nebula)
   ============================================================ */
(function bgParticles(){
  const canvas = document.getElementById("bg");
  const ctx = canvas.getContext("2d");
  let w=0,h=0, dpr=1;
  let parts=[];
  const N = 70;

  function resize(){
    dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    w = canvas.width = Math.floor(innerWidth * dpr);
    h = canvas.height = Math.floor(innerHeight * dpr);
    canvas.style.width = innerWidth + "px";
    canvas.style.height = innerHeight + "px";
  }
  window.addEventListener("resize", resize, {passive:true});
  resize();

  function rnd(a,b){ return a + Math.random()*(b-a); }

  function seed(){
    parts = [];
    for(let i=0;i<N;i++){
      parts.push({
        x: rnd(0,w),
        y: rnd(0,h),
        r: rnd(0.8*dpr, 2.4*dpr),
        vx: rnd(-0.18, 0.18)*dpr,
        vy: rnd(-0.12, 0.12)*dpr,
        a: rnd(0.10, 0.22),
        hue: Math.random() < 0.55 ? 210 : 265
      });
    }
  }
  seed();

  function step(){
    ctx.clearRect(0,0,w,h);

    // glow
    const g = ctx.createRadialGradient(w*0.3, h*0.2, 0, w*0.3, h*0.2, Math.max(w,h)*0.7);
    g.addColorStop(0, "rgba(90,166,255,.08)");
    g.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);

    const g2 = ctx.createRadialGradient(w*0.8, h*0.25, 0, w*0.8, h*0.25, Math.max(w,h)*0.75);
    g2.addColorStop(0, "rgba(139,92,246,.08)");
    g2.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = g2;
    ctx.fillRect(0,0,w,h);

    // particles
    for(const p of parts){
      p.x += p.vx; p.y += p.vy;
      if(p.x < -20) p.x = w+20;
      if(p.x > w+20) p.x = -20;
      if(p.y < -20) p.y = h+20;
      if(p.y > h+20) p.y = -20;

      ctx.beginPath();
      ctx.fillStyle = `hsla(${p.hue}, 90%, 65%, ${p.a})`;
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fill();
    }

    requestAnimationFrame(step);
  }
  step();
})();
</script>
</body>
</html>
