<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OBEARCO ‚Ä¢ Gate of Accounts</title>
  <meta name="theme-color" content="#0b0a10" />
  <style>
    :root{
      --bg0:#07060b;
      --bg1:#0b0a10;
      --panel: rgba(20,18,28,.62);
      --panel2: rgba(14,13,20,.62);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.16);
      --text:#e9e6ff;
      --muted: rgba(233,230,255,.70);
      --muted2: rgba(233,230,255,.50);
      --gold:#d7b86a;
      --gold2:#f0d48a;
      --cyan:#70f5ff;
      --ok:#37d98b;
      --warn:#ffcf66;
      --bad:#ff667a;
      --shadow: 0 24px 60px rgba(0,0,0,.55);
      --blur: blur(18px);
      --r: 22px;
      --r2: 16px;
      --pad: 18px;
      --pad2: 14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family:var(--font);
      background: radial-gradient(1200px 700px at 20% 10%, rgba(180,120,255,.16), transparent 55%),
                  radial-gradient(900px 600px at 70% 15%, rgba(90,240,255,.12), transparent 55%),
                  radial-gradient(900px 700px at 35% 90%, rgba(215,184,106,.14), transparent 60%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* ====== AAA Background VFX ====== */
    .vfx{
      position:fixed; inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index:0;
    }
    canvas#stars{position:absolute; inset:0; width:100%; height:100%;}
    .fog{
      position:absolute; inset:-30%;
      background:
        radial-gradient(closest-side at 20% 25%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(closest-side at 75% 35%, rgba(100,240,255,.06), transparent 60%),
        radial-gradient(closest-side at 35% 75%, rgba(215,184,106,.07), transparent 60%),
        radial-gradient(closest-side at 65% 80%, rgba(160,120,255,.06), transparent 60%);
      filter: blur(40px);
      opacity:.9;
      animation: drift 18s ease-in-out infinite alternate;
      transform: translate3d(0,0,0);
    }
    @keyframes drift{
      from{ transform: translate3d(-2%, -1%, 0) scale(1.02); }
      to  { transform: translate3d( 3%,  2%, 0) scale(1.06); }
    }
    .sparks{
      position:absolute; inset:0;
      background-image:
        radial-gradient(circle at 15% 40%, rgba(255,255,255,.12) 0 1px, transparent 2px),
        radial-gradient(circle at 65% 70%, rgba(112,245,255,.14) 0 1px, transparent 2px),
        radial-gradient(circle at 82% 18%, rgba(240,212,138,.14) 0 1px, transparent 2px),
        radial-gradient(circle at 40% 82%, rgba(190,140,255,.12) 0 1px, transparent 2px);
      opacity:.55;
      filter: blur(.2px);
      animation: twinkle 3.6s ease-in-out infinite;
    }
    @keyframes twinkle{
      0%,100%{opacity:.35}
      50%{opacity:.72}
    }

    /* ====== Layout ====== */
    .wrap{
      position:relative;
      z-index:2;
      max-width: 1320px;
      margin: 0 auto;
      padding: 18px 18px 44px;
    }

    .grid{
      display:grid;
      grid-template-columns: 290px 1fr 360px;
      gap: 18px;
      align-items:start;
    }

    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(650px 220px at 20% 0%, rgba(255,255,255,.06), transparent 65%),
                  radial-gradient(600px 260px at 95% 20%, rgba(112,245,255,.06), transparent 70%),
                  radial-gradient(520px 320px at 50% 100%, rgba(215,184,106,.06), transparent 70%);
      opacity:.9;
      pointer-events:none;
    }

    .card > *{position:relative; z-index:1;}

    .side{
      padding: var(--pad);
    }

    .title{
      display:flex; gap:12px; align-items:center;
      letter-spacing:.14em;
      text-transform:uppercase;
      font-size: 12px;
      color: var(--muted2);
    }
    .logo{
      width:38px; height:38px; border-radius:14px;
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.22), transparent 40%),
        linear-gradient(135deg, rgba(215,184,106,.30), rgba(160,120,255,.26), rgba(112,245,255,.20));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .h1{
      font-size: 16px;
      margin: 0;
      color: rgba(233,230,255,.95);
      letter-spacing:.08em;
    }
    .sub{
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted2);
      line-height:1.45;
    }

    .nav{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-top: 14px;
    }
    .navBtn{
      text-align:left;
      width:100%;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.10));
      color: var(--text);
      border-radius: 18px;
      padding: 14px 14px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      position:relative;
      overflow:hidden;
    }
    .navBtn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.18); }
    .navBtn.active{
      border-color: rgba(215,184,106,.34);
      background: linear-gradient(180deg, rgba(215,184,106,.16), rgba(0,0,0,.16));
    }
    .navBtn .l{
      display:flex; flex-direction:column; gap:3px;
    }
    .navBtn .t{
      font-size: 18px;
      font-weight: 800;
      letter-spacing:.02em;
    }
    .navBtn .d{
      font-size: 12px;
      color: var(--muted2);
    }
    .chip{
      border:1px solid rgba(255,255,255,.14);
      border-radius: 999px;
      padding: 7px 10px;
      font-size:12px;
      color: var(--muted);
      background: rgba(0,0,0,.18);
      display:flex; align-items:center; gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .dot{
      width:9px; height:9px; border-radius:50%;
      background: rgba(255,255,255,.22);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }
    .dot.ok{background: var(--ok); box-shadow: 0 0 0 3px rgba(55,217,139,.12);}
    .dot.bad{background: var(--bad); box-shadow: 0 0 0 3px rgba(255,102,122,.14);}
    .dot.warn{background: var(--warn); box-shadow: 0 0 0 3px rgba(255,207,102,.14);}

    /* ====== Top header (center) ====== */
    .mainHead{
      padding: 16px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .mainLeft{
      display:flex;
      gap: 12px;
      align-items:center;
      min-width: 0;
    }
    .mainText{min-width:0}
    .mainText .h1{
      font-size: 14px;
      letter-spacing:.12em;
      margin:0;
      text-transform:uppercase;
      color: rgba(233,230,255,.92);
    }
    .mainText .sub{
      margin:3px 0 0;
      font-size:12px;
      color: var(--muted2);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 520px;
    }

    .tools{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.14));
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, filter .12s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.22);}
    .btn.gold{
      border-color: rgba(215,184,106,.30);
      background: linear-gradient(180deg, rgba(215,184,106,.16), rgba(0,0,0,.18));
    }
    .btn.ghost{
      background: rgba(0,0,0,.10);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none;
    }

    /* ====== Main content ====== */
    .main{
      padding: 0 18px 18px;
    }
    .panelTitle{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      padding: 10px 0 12px;
    }
    .panelTitle .big{
      margin:0;
      font-size: 18px;
      letter-spacing:.06em;
      text-transform:uppercase;
    }
    .panelTitle .small{
      margin:0;
      font-size: 12px;
      color: var(--muted2);
    }

    .portalHero{
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 220px at 10% 0%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.16), rgba(0,0,0,.12));
      border-radius: var(--r);
      padding: 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      position:relative;
      overflow:hidden;
      margin-bottom: 12px;
    }
    .portalHero:after{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(215,184,106,.10), transparent 55%),
                  radial-gradient(circle at 70% 40%, rgba(112,245,255,.10), transparent 55%),
                  radial-gradient(circle at 55% 75%, rgba(160,120,255,.10), transparent 60%);
      filter: blur(26px);
      animation: drift 12s ease-in-out infinite alternate;
      opacity:.9;
      pointer-events:none;
    }
    .portalHero > *{position:relative; z-index:1;}

    .heroL{
      display:flex; gap:12px; align-items:flex-start;
      min-width:0;
    }
    .badge{
      width:44px; height:44px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(135deg, rgba(215,184,106,.18), rgba(160,120,255,.18), rgba(112,245,255,.14));
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      display:flex; align-items:center; justify-content:center;
      font-size: 20px;
    }
    .heroT{
      min-width:0;
    }
    .heroT h2{
      margin:0;
      font-size: 24px;
      letter-spacing:.02em;
    }
    .heroT p{
      margin:4px 0 0;
      color: var(--muted);
      font-size: 14px;
      line-height:1.4;
    }
    .heroActions{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }

    /* Scroll area (yellow-circled region requested) */
    .scrollArea{
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(0,0,0,.20), rgba(0,0,0,.14));
      border-radius: var(--r);
      overflow:hidden;
    }
    .scrollAreaHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      gap:12px;
    }
    .scrollAreaHeader .tabs{
      display:flex; gap:10px; align-items:center;
    }
    .tabBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.12);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 14px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease;
      display:flex; align-items:center; gap:8px;
      font-weight:800;
      letter-spacing:.02em;
    }
    .tabBtn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.22);}
    .tabBtn.active{
      border-color: rgba(215,184,106,.34);
      background: linear-gradient(180deg, rgba(215,184,106,.16), rgba(0,0,0,.14));
    }

    .scrollBody{
      max-height: 460px;      /* <- scroll aqui */
      overflow:auto;
      padding: 14px;
    }
    .scrollBody::-webkit-scrollbar{width:10px}
    .scrollBody::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.12);
      border-radius: 999px;
      border:2px solid rgba(0,0,0,.25);
    }

    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .block{
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.14));
      border-radius: var(--r2);
      padding: 14px;
    }
    .block h3{
      margin:0 0 6px;
      font-size: 20px;
      letter-spacing:.02em;
    }
    .block p{
      margin:0 0 10px;
      font-size: 12px;
      color: var(--muted2);
      line-height:1.45;
    }
    .row{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    label{
      display:block;
      font-size: 12px;
      color: var(--muted2);
      letter-spacing:.08em;
      text-transform:uppercase;
      margin: 10px 0 6px;
    }
    input, textarea{
      width:100%;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      color: var(--text);
      padding: 12px 12px;
      border-radius: 14px;
      outline:none;
      transition: border-color .12s ease, transform .12s ease;
      font-size: 14px;
    }
    textarea{min-height: 120px; resize: vertical;}
    input:focus, textarea:focus{border-color: rgba(112,245,255,.30);}
    .hint{
      font-size:12px;
      color: var(--muted2);
      margin-top:6px;
    }

    .divider{
      height:1px;
      background: rgba(255,255,255,.08);
      margin: 12px 0;
    }

    /* ====== Patch notes column ====== */
    .patch{
      padding: var(--pad);
    }
    .patchHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 12px;
    }
    .patchHead .tt{
      font-size:12px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color: var(--muted2);
    }
    .patchCard{
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.12));
      border-radius: var(--r);
      padding: 14px;
    }
    .patchCard h3{
      margin:0;
      font-size: 22px;
      letter-spacing:.02em;
    }
    .patchCard p{
      margin: 8px 0 0;
      color: var(--muted2);
      font-size: 13px;
      line-height:1.5;
    }
    .patchList{
      margin: 12px 0 0;
      padding-left: 16px;
      color: var(--muted);
      font-size: 13px;
      line-height:1.55;
    }
    .patchSmall{
      margin-top: 14px;
      color: var(--muted2);
      font-size: 12px;
    }

    /* ====== Toasts & Global Message ====== */
    .toast{
      position:fixed;
      right: 18px;
      bottom: 18px;
      width: min(460px, calc(100% - 36px));
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,10,16,.58);
      backdrop-filter: var(--blur);
      border-radius: 18px;
      padding: 12px 12px;
      box-shadow: var(--shadow);
      transform: translateY(24px);
      opacity:0;
      pointer-events:none;
      transition: transform .18s ease, opacity .18s ease;
      z-index: 999;
    }
    .toast.show{transform: translateY(0); opacity:1;}
    .toast .hd{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .toast .hd b{letter-spacing:.06em;}
    .toast .bd{color: var(--muted); margin-top:6px; line-height:1.45; font-size: 13px;}
    .toast .x{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
    }

    .globalMsg{
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      width: min(860px, calc(100% - 30px));
      z-index: 998;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(8,8,14,.55);
      backdrop-filter: var(--blur);
      border-radius: 18px;
      padding: 12px 14px;
      box-shadow: var(--shadow);
      display:none; /* invis√≠vel por padr√£o */
    }
    .globalMsg.show{display:block; animation: pop .18s ease-out;}
    @keyframes pop{from{transform:translateX(-50%) translateY(-8px);opacity:.0}to{transform:translateX(-50%) translateY(0);opacity:1}}
    .globalMsg .r{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .globalMsg .ttl{
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size: 12px;
      color: rgba(240,212,138,.92);
    }
    .globalMsg .msg{
      margin-top:4px;
      color: var(--text);
      line-height:1.45;
      font-size: 14px;
    }

    /* Responsive */
    @media (max-width: 1100px){
      .grid{grid-template-columns: 1fr; }
      .tools{justify-content:flex-start}
      .mainText .sub{max-width: 100%;}
    }
    @media (max-width: 720px){
      .formGrid{grid-template-columns: 1fr;}
      .portalHero{flex-direction:column; align-items:flex-start;}
    }
  </style>
</head>

<body>
  <div class="vfx" aria-hidden="true">
    <canvas id="stars"></canvas>
    <div class="fog"></div>
    <div class="sparks"></div>
  </div>

  <div class="globalMsg" id="globalMsg">
    <div class="r">
      <div>
        <div class="ttl">Mensagem Global</div>
        <div class="msg" id="globalMsgText"></div>
      </div>
      <button class="x" id="globalMsgClose">Fechar</button>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT NAV -->
      <div class="card">
        <div class="side">
          <div class="title">
            <div class="logo"></div>
            <div style="min-width:0">
              <p class="h1" style="margin:0">OBEARCO ‚Ä¢ GATE OF ACCOUNTS</p>
              <!-- Conectado ao portal (escondido at√© login) -->
              <p class="sub" id="connectedLine" style="display:none"></p>
            </div>
          </div>

          <div class="nav" id="nav">
            <!-- sempre vis√≠vel -->
            <button class="navBtn active" data-view="portal" id="navPortal">
              <span class="l">
                <span class="t">Portal</span>
                <span class="d">login / registro</span>
              </span>
              <span class="chip"><span class="dot warn" id="dotPortal"></span><span id="chipPortal">aguardando</span></span>
            </button>

            <!-- escondidos at√© login -->
            <button class="navBtn" data-view="taverna" id="navTaverna" style="display:none">
              <span class="l">
                <span class="t">Taverna</span>
                <span class="d">nicks registrados</span>
              </span>
              <span class="chip"><span class="dot" id="dotTaverna"></span><span id="chipTaverna">‚Äî</span></span>
            </button>

            <button class="navBtn" data-view="conta" id="navConta" style="display:none">
              <span class="l">
                <span class="t">Conta</span>
                <span class="d">token / perfil / seguran√ßa</span>
              </span>
              <span class="chip"><span class="dot" id="dotConta"></span><span id="chipConta">‚Äî</span></span>
            </button>
          </div>
        </div>
      </div>

      <!-- CENTER -->
      <div class="card">
        <div class="mainHead">
          <div class="mainLeft">
            <div class="logo" style="width:34px;height:34px;border-radius:14px"></div>
            <div class="mainText">
              <p class="h1">OBEARCO ‚Ä¢ GATE OF ACCOUNTS</p>
              <p class="sub" id="headLine">
                <!-- Sem mostrar a URL aqui at√© login -->
                Pronto para forjar sua entrada no reino.
              </p>
            </div>
          </div>

          <div class="tools">
            <button class="btn" id="btnSync">üîÑ Sync status.json</button>
            <button class="btn ghost" id="btnPing">‚òëÔ∏è Ping</button>
            <span class="chip" id="chipStatus"><span class="dot warn" id="dotStatus"></span><span id="statusText">status: ‚Ä¶</span></span>
          </div>
        </div>

        <div class="main">
          <!-- VIEW: PORTAL -->
          <div id="viewPortal">
            <div class="panelTitle">
              <div>
                <p class="big" style="margin:0">PORTAL</p>
                <p class="small" style="margin:4px 0 0">
                  Login/Registro usando <span class="chip" style="display:inline-flex;transform:translateY(2px)"><span class="dot" style="width:7px;height:7px"></span>/api/v1/cmd</span>.
                  (Base vem do <span class="chip" style="display:inline-flex;transform:translateY(2px)"><span class="dot" style="width:7px;height:7px"></span>server_status.json</span>)
                </p>
              </div>
              <span class="chip"><span class="dot ok" id="dotOnline"></span><span id="onlineText">status: Online</span></span>
            </div>

            <div class="portalHero">
              <div class="heroL">
                <div class="badge">‚öîÔ∏è</div>
                <div class="heroT">
                  <h2>Portal do Aventureiro</h2>
                  <p>Escolha <b>Login</b> ou <b>Registro</b> e forje sua entrada no reino.</p>
                </div>
              </div>
              <div class="heroActions">
                <!-- S√≥ 1 bot√£o login e 1 registro (como voc√™ pediu) -->
                <button class="btn gold" id="heroLogin">üîë Login</button>
                <button class="btn" id="heroRegister">üìú Registro</button>
              </div>
            </div>

            <!-- √Årea circulada: SCROLL + 2 bot√µes (login/registro) que trocam o conte√∫do -->
            <div class="scrollArea">
              <div class="scrollAreaHeader">
                <div class="tabs">
                  <button class="tabBtn active" id="tabLogin">üîë Login</button>
                  <button class="tabBtn" id="tabRegister">üìú Registro</button>
                </div>
                <div class="chip" title="base detectada via status.json">
                  <span class="dot" id="dotBase"></span>
                  <span id="baseChip">base: ‚Äî</span>
                </div>
              </div>

              <div class="scrollBody">
                <!-- LOGIN FORM -->
                <div id="panelLogin">
                  <div class="block">
                    <h3>Login</h3>
                    <p>Use username ou email no campo <b>login</b>. (Comando: <span class="chip" style="display:inline-flex;transform:translateY(2px)"><span class="dot" style="width:7px;height:7px"></span>/login</span>)</p>
                    <div class="formGrid">
                      <div>
                        <label>login (email ou username)</label>
                        <input id="loginLogin" placeholder="ex: Gustavo ou gustavo@email.com" />
                      </div>
                      <div>
                        <label>senha</label>
                        <input id="loginSenha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                      </div>
                    </div>
                    <div class="row" style="margin-top:12px">
                      <button class="btn gold" id="btnDoLogin">üîë Entrar</button>
                      <button class="btn" id="btnDoLogout">üö™ Logout</button>
                      <button class="btn ghost" id="btnClearToken">üßΩ Limpar token</button>
                    </div>
                    <div class="hint" id="loginHint"></div>
                  </div>
                </div>

                <!-- REGISTER FORM -->
                <div id="panelRegister" style="display:none">
                  <div class="block">
                    <h3>Registro</h3>
                    <p>Cria conta usando os campos da tabela <b>contas</b>. (Comando: <span class="chip" style="display:inline-flex;transform:translateY(2px)"><span class="dot" style="width:7px;height:7px"></span>/register</span>)</p>
                    <div class="formGrid">
                      <div>
                        <label>username</label>
                        <input id="regUsername" placeholder="ex: Gustavo_42" />
                        <div class="hint">3‚Äì32 chars: letras/n√∫meros/espa√ßo/_</div>
                      </div>
                      <div>
                        <label>email</label>
                        <input id="regEmail" placeholder="ex: voce@email.com" />
                      </div>
                      <div>
                        <label>senha</label>
                        <input id="regSenha" type="password" placeholder="m√≠nimo 6 chars" />
                      </div>
                      <div>
                        <label>confirmar senha</label>
                        <input id="regSenha2" type="password" placeholder="repita a senha" />
                      </div>
                    </div>
                    <div class="row" style="margin-top:12px">
                      <button class="btn gold" id="btnDoRegister">üìú Registrar</button>
                    </div>
                    <div class="hint" id="regHint"></div>
                  </div>
                </div>

                <div class="divider"></div>

                <div class="block">
                  <h3>Resposta</h3>
                  <p>Log do √∫ltimo comando (debug).</p>
                  <textarea id="rawOut" readonly spellcheck="false"></textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- VIEW: TAVERNA -->
          <div id="viewTaverna" style="display:none">
            <div class="panelTitle">
              <div>
                <p class="big" style="margin:0">TAVERNA</p>
                <p class="small" style="margin:4px 0 0">Lista de nicks registrados. Carrega ao entrar aqui.</p>
              </div>
              <div class="row">
                <button class="btn" id="btnReloadUsers">üîÅ Recarregar</button>
              </div>
            </div>

            <div class="block">
              <h3>Jogadores</h3>
              <p>Comando: <span class="chip" style="display:inline-flex;transform:translateY(2px)"><span class="dot" style="width:7px;height:7px"></span>/listusers</span></p>
              <div id="usersGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px"></div>
              <div class="hint" id="usersHint"></div>
            </div>
          </div>

          <!-- VIEW: CONTA -->
          <div id="viewConta" style="display:none">
            <div class="panelTitle">
              <div>
                <p class="big" style="margin:0">CONTA</p>
                <p class="small" style="margin:4px 0 0">Token no topo + rolando pra baixo: perfil, senha, delete.</p>
              </div>
              <div class="row">
                <button class="btn" id="btnWhoami">üëÅÔ∏è Whoami</button>
              </div>
            </div>

            <div class="scrollArea">
              <div class="scrollAreaHeader">
                <div class="tabs">
                  <span class="chip"><span class="dot ok"></span>logado</span>
                </div>
                <button class="btn ghost" id="btnCopyToken">üìã Copiar token</button>
              </div>

              <div class="scrollBody">
                <div class="block">
                  <h3>Token de Login</h3>
                  <p>Este √© o <b>session_token</b>. Copie para usar no launcher/debug.</p>
                  <input id="tokenView" readonly />
                  <div class="hint" id="tokenHint"></div>
                </div>

                <div class="divider"></div>

                <div class="block">
                  <h3>Atualizar perfil</h3>
                  <p>Comando: <span class="chip" style="display:inline-flex;transform:translateY(2px)"><span class="dot" style="width:7px;height:7px"></span>/updateprofile</span></p>
                  <div class="formGrid">
                    <div>
                      <label>novo username</label>
                      <input id="upUsername" placeholder="(opcional)" />
                    </div>
                    <div>
                      <label>novo email</label>
                      <input id="upEmail" placeholder="(opcional)" />
                    </div>
                  </div>
                  <div class="row" style="margin-top:12px">
                    <button class="btn gold" id="btnUpdateProfile">üíæ Salvar</button>
                  </div>
                  <div class="hint" id="upHint"></div>
                </div>

                <div class="divider"></div>

                <div class="block">
                  <h3>Trocar senha</h3>
                  <p>Comando: <span class="chip" style="display:inline-flex;transform:translateY(2px)"><span class="dot" style="width:7px;height:7px"></span>/changepassword</span></p>
                  <div class="formGrid">
                    <div>
                      <label>senha atual</label>
                      <input id="pwOld" type="password" />
                    </div>
                    <div>
                      <label>senha nova</label>
                      <input id="pwNew" type="password" />
                    </div>
                  </div>
                  <div class="row" style="margin-top:12px">
                    <button class="btn gold" id="btnChangePassword">üîê Alterar</button>
                  </div>
                  <div class="hint" id="pwHint"></div>
                </div>

                <div class="divider"></div>

                <div class="block" style="border-color: rgba(255,102,122,.22)">
                  <h3>Deletar conta</h3>
                  <p>Vai pedir confirma√ß√£o e o bot√£o <b>s√≥ libera depois de 5s</b>. (Comando: <span class="chip" style="display:inline-flex;transform:translateY(2px)"><span class="dot" style="width:7px;height:7px"></span>/deleteaccount</span>)</p>
                  <label>senha atual</label>
                  <input id="delPw" type="password" placeholder="obrigat√≥rio" />
                  <div class="row" style="margin-top:12px">
                    <button class="btn" id="btnAskDelete" style="border-color: rgba(255,102,122,.26)">üóëÔ∏è Quero deletar</button>
                    <button class="btn" id="btnConfirmDelete" disabled style="border-color: rgba(255,102,122,.26)">‚è≥ Confirmar (5s)</button>
                  </div>
                  <div class="hint" id="delHint"></div>
                </div>

                <div class="divider"></div>

                <div class="block">
                  <h3>RAW</h3>
                  <p>√öltimo retorno √∫til (debug).</p>
                  <textarea id="rawAccount" readonly spellcheck="false"></textarea>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- RIGHT PATCH NOTES (N√ÉO MEXER) -->
      <div class="card">
        <div class="patch">
          <div class="patchHead">
            <div>
              <div class="tt">PATCH NOTES</div>
              <div class="sub">lado fixo ‚Ä¢ estilo ‚Äúsite AAA‚Äù</div>
            </div>
            <button class="btn gold" id="btnPatchReload">‚ú® Atualizar</button>
          </div>

          <div class="patchCard">
            <h3>üó°Ô∏è Cr√¥nicas do Reino</h3>
            <p>Essa coluna sempre fica do lado. Voc√™ pode trocar o texto quando quiser.</p>
            <ul class="patchList" id="patchList">
              <li>Portal de contas (medieval/anime) + VFX</li>
              <li>√Årea do Portal com scroll</li>
              <li>Switch Login/Registro com 2 bot√µes</li>
              <li>Token vis√≠vel + copiar</li>
              <li>Delete com delay 5s</li>
              <li>Feed de nicks: <code>/listusers</code></li>
            </ul>
            <div class="patchSmall" id="patchStamp">Atualizado em ‚Äî</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="hd">
      <b id="toastTitle">Aviso</b>
      <button class="x" id="toastClose">Fechar</button>
    </div>
    <div class="bd" id="toastBody"></div>
  </div>

<script>
/* ============================================================
   0) AAA Background: stars/particles
============================================================ */
(function stars(){
  const c = document.getElementById('stars');
  const ctx = c.getContext('2d');
  let W=0,H=0, DPR=1;
  const pts = [];
  const N = 140;

  function resize(){
    DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    W = c.width = Math.floor(innerWidth * DPR);
    H = c.height = Math.floor(innerHeight * DPR);
    c.style.width = innerWidth+'px';
    c.style.height = innerHeight+'px';
    pts.length = 0;
    for(let i=0;i<N;i++){
      pts.push({
        x: Math.random()*W,
        y: Math.random()*H,
        r: (Math.random()*1.6+0.4)*DPR,
        a: Math.random()*0.8+0.15,
        vx: (Math.random()*0.18+0.02)*DPR,
        vy: (Math.random()*0.10+0.02)*DPR,
        t: Math.random()*Math.PI*2
      });
    }
  }
  function tick(){
    ctx.clearRect(0,0,W,H);
    // subtle vignette
    const g = ctx.createRadialGradient(W*0.5,H*0.5,0,W*0.5,H*0.5,Math.max(W,H)*0.65);
    g.addColorStop(0,'rgba(0,0,0,0)');
    g.addColorStop(1,'rgba(0,0,0,0.55)');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    for(const p of pts){
      p.t += 0.02;
      p.x += p.vx;
      p.y += p.vy + Math.sin(p.t)*0.08*DPR;
      if(p.x>W+40) p.x=-40;
      if(p.y>H+40) p.y=-40;

      ctx.beginPath();
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fillStyle = `rgba(255,255,255,${p.a})`;
      ctx.fill();
    }
    requestAnimationFrame(tick);
  }
  window.addEventListener('resize', resize);
  resize(); tick();
})();

/* ============================================================
   1) State + helpers
============================================================ */
const $ = (id)=>document.getElementById(id);

const state = {
  base: null,                 // ex: https://xxxx.ngrok-free.dev
  api: null,                  // base + /api/v1/cmd
  token: localStorage.getItem('obearco_token') || "",
  logged: false,
  lastUsersLoadedAt: 0,
  globalMsgHiddenByUser: false,
};

function toast(title, body){
  $('toastTitle').textContent = title;
  $('toastBody').textContent = body;
  $('toast').classList.add('show');
  setTimeout(()=>$('toast').classList.remove('show'), 5200);
}
$('toastClose').onclick = ()=>$('toast').classList.remove('show');

function setRaw(id, obj){
  $(id).value = JSON.stringify(obj, null, 2);
}

function setStatus(ok, text){
  $('statusText').textContent = text;
  $('dotStatus').className = 'dot ' + (ok ? 'ok' : 'bad');
  $('chipStatus').style.borderColor = ok ? 'rgba(55,217,139,.30)' : 'rgba(255,102,122,.26)';
}

/* ============================================================
   2) Load server_status.json (from GitHub pages) + build base
============================================================ */
async function syncStatus(){
  try{
    // cache-bust
    const url = `./server_status.json?ts=${Date.now()}`;
    const r = await fetch(url, { cache: 'no-store' });
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const j = await r.json();

    const base = (j.url_api_base || j.url_api_base || j.url_api || "").trim();
    if(!base) throw new Error("status.json sem url_api_base");

    state.base = base.replace(/\/+$/,'');
    state.api = state.base + "/api/v1/cmd";

    $('baseChip').textContent = "base: " + state.base.replace(/^https?:\/\//,'');
    $('dotBase').className = "dot ok";
    $('chipPortal').textContent = "ok";
    $('dotPortal').className = "dot ok";
    setStatus(true, "status: Online");
    return true;
  }catch(e){
    $('baseChip').textContent = "base: ‚Äî";
    $('dotBase').className = "dot bad";
    $('chipPortal').textContent = "sem base";
    $('dotPortal').className = "dot bad";
    setStatus(false, "status: Offline");
    toast("Falha no status.json", String(e.message || e));
    return false;
  }
}

$('btnSync').onclick = syncStatus;

/* ============================================================
   3) API call (/api/v1/cmd) with token
============================================================ */
async function apiCmd(comando, payload = {}){
  if(!state.api){
    const ok = await syncStatus();
    if(!ok) throw new Error("Sem base (status.json)");
  }
  const body = { comando, ...payload };
  const headers = { "Content-Type":"application/json" };
  if(state.token) headers["Authorization"] = "Bearer " + state.token;

  const r = await fetch(state.api, {
    method:"POST",
    headers,
    body: JSON.stringify(body),
  });

  const j = await r.json().catch(()=>({ok:false, error:"Resposta inv√°lida"}));
  return { http: r.status, json: j };
}

/* ============================================================
   4) Views & nav logic
============================================================ */
function setActiveNav(view){
  [...document.querySelectorAll('.navBtn')].forEach(b=>{
    b.classList.toggle('active', b.dataset.view===view);
  });
  $('viewPortal').style.display = view==="portal" ? "" : "none";
  $('viewTaverna').style.display = view==="taverna" ? "" : "none";
  $('viewConta').style.display = view==="conta" ? "" : "none";

  // Lazy load users when entering tavern
  if(view==="taverna") loadUsers(true).catch(()=>{});
  if(view==="conta") refreshAccountTokenUI();
}

document.querySelectorAll('.navBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const view = btn.dataset.view;
    setActiveNav(view);
  });
});

/* ============================================================
   5) Portal: tabs Login/Register
============================================================ */
function setPortalTab(which){
  const isLogin = which==="login";
  $('panelLogin').style.display = isLogin ? "" : "none";
  $('panelRegister').style.display = isLogin ? "none" : "";
  $('tabLogin').classList.toggle('active', isLogin);
  $('tabRegister').classList.toggle('active', !isLogin);
}
$('tabLogin').onclick = ()=>setPortalTab("login");
$('tabRegister').onclick = ()=>setPortalTab("register");
$('heroLogin').onclick = ()=>{ setPortalTab("login"); $('loginLogin').focus(); };
$('heroRegister').onclick = ()=>{ setPortalTab("register"); $('regUsername').focus(); };

/* ============================================================
   6) Auth: login/register/logout + unlock UI
============================================================ */
function setLoggedIn(on, contaInfo=null){
  state.logged = !!on;

  // show/hide nav items
  $('navTaverna').style.display = state.logged ? "" : "none";
  $('navConta').style.display = state.logged ? "" : "none";

  // show connected line ONLY after login
  if(state.logged && state.base){
    $('connectedLine').style.display = "";
    $('connectedLine').textContent = "Conectado ao portal: " + state.base;
    $('headLine').textContent = "Conectado ao portal (logado).";
  }else{
    $('connectedLine').style.display = "none";
    $('headLine').textContent = "Pronto para forjar sua entrada no reino.";
  }

  // chips
  $('chipTaverna').textContent = state.logged ? "pronto" : "‚Äî";
  $('chipConta').textContent = state.logged ? "pronto" : "‚Äî";
  $('dotTaverna').className = "dot " + (state.logged ? "ok" : "");
  $('dotConta').className = "dot " + (state.logged ? "ok" : "");

  // token UI
  refreshAccountTokenUI();
  if(contaInfo && contaInfo.username){
    toast("Bem-vindo ao reino", `Logado como ${contaInfo.username}`);
  }
}

function persistToken(t){
  state.token = (t||"").trim();
  if(state.token) localStorage.setItem('obearco_token', state.token);
  else localStorage.removeItem('obearco_token');
  refreshAccountTokenUI();
}

function refreshAccountTokenUI(){
  $('tokenView').value = state.token || "";
  $('tokenHint').textContent = state.token ? "Token salvo no navegador (localStorage)." : "Sem token salvo.";
}

$('btnClearToken').onclick = ()=>{
  persistToken("");
  setLoggedIn(false);
  setRaw('rawOut', { ok:true, message:"token limpo" });
};

$('btnDoLogin').onclick = async ()=>{
  $('loginHint').textContent = "";
  try{
    const login = $('loginLogin').value.trim();
    const senha = $('loginSenha').value.trim();
    const { http, json } = await apiCmd("/login", { login, senha });
    setRaw('rawOut', { http, ...json });

    if(json.ok){
      persistToken(json.session_token || "");
      setLoggedIn(true, json.conta || null);
      setPortalTab("login");
      setActiveNav("portal"); // mant√©m no portal
    }else{
      $('loginHint').textContent = json.error || "Falha no login.";
      toast("Login falhou", json.error || "Falha no login.");
    }
  }catch(e){
    $('loginHint').textContent = String(e.message || e);
    toast("Erro", String(e.message || e));
  }
};

$('btnDoLogout').onclick = async ()=>{
  try{
    if(!state.token){
      toast("Logout", "Voc√™ n√£o tem token salvo.");
      return;
    }
    const { http, json } = await apiCmd("/logout", {});
    setRaw('rawOut', { http, ...json });
    // mesmo se falhar, limpamos token no front
    persistToken("");
    setLoggedIn(false);
    toast("Logout", json.message || "Sess√£o limpa.");
  }catch(e){
    persistToken("");
    setLoggedIn(false);
    toast("Logout", "Sess√£o limpa (offline).");
  }
};

$('btnDoRegister').onclick = async ()=>{
  $('regHint').textContent = "";
  try{
    const username = $('regUsername').value.trim();
    const email = $('regEmail').value.trim();
    const senha = $('regSenha').value.trim();
    const senha2 = $('regSenha2').value.trim();
    if(senha !== senha2){
      $('regHint').textContent = "As senhas n√£o conferem.";
      return;
    }
    const { http, json } = await apiCmd("/register", { username, email, senha });
    setRaw('rawOut', { http, ...json });

    if(json.ok){
      toast("Registro OK", "Conta criada. Agora fa√ßa login.");
      setPortalTab("login");
      $('loginLogin').value = email || username;
      $('loginSenha').value = senha;
      $('loginSenha').focus();
    }else{
      $('regHint').textContent = json.error || "Falha no registro.";
      toast("Registro falhou", json.error || "Falha no registro.");
    }
  }catch(e){
    $('regHint').textContent = String(e.message || e);
    toast("Erro", String(e.message || e));
  }
};

/* ============================================================
   7) Ping always visible
============================================================ */
$('btnPing').onclick = async ()=>{
  try{
    const { http, json } = await apiCmd("/ping", {});
    setRaw('rawOut', { http, ...json });
    if(json.ok) toast("Ping", "Servidor respondeu.");
    else toast("Ping", json.error || "Falha.");
  }catch(e){
    toast("Ping falhou", String(e.message || e));
  }
};

/* ============================================================
   8) Tavern: list users (lazy load)
============================================================ */
function addUserCard(u){
  const div = document.createElement('div');
  div.style.border = "1px solid rgba(255,255,255,.10)";
  div.style.background = "linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.14))";
  div.style.borderRadius = "16px";
  div.style.padding = "12px";
  div.style.display = "flex";
  div.style.alignItems = "center";
  div.style.justifyContent = "space-between";
  div.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:2px;min-width:0">
      <b style="font-size:14px;letter-spacing:.02em;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(u.username || "‚Äî")}</b>
      <span style="color:rgba(233,230,255,.55);font-size:12px">id: ${escapeHtml(String(u.conta_id ?? "‚Äî"))}</span>
    </div>
    <span class="chip" style="border-color:rgba(112,245,255,.18)"><span class="dot ok" style="width:7px;height:7px"></span>registrado</span>
  `;
  return div;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}

async function loadUsers(force=false){
  if(!state.logged){
    $('usersHint').textContent = "Fa√ßa login para ver a Taverna.";
    return;
  }
  const now = Date.now();
  if(!force && (now - state.lastUsersLoadedAt) < 20_000) return; // anti-spam
  state.lastUsersLoadedAt = now;

  $('usersHint').textContent = "Carregando...";
  $('usersGrid').innerHTML = "";
  // loading skeletons
  for(let i=0;i<9;i++){
    const sk = document.createElement('div');
    sk.style.border = "1px solid rgba(255,255,255,.08)";
    sk.style.borderRadius = "16px";
    sk.style.height = "56px";
    sk.style.background = "rgba(255,255,255,.04)";
    sk.style.animation = "twinkle 1.2s ease-in-out infinite";
    $('usersGrid').appendChild(sk);
  }

  try{
    const { http, json } = await apiCmd("/listusers", { limit: 200 });
    setRaw('rawOut', { http, ...json });

    if(!json.ok){
      $('usersHint').textContent = json.error || "Falha ao listar.";
      return;
    }
    const users = json.users || [];
    $('usersGrid').innerHTML = "";
    users.forEach(u => $('usersGrid').appendChild(addUserCard(u)));
    $('usersHint').textContent = `Total: ${users.length}`;
    $('chipTaverna').textContent = String(users.length);
  }catch(e){
    $('usersHint').textContent = String(e.message || e);
  }
}

$('btnReloadUsers').onclick = ()=>loadUsers(true);

/* ============================================================
   9) Account: whoami / updateprofile / changepassword / delete
============================================================ */
$('btnCopyToken').onclick = async ()=>{
  if(!state.token){
    toast("Token", "Sem token.");
    return;
  }
  try{
    await navigator.clipboard.writeText(state.token);
    toast("Copiado", "Token copiado para a √°rea de transfer√™ncia.");
  }catch{
    // fallback
    $('tokenView').focus();
    $('tokenView').select();
    document.execCommand('copy');
    toast("Copiado", "Token copiado (fallback).");
  }
};

$('btnWhoami').onclick = async ()=>{
  $('upHint').textContent = "";
  try{
    const { http, json } = await apiCmd("/whoami", {});
    setRaw('rawAccount', { http, ...json });
    if(json.ok){
      toast("Whoami", "Dados atualizados.");
    }else{
      toast("Whoami falhou", json.error || "Sem sess√£o.");
    }
  }catch(e){
    toast("Erro", String(e.message || e));
  }
};

$('btnUpdateProfile').onclick = async ()=>{
  $('upHint').textContent = "";
  try{
    const username = $('upUsername').value.trim();
    const email = $('upEmail').value.trim();
    const { http, json } = await apiCmd("/updateprofile", { username, email });
    setRaw('rawAccount', { http, ...json });
    if(json.ok){
      $('upHint').textContent = json.message || "Atualizado.";
      toast("Perfil atualizado", json.message || "OK");
    }else{
      $('upHint').textContent = json.error || "Falhou.";
      toast("Falha", json.error || "Falhou.");
    }
  }catch(e){
    $('upHint').textContent = String(e.message || e);
  }
};

$('btnChangePassword').onclick = async ()=>{
  $('pwHint').textContent = "";
  try{
    const senha_atual = $('pwOld').value.trim();
    const senha_nova = $('pwNew').value.trim();
    const { http, json } = await apiCmd("/changepassword", { senha_atual, senha_nova });
    setRaw('rawAccount', { http, ...json });
    if(json.ok){
      $('pwHint').textContent = json.message || "Senha alterada.";
      toast("Senha alterada", json.message || "OK");
      $('pwOld').value = "";
      $('pwNew').value = "";
    }else{
      $('pwHint').textContent = json.error || "Falhou.";
      toast("Falha", json.error || "Falhou.");
    }
  }catch(e){
    $('pwHint').textContent = String(e.message || e);
  }
};

// Delete flow: ask -> enable confirm after 5s
let delTimer = null;
$('btnAskDelete').onclick = ()=>{
  $('delHint').textContent = "Tem certeza? Aguarde 5s para liberar o bot√£o Confirmar‚Ä¶";
  $('btnConfirmDelete').disabled = true;
  $('btnConfirmDelete').textContent = "‚è≥ Confirmar (5s)";
  let s = 5;
  clearInterval(delTimer);
  delTimer = setInterval(()=>{
    s--;
    if(s<=0){
      clearInterval(delTimer);
      $('btnConfirmDelete').disabled = false;
      $('btnConfirmDelete').textContent = "üóëÔ∏è Confirmar delete";
      $('delHint').textContent = "Agora voc√™ pode confirmar.";
    }else{
      $('btnConfirmDelete').textContent = `‚è≥ Confirmar (${s}s)`;
    }
  }, 1000);
};

$('btnConfirmDelete').onclick = async ()=>{
  $('delHint').textContent = "";
  try{
    const senha_atual = $('delPw').value.trim();
    if(!senha_atual){
      $('delHint').textContent = "Informe a senha atual.";
      return;
    }
    const { http, json } = await apiCmd("/deleteaccount", { senha_atual });
    setRaw('rawAccount', { http, ...json });
    if(json.ok){
      toast("Conta deletada", "At√© a pr√≥xima aventura.");
      persistToken("");
      setLoggedIn(false);
      setActiveNav("portal");
    }else{
      $('delHint').textContent = json.error || "Falhou.";
      toast("Falha", json.error || "Falhou.");
    }
  }catch(e){
    $('delHint').textContent = String(e.message || e);
  }
};

/* ============================================================
   10) Global message poll (every 2 minutes)
   - invisible if no response
   - visible only if server returns message fields
============================================================ */
function extractGlobalMessage(json){
  if(!json || typeof json !== 'object') return "";
  // try common keys
  return (json.global_message || json.message_global || json.motd || json.broadcast || json.notice || "").toString().trim();
}

function showGlobal(msg){
  if(state.globalMsgHiddenByUser) return;
  $('globalMsgText').textContent = msg;
  $('globalMsg').classList.add('show');
}

function hideGlobal(){
  $('globalMsg').classList.remove('show');
}

$('globalMsgClose').onclick = ()=>{
  state.globalMsgHiddenByUser = true;
  hideGlobal();
  setTimeout(()=>{ state.globalMsgHiddenByUser = false; }, 60_000); // depois de 1 min, pode aparecer de novo
};

async function pollGlobal(){
  try{
    // se n√£o tem base, tenta sync silencioso
    if(!state.api){
      const ok = await syncStatus();
      if(!ok){ hideGlobal(); return; }
    }
    // chamando ping (leve) - se voc√™ preferir outro comando depois, troca aqui
    const { json } = await apiCmd("/ping", {});
    // regra: se o servidor n√£o responder nada -> invis√≠vel
    // aqui, se respondeu mas n√£o tem mensagem, fica invis√≠vel tamb√©m.
    const msg = extractGlobalMessage(json);
    if(msg) showGlobal(msg);
    else hideGlobal();
  }catch{
    hideGlobal();
  }
}

// start polling
setInterval(pollGlobal, 120_000);
setTimeout(pollGlobal, 6_000);

/* ============================================================
   11) Patch notes "Atualizar" (s√≥ carimbo)
============================================================ */
function stampPatch(){
  const d = new Date();
  const pad = (n)=>String(n).padStart(2,'0');
  $('patchStamp').textContent = `Atualizado em ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}, ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
$('btnPatchReload').onclick = ()=>{ stampPatch(); toast("Patch Notes", "Atualizado."); };

/* ============================================================
   12) Boot
============================================================ */
(async function boot(){
  stampPatch();
  refreshAccountTokenUI();
  await syncStatus();

  // try auto whoami if token exists (silencioso)
  if(state.token){
    try{
      const { json } = await apiCmd("/whoami", {});
      if(json && json.ok){
        setLoggedIn(true, (json.session || json.conta || null));
      }else{
        // token inv√°lido
        persistToken("");
        setLoggedIn(false);
      }
    }catch{
      // offline: mant√©m token, mas n√£o libera login UI
      setLoggedIn(false);
    }
  }else{
    setLoggedIn(false);
  }

  // default view
  setActiveNav("portal");
})();
</script>
</body>
</html>
