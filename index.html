<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OBEARCO ‚Ä¢ Web</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b0d10; --panel:#10141a; --panel2:#0f1318;
      --text:#e7eef7; --muted:#a6b2c2; --border:#1e2632;
      --accent:#5aa6ff; --accent2:#8b5cf6; --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b;
      --shadow: 0 10px 35px rgba(0,0,0,.35);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); background:radial-gradient(1200px 700px at 10% -10%, rgba(90,166,255,.12), transparent 50%),
      radial-gradient(900px 600px at 90% 0%, rgba(139,92,246,.10), transparent 45%),
      var(--bg);
      color:var(--text);
    }
    a{color:inherit; text-decoration:none}
    .app{min-height:100vh; display:flex; flex-direction:column}
    .topbar{
      position:sticky; top:0; z-index:50;
      background: rgba(11,13,16,.75); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .topbar-inner{
      max-width:1100px; margin:0 auto; padding:14px 16px;
      display:flex; align-items:center; gap:12px; justify-content:space-between;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.4px;
    }
    .dot{width:10px;height:10px;border-radius:99px;background:var(--warn); box-shadow:0 0 0 4px rgba(245,158,11,.12)}
    .nav{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .chip{
      border:1px solid var(--border); background:rgba(16,20,26,.6);
      padding:8px 10px; border-radius:999px; color:var(--muted);
      font-size:13px;
      display:inline-flex; gap:8px; align-items:center;
    }
    .btn{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(16,20,26,.85), rgba(16,20,26,.55));
      color:var(--text);
      padding:9px 12px; border-radius:12px;
      cursor:pointer; transition:.15s transform,.15s filter,.15s border-color;
      display:inline-flex; align-items:center; gap:8px; font-weight:650;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.05); border-color:#2a3648}
    .btn.primary{
      border-color: rgba(90,166,255,.35);
      background: linear-gradient(180deg, rgba(90,166,255,.22), rgba(90,166,255,.10));
    }
    .btn.danger{
      border-color: rgba(239,68,68,.35);
      background: linear-gradient(180deg, rgba(239,68,68,.22), rgba(239,68,68,.10));
    }
    .btn.ghost{background:transparent}
    .container{
      max-width:1100px; width:100%;
      margin:0 auto; padding:18px 16px 34px;
      display:grid; gap:16px;
    }
    .grid{
      display:grid; gap:16px;
      grid-template-columns: 1.2fr .8fr;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:linear-gradient(180deg, rgba(16,20,26,.95), rgba(16,20,26,.70));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .card h2{margin:0 0 8px; font-size:18px}
    .card h3{margin:0 0 8px; font-size:15px; color:var(--muted); font-weight:700}
    .muted{color:var(--muted)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .col{display:flex; flex-direction:column; gap:10px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; font-size:12px;
      border:1px solid var(--border); background:rgba(15,19,24,.65);
      color:var(--muted);
    }
    .pill.ok{border-color: rgba(34,197,94,.35); color:#b7f7cb; background:rgba(34,197,94,.08)}
    .pill.bad{border-color: rgba(239,68,68,.35); color:#ffd0d0; background:rgba(239,68,68,.08)}
    .pill.warn{border-color: rgba(245,158,11,.35); color:#ffe2b3; background:rgba(245,158,11,.08)}
    .hr{height:1px; background:var(--border); margin:12px 0}
    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-size:12px; color:var(--muted)}
    input, textarea, select{
      width:100%;
      padding:10px 11px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(15,19,24,.85);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:110px; resize:vertical; font-family:var(--mono); font-size:12.5px}
    .kpi{
      display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px;
    }
    @media (max-width: 600px){
      .kpi{grid-template-columns:1fr}
    }
    .kpi .box{
      border:1px solid var(--border);
      background:rgba(15,19,24,.6);
      border-radius:14px;
      padding:10px;
    }
    .kpi .n{font-weight:900; font-size:16px}
    .kpi .t{font-size:12px; color:var(--muted)}
    .toast-wrap{
      position:fixed; right:16px; bottom:16px; z-index:9999;
      display:flex; flex-direction:column; gap:10px;
      max-width:min(520px, calc(100vw - 32px));
    }
    .toast{
      border:1px solid var(--border);
      background:rgba(16,20,26,.92);
      border-radius:14px;
      padding:10px 12px;
      box-shadow:var(--shadow);
      display:flex; gap:10px; align-items:flex-start;
    }
    .toast b{display:block; margin-bottom:2px}
    .tag{font-family:var(--mono); font-size:12px; opacity:.9}
    .mini{font-size:12px}
    .list{display:flex; flex-direction:column; gap:10px}
    .item{
      border:1px solid var(--border);
      background:rgba(15,19,24,.6);
      border-radius:14px;
      padding:10px;
    }
    .item .title{font-weight:800}
    .item .sub{color:var(--muted); font-size:12px}
    .split{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 700px){ .split{grid-template-columns:1fr} }
    .smallnote{font-size:12px; color:var(--muted); line-height:1.35}
  </style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <span class="dot" id="srvDot"></span>
        <div>
          <div>OBEARCO <span class="muted">Web</span></div>
          <div class="mini muted" id="srvLine">Carregando status‚Ä¶</div>
        </div>
      </div>

      <div class="nav" id="nav">
        <!-- preenchido via JS -->
      </div>
    </div>
  </div>

  <main class="container" id="app"></main>
</div>

<div class="toast-wrap" id="toasts"></div>

<script>
/* ============================================================
   CONFIG (GitHub status.json)
   ============================================================ */

const STATUS_BLOB_URL = "https://github.com/NoSense-Bot/Servidor/blob/main/server_status.json";

function blobToRaw(url){
  try{
    if(url.includes("raw.githubusercontent.com")) return url;
    return url
      .replace("https://github.com/", "https://raw.githubusercontent.com/")
      .replace("/blob/", "/");
  }catch{ return url; }
}

const LS = {
  token: "obearco_session_token",
  apiBase: "obearco_api_base",
  me: "obearco_me_cache",
};

function safeJson(s){
  try{ return JSON.parse(s); }catch{ return null; }
}

const state = {
  loading: true,
  status: null,
  apiBase: localStorage.getItem(LS.apiBase) || "",
  token: localStorage.getItem(LS.token) || "",
  me: safeJson(localStorage.getItem(LS.me)) || null,
  isAdmin: false,
  route: location.hash || "#/login",
};

function toast(title, msg, kind="info"){
  const wrap = document.getElementById("toasts");
  const t = document.createElement("div");
  t.className = "toast";
  const icon = kind==="ok" ? "‚úÖ" : kind==="bad" ? "‚ùå" : kind==="warn" ? "‚ö†Ô∏è" : "‚ÑπÔ∏è";
  t.innerHTML = `
    <div style="font-size:18px;line-height:1">${icon}</div>
    <div>
      <b>${escapeHtml(title)}</b>
      <div class="mini muted">${escapeHtml(msg)}</div>
    </div>
  `;
  wrap.appendChild(t);
  setTimeout(()=>{ t.style.opacity="0"; t.style.transform="translateY(6px)"; }, 3200);
  setTimeout(()=>{ t.remove(); }, 3800);
}

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/* ============================================================
   API helpers
   ============================================================ */

async function fetchStatus(){
  const rawUrl = blobToRaw(STATUS_BLOB_URL);
  const res = await fetch(rawUrl, { cache: "no-store" });
  if(!res.ok) throw new Error("N√£o consegui baixar server_status.json");
  return await res.json();
}

function apiUrl(path){
  const base = (state.apiBase || "").replace(/\/+$/,"");
  return base + path;
}

async function apiCmd(payload){
  const url = apiUrl("/api/v1/cmd");
  const headers = { "Content-Type":"application/json" };
  if(state.token) headers["Authorization"] = "Bearer " + state.token;

  try{
    const r = await fetch(url, { method:"POST", headers, body: JSON.stringify(payload) });
    const j = await r.json().catch(()=> ({}));
    if(!r.ok || j.ok === false) throw new Error(j.error || "Falha no cmd");
    return j;
  }catch(err){
    if(payload?.comando === "/login" || payload?.comando === "/register"){
      const legacyPath = payload.comando === "/login" ? "/login" : "/register";
      const rr = await fetch(apiUrl(legacyPath), { method:"POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(payload) });
      const jj = await rr.json().catch(()=> ({}));
      if(!rr.ok || jj.ok === false) throw new Error(jj.error || "Falha no login/register");
      return jj;
    }
    throw err;
  }
}

function pickId(user){
  return user?.id ?? user?.user_id ?? user?._id ?? user?.email ?? null;
}

function isAdminFromMe(me){
  return !!(me?.is_admin || me?.admin || me?.role === "admin" || me?.nivel === "admin");
}

/* ============================================================
   Auth flows
   ============================================================ */

async function doLogin(email, senha){
  const out = await apiCmd({ comando:"/login", email, senha });
  const token = out.session_token || out.token || out?.data?.session_token || out?.session?.token;
  if(!token) throw new Error("Login OK mas n√£o veio session_token");
  state.token = token;
  localStorage.setItem(LS.token, token);
  toast("Login", "Sess√£o salva ‚úÖ", "ok");
  await loadMe();
  go("#/feed");
}

async function doRegister(email, senha, extra={}){
  // AGORA ENVIA usuario TAMB√âM (backend exige email, senha, usuario)
  const out = await apiCmd({ comando:"/register", email, senha, ...extra });
  toast("Conta criada", "Agora faz login üòâ", "ok");
  go("#/login");
}

function doLogout(){
  state.token = "";
  state.me = null;
  state.isAdmin = false;
  localStorage.removeItem(LS.token);
  localStorage.removeItem(LS.me);
  toast("Logout", "Sess√£o removida.", "ok");
  go("#/login");
}

/* ============================================================
   ME / USER CRUD (normal)
   ============================================================ */

async function loadMe(){
  if(!state.token) return null;
  try{
    const out = await apiCmd({ comando:"/me/get" });
    const me = out.me || out.user || out.account || out.data || out;
    state.me = me;
    state.isAdmin = isAdminFromMe(me);
    localStorage.setItem(LS.me, JSON.stringify(me));
    renderNav();
    return me;
  }catch(e1){
    const out2 = await apiCmd({ comando:"/me" }).catch(()=> null);
    if(out2){
      const me = out2.me || out2.user || out2.account || out2.data || out2;
      state.me = me;
      state.isAdmin = isAdminFromMe(me);
      localStorage.setItem(LS.me, JSON.stringify(me));
      renderNav();
      return me;
    }
    throw e1;
  }
}

async function updateMe(patch){
  const out = await apiCmd({ comando:"/me/update", patch });
  toast("Conta", "Atualizada ‚úÖ", "ok");
  await loadMe();
  return out;
}

async function deleteMe(){
  await apiCmd({ comando:"/me/delete" });
  toast("Conta", "Deletada üóëÔ∏è", "ok");
  doLogout();
}

async function addSkill(skill){
  await apiCmd({ comando:"/me/skills/add", skill });
  toast("Skills", "Adicionada ‚úÖ", "ok");
  await loadMe();
}

async function removeSkill(skill){
  await apiCmd({ comando:"/me/skills/remove", skill });
  toast("Skills", "Removida ‚úÖ", "ok");
  await loadMe();
}

/* ============================================================
   ADMIN CRUD (tudo)
   ============================================================ */

async function adminListUsers(){
  const out = await apiCmd({ comando:"/admin/users/list" });
  return out.users || out.list || out.data || [];
}
async function adminGetUser(id){
  const out = await apiCmd({ comando:"/admin/users/get", id });
  return out.user || out.data || out;
}
async function adminUpdateUser(id, patch){
  await apiCmd({ comando:"/admin/users/update", id, patch });
  toast("Admin", "Usu√°rio atualizado ‚úÖ", "ok");
}
async function adminDeleteUser(id){
  await apiCmd({ comando:"/admin/users/delete", id });
  toast("Admin", "Usu√°rio deletado üóëÔ∏è", "ok");
}
async function adminCreateUser(payload){
  await apiCmd({ comando:"/admin/users/create", ...payload });
  toast("Admin", "Usu√°rio criado ‚úÖ", "ok");
}

/* ============================================================
   Router + Render
   ============================================================ */

function go(hash){
  location.hash = hash;
}

window.addEventListener("hashchange", ()=>{
  state.route = location.hash || "#/login";
  render();
});

function renderNav(){
  const nav = document.getElementById("nav");
  const authed = !!state.token;

  nav.innerHTML = "";

  const chip = document.createElement("div");
  chip.className = "chip";
  chip.innerHTML = `
    <span class="tag">API</span>
    <span class="muted">${escapeHtml(state.apiBase || "‚Äî")}</span>
  `;
  nav.appendChild(chip);

  if(!authed){
    nav.appendChild(btn("üîê Login", ()=>go("#/login"), "primary"));
    nav.appendChild(btn("üßæ Registrar", ()=>go("#/register")));
    return;
  }

  nav.appendChild(btn("üì∞ Feed", ()=>go("#/feed"), "primary"));
  nav.appendChild(btn("‚öôÔ∏è Config", ()=>go("#/config")));
  if(state.isAdmin) nav.appendChild(btn("üõ°Ô∏è Admin", ()=>go("#/admin")));
  nav.appendChild(btn("üö™ Sair", doLogout, "ghost"));
}

function btn(label, onClick, cls=""){
  const b = document.createElement("button");
  b.className = "btn " + cls;
  b.textContent = label;
  b.onclick = onClick;
  return b;
}

function setServerBadge(online){
  const dot = document.getElementById("srvDot");
  const line = document.getElementById("srvLine");
  if(online){
    dot.style.background = "var(--ok)";
    dot.style.boxShadow = "0 0 0 4px rgba(34,197,94,.12)";
    line.textContent = "Servidor: Online ‚úÖ";
  }else{
    dot.style.background = "var(--bad)";
    dot.style.boxShadow = "0 0 0 4px rgba(239,68,68,.12)";
    line.textContent = "Servidor: Offline ‚ùå";
  }
}

function render(){
  const app = document.getElementById("app");
  const r = state.route;

  if(!state.token && (r.startsWith("#/feed") || r.startsWith("#/config") || r.startsWith("#/admin"))){
    go("#/login");
    return;
  }
  if(state.token && r.startsWith("#/admin") && !state.isAdmin){
    toast("Sem permiss√£o", "Voc√™ n√£o √© admin üòÖ", "warn");
    go("#/feed");
    return;
  }

  if(r.startsWith("#/login")) return renderLogin(app);
  if(r.startsWith("#/register")) return renderRegister(app);
  if(r.startsWith("#/feed")) return renderFeed(app);
  if(r.startsWith("#/config")) return renderConfig(app);
  if(r.startsWith("#/admin")) return renderAdmin(app);

  go("#/login");
}

function renderLogin(app){
  app.innerHTML = `
    <div class="grid">
      <div class="card">
        <h2>üîê Login</h2>
        <div class="muted">Entre com sua conta (usu√°rio normal ou admin).</div>
        <div class="hr"></div>

        <div class="field">
          <label>Email</label>
          <input id="email" placeholder="email@exemplo.com" />
        </div>
        <div class="field">
          <label>Senha</label>
          <input id="senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnLogin">Entrar</button>
          <button class="btn" onclick="location.hash='#/register'">Criar conta</button>
        </div>

        <div class="hr"></div>
        <div class="smallnote">
          üí° Dica: a base da API vem do <span class="tag">server_status.json</span> (GitHub).<br/>
          Se o CORS travar, confirme se seu servidor permite <span class="tag">https://nosense-bot.github.io</span>.
        </div>
      </div>

      <div class="card">
        <h2>üì° Conex√£o</h2>
        <div class="kpi">
          <div class="box">
            <div class="n" id="kpiStatus">‚Äî</div>
            <div class="t">status_servidor</div>
          </div>
          <div class="box">
            <div class="n" id="kpiApi">‚Äî</div>
            <div class="t">version_api</div>
          </div>
          <div class="box">
            <div class="n" id="kpiPort">‚Äî</div>
            <div class="t">porta</div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="muted mini"><span class="tag">url_api_base</span></div>
        <div class="tag" id="kpiBase">‚Äî</div>
      </div>
    </div>
  `;

  const email = app.querySelector("#email");
  const senha = app.querySelector("#senha");
  const btnLogin = app.querySelector("#btnLogin");

  btnLogin.onclick = async ()=>{
    const e = (email.value || "").trim();
    const s = (senha.value || "");
    if(!e || !s){ toast("Ops", "Preenche email e senha üòÖ", "warn"); return; }
    btnLogin.disabled = true;
    btnLogin.textContent = "Entrando‚Ä¶";
    try{
      await doLogin(e, s);
    }catch(err){
      toast("Login falhou", err?.message || String(err), "bad");
    }finally{
      btnLogin.disabled = false;
      btnLogin.textContent = "Entrar";
    }
  };

  const st = state.status || {};
  app.querySelector("#kpiStatus").textContent = st.status_servidor ?? "‚Äî";
  app.querySelector("#kpiApi").textContent = st.version_api ?? "‚Äî";
  app.querySelector("#kpiPort").textContent = st.porta ?? "‚Äî";
  app.querySelector("#kpiBase").textContent = st.url_api_base ?? "‚Äî";
}

function renderRegister(app){
  app.innerHTML = `
    <div class="grid">
      <div class="card">
        <h2>üßæ Registrar</h2>
        <div class="muted">Cria conta de usu√°rio normal (admin voc√™ define no banco/servidor).</div>
        <div class="hr"></div>

        <div class="field">
          <label>Usu√°rio</label>
          <input id="usuario" placeholder="seu nick" />
        </div>
        <div class="field">
          <label>Email</label>
          <input id="email" placeholder="email@exemplo.com" />
        </div>
        <div class="field">
          <label>Senha</label>
          <input id="senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnReg">Criar</button>
          <button class="btn" onclick="location.hash='#/login'">Voltar</button>
        </div>

        <div class="hr"></div>
        <div class="smallnote">üîß Backend esperado: comando <span class="tag">/register</span> retornando ok (requer email, senha, usuario).</div>
      </div>

      <div class="card">
        <h2>üß† Observa√ß√£o</h2>
        <div class="muted">
          Esse site salva o token no <span class="tag">localStorage</span> (simples e pr√°tico pra dev).<br/>
          Em produ√ß√£o, o ideal √© cookie HttpOnly.
        </div>
      </div>
    </div>
  `;

  const usuario = app.querySelector("#usuario");
  const email = app.querySelector("#email");
  const senha = app.querySelector("#senha");
  const btnReg = app.querySelector("#btnReg");

  btnReg.onclick = async ()=>{
    const u = (usuario.value || "").trim();
    const e = (email.value || "").trim();
    const s = (senha.value || "");
    if(!u || !e || !s){
      toast("Ops", "Preenche usu√°rio, email e senha üòÖ", "warn");
      return;
    }
    btnReg.disabled = true;
    btnReg.textContent = "Criando‚Ä¶";
    try{
      await doRegister(e, s, { usuario: u }); // envia usuario pro backend
    }catch(err){
      toast("Registro falhou", err?.message || String(err), "bad");
    }finally{
      btnReg.disabled = false;
      btnReg.textContent = "Criar";
    }
  };
}

function renderFeed(app){
  const me = state.me || {};
  const skills = me.skills ?? me.Skills ?? me.habilidades ?? null;

  app.innerHTML = `
    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <h2>üì∞ Feed</h2>
            <div class="muted">Seu perfil aparece no topo (skills etc.). Se n√£o tiver, fica <span class="tag">null</span>.</div>
          </div>
          <div class="row">
            ${state.isAdmin ? `<span class="pill ok">üõ°Ô∏è Admin</span>` : `<span class="pill warn">üë§ User</span>`}
          </div>
        </div>

        <div class="hr"></div>

        <div class="item">
          <div class="title">${escapeHtml(me.usuario || me.nome || me.name || me.username || me.email || "‚Äî")}</div>
          <div class="sub">${escapeHtml(me.email || "‚Äî")}</div>

          <div class="hr"></div>

          <div class="split">
            <div>
              <div class="muted mini">Token</div>
              <div class="tag">${escapeHtml(state.token ? state.token.slice(0,24)+"‚Ä¶" : "‚Äî")}</div>
            </div>
            <div>
              <div class="muted mini">ID</div>
              <div class="tag">${escapeHtml(pickId(me) || "‚Äî")}</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="muted mini">Skills</div>
          <div class="tag">${escapeHtml(skills === null ? "null" : JSON.stringify(skills))}</div>
        </div>

        <div class="hr"></div>

        <h3>üìå Seu feed (placeholder)</h3>
        <div class="muted mini">
          Aqui voc√™ pode listar posts, atividades, quests, etc.<br/>
          (quando voc√™ criar comandos tipo <span class="tag">/feed/list</span>, √© s√≥ plugar).
        </div>
      </div>

      <div class="card">
        <h2>‚ö° A√ß√µes r√°pidas</h2>
        <div class="row">
          <button class="btn primary" onclick="location.hash='#/config'">‚öôÔ∏è Abrir Config</button>
          ${state.isAdmin ? `<button class="btn" onclick="location.hash='#/admin'">üõ°Ô∏è Abrir Admin</button>` : ``}
        </div>
        <div class="hr"></div>
        <div class="smallnote">
          ‚úÖ Conectado como: <span class="tag">${escapeHtml(me.email || "‚Äî")}</span><br/>
          üåê API: <span class="tag">${escapeHtml(state.apiBase || "‚Äî")}</span>
        </div>
      </div>
    </div>
  `;
}

function renderConfig(app){
  const me = state.me || {};
  const skills = Array.isArray(me.skills) ? me.skills : (Array.isArray(me.Skills) ? me.Skills : []);
  const skillsJson = JSON.stringify(skills ?? null, null, 2);

  app.innerHTML = `
    <div class="grid">
      <div class="card">
        <h2>‚öôÔ∏è Config (usu√°rio)</h2>
        <div class="muted">Seu token + dados da conta com CRUD.</div>

        <div class="hr"></div>

        <div class="field">
          <label>Session token</label>
          <input value="${escapeHtml(state.token || "")}" readonly />
        </div>

        <div class="split">
          <div class="field">
            <label>Usu√°rio</label>
            <input id="fUsuario" value="${escapeHtml(me.usuario || "")}" placeholder="seu nick" />
          </div>
          <div class="field">
            <label>Email</label>
            <input id="fEmail" value="${escapeHtml(me.email || "")}" placeholder="email@exemplo.com" />
          </div>
        </div>

        <div class="field">
          <label>Nome (opcional)</label>
          <input id="fName" value="${escapeHtml(me.nome || me.name || "")}" placeholder="Seu nome" />
        </div>

        <div class="field">
          <label>Bio (opcional)</label>
          <input id="fBio" value="${escapeHtml(me.bio || me.about || "")}" placeholder="Uma descri√ß√£o‚Ä¶" />
        </div>

        <div class="field">
          <label>Skills (JSON)</label>
          <textarea id="fSkills">${escapeHtml(skillsJson === "null" ? "null" : skillsJson)}</textarea>
          <div class="smallnote">üí° Se n√£o tiver skills ainda, deixa <span class="tag">null</span> ou <span class="tag">[]</span>.</div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnSave">üíæ Salvar</button>
          <button class="btn" id="btnReload">üîÑ Recarregar</button>
          <button class="btn danger" id="btnDelete">üóëÔ∏è Deletar conta</button>
        </div>
      </div>

      <div class="card">
        <h2>üß© Skills r√°pidas</h2>
        <div class="muted">Adicionar/remover skill (via comandos dedicados).</div>

        <div class="hr"></div>

        <div class="field">
          <label>Skill</label>
          <input id="skillName" placeholder="ex: espada, alquimia‚Ä¶" />
        </div>
        <div class="row">
          <button class="btn primary" id="btnAddSkill">‚ûï Add</button>
          <button class="btn" id="btnRemSkill">‚ûñ Remover</button>
        </div>

        <div class="hr"></div>

        <div class="smallnote">
          Backend esperado:<br/>
          <span class="tag">/me/update</span>, <span class="tag">/me/delete</span>, <span class="tag">/me/skills/add</span>, <span class="tag">/me/skills/remove</span>
        </div>
      </div>
    </div>
  `;

  const fUsuario = app.querySelector("#fUsuario");
  const fName = app.querySelector("#fName");
  const fEmail = app.querySelector("#fEmail");
  const fBio = app.querySelector("#fBio");
  const fSkills = app.querySelector("#fSkills");
  const btnSave = app.querySelector("#btnSave");
  const btnReload = app.querySelector("#btnReload");
  const btnDelete = app.querySelector("#btnDelete");
  const skillName = app.querySelector("#skillName");
  const btnAddSkill = app.querySelector("#btnAddSkill");
  const btnRemSkill = app.querySelector("#btnRemSkill");

  btnReload.onclick = async ()=>{
    try{ await loadMe(); render(); toast("OK", "Recarregado ‚úÖ", "ok"); }
    catch(err){ toast("Falhou", err?.message || String(err), "bad"); }
  };

  btnSave.onclick = async ()=>{
    btnSave.disabled = true;
    btnSave.textContent = "Salvando‚Ä¶";
    try{
      let skillsVal = null;
      const raw = (fSkills.value || "").trim();
      if(raw !== ""){
        skillsVal = JSON.parse(raw);
      }

      const patch = {
        usuario: (fUsuario.value || "").trim(),
        name: (fName.value || "").trim(),
        email: (fEmail.value || "").trim(),
        bio: (fBio.value || "").trim(),
        skills: skillsVal,
      };

      await updateMe(patch);
      render();
    }catch(err){
      toast("Salvar falhou", err?.message || String(err), "bad");
    }finally{
      btnSave.disabled = false;
      btnSave.textContent = "üíæ Salvar";
    }
  };

  btnDelete.onclick = async ()=>{
    if(!confirm("Tem certeza que quer deletar sua conta?")) return;
    btnDelete.disabled = true;
    try{ await deleteMe(); }
    catch(err){ toast("Delete falhou", err?.message || String(err), "bad"); btnDelete.disabled = false; }
  };

  btnAddSkill.onclick = async ()=>{
    const sk = (skillName.value||"").trim();
    if(!sk){ toast("Ops", "Digita uma skill üòÖ", "warn"); return; }
    try{ await addSkill(sk); render(); }
    catch(err){ toast("Falhou", err?.message || String(err), "bad"); }
  };

  btnRemSkill.onclick = async ()=>{
    const sk = (skillName.value||"").trim();
    if(!sk){ toast("Ops", "Digita uma skill üòÖ", "warn"); return; }
    try{ await removeSkill(sk); render(); }
    catch(err){ toast("Falhou", err?.message || String(err), "bad"); }
  };
}

function renderAdmin(app){
  app.innerHTML = `
    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <h2>üõ°Ô∏è Admin</h2>
            <div class="muted">Ver todas as contas + CRUD total.</div>
          </div>
          <span class="pill ok">Admin mode</span>
        </div>

        <div class="hr"></div>

        <div class="split">
          <div class="field">
            <label>Buscar (email/id)</label>
            <input id="q" placeholder="ex: user@gmail.com" />
          </div>
          <div class="row" style="align-items:flex-end">
            <button class="btn primary" id="btnLoad">üì• Carregar lista</button>
            <button class="btn" id="btnNew">‚ûï Novo usu√°rio</button>
          </div>
        </div>

        <div class="hr"></div>
        <div class="list" id="usersList"></div>
      </div>

      <div class="card">
        <h2>‚úçÔ∏è Editor</h2>
        <div class="muted">Selecione um usu√°rio na lista pra editar.</div>

        <div class="hr"></div>

        <div class="field">
          <label>ID selecionado</label>
          <input id="selId" readonly />
        </div>

        <div class="field">
          <label>JSON (patch)</label>
          <textarea id="patch" placeholder='{"bio":"novo","skills":["a","b"],"is_admin":false}'></textarea>
          <div class="smallnote">üîß Isso envia <span class="tag">patch</span> pro comando <span class="tag">/admin/users/update</span></div>
        </div>

        <div class="row">
          <button class="btn primary" id="btnSaveUser">üíæ Atualizar</button>
          <button class="btn danger" id="btnDelUser">üóëÔ∏è Deletar</button>
          <button class="btn" id="btnGetUser">üîé Ver detalhes</button>
        </div>

        <div class="hr"></div>
        <div class="field">
          <label>Detalhes (read-only)</label>
          <textarea id="details" readonly></textarea>
        </div>
      </div>
    </div>
  `;

  const q = app.querySelector("#q");
  const btnLoad = app.querySelector("#btnLoad");
  const btnNew = app.querySelector("#btnNew");
  const usersList = app.querySelector("#usersList");
  const selId = app.querySelector("#selId");
  const patch = app.querySelector("#patch");
  const details = app.querySelector("#details");
  const btnSaveUser = app.querySelector("#btnSaveUser");
  const btnDelUser = app.querySelector("#btnDelUser");
  const btnGetUser = app.querySelector("#btnGetUser");

  let usersCache = [];

  function renderUsers(list){
    usersList.innerHTML = "";
    if(!list.length){
      usersList.innerHTML = `<div class="muted">Nenhuma conta encontrada.</div>`;
      return;
    }
    list.forEach(u=>{
      const id = pickId(u);
      const name = u.usuario || u.nome || u.name || u.username || u.email || "‚Äî";
      const role = (u.is_admin || u.admin || u.role==="admin") ? "admin" : "user";
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="title">${escapeHtml(name)}</div>
            <div class="sub">${escapeHtml(u.email || "")}</div>
          </div>
          <span class="pill ${role==="admin" ? "ok":"warn"}">${role==="admin" ? "üõ°Ô∏è admin":"üë§ user"}</span>
        </div>
        <div class="hr"></div>
        <div class="tag">${escapeHtml(id || "‚Äî")}</div>
      `;
      el.onclick = ()=>{
        selId.value = id || "";
        details.value = JSON.stringify(u, null, 2);
        patch.value = "{}";
      };
      usersList.appendChild(el);
    });
  }

  btnLoad.onclick = async ()=>{
    btnLoad.disabled = true;
    btnLoad.textContent = "Carregando‚Ä¶";
    try{
      const list = await adminListUsers();
      usersCache = Array.isArray(list) ? list : [];
      const term = (q.value||"").trim().toLowerCase();
      const filtered = term
        ? usersCache.filter(u => JSON.stringify(u).toLowerCase().includes(term))
        : usersCache;
      renderUsers(filtered);
      toast("Admin", "Lista carregada ‚úÖ", "ok");
    }catch(err){
      toast("Admin falhou", err?.message || String(err), "bad");
    }finally{
      btnLoad.disabled = false;
      btnLoad.textContent = "üì• Carregar lista";
    }
  };

  btnNew.onclick = async ()=>{
    const usuario = prompt("Usu√°rio (nick):");
    if(!usuario) return;
    const email = prompt("Email do novo usu√°rio:");
    if(!email) return;
    const senha = prompt("Senha:");
    if(!senha) return;
    const isAdmin = confirm("Esse usu√°rio √© ADMIN?");
    try{
      await adminCreateUser({ usuario, email, senha, is_admin: isAdmin });
      await btnLoad.onclick();
    }catch(err){
      toast("Criar falhou", err?.message || String(err), "bad");
    }
  };

  btnGetUser.onclick = async ()=>{
    const id = (selId.value||"").trim();
    if(!id){ toast("Ops", "Seleciona um usu√°rio üòÖ", "warn"); return; }
    try{
      const u = await adminGetUser(id);
      details.value = JSON.stringify(u, null, 2);
      toast("OK", "Detalhes carregados ‚úÖ", "ok");
    }catch(err){
      toast("Falhou", err?.message || String(err), "bad");
    }
  };

  btnSaveUser.onclick = async ()=>{
    const id = (selId.value||"").trim();
    if(!id){ toast("Ops", "Seleciona um usu√°rio üòÖ", "warn"); return; }
    let p = {};
    try{ p = JSON.parse((patch.value||"{}") || "{}"); }
    catch{ toast("JSON inv√°lido", "Corrige o patch üòÖ", "warn"); return; }

    btnSaveUser.disabled = true;
    try{
      await adminUpdateUser(id, p);
      await btnLoad.onclick();
    }catch(err){
      toast("Update falhou", err?.message || String(err), "bad");
    }finally{
      btnSaveUser.disabled = false;
    }
  };

  btnDelUser.onclick = async ()=>{
    const id = (selId.value||"").trim();
    if(!id){ toast("Ops", "Seleciona um usu√°rio üòÖ", "warn"); return; }
    if(!confirm("Deletar esse usu√°rio?")) return;
    btnDelUser.disabled = true;
    try{
      await adminDeleteUser(id);
      selId.value = "";
      details.value = "";
      patch.value = "{}";
      await btnLoad.onclick();
    }catch(err){
      toast("Delete falhou", err?.message || String(err), "bad");
    }finally{
      btnDelUser.disabled = false;
    }
  };
}

/* ============================================================
   Boot
   ============================================================ */

async function boot(){
  try{
    state.loading = true;
    renderNav();

    const st = await fetchStatus();
    state.status = st;

    const base = (st?.url_api_base || "").trim();
    if(base){
      state.apiBase = base.replace(/\/+$/,"");
      localStorage.setItem(LS.apiBase, state.apiBase);
    }

    const online = String(st?.status_servidor || "").toLowerCase().includes("online");
    setServerBadge(online);

    if(state.token){
      try{ await loadMe(); }
      catch(e){ toast("Sess√£o", "Token inv√°lido/expirado. Faz login de novo üòâ", "warn"); doLogout(); }
    }

    renderNav();
    render();
  }catch(err){
    setServerBadge(false);
    toast("Boot falhou", err?.message || String(err), "bad");
    renderNav();
    render();
  }finally{
    state.loading = false;
  }
}

boot();
</script>
</body>
</html>
